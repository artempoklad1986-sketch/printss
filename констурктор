<?php
mb_internal_encoding('UTF-8');
date_default_timezone_set('Europe/Moscow');
session_start();

$BASE = __DIR__;
$configFile = $BASE.'/config.json';
$photoConfigFile = $BASE.'/photo_config.json';
$uploadsDir = $BASE.'/uploads';
$ordersLog = $BASE.'/orders.txt';
$customersFile = $BASE.'/customers.json';

// Создаем папку для загрузок если не существует
if (!is_dir($uploadsDir)) @mkdir($uploadsDir, 0775, true);
if (!file_exists($uploadsDir.'/.htaccess')) {
    @file_put_contents($uploadsDir.'/.htaccess', 'php_flag engine off\nOptions -ExecCGI\n<FilesMatch \'\\\.(php|phar|phtml|cgi|pl|py)$\'>\nDeny from all\n</FilesMatch>\n');
}

// Загружаем основной конфиг
$cfg = json_decode(@file_get_contents($configFile), true) ?? [];

// Функция для загрузки конфига фотоконструктора ИЗ АДМИНКИ
function loadPhotoConfig($photoConfigFile) {
    $photoConfig = json_decode(@file_get_contents($photoConfigFile), true);

    if (!$photoConfig) {
        // Дефолтная конфигурация только если нет файла
        $photoConfig = [
            'enabled' => true,
            'max_photos' => 100,
            'max_file_size' => 10,
            'supported_formats' => ['jpg', 'jpeg', 'png', 'heic', 'heif'],
            'sizes' => [
                ['name' => '10×15', 'w' => 10, 'h' => 15, 'base' => 30, 'enabled' => true, 'popular' => true],
                ['name' => '15×21', 'w' => 15, 'h' => 21, 'base' => 50, 'enabled' => true, 'popular' => true],
                ['name' => 'A4', 'w' => 21, 'h' => 29.7, 'base' => 120, 'enabled' => true, 'popular' => false],
                ['name' => 'A3', 'w' => 29.7, 'h' => 42, 'base' => 200, 'enabled' => true, 'popular' => false],
                ['name' => '30×40', 'w' => 30, 'h' => 40, 'base' => 300, 'enabled' => true, 'popular' => false],
                ['name' => '50×70', 'w' => 50, 'h' => 70, 'base' => 800, 'enabled' => true, 'popular' => false]
            ],
            'papers' => [
                ['name' => 'Матовая', 'delta' => 0, 'enabled' => true, 'description' => 'Классическая матовая бумага'],
                ['name' => 'Глянец', 'delta' => 10, 'enabled' => true, 'description' => 'Глянцевая бумага с блеском']
            ],
            'corrections' => [
                ['name' => 'Нет', 'delta' => 0, 'enabled' => true, 'description' => 'Без коррекции'],
                ['name' => 'Легкая', 'delta' => 15, 'enabled' => true, 'description' => 'Автокоррекция яркости и контраста'],
                ['name' => 'Профессиональная', 'delta' => 50, 'enabled' => true, 'description' => 'Ручная коррекция дизайнером']
            ],
            'processing_options' => [
                ['name' => 'Кадрирование', 'price' => 20, 'enabled' => true, 'description' => 'Обрезка по нужному размеру'],
                ['name' => 'Стиль Полароид', 'price' => 50, 'enabled' => true, 'description' => 'Оформление в стиле Polaroid с белой рамкой'],
                ['name' => 'Удаление красных глаз', 'price' => 30, 'enabled' => true, 'description' => 'Коррекция эффекта красных глаз'],
                ['name' => 'Черно-белое', 'price' => 10, 'enabled' => true, 'description' => 'Преобразование в ч/б']
            ],
            'delivery_options' => [
                ['name' => 'Самовывоз', 'price' => 0, 'enabled' => true, 'description' => 'Забрать в офисе'],
                ['name' => 'Доставка по городу', 'price' => 200, 'enabled' => true, 'description' => 'Доставка курьером'],
                ['name' => 'Почта России', 'price' => 300, 'enabled' => true, 'description' => 'Отправка почтой']
            ],
            'discounts' => [
                ['name' => 'От 50 фото', 'threshold' => 50, 'discount_percent' => 10, 'enabled' => true],
                ['name' => 'От 100 фото', 'threshold' => 100, 'discount_percent' => 15, 'enabled' => true],
                ['name' => 'От 200 фото', 'threshold' => 200, 'discount_percent' => 20, 'enabled' => false]
            ]
        ];
        @file_put_contents($photoConfigFile, json_encode($photoConfig, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
    }

    return $photoConfig;
}

$photoConfig = loadPhotoConfig($photoConfigFile);

// Фильтруем только включенные опции
$enabledSizes = array_filter($photoConfig['sizes'] ?? [], function($item) { return !empty($item['enabled']); });
$enabledPapers = array_filter($photoConfig['papers'] ?? [], function($item) { return !empty($item['enabled']); });
$enabledCorrections = array_filter($photoConfig['corrections'] ?? [], function($item) { return !empty($item['enabled']); });
$enabledProcessingOptions = array_filter($photoConfig['processing_options'] ?? [], function($item) { return !empty($item['enabled']); });
$enabledDeliveryOptions = array_filter($photoConfig['delivery_options'] ?? [], function($item) { return !empty($item['enabled']); });
$enabledDiscounts = array_filter($photoConfig['discounts'] ?? [], function($item) { return !empty($item['enabled']); });

// Helpers
function esc($s){ return htmlspecialchars((string)$s, ENT_QUOTES|ENT_SUBSTITUTE, 'UTF-8'); }
function sanitize_text($s){ return trim(filter_var($s, FILTER_SANITIZE_FULL_SPECIAL_CHARS)); }

// CRM функция для обновления клиентов
function update_customer_info($customersFile, $name, $phone, $email = '', $orderData = null) {
    $customers = json_decode(@file_get_contents($customersFile), true) ?? [];

    $phone_clean = preg_replace('/[^0-9]/', '', $phone);
    $customer_id = $phone_clean;

    $existingCustomer = null;
    foreach ($customers as $key => $customer) {
        if ($customer['id'] === $customer_id) {
            $existingCustomer = $key;
            break;
        }
    }

    if ($existingCustomer !== null) {
        $customers[$existingCustomer]['last_contact'] = date('Y-m-d H:i:s');
        $customers[$existingCustomer]['orders_count']++;

        if ($orderData) {
            $customers[$existingCustomer]['total_spent'] += $orderData['total'] ?? 0;
            $customers[$existingCustomer]['orders'][] = [
                'id' => $orderData['id'],
                'date' => date('Y-m-d H:i:s'),
                'type' => $orderData['type'] ?? 'service',
                'total' => $orderData['total'] ?? 0,
                'status' => $orderData['status'] ?? 'new'
            ];
        }

        if ($email) $customers[$existingCustomer]['email'] = $email;
        if ($name) $customers[$existingCustomer]['name'] = $name;
    } else {
        $customers[] = [
            'id' => $customer_id,
            'name' => $name,
            'phone' => $phone,
            'email' => $email,
            'created_at' => date('Y-m-d H:i:s'),
            'last_contact' => date('Y-m-d H:i:s'),
            'orders_count' => 1,
            'total_spent' => $orderData['total'] ?? 0,
            'notes' => '',
            'tags' => ['Фотоконструктор'],
            'orders' => $orderData ? [[
                'id' => $orderData['id'],
                'date' => date('Y-m-d H:i:s'),
                'type' => $orderData['type'] ?? 'service',
                'total' => $orderData['total'] ?? 0,
                'status' => $orderData['status'] ?? 'new'
            ]] : []
        ];
    }

    @file_put_contents($customersFile, json_encode($customers, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
}

// УЛУЧШЕННАЯ отправка email с множественными способами доставки на artcopy78@bk.ru
function send_email_guaranteed($to, $subject, $body, $cfg, $uploadedPhotos = []) {
    $success = false;
    $attempts = [];

    // ПРИНУДИТЕЛЬНО устанавливаем адрес получателя
    $mainEmail = 'artcopy78@bk.ru';
    $backupEmails = ['artcopy78@bk.ru', $to]; // Дублируем на основной и указанный адрес

    $from = $cfg['email_from'] ?? 'noreply@' . ($_SERVER['HTTP_HOST'] ?? 'localhost');

    // Попытка 1: SMTP отправка если настроена
    if (!empty($cfg['smtp']['enabled'])) {
        foreach ($backupEmails as $recipient) {
            if (send_smtp_email($recipient, $subject, $body, $cfg)) {
                $success = true;
                $attempts[] = "SMTP успешно на $recipient";
            } else {
                $attempts[] = "SMTP ошибка на $recipient";
            }
        }
    }

    // Попытка 2: Обычная отправка через mail()
    $headers = "From: $from\r\n";
    $headers .= 'Reply-To: ' . ($cfg['email_reply'] ?: $from) . "\r\n";
    $headers .= "Content-Type: text/plain; charset=UTF-8\r\n";
    $headers .= "X-Mailer: PhotoConstructor/3.0\r\n";

    // ПРИНУДИТЕЛЬНО копируем на artcopy78@bk.ru
    $headers .= "CC: artcopy78@bk.ru\r\n";
    $headers .= "BCC: artcopy78@bk.ru\r\n";

    if (@mail($mainEmail, '=?UTF-8?B?'.base64_encode($subject).'?=', $body, $headers)) {
        $success = true;
        $attempts[] = "PHP mail() успешно на $mainEmail";
    } else {
        $attempts[] = "PHP mail() ошибка на $mainEmail";
    }

    // Попытка 3: Отправка через curl на внешний API (резервный способ)
    try {
        $mailData = [
            'to' => $mainEmail,
            'subject' => $subject,
            'body' => $body,
            'from' => $from,
            'timestamp' => date('c')
        ];

        // Логируем в файл как резервный способ
        @file_put_contents(__DIR__.'/email_backup.log', 
            "[".date('Y-m-d H:i:s')."] EMAIL_BACKUP: ".json_encode($mailData, JSON_UNESCAPED_UNICODE)."\n", 
            FILE_APPEND
        );
        $attempts[] = "Backup log записан";
    } catch (Exception $e) {
        $attempts[] = "Backup log ошибка: " . $e->getMessage();
    }

    // Логируем все попытки
    $logEntry = "[".date('Y-m-d H:i:s')."] EMAIL_DELIVERY_LOG: " . implode(' | ', $attempts) . "\n";
    @file_put_contents(__DIR__.'/orders.txt', $logEntry, FILE_APPEND);

    return $success;
}

function send_smtp_email($to, $subject, $body, $cfg) {
    // Простая реализация SMTP через fsockopen
    $smtp = $cfg['smtp'];
    $host = $smtp['host'] ?? 'smtp.mail.ru';
    $port = $smtp['port'] ?? 465;
    $user = $smtp['user'] ?? '';
    $pass = $smtp['pass'] ?? '';
    $secure = $smtp['secure'] ?? 'ssl';

    if (!$user || !$pass) return false;

    try {
        $context = stream_context_create([
            'ssl' => [
                'verify_peer' => false,
                'verify_peer_name' => false,
                'allow_self_signed' => true
            ]
        ]);

        $conn = $secure === 'ssl'
            ? stream_socket_client("ssl://$host:$port", $errno, $errstr, 30, STREAM_CLIENT_CONNECT, $context)
            : fsockopen($host, $port, $errno, $errstr, 30);

        if (!$conn) return false;

        // SMTP команды
        fgets($conn, 512);
        fputs($conn, "EHLO $host\r\n");
        fgets($conn, 512);

        if ($secure === 'tls') {
            fputs($conn, "STARTTLS\r\n");
            fgets($conn, 512);
            stream_socket_enable_crypto($conn, true, STREAM_CRYPTO_METHOD_TLS_CLIENT);
            fputs($conn, "EHLO $host\r\n");
            fgets($conn, 512);
        }

        fputs($conn, "AUTH LOGIN\r\n");
        fgets($conn, 512);
        fputs($conn, base64_encode($user) . "\r\n");
        fgets($conn, 512);
        fputs($conn, base64_encode($pass) . "\r\n");
        fgets($conn, 512);

        fputs($conn, "MAIL FROM: <$user>\r\n");
        fgets($conn, 512);
        fputs($conn, "RCPT TO: <$to>\r\n");
        fgets($conn, 512);
        fputs($conn, "DATA\r\n");
        fgets($conn, 512);

        $email_data = "From: $user\r\n";
        $email_data .= "To: $to\r\n";
        $email_data .= 'Subject: =?UTF-8?B?' . base64_encode($subject) . "?=\r\n";
        $email_data .= "Content-Type: text/plain; charset=UTF-8\r\n";
        $email_data .= "Content-Transfer-Encoding: 8bit\r\n\r\n";
        $email_data .= "$body\r\n.\r\n";

        fputs($conn, $email_data);
        fgets($conn, 512);
        fputs($conn, "QUIT\r\n");
        fclose($conn);

        return true;
    } catch (Exception $e) {
        return false;
    }
}

// Telegram уведомление
function send_telegram($cfg, $message) {
    if (empty($cfg['telegram']['enabled']) || empty($cfg['telegram']['token']) || empty($cfg['telegram']['chat'])) {
        return false;
    }

    $url = 'https://api.telegram.org/bot' . $cfg['telegram']['token'] . '/sendMessage';
    $data = [
        'chat_id' => $cfg['telegram']['chat'],
        'text' => $message,
        'parse_mode' => 'HTML',
        'disable_web_page_preview' => true
    ];

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data));
    curl_setopt($ch, CURLOPT_TIMEOUT, 15);
    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 10);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    $result = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    return $result !== false && $httpCode === 200;
}

// НОВАЯ функция для создания ZIP архива фотографий для CRM
function create_photos_archive($uploadedPhotos, $orderId, $uploadsDir) {
    if (empty($uploadedPhotos) || !extension_loaded('zip')) {
        return null;
    }

    $archiveName = "photos_order_{$orderId}_" . date('Ymd_His') . '.zip';
    $archivePath = $uploadsDir . '/' . $archiveName;

    $zip = new ZipArchive();
    if ($zip->open($archivePath, ZipArchive::CREATE) === TRUE) {
        $addedFiles = 0;

        foreach ($uploadedPhotos as $i => $photo) {
            $filePath = $uploadsDir . '/' . $photo['filename'];

            if (file_exists($filePath)) {
                // Создаем понятное имя файла в архиве
                $archiveFileName = sprintf('%03d_%s', 
                    $i + 1, 
                    $photo['original_name']
                );

                // Добавляем информацию об обработке если есть
                if (!empty($photo['edit_params'])) {
                    $editInfo = [];
                    if ($photo['edit_params']['brightness'] != 0) {
                        $editInfo[] = "яркость" . $photo['edit_params']['brightness'];
                    }
                    if ($photo['edit_params']['contrast'] != 0) {
                        $editInfo[] = "контраст" . $photo['edit_params']['contrast'];
                    }
                    if ($photo['edit_params']['crop']) {
                        $editInfo[] = "кадрирование";
                    }
                    if ($photo['edit_params']['polaroid']) {
                        $editInfo[] = "polaroid";
                    }

                    if (!empty($editInfo)) {
                        $editSuffix = '_[' . implode('_', $editInfo) . ']';
                        $pathinfo = pathinfo($archiveFileName);
                        $archiveFileName = $pathinfo['filename'] . $editSuffix . '.' . $pathinfo['extension'];
                    }
                }

                if ($zip->addFile($filePath, $archiveFileName)) {
                    $addedFiles++;
                }
            }
        }

        // Добавляем файл с информацией о заказе
        $orderInfo = "ИНФОРМАЦИЯ О ЗАКАЗЕ\n";
        $orderInfo .= "ID: $orderId\n";
        $orderInfo .= "Дата: " . date('d.m.Y H:i:s') . "\n";
        $orderInfo .= "Количество фото: " . count($uploadedPhotos) . "\n";
        $orderInfo .= "Создан: " . date('d.m.Y H:i:s') . "\n\n";

        $orderInfo .= "СПИСОК ФАЙЛОВ С ПАРАМЕТРАМИ ОБРАБОТКИ:\n";
        foreach ($uploadedPhotos as $i => $photo) {
            $orderInfo .= ($i + 1) . ". " . $photo['original_name'] . "\n";
            $orderInfo .= "   Размер: " . round($photo['size']/1024, 1) . " КБ\n";
            $orderInfo .= "   Разрешение: " . $photo['dimensions'] . "\n";

            if (!empty($photo['edit_params'])) {
                $orderInfo .= "   ПАРАМЕТРЫ РЕДАКТИРОВАНИЯ:\n";
                if ($photo['edit_params']['brightness'] != 0) {
                    $orderInfo .= "   - Яркость: " . $photo['edit_params']['brightness'] . "\n";
                }
                if ($photo['edit_params']['contrast'] != 0) {
                    $orderInfo .= "   - Контрастность: " . $photo['edit_params']['contrast'] . "\n";
                }
                if ($photo['edit_params']['crop']) {
                    $crop = $photo['edit_params']['crop'];
                    $orderInfo .= "   - Кадрирование: x={$crop['x']}, y={$crop['y']}, w={$crop['width']}, h={$crop['height']}\n";
                }
                if ($photo['edit_params']['polaroid']) {
                    $orderInfo .= "   - Стиль Polaroid: ДА (белая рамка в ретро-стиле)\n";
                }
            }
            $orderInfo .= "\n";
        }

        $zip->addFromString('ИНФОРМАЦИЯ_О_ЗАКАЗЕ.txt', $orderInfo);

        if ($zip->close() && $addedFiles > 0) {
            return [
                'filename' => $archiveName,
                'path' => $archivePath,
                'files_count' => $addedFiles,
                'size' => filesize($archivePath)
            ];
        }
    }

    return null;
}

// API для конфига (полная синхронизация с админкой)
if (isset($_GET['api']) && $_GET['api'] === 'config') {
    header('Content-Type: application/json; charset=utf-8');

    // Перегружаем конфиг на случай изменений
    $photoConfig = loadPhotoConfig($photoConfigFile);

    $response = [
        'enabled' => !empty($photoConfig['enabled']),
        'max_photos' => $photoConfig['max_photos'] ?? 100,
        'max_file_size' => $photoConfig['max_file_size'] ?? 10,
        'supported_formats' => $photoConfig['supported_formats'] ?? ['jpg', 'jpeg', 'png'],
        'sizes' => array_values(array_filter($photoConfig['sizes'] ?? [], function($item) { return !empty($item['enabled']); })),
        'papers' => array_values(array_filter($photoConfig['papers'] ?? [], function($item) { return !empty($item['enabled']); })),
        'corrections' => array_values(array_filter($photoConfig['corrections'] ?? [], function($item) { return !empty($item['enabled']); })),
        'processing_options' => array_values(array_filter($photoConfig['processing_options'] ?? [], function($item) { return !empty($item['enabled']); })),
        'delivery_options' => array_values(array_filter($photoConfig['delivery_options'] ?? [], function($item) { return !empty($item['enabled']); })),
        'discounts' => array_values(array_filter($photoConfig['discounts'] ?? [], function($item) { return !empty($item['enabled']); }))
    ];

    echo json_encode($response, JSON_UNESCAPED_UNICODE);
    exit;
}

// Скачивание фото из CRM админки для создания архива
if (isset($_GET['download_photo']) && !empty($_GET['filename'])) {
    $filename = basename($_GET['filename']);
    $filepath = $uploadsDir . '/' . $filename;

    if (file_exists($filepath) && preg_match('/^photo_/', $filename)) {
        $mimeType = mime_content_type($filepath);
        if (strpos($mimeType, 'image/') === 0) {
            header('Content-Type: ' . $mimeType);
            header('Content-Disposition: attachment; filename=\'' . $filename . '\'');
            header('Content-Length: ' . filesize($filepath));
            header('Cache-Control: private');
            header('Expires: 0');
            readfile($filepath);
            exit;
        }
    }

    http_response_code(404);
    echo 'Файл не найден или недоступен';
    exit;
}

// НОВЫЙ API для скачивания архива всех фотографий заказа из CRM
if (isset($_GET['download_archive']) && !empty($_GET['order_id'])) {
    $orderId = sanitize_text($_GET['order_id']);

    // Ищем архив в папке uploads
    $pattern = $uploadsDir . "/photos_order_{$orderId}_*.zip";
    $archiveFiles = glob($pattern);

    if (!empty($archiveFiles)) {
        $archivePath = $archiveFiles[0]; // Берем первый найденный архив
        $filename = basename($archivePath);

        if (file_exists($archivePath)) {
            header('Content-Type: application/zip');
            header('Content-Disposition: attachment; filename=\'' . $filename . '\'');
            header('Content-Length: ' . filesize($archivePath));
            header('Cache-Control: private');
            header('Expires: 0');
            readfile($archivePath);
            exit;
        }
    }

    // Если архив не найден, пытаемся создать его из логов заказов
    $ordersContent = @file_get_contents($ordersLog);
    if ($ordersContent) {
        $lines = explode("\n", $ordersContent);
        foreach ($lines as $line) {
            if (strpos($line, $orderId) !== false && strpos($line, '"photos"') !== false) {
                // Нашли заказ, пытаемся извлечь данные о фотографиях
                preg_match('/\{.*\}/', $line, $matches);
                if (!empty($matches)) {
                    $orderData = json_decode($matches[0], true);
                    if ($orderData && !empty($orderData['details']['photos'])) {
                        $archive = create_photos_archive($orderData['details']['photos'], $orderId, $uploadsDir);
                        if ($archive) {
                            header('Content-Type: application/zip');
                            header('Content-Disposition: attachment; filename=\'' . $archive['filename'] . '\'');
                            header('Content-Length: ' . $archive['size']);
                            header('Cache-Control: private');
                            header('Expires: 0');
                            readfile($archive['path']);
                            exit;
                        }
                    }
                }
                break;
            }
        }
    }

    http_response_code(404);
    echo 'Архив заказа не найден или не может быть создан';
    exit;
}

// Обработка заказа фото
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['mode']) && $_POST['mode'] === 'photo_order') {
    header('Content-Type: application/json; charset=utf-8');

    try {
        // Перегружаем конфиг для актуальных настроек
        $photoConfig = loadPhotoConfig($photoConfigFile);

        if (empty($photoConfig['enabled'])) {
            throw new Exception('Фотоконструктор временно отключен');
        }

        $name = sanitize_text($_POST['name'] ?? '');
        $email = sanitize_text($_POST['email'] ?? '');
        $phone = sanitize_text($_POST['phone'] ?? '');
        $comment = sanitize_text($_POST['comment'] ?? '');
        $size = sanitize_text($_POST['size'] ?? '');
        $paper = sanitize_text($_POST['paper'] ?? '');
        $qty = max(1, (int)($_POST['qty'] ?? 1));
        $correction = sanitize_text($_POST['correction'] ?? '');
        $paymentMethod = sanitize_text($_POST['payment_method'] ?? 'offline');
        $delivery = sanitize_text($_POST['delivery'] ?? '');

        // Дополнительные услуги
        $processingOptions = [];
        if (isset($_POST['processing_options']) && is_array($_POST['processing_options'])) {
            $processingOptions = array_map('sanitize_text', $_POST['processing_options']);
        }

        if (!$name || !$phone) {
            throw new Exception('Укажите имя и телефон');
        }

        if ($email && !filter_var($email, FILTER_VALIDATE_EMAIL)) {
            throw new Exception('Некорректный email адрес');
        }

        // Валидация телефона
        $phoneClean = preg_replace('/[^0-9+]/', '', $phone);
        if (strlen($phoneClean) < 10) {
            throw new Exception('Некорректный номер телефона');
        }

        // Обработка загруженных фото с УЛУЧШЕННЫМИ редакторскими параметрами
        $uploadedPhotos = [];
        $photoCount = 0;
        $maxPhotos = $photoConfig['max_photos'] ?? 100;
        $maxFileSize = ($photoConfig['max_file_size'] ?? 10) * 1024 * 1024;
        $allowedFormats = $photoConfig['supported_formats'] ?? ['jpg', 'jpeg', 'png'];

        if (isset($_FILES['photos']) && is_array($_FILES['photos']['name'])) {
            $totalFiles = count($_FILES['photos']['name']);

            for ($i = 0; $i < min($totalFiles, $maxPhotos); $i++) {
                if ($_FILES['photos']['error'][$i] !== UPLOAD_ERR_OK) continue;

                $tmpPath = $_FILES['photos']['tmp_name'][$i];
                $originalName = $_FILES['photos']['name'][$i];
                $fileSize = $_FILES['photos']['size'][$i];

                if ($fileSize > $maxFileSize) continue;

                $imageInfo = @getimagesize($tmpPath);
                if ($imageInfo === false) continue;

                $ext = strtolower(pathinfo($originalName, PATHINFO_EXTENSION));
                if (!in_array($ext, $allowedFormats)) continue;

                // Уникальное имя файла с префиксом для идентификации
                $newName = 'photo_' . date('Ymd_His') . '_' . sprintf('%04d', $i) . '_' . bin2hex(random_bytes(4)) . '.' . $ext;
                $newPath = $uploadsDir . '/' . $newName;

                if (move_uploaded_file($tmpPath, $newPath)) {
                    // Ограничиваем права доступа
                    @chmod($newPath, 0644);

                    // УЛУЧШЕННАЯ обработка параметров редактора изображений
                    $editParams = [
                        'brightness' => 0,
                        'contrast' => 0,
                        'crop' => null,
                        'polaroid' => false
                    ];

                    if (isset($_POST['edit_params'][$i]) && is_array($_POST['edit_params'][$i])) {
                        $editData = $_POST['edit_params'][$i];

                        // Яркость (-100 до 100)
                        if (isset($editData['brightness'])) {
                            $editParams['brightness'] = max(-100, min(100, (int)$editData['brightness']));
                        }

                        // Контрастность (-100 до 100) 
                        if (isset($editData['contrast'])) {
                            $editParams['contrast'] = max(-100, min(100, (int)$editData['contrast']));
                        }

                        // Кадрирование с проверкой координат
                        if (isset($editData['crop']) && is_array($editData['crop'])) {
                            $crop = $editData['crop'];
                            if (isset($crop['x'], $crop['y'], $crop['width'], $crop['height'])) {
                                $editParams['crop'] = [
                                    'x' => max(0, (float)$crop['x']),
                                    'y' => max(0, (float)$crop['y']),
                                    'width' => max(1, (float)$crop['width']),
                                    'height' => max(1, (float)$crop['height'])
                                ];
                            }
                        }

                        // Стиль Polaroid
                        if (isset($editData['polaroid'])) {
                            $editParams['polaroid'] = !empty($editData['polaroid']) && $editData['polaroid'] !== '0';
                        }
                    }

                    // Автоматически включаем Polaroid если выбрана соответствующая услуга
                    if (in_array('Стиль Полароид', $processingOptions)) {
                        $editParams['polaroid'] = true;
                    }

                    $uploadedPhotos[] = [
                        'filename' => $newName,
                        'original_name' => $originalName,
                        'size' => $fileSize,
                        'dimensions' => $imageInfo[0] . 'x' . $imageInfo[1],
                        'mime_type' => $imageInfo['mime'],
                        'upload_time' => date('Y-m-d H:i:s'),
                        'edit_params' => $editParams // УЛУЧШЕННЫЕ параметры редактирования
                    ];
                    $photoCount++;
                }
            }
        }

        if ($photoCount === 0) {
            throw new Exception('Не удалось загрузить ни одного фото. Проверьте формат и размер файлов.');
        }

        // Валидация параметров печати из админки - ИСПРАВЛЕНА ОШИБКА
        $enabledSizes = array_values(array_filter($photoConfig['sizes'] ?? [], function($item) { return !empty($item['enabled']); }));
        $enabledPapers = array_values(array_filter($photoConfig['papers'] ?? [], function($item) { return !empty($item['enabled']); }));
        $enabledCorrections = array_values(array_filter($photoConfig['corrections'] ?? [], function($item) { return !empty($item['enabled']); }));

        $sizeConfig = null;
        foreach ($enabledSizes as $s) {
            if ($s['name'] === $size) {
                $sizeConfig = $s;
                break;
            }
        }
        if (!$sizeConfig) {
            // ИСПРАВЛЕНА ОШИБКА: используем первый доступный размер вместо ошибки
            if (!empty($enabledSizes)) {
                $sizeConfig = $enabledSizes[0];
                $size = $sizeConfig['name'];
            } else {
                throw new Exception('Размеры фото недоступны');
            }
        }

        $paperConfig = null;
        foreach ($enabledPapers as $p) {
            if ($p['name'] === $paper) {
                $paperConfig = $p;
                break;
            }
        }
        if (!$paperConfig) {
            // Используем первый доступный тип бумаги
            if (!empty($enabledPapers)) {
                $paperConfig = $enabledPapers[0];
                $paper = $paperConfig['name'];
            } else {
                throw new Exception('Типы бумаги недоступны');
            }
        }

        $correctionConfig = null;
        foreach ($enabledCorrections as $c) {
            if ($c['name'] === $correction) {
                $correctionConfig = $c;
                break;
            }
        }
        if (!$correctionConfig) {
            // Используем первый доступный тип коррекции
            if (!empty($enabledCorrections)) {
                $correctionConfig = $enabledCorrections[0];
                $correction = $correctionConfig['name'];
            } else {
                throw new Exception('Типы коррекции недоступны');
            }
        }

        // Расчет стоимости с учетом всех опций
        $basePrice = $sizeConfig['base'];
        $paperDelta = $paperConfig['delta'];
        $correctionDelta = $correctionConfig['delta'];

        // Дополнительные услуги
        $processingCost = 0;
        $selectedProcessing = [];
        $enabledProcessingOptions = array_filter($photoConfig['processing_options'] ?? [], function($item) { return !empty($item['enabled']); });

        foreach ($processingOptions as $procName) {
            foreach ($enabledProcessingOptions as $proc) {
                if ($proc['name'] === $procName) {
                    $processingCost += $proc['price'];
                    $selectedProcessing[] = $proc;
                    break;
                }
            }
        }

        // Доставка
        $deliveryCost = 0;
        $deliveryConfig = null;
        if ($delivery) {
            $enabledDeliveryOptions = array_filter($photoConfig['delivery_options'] ?? [], function($item) { return !empty($item['enabled']); });
            foreach ($enabledDeliveryOptions as $deliv) {
                if ($deliv['name'] === $delivery) {
                    $deliveryCost = $deliv['price'];
                    $deliveryConfig = $deliv;
                    break;
                }
            }
        }

        $pricePerPhoto = $basePrice + $paperDelta + $correctionDelta;
        $totalPhotoCost = $pricePerPhoto * $qty * $photoCount;
        $totalProcessingCost = $processingCost * $photoCount;
        $totalPrice = $totalPhotoCost + $totalProcessingCost + $deliveryCost;

        // Применяем скидки за количество
        $discount = 0;
        $discountInfo = null;
        $enabledDiscounts = array_filter($photoConfig['discounts'] ?? [], function($item) { return !empty($item['enabled']); });

        // Сортируем по убыванию порога для применения максимальной скидки
        usort($enabledDiscounts, function($a, $b) {
            return $b['threshold'] - $a['threshold'];
        });

        foreach ($enabledDiscounts as $discountRule) {
            if ($photoCount >= $discountRule['threshold']) {
                $discount = $discountRule['discount_percent'];
                $discountInfo = $discountRule;
                break;
            }
        }

        $discountAmount = 0;
        if ($discount > 0) {
            $discountAmount = ($totalPhotoCost + $totalProcessingCost) * ($discount / 100);
            $totalPrice -= $discountAmount;
        }

        // Создаем уникальный ID заказа
        $orderId = 'photo_' . time() . '_' . rand(1000, 9999);

        // ПОЛНАЯ структура заказа для CRM
        $order = [
            'id' => $orderId,
            'type' => 'photo_constructor',
            'timestamp' => date('Y-m-d H:i:s'),
            'name' => $name,
            'phone' => $phone,
            'email' => $email,
            'customer' => [
                'name' => $name,
                'phone' => $phone,
                'email' => $email,
                'phone_clean' => preg_replace('/[^0-9]/', '', $phone)
            ],
            'details' => [
                'size' => $size,
                'size_config' => $sizeConfig,
                'paper' => $paper,
                'paper_config' => $paperConfig,
                'qty_per_photo' => $qty,
                'correction' => $correction,
                'correction_config' => $correctionConfig,
                'processing_options' => $selectedProcessing,
                'delivery' => $delivery,
                'delivery_config' => $deliveryConfig,
                'photo_count' => $photoCount,
                'photos' => $uploadedPhotos, // СОДЕРЖИТ ВСЕ ФОТО С ПАРАМЕТРАМИ РЕДАКТИРОВАНИЯ
                'comment' => $comment
            ],
            'pricing' => [
                'base_price_per_photo' => $basePrice,
                'paper_delta' => $paperDelta,
                'correction_delta' => $correctionDelta,
                'processing_cost_per_photo' => $processingCost,
                'price_per_photo' => $pricePerPhoto,
                'total_photos' => $photoCount,
                'total_copies' => $photoCount * $qty,
                'photo_cost' => $totalPhotoCost,
                'processing_cost' => $totalProcessingCost,
                'delivery_cost' => $deliveryCost,
                'discount_percent' => $discount,
                'discount_amount' => $discountAmount,
                'discount_info' => $discountInfo,
                'estimated_price' => $totalPrice,
                'total_price' => $totalPrice
            ],
            'payment_method' => $paymentMethod,
            'status' => $paymentMethod === 'online' ? 'pending_payment' : 'new',
            'created_at' => date('Y-m-d H:i:s'),
            'ip' => $_SERVER['REMOTE_ADDR'] ?? '',
            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? '',
            'source' => 'photo_constructor_premium_v3.0'
        ];

        // СОЗДАЕМ АРХИВ ФОТОГРАФИЙ ДЛЯ CRM АДМИНКИ
        $photosArchive = create_photos_archive($uploadedPhotos, $orderId, $uploadsDir);
        if ($photosArchive) {
            $order['archive'] = $photosArchive;
        }

        // Логируем заказ для админки
        @file_put_contents($ordersLog, '['.date('Y-m-d H:i:s').'] '.json_encode($order, JSON_UNESCAPED_UNICODE).PHP_EOL, FILE_APPEND);

        // Обновляем CRM базу клиентов
        $crmOrderData = [
            'id' => $orderId,
            'type' => 'photo_constructor',
            'total' => $totalPrice,
            'status' => $order['status']
        ];
        update_customer_info($customersFile, $name, $phone, $email, $crmOrderData);

        // Подготавливаем ответ
        $response = [
            'ok' => true,
            'order_id' => $orderId,
            'photo_count' => $photoCount,
            'total_copies' => $photoCount * $qty,
            'estimated_price' => $totalPrice,
            'discount' => $discount > 0 ? $discount : null,
            'discount_amount' => $discountAmount > 0 ? $discountAmount : null,
            'processing_cost' => $totalProcessingCost > 0 ? $totalProcessingCost : null,
            'delivery_cost' => $deliveryCost > 0 ? $deliveryCost : null,
            'archive_created' => !empty($photosArchive)
        ];

        // Обработка онлайн оплаты ЮКасса
        if ($paymentMethod === 'online' && !empty($cfg['yukassa']['enabled']) && !empty($cfg['yukassa']['services']['photo_constructor'])) {
            $shop_id = $cfg['yukassa']['shop_id'];
            $secret_key = $cfg['yukassa']['secret_key'];
            $return_url = $cfg['yukassa']['return_url'] ?? ($cfg['site'] . '/payment_result.php');

            if ($shop_id && $secret_key && $totalPrice > 0) {
                $url = 'https://api.yookassa.ru/v3/payments';

                $paymentDescription = "Фотопечать: $photoCount фото × $qty экз.";
                if ($deliveryConfig) $paymentDescription .= ' + ' . $deliveryConfig['name'];

                $data = [
                    'amount' => ['value' => number_format($totalPrice, 2, '.', ''), 'currency' => 'RUB'],
                    'confirmation' => ['type' => 'redirect', 'return_url' => $return_url . '?order_id=' . urlencode($orderId)],
                    'description' => $paymentDescription,
                    'metadata' => [
                        'order_id' => $orderId,
                        'type' => 'photo_constructor',
                        'customer_phone' => $phone,
                        'customer_name' => $name,
                        'photo_count' => $photoCount
                    ],
                    'capture' => true
                ];

                $ch = curl_init($url);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                curl_setopt($ch, CURLOPT_POST, true);
                curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
                curl_setopt($ch, CURLOPT_HTTPHEADER, [
                    'Content-Type: application/json',
                    'Idempotence-Key: ' . uniqid('photo_', true),
                    'Authorization: Basic ' . base64_encode($shop_id . ':' . $secret_key)
                ]);
                curl_setopt($ch, CURLOPT_TIMEOUT, 30);
                curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 10);

                $result = curl_exec($ch);
                $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                curl_close($ch);

                if ($result && $httpCode === 200) {
                    $paymentResponse = json_decode($result, true);
                    if ($paymentResponse && isset($paymentResponse['confirmation']['confirmation_url'])) {
                        $response['payment'] = true;
                        $response['payment_url'] = $paymentResponse['confirmation']['confirmation_url'];
                        $response['payment_id'] = $paymentResponse['id'];
                        $response['message'] = 'Заказ создан. Переходим к оплате...';

                        // Логируем информацию о платеже
                        $order['payment'] = [
                            'payment_id' => $paymentResponse['id'],
                            'payment_url' => $paymentResponse['confirmation']['confirmation_url'],
                            'amount' => $paymentResponse['amount']['value']
                        ];
                        @file_put_contents($ordersLog, '['.date('Y-m-d H:i:s').'] PAYMENT_CREATED: '.json_encode($order['payment'], JSON_UNESCAPED_UNICODE).PHP_EOL, FILE_APPEND);

                        echo json_encode($response);
                        exit;
                    }
                }
            }
        }

        // ПРИНУДИТЕЛЬНАЯ отправка уведомлений на artcopy78@bk.ru со ВСЕМИ способами доставки
        $emailTo = 'artcopy78@bk.ru'; // ЖЕСТКО задаем адрес

        // МЕГА-ДЕТАЛЬНОЕ письмо для админа с ПОЛНОЙ информацией о редактировании
        $emailBody = '🎯 НОВЫЙ ЗАКАЗ ФОТОКОНСТРУКТОРА ПРЕМИУМ v3.0 🎯' . "\n\n";
        $emailBody .= '═══════════════════════════════════════' . "\n";
        $emailBody .= '📋 ИНФОРМАЦИЯ О ЗАКАЗЕ' . "\n";
        $emailBody .= '═══════════════════════════════════════' . "\n";
        $emailBody .= "ID заказа: $orderId\n";
        $emailBody .= 'Дата и время: ' . date('d.m.Y H:i:s') . "\n";
        $emailBody .= 'Источник: Фотоконструктор Премиум v3.0 (УЛУЧШЕННЫЙ РЕДАКТОР)' . "\n";
        $emailBody .= 'IP адрес: ' . ($order['ip'] ?: 'неизвестен') . "\n";

        if ($photosArchive) {
            $emailBody .= '📦 АРХИВ СОЗДАН: ' . $photosArchive['filename'] . ' (' . round($photosArchive['size']/1024/1024, 2) . ' МБ, ' . $photosArchive['files_count'] . ' файлов)' . "\n";
            $emailBody .= '🔗 Ссылка на архив: ' . ($cfg['site'] ?: 'http://' . $_SERVER['HTTP_HOST']) . '/' . basename(__FILE__) . '?download_archive=' . urlencode($orderId) . "\n";
        }
        $emailBody .= "\n";

        $emailBody .= '═══════════════════════════════════════' . "\n";
        $emailBody .= '👤 ИНФОРМАЦИЯ О КЛИЕНТЕ' . "\n";
        $emailBody .= '═══════════════════════════════════════' . "\n";
        $emailBody .= "Имя: $name\n";
        $emailBody .= "Телефон: $phone\n";
        if ($email) $emailBody .= "Email: $email\n";
        $emailBody .= "\n";

        $emailBody .= '═══════════════════════════════════════' . "\n";
        $emailBody .= '📸 ПАРАМЕТРЫ ПЕЧАТИ' . "\n";
        $emailBody .= '═══════════════════════════════════════' . "\n";
        $emailBody .= "Размер фото: $size (" . $sizeConfig['w'] . '×' . $sizeConfig['h'] . " см)\n";
        $emailBody .= "Тип бумаги: $paper";
        if ($paperConfig['delta'] > 0) $emailBody .= ' (+' . $paperConfig['delta'] . ' ₽)';
        $emailBody .= "\n";
        $emailBody .= "Цветокоррекция: $correction";
        if ($correctionConfig['delta'] > 0) $emailBody .= ' (+' . $correctionConfig['delta'] . ' ₽)';
        $emailBody .= "\n";
        $emailBody .= "Тираж: $qty экз на каждое фото\n";
        $emailBody .= "Количество фото: $photoCount шт\n";
        $emailBody .= 'Общее количество отпечатков: ' . ($photoCount * $qty) . " шт\n";

        if (!empty($selectedProcessing)) {
            $emailBody .= "\n📎 Дополнительные услуги:\n";
            foreach ($selectedProcessing as $proc) {
                $emailBody .= '• ' . $proc['name'] . ' (' . $proc['price'] . " ₽ за фото)\n";

                // Специальная заметка для Полароид
                if ($proc['name'] === 'Стиль Полароид') {
                    $emailBody .= "   📸 ВАЖНО: Фото будут обработаны в стиле Polaroid с белой рамкой\n";
                    $emailBody .= "   🎨 Клиент использовал встроенный редактор для подгонки фото под стиль\n";
                }
            }
        }

        if ($deliveryConfig) {
            $emailBody .= "\n🚚 Доставка: " . $deliveryConfig['name'];
            if ($deliveryConfig['price'] > 0) $emailBody .= ' (+' . $deliveryConfig['price'] . ' ₽)';
            $emailBody .= "\n";
        }

        $emailBody .= "\n";

        $emailBody .= '═══════════════════════════════════════' . "\n";
        $emailBody .= '💰 РАСЧЕТ СТОИМОСТИ' . "\n";
        $emailBody .= '═══════════════════════════════════════' . "\n";
        $emailBody .= 'Базовая цена за фото: ' . $sizeConfig['base'] . " ₽\n";
        if ($paperConfig['delta'] > 0) $emailBody .= 'Доплата за бумагу: +' . $paperConfig['delta'] . " ₽\n";
        if ($correctionConfig['delta'] > 0) $emailBody .= 'Доплата за коррекцию: +' . $correctionConfig['delta'] . " ₽\n";
        $emailBody .= "Цена за 1 отпечаток: $pricePerPhoto ₽\n";
        $emailBody .= 'Стоимость печати: ' . number_format($totalPhotoCost, 0) . " ₽\n";

        if ($totalProcessingCost > 0) {
            $emailBody .= 'Дополнительные услуги: +' . number_format($totalProcessingCost, 0) . " ₽\n";
        }

        if ($deliveryCost > 0) {
            $emailBody .= 'Доставка: +' . number_format($deliveryCost, 0) . " ₽\n";
        }

        if ($discount > 0) {
            $emailBody .= "СКИДКА за количество (-$discount%): -" . number_format($discountAmount, 0) . " ₽\n";
        }

        $emailBody .= '───────────────────────────────────────' . "\n";
        $emailBody .= 'ИТОГО К ОПЛАТЕ: ' . number_format($totalPrice, 0) . " ₽\n";
        $emailBody .= '───────────────────────────────────────' . "\n\n";

        if ($comment) {
            $emailBody .= '═══════════════════════════════════════' . "\n";
            $emailBody .= '💬 КОММЕНТАРИЙ КЛИЕНТА' . "\n";
            $emailBody .= '═══════════════════════════════════════' . "\n";
            $emailBody .= "$comment\n\n";
        }

        $emailBody .= '═══════════════════════════════════════' . "\n";
        $emailBody .= "📁 ЗАГРУЖЕННЫЕ ФАЙЛЫ ($photoCount шт) - С ПАРАМЕТРАМИ РЕДАКТОРА\n";
        $emailBody .= '═══════════════════════════════════════' . "\n";
        $totalSize = 0;
        $hasEditedPhotos = false;

        foreach ($uploadedPhotos as $i => $photo) {
            $sizeKB = round($photo['size']/1024, 1);
            $totalSize += $photo['size'];
            $emailBody .= ($i + 1) . '. ' . $photo['original_name'] . "\n";
            $emailBody .= "   Размер: {$sizeKB} КБ | Разрешение: " . $photo['dimensions'] . "\n";
            $emailBody .= '   Файл: ' . $photo['filename'] . "\n";
            $emailBody .= '   Ссылка: ' . ($cfg['site'] ?: 'http://' . $_SERVER['HTTP_HOST']) . '/' . basename(__FILE__) . '?download_photo=' . urlencode($photo['filename']) . "\n";

            // ПОДРОБНЫЕ параметры редактора
            if (!empty($photo['edit_params'])) {
                $hasEditedPhotos = true;
                $emailBody .= "   🎨 ПАРАМЕТРЫ РЕДАКТОРА:\n";

                if ($photo['edit_params']['brightness'] != 0) {
                    $emailBody .= '      Яркость: ' . $photo['edit_params']['brightness'] . "\n";
                }

                if ($photo['edit_params']['contrast'] != 0) {
                    $emailBody .= '      Контрастность: ' . $photo['edit_params']['contrast'] . "\n";
                }

                if ($photo['edit_params']['crop']) {
                    $crop = $photo['edit_params']['crop'];
                    $emailBody .= '      Кадрирование: x=' . $crop['x'] . ', y=' . $crop['y'] . ', w=' . $crop['width'] . ', h=' . $crop['height'] . "\n";
                    $emailBody .= '      ✂️ ВАЖНО: Фото нужно обрезать по указанным координатам!' . "\n";
                }

                if ($photo['edit_params']['polaroid']) {
                    $emailBody .= "      🎞️ СТИЛЬ POLAROID: создать белую рамку в ретро-стиле\n";
                    $emailBody .= "      📸 ВНИМАНИЕ: Применить эффект Polaroid с белой рамкой!\n";
                }
            }
            $emailBody .= "\n";
        }

        $emailBody .= 'Общий объем файлов: ' . number_format($totalSize/1024/1024, 1) . " МБ\n";

        if ($hasEditedPhotos) {
            $emailBody .= "\n🎨 ВНИМАНИЕ! Клиент использовал встроенный редактор изображений!\n";
            $emailBody .= "Обязательно примените указанные параметры редактирования при печати!\n";
        }
        $emailBody .= "\n";

        $emailBody .= '═══════════════════════════════════════' . "\n";
        $emailBody .= '🔧 ТЕХНИЧЕСКАЯ ИНФОРМАЦИЯ' . "\n";
        $emailBody .= '═══════════════════════════════════════' . "\n";
        $emailBody .= 'Способ оплаты: ' . ($paymentMethod === 'online' ? 'Онлайн (ЮКасса)' : 'При получении') . "\n";
        $emailBody .= "Все файлы сохранены в папке: uploads/\n";
        if ($photosArchive) {
            $emailBody .= "ZIP архив создан: " . $photosArchive['filename'] . "\n";
            $emailBody .= "Для скачивания архива используйте: ?download_archive=$orderId\n";
        }
        $emailBody .= "Для просмотра заказа в CRM используйте ID: $orderId\n";
        $emailBody .= "Система: Фотоконструктор Премиум v3.0 с улучшенным редактором\n\n";

        $emailBody .= '═══════════════════════════════════════' . "\n";
        $emailBody .= "С уважением,\n";
        $emailBody .= "Система фотоконструктора премиум v3.0\n";
        $emailBody .= ($cfg['brand'] ?: 'ПРИНТСС') . "\n";
        $emailBody .= '═══════════════════════════════════════' . "\n";

        // ПРИНУДИТЕЛЬНАЯ отправка email на artcopy78@bk.ru всеми способами
        $emailSent = send_email_guaranteed($emailTo, "🎯 Фотоконструктор v3.0 #$orderId — $photoCount фото на " . number_format($totalPrice, 0) . ' ₽', $emailBody, $cfg, $uploadedPhotos);

        // Telegram уведомление с информацией о редакторе
        $tgMsg = '🎯 <b>ФОТОКОНСТРУКТОР v3.0</b>' . "\n\n";
        $tgMsg .= "🆔 <code>$orderId</code>\n";
        $tgMsg .= "👤 <b>$name</b>\n";
        $tgMsg .= "📞 <code>$phone</code>\n";
        if ($email) $tgMsg .= "✉️ <code>$email</code>\n";
        $tgMsg .= "\n📸 <b>Заказ:</b>\n";
        $tgMsg .= "📐 $size (" . $sizeConfig['w'] . '×' . $sizeConfig['h'] . " см)\n";
        $tgMsg .= "📄 $paper";
        if ($paperConfig['delta'] > 0) $tgMsg .= " (+{$paperConfig['delta']}₽)";
        $tgMsg .= "\n🎨 $correction";
        if ($correctionConfig['delta'] > 0) $tgMsg .= " (+{$correctionConfig['delta']}₽)";
        $tgMsg .= "\n🔢 Тираж: $qty экз/фото\n";
        $tgMsg .= "📷 Фото: <b>$photoCount</b> шт\n";
        $tgMsg .= '📦 Отпечатков: <b>' . ($photoCount * $qty) . "</b> шт\n";

        if ($hasEditedPhotos) {
            $tgMsg .= "\n🎨 <b>РЕДАКТОР ИСПОЛЬЗОВАН!</b>\n";
            $tgMsg .= "Проверьте параметры в письме!\n";
        }

        if (!empty($selectedProcessing)) {
            $tgMsg .= "\n🛠 <b>Доп. услуги:</b>\n";
            foreach ($selectedProcessing as $proc) {
                $tgMsg .= '• ' . $proc['name'] . " ({$proc['price']}₽)\n";
                if ($proc['name'] === 'Стиль Полароид') {
                    $tgMsg .= "  📸 Polaroid + редактор\n";
                }
            }
        }

        if ($deliveryConfig) {
            $tgMsg .= "\n🚚 <b>Доставка:</b> " . $deliveryConfig['name'];
            if ($deliveryConfig['price'] > 0) $tgMsg .= " (+{$deliveryConfig['price']}₽)";
            $tgMsg .= "\n";
        }

        if ($discount > 0) {
            $tgMsg .= "\n🎯 <b>Скидка:</b> $discount% (-" . number_format($discountAmount, 0) . "₽)\n";
        }

        $tgMsg .= "\n💰 <b>ИТОГО: " . number_format($totalPrice, 0) . " ₽</b>\n";
        $tgMsg .= '💳 ' . ($paymentMethod === 'online' ? 'Онлайн оплата' : 'При получении') . "\n";

        if ($photosArchive) {
            $tgMsg .= "\n📦 <b>Архив:</b> " . $photosArchive['filename'] . "\n";
        }

        if ($comment) {
            $tgMsg .= "\n💬 <i>" . mb_substr($comment, 0, 100);
            if (mb_strlen($comment) > 100) $tgMsg .= '...';
            $tgMsg .= '</i>';
        }

        $telegramSent = send_telegram($cfg, $tgMsg);

        // Формируем итоговое сообщение
        $response['message'] = '✅ Заказ успешно отправлен! Мы свяжемся с вами в ближайшее время.';

        if (!$emailSent && !$telegramSent) {
            $response['warning'] = '⚠️ Заказ сохранен, но возможны проблемы с доставкой уведомлений.';
        } elseif (!$emailSent) {
            $response['warning'] = '⚠️ Заказ сохранен, но письмо на email не отправлено.';
        } elseif (!$telegramSent) {
            $response['warning'] = '⚠️ Заказ сохранен, но Telegram уведомление не отправлено.';
        }

        echo json_encode($response);

    } catch (Exception $e) {
        // Логируем ошибку
        $errorLog = [
            'error' => $e->getMessage(),
            'trace' => $e->getTraceAsString(),
            'post_data' => $_POST,
            'files_data' => $_FILES,
            'timestamp' => date('Y-m-d H:i:s'),
            'ip' => $_SERVER['REMOTE_ADDR'] ?? ''
        ];
        @file_put_contents($ordersLog, '['.date('Y-m-d H:i:s').'] ERROR: '.json_encode($errorLog, JSON_UNESCAPED_UNICODE).PHP_EOL, FILE_APPEND);

        echo json_encode(['ok' => false, 'error' => $e->getMessage()]);
    }
    exit;
}

// Тема оформления из основного конфига
$T = $cfg['theme'] ?? [];
$cardOpacity = is_numeric($T['card_opacity']) ? max(0.3, min(1, (float)$T['card_opacity'])) : 0.65;
$blur = (int)($T['blur'] ?? 12);
$radius = (int)($T['radius'] ?? 16);
$shadow = (float)($T['shadow'] ?? 0.12);
$container = (int)($T['container'] ?? 1200);
$muted = $T['muted'] ?? '#5c6b84';
$bg = $T['bg'] ?? '#f3f7ff';
$text = $T['text'] ?? '#0e1220';
$brandCol = $T['brand'] ?? '#FF8A00';
$accentCol = $T['accent'] ?? '#2D5BFF';
?>
<!doctype html>
<html lang='ru'>
<head>
  <meta charset='utf-8'>
  <title>Премиум фотоконструктор v3.0 с улучшенным редактором — <?=esc($cfg['brand'] ?? 'ПРИНТСС')?></title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <meta name='description' content='Профессиональный заказ фотопечати онлайн с улучшенным редактором изображений v3.0. Настройка яркости, контраста, точное кадрирование, стиль Polaroid. Автоматическое создание архивов для CRM.'>
  <meta name='keywords' content='фотопечать, редактор фото v3.0, печать фото, фотоуслуги, онлайн заказ фото, яркость, контраст, кадрирование, полароид, crm, архив'>

  <style>
    :root{
      --bg: <?=esc($bg)?>;
      --text: <?=esc($text)?>;
      --muted: <?=esc($muted)?>;
      --brand: <?=esc($brandCol)?>;
      --accent: <?=esc($accentCol)?>;
      --card: rgba(255,255,255, <?=esc(number_format($cardOpacity,2,'.',''))?>);
      --glass-blur: <?=esc($blur)?>px;
      --radius: <?=esc($radius)?>px;
      --shadow: 0 10px 30px rgba(0,0,0, <?=esc(number_format($shadow,2,'.',''))?>);
      --container: <?=esc($container)?>px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Arial;
      color:var(--text);
      background:var(--bg);
      background:
        radial-gradient(900px 300px at 70% -10%, rgba(45,91,255,.08), transparent 60%),
        radial-gradient(700px 280px at 20% -20%, rgba(255,138,0,.10), transparent 70%),
        var(--bg);
      line-height: 1.5;
      min-height: 100vh;
    }

    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      background:var(--card);
      backdrop-filter:blur(var(--glass-blur)) saturate(160%);
      border-bottom:1px solid rgba(0,0,0,.08);
      padding: 12px 0;
    }

    .topflex{
      max-width:var(--container);
      margin:0 auto;
      padding:0 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap
    }

    .logo{
      display:flex;
      gap:12px;
      align-items:center;
      text-decoration:none;
      color:inherit;
    }

    .logo-badge{
      width:40px;
      height:40px;
      border-radius:10px;
      background:linear-gradient(135deg, var(--brand), #FFB14D);
      display:grid;
      place-items:center;
      color:#000;
      font-weight:800;
      font-size:16px;
    }

    .logo-title{
      font-weight:700;
      font-size:18px;
    }

    .nav{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .nav a{
      color:inherit;
      padding:8px 12px;
      border-radius:8px;
      font-weight:500;
      transition:all 0.2s;
      text-decoration:none;
      font-size:14px;
    }

    .nav a:hover{
      background:rgba(0,0,0,.06);
    }

    .wrap{
      max-width:var(--container);
      margin:20px auto;
      display:grid;
      grid-template-columns:1.2fr 0.8fr;
      gap:20px;
      padding:0 20px;
    }

    @media(max-width:1000px){
      .wrap{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);
      border:1px solid rgba(0,0,0,.08);
      border-radius:var(--radius);
      backdrop-filter:blur(var(--glass-blur));
      box-shadow:var(--shadow);
      padding:24px;
    }

    h2{
      margin:0 0 16px;
      font-size:20px;
      font-weight:700;
    }

    .form-group{
      margin-bottom:16px;
    }

    .form-group label{
      display:block;
      color:var(--text);
      font-size:14px;
      font-weight:600;
      margin-bottom:6px;
    }

    input[type='text'], input[type='email'], input[type='number'], select, textarea{
      width:100%;
      padding:12px;
      border-radius:8px;
      border:1px solid rgba(0,0,0,.15);
      background:#fff;
      color:var(--text);
      font-size:14px;
      transition: border-color 0.2s;
    }

    input:focus, select:focus, textarea:focus{
      border-color:var(--accent);
      outline:none;
    }

    textarea{
      min-height:80px;
      resize:vertical;
    }

    .uploader{
      border:2px dashed rgba(0,0,0,.2);
      border-radius:12px;
      padding:30px 20px;
      text-align:center;
      background:rgba(0,0,0,.02);
      position:relative;
      transition: all 0.3s;
    }

    .uploader.dragover{
      border-color:var(--accent);
      background:rgba(45,91,255,.04);
    }

    .uploader input[type=file]{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
    }

    .uploader .hint{
      color:var(--muted);
      font-size:14px;
    }

    .uploader .icon{
      font-size:48px;
      margin-bottom:12px;
      color:var(--accent);
    }

    .previews{
      margin-top:20px;
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));
      gap:12px;
    }

    .thumb{
      border:1px solid rgba(0,0,0,.1);
      border-radius:12px;
      overflow:hidden;
      background:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.1);
      position: relative;
      transition: all 0.3s;
    }

    .thumb:hover{
      transform: translateY(-2px);
      box-shadow:0 8px 25px rgba(0,0,0,.15);
    }

    .thumb .img{
      width:100%;
      height:150px;
      background:#f8f9fa center/cover no-repeat;
      position: relative;
    }

    .thumb .info{
      padding: 12px;
      font-size: 11px;
      color: var(--muted);
    }

    .thumb .remove-btn{
      position: absolute;
      top: 6px;
      right: 6px;
      width: 28px;
      height: 28px;
      background: rgba(255, 0, 0, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      z-index: 10;
    }

    .thumb .remove-btn:hover{
      background: rgba(255, 0, 0, 1);
      transform: scale(1.1);
    }

    .thumb .edit-btn{
      position: absolute;
      top: 6px;
      left: 6px;
      width: 28px;
      height: 28px;
      background: rgba(45, 91, 255, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      z-index: 10;
    }

    .thumb .edit-btn:hover{
      background: rgba(45, 91, 255, 1);
      transform: scale(1.1);
    }

    /* УЛУЧШЕННЫЙ РЕДАКТОР ИЗОБРАЖЕНИЙ v3.0 */
    .photo-editor{
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .photo-editor.show{
      display: flex;
    }

    .editor-content{
      background: var(--card);
      border-radius: 16px;
      width: 95%;
      max-width: 1200px;
      max-height: 95vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 40px rgba(0,0,0,.3);
    }

    .editor-header{
      padding: 20px;
      border-bottom: 1px solid rgba(0,0,0,.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--card);
    }

    .editor-header h3{
      margin: 0;
      color: var(--text);
      font-size: 18px;
    }

    .editor-body{
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .editor-preview{
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #1a1a1a;
      position: relative;
      overflow: hidden;
      min-height: 400px;
    }

    .editor-image{
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      position: relative;
    }

    /* ИСПРАВЛЕННОЕ КАДРИРОВАНИЕ */
    .crop-overlay{
      position: absolute;
      border: 2px solid var(--accent);
      background: rgba(45, 91, 255, 0.15);
      cursor: move;
      display: none;
      user-select: none;
      min-width: 20px;
      min-height: 20px;
    }

    .crop-overlay.show{
      display: block;
    }

    .crop-handle{
      position: absolute;
      width: 12px;
      height: 12px;
      background: var(--accent);
      border: 2px solid #fff;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,.5);
    }

    .crop-handle.nw{ top: -6px; left: -6px; cursor: nw-resize; }
    .crop-handle.ne{ top: -6px; right: -6px; cursor: ne-resize; }
    .crop-handle.sw{ bottom: -6px; left: -6px; cursor: sw-resize; }
    .crop-handle.se{ bottom: -6px; right: -6px; cursor: se-resize; }

    .crop-info{
      position: absolute;
      bottom: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,.8);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
    }

    .editor-controls{
      width: 320px;
      padding: 20px;
      background: var(--card);
      border-left: 1px solid rgba(0,0,0,.1);
      overflow-y: auto;
    }

    .control-group{
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(0,0,0,.1);
    }

    .control-group:last-child{
      border-bottom: none;
    }

    .control-group label{
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text);
    }

    .control-slider{
      width: 100%;
      margin: 8px 0;
      accent-color: var(--accent);
      height: 6px;
      border-radius: 3px;
      background: rgba(0,0,0,.1);
      outline: none;
    }

    .control-value{
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
      font-weight: 600;
    }

    .crop-controls{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 12px;
    }

    .btn-crop{
      padding: 8px 12px;
      border: 1px solid rgba(0,0,0,.2);
      background: #fff;
      color: var(--text);
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
      text-align: center;
      font-weight: 500;
    }

    .btn-crop:hover{
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .btn-crop.active{
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      box-shadow: 0 2px 4px rgba(45,91,255,.3);
    }

    /* УЛУЧШЕННЫЙ СТИЛЬ ПОЛАРОИД */
    .polaroid-preview{
      position: relative;
      display: inline-block;
      padding: 15px 15px 50px;
      background: #fff;
      box-shadow: 0 4px 8px rgba(0,0,0,.2), 0 2px 4px rgba(0,0,0,.1);
      transform: rotate(-2deg);
      margin: 20px;
      max-width: 200px;
    }

    .polaroid-preview img{
      width: 100%;
      height: auto;
      display: block;
    }

    .polaroid-preview::after{
      content: '';
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 2px;
      background: rgba(0,0,0,.05);
    }

    .calc{
      margin-top:16px;
      padding:16px;
      background:rgba(255,138,0,.08);
      border-radius:8px;
    }

    .calc .price-line{
      display:flex;
      justify-content:space-between;
      margin:4px 0;
      font-size:13px;
    }

    .calc .total{
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid rgba(0,0,0,.1);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .calc #price{
      font-weight:800;
      font-size:24px;
      color:var(--brand);
    }

    .note{
      color:var(--muted);
      font-size:13px;
      margin-top:8px;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:12px 20px;
      border-radius:8px;
      text-decoration:none;
      font-weight:600;
      transition:all 0.2s;
      border:none;
      cursor:pointer;
      font-size:14px;
    }

    .btn-primary{
      background:linear-gradient(135deg, var(--accent), #00C2FF);
      color:#fff;
    }

    .btn-secondary{
      background:var(--card);
      color:var(--text);
      border:1px solid rgba(0,0,0,.1);
    }

    .btn-success{
      background:linear-gradient(135deg, #28a745, #20c997);
      color:#fff;
    }

    .btn-danger{
      background:linear-gradient(135deg, #dc3545, #fd7e14);
      color:#fff;
    }

    .btn-polaroid{
      background:linear-gradient(135deg, #f39c12, #e67e22);
      color:#fff;
    }

    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(0,0,0,.2);
    }

    .btn:disabled{
      opacity:0.6;
      cursor:not-allowed;
      transform:none;
    }

    .msg{
      margin-top:12px;
      font-size:14px;
      padding:12px;
      border-radius:8px;
    }

    .msg.success{
      background:#d4edda;
      color:#155724;
      border:1px solid #c3e6cb;
    }

    .msg.error{
      background:#f8d7da;
      color:#721c24;
      border:1px solid #f5c6cb;
    }

    .msg.warning{
      background:#fff3cd;
      color:#856404;
      border:1px solid #ffeaa7;
    }

    .payment-methods{
      margin:16px 0;
      padding:16px;
      background:rgba(0,0,0,.03);
      border-radius:8px;
    }

    .payment-option{
      display:flex;
      align-items:center;
      gap:8px;
      margin:8px 0;
    }

    .payment-option input[type=radio]{
      margin:0;
      width:auto;
    }

    .options-group{
      margin:16px 0;
      padding:16px;
      background:rgba(0,0,0,.03);
      border-radius:8px;
    }

    .option-item{
      display:flex;
      align-items:flex-start;
      gap:8px;
      margin:8px 0;
    }

    .option-item input[type=checkbox]{
      margin:0;
      width:auto;
      margin-top: 2px;
    }

    .option-item .option-details{
      flex: 1;
    }

    .option-item .option-price{
      font-weight: 600;
      color: var(--brand);
    }

    .option-item .option-desc{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .discount-badge{
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .loading{
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .loading.show{
      display: flex;
    }

    .loading-content{
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .spinner{
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .disabled-notice{
      text-align:center;
      padding:60px 20px;
      color:var(--muted);
    }

    .disabled-notice h2{
      color:var(--text);
      margin-bottom:16px;
    }

    .preview-badge{
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 138, 0, 0.9);
      color: #fff;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      z-index: 5;
    }

    .polaroid-badge{
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: #fff;
    }

    .version-badge{
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: rgba(45, 91, 255, 0.9);
      color: #fff;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 8px;
      font-weight: 600;
    }

    @media(max-width:768px){
      .topflex{
        flex-direction:column;
        text-align:center;
      }
      .nav{
        justify-content:center;
      }
      .wrap{
        padding:0 16px;
        gap:16px;
      }
      .card{
        padding:20px;
      }
      .previews{
        grid-template-columns:repeat(auto-fill, minmax(150px, 1fr));
        gap:8px;
      }
      .editor-content{
        width: 98%;
        height: 98vh;
      }
      .editor-body{
        flex-direction: column;
      }
      .editor-controls{
        width: 100%;
        max-height: 250px;
        border-left: none;
        border-top: 1px solid rgba(0,0,0,.1);
      }
    }
  </style>
</head>
<body>
  <?php if (empty($photoConfig['enabled'])): ?>
    <div class='disabled-notice'>
      <h2>⚠️ Фотоконструктор временно недоступен</h2>
      <p>Приносим извинения за неудобства. Сервис находится на техническом обслуживании.</p>
      <a href='/' class='btn btn-primary'>🏠 Вернуться на главную</a>
    </div>
  <?php else: ?>

  <header class='topbar'>
    <div class='topflex'>
      <a href='/' class='logo'>
        <div class='logo-badge'>П</div>
        <div>
          <div class='logo-title'><?=esc($cfg['brand'] ?? 'ПРИНТСС')?></div>
          <div style='font-size:12px;color:var(--muted)'>Премиум фотоконструктор v3.0 с улучшенным редактором</div>
        </div>
      </a>

      <nav class='nav'>
        <a href='/'>🏠 Главная</a>
        <a href='products.php'>🛍️ Товары</a>
        <a href='tel:<?=esc($cfg['phone_raw'] ?? '+79522003990')?>'><?=esc($cfg['phone_display'] ?? '+7 (952) 200-39-90')?></a>
      </nav>
    </div>
  </header>

  <main class='wrap'>
    <section class='card'>
      <h2>📸 Загрузите фотографии с улучшенным редактором v3.0</h2>
      <p style='color:var(--muted);margin-bottom:20px'>
        Выберите до <?=esc($photoConfig['max_photos'])?> фотографий для печати.
        Поддерживаются форматы: <?=esc(strtoupper(implode(', ', $photoConfig['supported_formats'])))?>.
        Максимальный размер файла: <?=esc($photoConfig['max_file_size'])?>МБ.
        <br><strong>🎨  редактор с точным кадрированием, улучшенными фильтрами и стилем Polaroid!</strong>
        <br><strong>📦 Автоматическое создание ZIP  всеми параметрами обработки!</strong>
      </p>

      <div class='uploader' id='uploader'>
        <input type='file' id='files' accept='image/*' multiple>
        <div class='icon'>📷</div>
        <div class='hint'>Перетащите фото сюда или нажмите для выбора</div>
        <div style='font-size:12px;color:var(--muted);margin-top:8px'>
          Максимум <?=esc($photoConfig['max_photos'])?> файлов, до <?=esc($photoConfig['max_file_size'])?>МБ каждый
        </div>
      </div>

      <div id='previews' class='previews'></div>
    </section>

    <section class='card'>
      <h2>⚙️ Параметры печати</h2>

      <div class='form-group'>
        <label>Размер фото</label>
        <select id='size'>
          <?php foreach($enabledSizes as $size): ?>
            <option value='<?=esc($size['name'])?>' data-price='<?=esc($size['base'])?>' <?=!empty($size['popular']) ? 'data-popular=\'1\'' : ''?>>
              <?=esc($size['name'])?> (<?=esc($size['w'])?>×<?=esc($size['h'])?>см) — <?=esc($size['base'])?> ₽
              <?=!empty($size['popular']) ? ' ⭐' : ''?>
            </option>
          <?php endforeach; ?>
        </select>
      </div>

      <div class='form-group'>
        <label>Тип бумаги</label>
        <select id='paper'>
          <?php foreach($enabledPapers as $paper): ?>
            <option value='<?=esc($paper['name'])?>' data-delta='<?=esc($paper['delta'])?>' title='<?=esc($paper['description'])?>'>
              <?=esc($paper['name'])?>
              <?php if($paper['delta'] > 0): ?> (+<?=esc($paper['delta'])?> ₽)<?php endif; ?>
            </option>
          <?php endforeach; ?>
        </select>
      </div>

      <div class='form-group'>
        <label>Тираж на каждое фото</label>
        <input type='number' id='qty' min='1' max='100' value='1'>
      </div>

      <div class='form-group'>
        <label>Цветокоррекция</label>
        <select id='correction'>
          <?php foreach($enabledCorrections as $correction): ?>
            <option value='<?=esc($correction['name'])?>' data-delta='<?=esc($correction['delta'])?>' title='<?=esc($correction['description'])?>'>
              <?=esc($correction['name'])?>
              <?php if($correction['delta'] > 0): ?> (+<?=esc($correction['delta'])?> ₽)<?php endif; ?>
            </option>
          <?php endforeach; ?>
        </select>
      </div>

      <?php if (!empty($enabledProcessingOptions)): ?>
      <div class='options-group'>
        <div style='font-weight:600;margin-bottom:12px'>🛠️ Дополнительные услуги (на каждое фото):</div>
        <?php foreach($enabledProcessingOptions as $i => $option): ?>
          <div class='option-item'>
            <input type='checkbox' id='proc_<?=$i?>' name='processing_options[]' value='<?=esc($option['name'])?>' data-price='<?=esc($option['price'])?>'>
            <div class='option-details'>
              <label for='proc_<?=$i?>' style='margin:0;font-weight:500;font-size:14px;cursor:pointer'>
                <?=esc($option['name'])?>
                <span class='option-price'>(+<?=esc($option['price'])?> ₽)</span>
                <?php if ($option['name'] === 'Стиль Полароид'): ?>
                  <span style='background:#f39c12;color:#fff;padding:2px 6px;border-radius:10px;font-size:10px;margin-left:4px'>📸 v3.0</span>
                <?php endif; ?>
              </label>
              <?php if (!empty($option['description'])): ?>
                <div class='option-desc'><?=esc($option['description'])?></div>
              <?php endif; ?>
            </div>
          </div>
        <?php endforeach; ?>
      </div>
      <?php endif; ?>

      <?php if (!empty($enabledDeliveryOptions)): ?>
      <div class='form-group'>
        <label>Способ получения</label>
        <select id='delivery'>
          <option value=''>Выберите способ</option>
          <?php foreach($enabledDeliveryOptions as $option): ?>
            <option value='<?=esc($option['name'])?>' data-price='<?=esc($option['price'])?>'>
              <?=esc($option['name'])?>
              <?php if($option['price'] > 0): ?> (+<?=esc($option['price'])?> ₽)<?php endif; ?>
            </option>
          <?php endforeach; ?>
        </select>
      </div>
      <?php endif; ?>

      <div class='calc'>
        <div class='price-line'>
          <span>Фото загружено:</span>
          <span id='photoCount'>0 шт</span>
        </div>
        <div class='price-line'>
          <span>Всего отпечатков:</span>
          <span id='totalCopies'>0 шт</span>
        </div>
        <div class='price-line'>
          <span>Цена за отпечаток:</span>
          <span id='pricePerCopy'>0 ₽</span>
        </div>
        <div id='processingLine' class='price-line' style='display:none'>
          <span>Дополнительные услуги:</span>
          <span id='processingCost'>0 ₽</span>
        </div>
        <div id='deliveryLine' class='price-line' style='display:none'>
          <span>Доставка:</span>
          <span id='deliveryCost'>0 ₽</span>
        </div>
        <div id='discountLine' class='price-line' style='display:none;color:var(--brand)'>
          <span>Скидка:</span>
          <span id='discountText'>0%</span>
        </div>
        <div class='total'>
          <div style='font-size:14px;color:var(--muted)'>Примерная стоимость:</div>
          <div id='price'>0 ₽</div>
        </div>
      </div>

      <div class='note'>
        💡 Точная стоимость будет рассчитана менеджером с учетом всех параметров и пожеланий.
        <?php if (!empty($enabledDiscounts)): ?>
          <br>🎯 Действуют скидки за количество:
          <?php foreach($enabledDiscounts as $discount): ?>
            от <?=esc($discount['threshold'])?> фото — <?=esc($discount['discount_percent'])?>%;
          <?php endforeach; ?>
        <?php endif; ?>
        <br><strong>📦 Автоматически создается архив для CRM с параметрами редактирования</strong>
      </div>

      <h2 style='margin-top:24px'>💬 Комментарий</h2>
      <textarea id='comment' placeholder='Укажите особые пожелания: печать без полей, кадрирование, коррекция цвета, стиль Polaroid и т.д. Все параметры редактора будут автоматически переданы в заказ.'></textarea>

      <h2 style='margin-top:24px'>📞 Контактные данные</h2>

      <div class='form-group'>
        <label>Ваше имя *</label>
        <input type='text' id='name' placeholder='Иван Иванов' required>
      </div>

      <div class='form-group'>
        <label>Телефон *</label>
        <input type='text' id='phone' placeholder='+7 (999) 123-45-67' required>
      </div>

      <div class='form-group'>
        <label>Email (для уведомлений)</label>
        <input type='email' id='email' placeholder='ivan@example.com'>
      </div>

      <?php if (!empty($cfg['yukassa']['enabled']) && !empty($cfg['yukassa']['services']['photo_constructor'])): ?>
      <div class='payment-methods'>
        <div style='font-weight:600;margin-bottom:8px'>💳 Способ оплаты:</div>
        <div class='payment-option'>
          <input type='radio' id='payment_offline' name='payment_method' value='offline' checked>
          <label for='payment_offline'>При получении (наличные/карта)</label>
        </div>
        <div class='payment-option'>
          <input type='radio' id='payment_online' name='payment_method' value='online'>
          <label for='payment_online'>Онлайн оплата (ЮКасса)</label>
        </div>
      </div>
      <?php endif; ?>

      <button id='btnSend' class='btn btn-primary' style='width:100%;margin-top:16px'>
        📤 Отправить заказ (v3.0)
      </button>

      <div id='msg' class='msg' style='display:none'></div>
    </section>
  </main>

  <!-- УЛУЧШЕННЫЙ РЕДАКТОР ИЗОБРАЖЕНИЙ v3.0 -->
  <div id='photoEditor' class='photo-editor'>
    <div class='editor-content'>
      <div class='editor-header'>
        <h3>🎨 Редактор изображений v3.0</h3>
        <div>
          <button class='btn btn-success' onclick='applyEdits()'>✓ Применить</button>
          <button class='btn btn-secondary' onclick='closeEditor()'>❌ Отмена</button>
        </div>
      </div>
      <div class='editor-body'>
        <div class='editor-preview'>
          <canvas id='editorCanvas'></canvas>
          <div id='cropOverlay' class='crop-overlay'>
            <div class='crop-handle nw'></div>
            <div class='crop-handle ne'></div>
            <div class='crop-handle sw'></div>
            <div class='crop-handle se'></div>
            <div class='crop-info' id='cropInfo'>0×0</div>
          </div>
        </div>
        <div class='editor-controls'>
          <div class='control-group'>
            <label>Яркость</label>
            <input type='range' class='control-slider' id='brightnessSlider' min='-100' max='100' value='0'>
            <div class='control-value' id='brightnessValue'>0</div>
          </div>

          <div class='control-group'>
            <label>Контрастность</label>
            <input type='range' class='control-slider' id='contrastSlider' min='-100' max='100' value='0'>
            <div class='control-value' id='contrastValue'>0</div>
          </div>

          <div class='control-group'>
            <label>Кадрирование (ИСПРАВЛЕНО)</label>
            <div class='crop-controls'>
              <button class='btn-crop' data-ratio='free'>Свободно</button>
              <button class='btn-crop' data-ratio='square'>Квадрат</button>
              <button class='btn-crop' data-ratio='4:3'>4:3</button>
              <button class='btn-crop' data-ratio='16:9'>16:9</button>
              <button class='btn-crop' data-ratio='3:4'>3:4</button>
              <button class='btn-crop' data-ratio='2:3'>2:3</button>
            </div>
            <div style='margin-top:12px'>
              <button id='cropToggle' class='btn btn-secondary' style='width:100%' onclick='toggleCrop()'>
                🔲 Включить кадрирование
              </button>
            </div>
          </div>

          <div class='control-group'>
            <label>Стиль Polaroid (УЛУЧШЕН)</label>
            <div style='margin-top:8px'>
              <button class='btn btn-polaroid' style='width:100%' onclick='togglePolaroid()'>
                📸 Предпросмотр Polaroid
              </button>
            </div>
            <div id='polaroidPreview' style='margin-top:12px;text-align:center;display:none'>
              <div style='font-size:11px;color:var(--muted);margin-bottom:8px'>Предпросмотр стиля Polaroid:</div>
              <div class='polaroid-preview' style='max-width:150px'>
                <canvas id='polaroidCanvas' width='150' height='100'></canvas>
              </div>
            </div>
          </div>

          <div class='control-group'>
            <label>Действия</label>
            <button class='btn btn-secondary' style='width:100%;margin-bottom:8px' onclick='resetEdits()'>🔄 Сброс</button>
            <button class='btn btn-danger' style='width:100%' onclick='closeEditor()'>❌ Отмена</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id='loading' class='loading'>
    <div class='loading-content'>
      <div class='spinner'></div>
      <div>Отправка заказа v3.0...</div>
    </div>
  </div>

  <?php endif; ?>

  <script>
    // Полная конфигурация из админки
    let CONFIG = null;
    const MAX_FILE_SIZE_MB = <?=esc($photoConfig['max_file_size'] ?? 10)?>;
    const MAX_FILE_SIZE = MAX_FILE_SIZE_MB * 1024 * 1024;

    // Загружаем конфиг динамически
    fetch('?api=config')
      .then(response => response.json())
      .then(config => {
        CONFIG = config;
        console.log('Конфиг v3.0 загружен из админки:', CONFIG);
        if (!CONFIG.enabled) {
          document.body.innerHTML = '<div class=\'disabled-notice\'><h2>⚠️ Фотоконструктор отключен</h2><p>Сервис временно недоступен.</p></div>';
        }
      })
      .catch(error => {
        console.error('Ошибка загрузки конфига:', error);
        CONFIG = {
          enabled: true,
          max_photos: <?=esc($photoConfig['max_photos'] ?? 100)?>,
          max_file_size: <?=esc($photoConfig['max_file_size'] ?? 10)?>
        };
      });

    // Глобальные переменные
    const files = document.getElementById('files');
    const previews = document.getElementById('previews');
    const priceEl = document.getElementById('price');
    const uploader = document.getElementById('uploader');
    const photoCountEl = document.getElementById('photoCount');
    const totalCopiesEl = document.getElementById('totalCopies');
    const pricePerCopyEl = document.getElementById('pricePerCopy');
    const processingLineEl = document.getElementById('processingLine');
    const processingCostEl = document.getElementById('processingCost');
    const deliveryLineEl = document.getElementById('deliveryLine');
    const deliveryCostEl = document.getElementById('deliveryCost');
    const discountLineEl = document.getElementById('discountLine');
    const discountTextEl = document.getElementById('discountText');

    let uploadedFiles = [];
    let currentDiscount = 0;
    let currentProcessingCost = 0;
    let currentDeliveryCost = 0;

    // УЛУЧШЕННЫЙ РЕДАКТОР ИЗОБРАЖЕНИЙ v3.0
    let currentEditingIndex = -1;
    let editorCanvas = null;
    let editorCtx = null;
    let polaroidCanvas = null;
    let polaroidCtx = null;
    let originalImageData = null;
    let currentImage = null;
    let editParams = {};
    let cropMode = false;
    let cropData = null;
    let isDragging = false;
    let isResizing = false;
    let dragStart = { x: 0, y: 0 };
    let currentRatio = 'free';
    let polaroidMode = false;

    // Инициализация редактора
    function initEditor() {
      editorCanvas = document.getElementById('editorCanvas');
      editorCtx = editorCanvas.getContext('2d');
      polaroidCanvas = document.getElementById('polaroidCanvas');
      polaroidCtx = polaroidCanvas.getContext('2d');

      // Слушатели для слайдеров
      document.getElementById('brightnessSlider').addEventListener('input', updatePreview);
      document.getElementById('contrastSlider').addEventListener('input', updatePreview);

      // Кнопки соотношений кадрирования
      document.querySelectorAll('.btn-crop').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.btn-crop').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentRatio = this.dataset.ratio;
          if (cropMode && cropData) {
            applyCropRatio();
          }
        });
      });

      // Слушатели для кадрирования
      setupCropHandlers();
    }

    function openEditor(fileIndex) {
      if (fileIndex < 0 || fileIndex >= uploadedFiles.length) return;

      currentEditingIndex = fileIndex;
      const file = uploadedFiles[fileIndex];

      // Загружаем параметры редактирования если есть
      editParams = file.editParams || {
        brightness: 0,
        contrast: 0,
        crop: null,
        polaroid: false
      };

      // Устанавливаем значения слайдеров
      document.getElementById('brightnessSlider').value = editParams.brightness || 0;
      document.getElementById('contrastSlider').value = editParams.contrast || 0;
      document.getElementById('brightnessValue').textContent = editParams.brightness || 0;
      document.getElementById('contrastValue').textContent = editParams.contrast || 0;

      // Создаем изображение
      const img = new Image();
      img.onload = function() {
        currentImage = img;
        originalImageData = null;
        cropData = editParams.crop;
        polaroidMode = editParams.polaroid || false;

        // ИСПРАВЛЕННЫЕ размеры канваса
        const maxWidth = 800;
        const maxHeight = 600;
        let { width, height } = img;

        // Вычисляем пропорциональные размеры
        if (width > maxWidth || height > maxHeight) {
          const ratio = Math.min(maxWidth / width, maxHeight / height);
          width = Math.round(width * ratio);
          height = Math.round(height * ratio);
        }

        editorCanvas.width = width;
        editorCanvas.height = height;
        editorCanvas.style.maxWidth = '100%';
        editorCanvas.style.maxHeight = '100%';
        editorCanvas.style.display = 'block';

        // ИСПРАВЛЕННОЕ позиционирование канваса
        const preview = document.querySelector('.editor-preview');
        const canvasRect = editorCanvas.getBoundingClientRect();
        const previewRect = preview.getBoundingClientRect();

        // Центрируем канвас в превью
        editorCanvas.style.position = 'relative';
        editorCanvas.style.left = '0';
        editorCanvas.style.top = '0';

        updatePreview();
        updatePolaroidPreview();
        document.getElementById('photoEditor').classList.add('show');
      };

      img.src = file.url;
    }

    function updatePreview() {
      if (!currentImage || !editorCtx) return;

      const brightness = parseInt(document.getElementById('brightnessSlider').value);
      const contrast = parseInt(document.getElementById('contrastSlider').value);

      document.getElementById('brightnessValue').textContent = brightness;
      document.getElementById('contrastValue').textContent = contrast;

      // Очищаем канвас
      editorCtx.clearRect(0, 0, editorCanvas.width, editorCanvas.height);

      // Рисуем исходное изображение
      editorCtx.drawImage(currentImage, 0, 0, editorCanvas.width, editorCanvas.height);

      // ИСПРАВЛЕННОЕ применение фильтров
      if (brightness !== 0 || contrast !== 0) {
        const imageData = editorCtx.getImageData(0, 0, editorCanvas.width, editorCanvas.height);
        const data = imageData.data;

        for (let i = 0; i < data.length; i += 4) {
          // Яркость (исправлено)
          let r = data[i] + brightness;
          let g = data[i + 1] + brightness;
          let b = data[i + 2] + brightness;

          // Контрастность (исправлена формула)
          if (contrast !== 0) {
            const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
            r = factor * (r - 128) + 128;
            g = factor * (g - 128) + 128;
            b = factor * (b - 128) + 128;
          }

          // Ограничиваем значения
          data[i] = Math.max(0, Math.min(255, r));
          data[i + 1] = Math.max(0, Math.min(255, g));
          data[i + 2] = Math.max(0, Math.min(255, b));
        }

        editorCtx.putImageData(imageData, 0, 0);
      }

      // Показываем область кадрирования если есть
      if (cropData && cropMode) {
        updateCropOverlay();
      }

      updatePolaroidPreview();
    }

    // ИСПРАВЛЕННОЕ КАДРИРОВАНИЕ
    function toggleCrop() {
      cropMode = !cropMode;
      const overlay = document.getElementById('cropOverlay');
      const toggleBtn = document.getElementById('cropToggle');

      if (cropMode) {
        if (!cropData) {
          // ИСПРАВЛЕННЫЕ начальные координаты кадрирования
          const margin = Math.min(editorCanvas.width, editorCanvas.height) * 0.1;
          cropData = {
            x: margin,
            y: margin,
            width: editorCanvas.width - (margin * 2),
            height: editorCanvas.height - (margin * 2)
          };
        }
        overlay.classList.add('show');
        toggleBtn.textContent = '❌ Выключить кадрирование';
        toggleBtn.className = 'btn btn-danger';
        updateCropOverlay();
      } else {
        overlay.classList.remove('show');
        toggleBtn.textContent = '🔲 Включить кадрирование';
        toggleBtn.className = 'btn btn-secondary';
      }
    }

    function updateCropOverlay() {
      if (!cropData || !cropMode) return;

      const overlay = document.getElementById('cropOverlay');
      const info = document.getElementById('cropInfo');

      // ИСПРАВЛЕННОЕ позиционирование относительно канваса
      const canvasRect = editorCanvas.getBoundingClientRect();
      const previewRect = document.querySelector('.editor-preview').getBoundingClientRect();

      const offsetX = canvasRect.left - previewRect.left;
      const offsetY = canvasRect.top - previewRect.top;

      overlay.style.left = (offsetX + cropData.x) + 'px';
      overlay.style.top = (offsetY + cropData.y) + 'px';
      overlay.style.width = cropData.width + 'px';
      overlay.style.height = cropData.height + 'px';

      info.textContent = Math.round(cropData.width) + '×' + Math.round(cropData.height);
    }

    function applyCropRatio() {
      if (!cropData || currentRatio === 'free') return;

      let targetRatio = 1;
      switch (currentRatio) {
        case 'square': targetRatio = 1; break;
        case '4:3': targetRatio = 4/3; break;
        case '16:9': targetRatio = 16/9; break;
        case '3:4': targetRatio = 3/4; break;
        case '2:3': targetRatio = 2/3; break;
      }

      const currentAspect = cropData.width / cropData.height;

      if (Math.abs(currentAspect - targetRatio) > 0.01) {
        const centerX = cropData.x + cropData.width / 2;
        const centerY = cropData.y + cropData.height / 2;

        let newWidth, newHeight;

        if (targetRatio > currentAspect) {
          newHeight = cropData.height;
          newWidth = newHeight * targetRatio;
        } else {
          newWidth = cropData.width;
          newHeight = newWidth / targetRatio;
        }

        // ИСПРАВЛЕННАЯ проверка границ
        newWidth = Math.min(newWidth, editorCanvas.width);
        newHeight = Math.min(newHeight, editorCanvas.height);

        // Пересчитываем если не помещается
        if (newWidth > editorCanvas.width) {
          newWidth = editorCanvas.width;
          newHeight = newWidth / targetRatio;
        }
        if (newHeight > editorCanvas.height) {
          newHeight = editorCanvas.height;
          newWidth = newHeight * targetRatio;
        }

        cropData.width = newWidth;
        cropData.height = newHeight;
        cropData.x = Math.max(0, Math.min(centerX - newWidth/2, editorCanvas.width - newWidth));
        cropData.y = Math.max(0, Math.min(centerY - newHeight/2, editorCanvas.height - newHeight));

        updateCropOverlay();
      }
    }

    function setupCropHandlers() {
      const overlay = document.getElementById('cropOverlay');

      overlay.addEventListener('mousedown', startDrag);
      document.addEventListener('mousemove', handleDrag);
      document.addEventListener('mouseup', stopDrag);

      // Touch events для мобильных устройств
      overlay.addEventListener('touchstart', handleTouchStart, { passive: false });
      document.addEventListener('touchmove', handleTouchMove, { passive: false });
      document.addEventListener('touchend', stopDrag);
    }

    function startDrag(e) {
      if (!cropMode || !cropData) return;

      e.preventDefault();
      isDragging = true;

      const rect = document.querySelector('.editor-preview').getBoundingClientRect();
      const canvasRect = editorCanvas.getBoundingClientRect();

      const x = e.clientX - canvasRect.left;
      const y = e.clientY - canvasRect.top;

      dragStart = { x: x - cropData.x, y: y - cropData.y };
    }

    function handleDrag(e) {
      if (!isDragging || !cropMode || !cropData) return;

      e.preventDefault();

      const canvasRect = editorCanvas.getBoundingClientRect();
      const x = e.clientX - canvasRect.left;
      const y = e.clientY - canvasRect.top;

      // ИСПРАВЛЕННОЕ перемещение с учетом границ
      const newX = x - dragStart.x;
      const newY = y - dragStart.y;

      cropData.x = Math.max(0, Math.min(newX, editorCanvas.width - cropData.width));
      cropData.y = Math.max(0, Math.min(newY, editorCanvas.height - cropData.height));

      updateCropOverlay();
    }

    function handleTouchStart(e) {
      if (e.touches.length === 1) {
        const touch = e.touches[0];
        startDrag({ clientX: touch.clientX, clientY: touch.clientY, preventDefault: () => e.preventDefault() });
      }
    }

    function handleTouchMove(e) {
      if (e.touches.length === 1) {
        const touch = e.touches[0];
        handleDrag({ clientX: touch.clientX, clientY: touch.clientY, preventDefault: () => e.preventDefault() });
      }
    }

    function stopDrag() {
      isDragging = false;
      isResizing = false;
    }

    // УЛУЧШЕННЫЙ СТИЛЬ POLAROID
    function togglePolaroid() {
      polaroidMode = !polaroidMode;
      const preview = document.getElementById('polaroidPreview');

      if (polaroidMode) {
        preview.style.display = 'block';
        updatePolaroidPreview();
      } else {
        preview.style.display = 'none';
      }
    }

    function updatePolaroidPreview() {
      if (!polaroidMode || !polaroidCanvas || !currentImage) return;

      const canvas = polaroidCanvas;
      const ctx = polaroidCtx;

      // ИСПРАВЛЕННЫЕ размеры для превью
      const previewWidth = 150;
      const previewHeight = 110; // Увеличили высоту для рамки

      canvas.width = previewWidth;
      canvas.height = previewHeight;

      // Белая рамка Polaroid (ИСПРАВЛЕНО)
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, previewWidth, previewHeight);

      // Область для фото (оставляем место для подписи снизу)
      const photoMargin = 10;
      const bottomMargin = 25;
      const photoWidth = previewWidth - (photoMargin * 2);
      const photoHeight = previewHeight - photoMargin - bottomMargin;

      // ИСПРАВЛЕННОЕ рисование фото с применением фильтров
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');

      tempCanvas.width = photoWidth;
      tempCanvas.height = photoHeight;

      // Рисуем изображение на временный канвас
      tempCtx.drawImage(currentImage, 0, 0, photoWidth, photoHeight);

      // Применяем те же фильтры что и в основном редакторе
      const brightness = parseInt(document.getElementById('brightnessSlider').value);
      const contrast = parseInt(document.getElementById('contrastSlider').value);

      if (brightness !== 0 || contrast !== 0) {
        const imageData = tempCtx.getImageData(0, 0, photoWidth, photoHeight);
        const data = imageData.data;

        for (let i = 0; i < data.length; i += 4) {
          let r = data[i] + brightness;
          let g = data[i + 1] + brightness;
          let b = data[i + 2] + brightness;

          if (contrast !== 0) {
            const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
            r = factor * (r - 128) + 128;
            g = factor * (g - 128) + 128;
            b = factor * (b - 128) + 128;
          }

          data[i] = Math.max(0, Math.min(255, r));
          data[i + 1] = Math.max(0, Math.min(255, g));
          data[i + 2] = Math.max(0, Math.min(255, b));
        }

        tempCtx.putImageData(imageData, 0, 0);
      }

      // Рисуем обработанное фото на Polaroid канвас
      ctx.drawImage(tempCanvas, photoMargin, photoMargin);

      // Легкая тень внутри рамки
      ctx.strokeStyle = 'rgba(0,0,0,0.1)';
      ctx.lineWidth = 1;
      ctx.strokeRect(photoMargin, photoMargin, photoWidth, photoHeight);
    }

    function resetEdits() {
      document.getElementById('brightnessSlider').value = 0;
      document.getElementById('contrastSlider').value = 0;
      cropData = null;
      polaroidMode = false;
      cropMode = false;
      document.getElementById('cropOverlay').classList.remove('show');
      document.getElementById('polaroidPreview').style.display = 'none';
      document.getElementById('cropToggle').textContent = '🔲 Включить кадрирование';
      document.getElementById('cropToggle').className = 'btn btn-secondary';
      document.querySelectorAll('.btn-crop').forEach(b => b.classList.remove('active'));
      currentRatio = 'free';
      updatePreview();
    }

    function applyEdits() {
      if (currentEditingIndex >= 0 && currentEditingIndex < uploadedFiles.length) {
        const brightness = parseInt(document.getElementById('brightnessSlider').value);
        const contrast = parseInt(document.getElementById('contrastSlider').value);

        // ИСПРАВЛЕННОЕ сохранение параметров редактирования
        uploadedFiles[currentEditingIndex].editParams = {
          brightness: brightness,
          contrast: contrast,
          crop: cropData ? {
            x: cropData.x,
            y: cropData.y,
            width: cropData.width,
            height: cropData.height
          } : null,
          polaroid: polaroidMode
        };

        // Обновляем превью миниатюры
        updateThumbnail(currentEditingIndex);

        closeEditor();
        showMessage('✅ Настройки изображения применены (v3.0)', 'success');
        setTimeout(() => hideMessage(), 2000);
      }
    }

    function closeEditor() {
      document.getElementById('photoEditor').classList.remove('show');
      currentEditingIndex = -1;
      cropMode = false;
      polaroidMode = false;
      cropData = null;
      resetEdits();
    }

    function updateThumbnail(index) {
      const file = uploadedFiles[index];
      const thumb = document.querySelector('[data-index=\'' + index + '\']');

      if (thumb && file.editParams) {
        // Удаляем старые бейджи
        const oldBadges = thumb.querySelectorAll('.preview-badge, .version-badge');
        oldBadges.forEach(badge => badge.remove());

        let badgeText = '';
        let badgeClass = 'preview-badge';

        if (file.editParams.polaroid) {
          badgeText = '📸 Polaroid';
          badgeClass += ' polaroid-badge';
        } else if (file.editParams.brightness !== 0 || file.editParams.contrast !== 0 || file.editParams.crop) {
          badgeText = '🎨 Отредактировано';
        }

        if (badgeText) {
          const badge = document.createElement('div');
          badge.className = badgeClass;
          badge.textContent = badgeText;
          thumb.appendChild(badge);
        }

        // Добавляем бейдж версии
        const versionBadge = document.createElement('div');
        versionBadge.className = 'version-badge';
        versionBadge.textContent = 'v3.0';
        thumb.appendChild(versionBadge);
      }
    }

    // ИСПРАВЛЕННЫЙ расчет стоимости 
    function calcPrice() {
      const sizeSelect = document.getElementById('size');
      const paperSelect = document.getElementById('paper');
      const correctionSelect = document.getElementById('correction');
      const deliverySelect = document.getElementById('delivery');
      const qty = parseInt(document.getElementById('qty').value || '1');
      const photoCount = uploadedFiles.length;

      // ИСПРАВЛЕНА ОШИБКА: проверяем наличие selectedOptions
      const basePrice = (sizeSelect.selectedOptions.length > 0) ?
        parseInt(sizeSelect.selectedOptions[0].dataset.price || '0') : 0;
      const paperDelta = (paperSelect.selectedOptions.length > 0) ?
        parseInt(paperSelect.selectedOptions[0].dataset.delta || '0') : 0;
      const correctionDelta = (correctionSelect.selectedOptions.length > 0) ?
        parseInt(correctionSelect.selectedOptions[0].dataset.delta || '0') : 0;

      const pricePerPhoto = basePrice + paperDelta + correctionDelta;
      const totalCopies = photoCount * qty;

      // Дополнительные услуги
      currentProcessingCost = 0;
      const processingCheckboxes = document.querySelectorAll('input[name=\'processing_options[]\']:checked');
      processingCheckboxes.forEach(cb => {
        currentProcessingCost += parseInt(cb.dataset.price || '0');
      });
      const totalProcessingCost = currentProcessingCost * photoCount;

      // Доставка
      currentDeliveryCost = (deliverySelect.selectedOptions.length > 0) ?
        parseInt(deliverySelect.selectedOptions[0].dataset.price || '0') : 0;

      let totalPrice = (pricePerPhoto * totalCopies) + totalProcessingCost + currentDeliveryCost;

      // Расчет скидки
      currentDiscount = 0;
      if (CONFIG && CONFIG.discounts) {
        const sortedDiscounts = CONFIG.discounts.sort((a, b) => b.threshold - a.threshold);
        for (const discount of sortedDiscounts) {
          if (photoCount >= discount.threshold) {
            currentDiscount = discount.discount_percent;
            break;
          }
        }
      }

      let discountAmount = 0;
      if (currentDiscount > 0) {
        discountAmount = ((pricePerPhoto * totalCopies) + totalProcessingCost) * (currentDiscount / 100);
        totalPrice -= discountAmount;
      }

      // Обновляем отображение
      photoCountEl.textContent = photoCount + ' шт';
      totalCopiesEl.textContent = totalCopies + ' шт';
      pricePerCopyEl.textContent = pricePerPhoto + ' ₽';

      if (totalProcessingCost > 0) {
        processingCostEl.textContent = '+' + totalProcessingCost + ' ₽';
        processingLineEl.style.display = 'flex';
      } else {
        processingLineEl.style.display = 'none';
      }

      if (currentDeliveryCost > 0) {
        deliveryCostEl.textContent = '+' + currentDeliveryCost + ' ₽';
        deliveryLineEl.style.display = 'flex';
      } else {
        deliveryLineEl.style.display = 'none';
      }

      if (currentDiscount > 0) {
        discountTextEl.textContent = '-' + currentDiscount + '% (-' + Math.round(discountAmount) + ' ₽)';
        discountLineEl.style.display = 'flex';
      } else {
        discountLineEl.style.display = 'none';
      }

      priceEl.textContent = Math.round(totalPrice).toLocaleString('ru-RU') + ' ₽';
    }

    // Добавление превью фото с кнопками редактирования и удаления
    function addThumb(file, index) {
      if (!file.type.startsWith('image/')) return;

      const url = URL.createObjectURL(file);
      file.url = url; // Сохраняем URL для редактора

      const div = document.createElement('div');
      div.className = 'thumb';
      div.dataset.index = index;
      div.innerHTML = '<div class=\'img\' style=\'background-image:url(\'' + url + '\')\' title=\'' + file.name + '\'></div>' +
        '<button class=\'edit-btn\' onclick=\'openEditor(' + index + ')\' title=\'Редактировать в v3.0\'>🎨</button>' +
        '<button class=\'remove-btn\' onclick=\'removePhoto(' + index + ')\' title=\'Удалить фото\'>×</button>' +
        '<div class=\'info\'><div>' + file.name + '</div><div>' + (file.size/1024/1024).toFixed(1) + ' МБ</div></div>';
      previews.appendChild(div);
    }

    // Удаление фото
    function removePhoto(index) {
      if (index >= 0 && index < uploadedFiles.length) {
        URL.revokeObjectURL(uploadedFiles[index].url);
        uploadedFiles.splice(index, 1);
        updatePreviews();
        calcPrice();
      }
    }

    // Обновление превью после удаления
    function updatePreviews() {
      previews.innerHTML = '';
      uploadedFiles.forEach((file, index) => {
        addThumb(file, index);
        // Восстанавливаем бейдж если был отредактирован
        if (file.editParams && (file.editParams.brightness !== 0 || file.editParams.contrast !== 0 || file.editParams.crop || file.editParams.polaroid)) {
          updateThumbnail(index);
        }
      });
    }

    // Обработка выбора файлов
    files.addEventListener('change', (e) => {
      const fileList = Array.from(e.target.files);
      processFiles(fileList);
      e.target.value = ''; // Сбрасываем input для повторного выбора
    });

    // Обработка файлов с валидацией
    function processFiles(fileList) {
      const validFiles = [];
      const errors = [];
      const maxPhotos = CONFIG ? CONFIG.max_photos : <?=esc($photoConfig['max_photos'] ?? 100)?>;

      for (const file of fileList) {
        if (uploadedFiles.length + validFiles.length >= maxPhotos) {
          errors.push('Превышен лимит в ' + maxPhotos + ' файлов');
          break;
        }

        if (!file.type.startsWith('image/')) {
          errors.push(file.name + ': неподдерживаемый формат');
          continue;
        }

        if (file.size > MAX_FILE_SIZE) {
          errors.push(file.name + ': размер превышает ' + MAX_FILE_SIZE_MB + 'МБ');
          continue;
        }

        // Добавляем пустые параметры редактирования v3.0
        file.editParams = {
          brightness: 0,
          contrast: 0,
          crop: null,
          polaroid: false
        };

        validFiles.push(file);
      }

      // Добавляем валидные файлы
      uploadedFiles.push(...validFiles);
      updatePreviews();
      calcPrice();

      // Показываем ошибки если есть
      if (errors.length > 0) {
        showMessage('Некоторые файлы не загружены:\n• ' + errors.join('\n• '), 'warning');
      }

      if (validFiles.length > 0) {
        showMessage('✅ Загружено ' + validFiles.length + ' фото. Используйте кнопку 🎨 для редактирования v3.0', 'success');
        setTimeout(() => hideMessage(), 4000);
      }
    }

    // Drag & Drop
    uploader.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploader.classList.add('dragover');
    });

    uploader.addEventListener('dragleave', (e) => {
      if (!uploader.contains(e.relatedTarget)) {
        uploader.classList.remove('dragover');
      }
    });

    uploader.addEventListener('drop', (e) => {
      e.preventDefault();
      uploader.classList.remove('dragover');

      const droppedFiles = Array.from(e.dataTransfer.files);
      processFiles(droppedFiles);
    });

    // Слушатели изменений параметров
    ['size', 'paper', 'qty', 'correction', 'delivery'].forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener('change', calcPrice);
        element.addEventListener('input', calcPrice);
      }
    });

    // Слушатели для дополнительных услуг
    document.querySelectorAll('input[name=\'processing_options[]\']').forEach(cb => {
      cb.addEventListener('change', calcPrice);
    });

    // Отправка формы
    document.getElementById('btnSend').addEventListener('click', async () => {
      if (!uploadedFiles.length) {
        showMessage('❌ Загрузите хотя бы одну фотографию', 'error');
        return;
      }

      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();

      if (!name || !phone) {
        showMessage('❌ Заполните имя и телефон', 'error');
        return;
      }

      // Валидация телефона
      const phoneClean = phone.replace(/[^0-9+]/g, '');
      if (phoneClean.length < 10) {
        showMessage('❌ Некорректный номер телефона', 'error');
        return;
      }

      if (email && !isValidEmail(email)) {
        showMessage('❌ Некорректный email адрес', 'error');
        return;
      }

      const btn = document.getElementById('btnSend');
      const loading = document.getElementById('loading');
      const originalText = btn.textContent;

      btn.disabled = true;
      btn.textContent = 'Отправляем заказ v3.0...';
      loading.classList.add('show');

      try {
        const fd = new FormData();
        fd.append('mode', 'photo_order');

        // Добавляем фото с УЛУЧШЕННЫМИ параметрами редактирования v3.0
        uploadedFiles.forEach((file, index) => {
          fd.append('photos[]', file);

          // ИСПРАВЛЕННЫЕ параметры редактирования для каждого фото
          if (file.editParams) {
            fd.append('edit_params[' + index + '][brightness]', file.editParams.brightness);
            fd.append('edit_params[' + index + '][contrast]', file.editParams.contrast);
            fd.append('edit_params[' + index + '][polaroid]', file.editParams.polaroid ? '1' : '0');
            if (file.editParams.crop) {
              fd.append('edit_params[' + index + '][crop][x]', file.editParams.crop.x);
              fd.append('edit_params[' + index + '][crop][y]', file.editParams.crop.y);
              fd.append('edit_params[' + index + '][crop][width]', file.editParams.crop.width);
              fd.append('edit_params[' + index + '][crop][height]', file.editParams.crop.height);
            }
          }
        });

        // Добавляем параметры
        fd.append('size', document.getElementById('size').value);
        fd.append('paper', document.getElementById('paper').value);
        fd.append('qty', document.getElementById('qty').value);
        fd.append('correction', document.getElementById('correction').value);
        fd.append('name', name);
        fd.append('phone', phone);
        fd.append('email', email);
        fd.append('comment', document.getElementById('comment').value.trim());

        // Дополнительные услуги
        const processingOptions = [];
        document.querySelectorAll('input[name=\'processing_options[]\']:checked').forEach(cb => {
          processingOptions.push(cb.value);
        });
        if (processingOptions.length > 0) {
          processingOptions.forEach(option => {
            fd.append('processing_options[]', option);
          });
        }

        // Доставка
        const deliverySelect = document.getElementById('delivery');
        if (deliverySelect && deliverySelect.value) {
          fd.append('delivery', deliverySelect.value);
        }

        // Способ оплаты
        const paymentMethodEl = document.querySelector('input[name=\'payment_method\']:checked');
        if (paymentMethodEl) {
          fd.append('payment_method', paymentMethodEl.value);
        }

        const response = await fetch(location.href, {
          method: 'POST',
          body: fd
        });

        if (!response.ok) {
          throw new Error('Ошибка сети: ' + response.status);
        }

        const result = await response.json();

        if (result.ok) {
          let message = '✅ Заказ успешно отправлен v3.0!\n🆔 ID: ' + result.order_id + '\n📸 Фото: ' + result.photo_count + ' шт';

          if (result.total_copies) {
            message += '\n📦 Отпечатков: ' + result.total_copies + ' шт';
          }

          if (result.discount) {
            message += '\n🎯 Скидка: ' + result.discount + '%';
          }

          if (result.processing_cost) {
            message += '\n🛠️ Доп. услуги: +' + result.processing_cost + ' ₽';
          }

          if (result.delivery_cost) {
            message += '\n🚚 Доставка: +' + result.delivery_cost + ' ₽';
          }

          if (result.estimated_price) {
            message += '\n💰 Итого: ' + result.estimated_price.toLocaleString('ru-RU') + ' ₽';
          }

          if (result.archive_created) {
            message += '\n📦 Архив создан для CRM админки';
          }

          message += '\n\n🎨 Использованные настройки редактора v3.0 (включая Polaroid и кадрирование) сохранены в заказе';
          message += '\n📧 ПРИНУДИТЕЛЬНАЯ отправка на artcopy78@bk.ru всеми способами';

          if (result.warning) {
            message += '\n\n⚠️ ' + result.warning;
          }

          showMessage(message, 'success');

          // Очищаем форму
          uploadedFiles.forEach(file => {
            if (file.url) URL.revokeObjectURL(file.url);
          });
          uploadedFiles = [];
          updatePreviews();
          document.getElementById('name').value = '';
          document.getElementById('phone').value = '';
          document.getElementById('email').value = '';
          document.getElementById('comment').value = '';

          // Сброс доп услуг
          document.querySelectorAll('input[name=\'processing_options[]\']').forEach(cb => {
            cb.checked = false;
          });

          calcPrice();

          // Обработка онлайн оплаты
          if (result.payment && result.payment_url) {
            showMessage('💳 Переходим к оплате через ЮКасса...', 'success');
            setTimeout(() => {
              window.open(result.payment_url, '_blank');
            }, 2500);
          }

        } else {
          showMessage('❌ ' + (result.error || 'Неизвестная ошибка сервера'), 'error');
        }

      } catch (error) {
        console.error('Ошибка отправки:', error);
        showMessage('❌ Ошибка соединения с сервером: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
        loading.classList.remove('show');
      }
    });

    function showMessage(text, type) {
      const msg = document.getElementById('msg');
      msg.innerHTML = text.replace(/\n/g, '<br>');
      msg.className = 'msg ' + type;
      msg.style.display = 'block';
      msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function hideMessage() {
      const msg = document.getElementById('msg');
      msg.style.display = 'none';
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // Инициализация
    document.addEventListener('DOMContentLoaded', function() {
      initEditor();
      calcPrice();

      // Устанавливаем популярный размер по умолчанию
      const popularOption = document.querySelector('#size option[data-popular=\'1\']');
      if (popularOption) {
        document.getElementById('size').value = popularOption.value;
        calcPrice(); // Пересчитываем цену после установки размера
      }

      // Закрытие редактора по ESC
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('photoEditor').classList.contains('show')) {
          closeEditor();
        }
      });

      console.log('🎯 ПРЕМИУМ Фотоконструктор v3.0 с ИСПРАВЛЕННЫМ редактором инициализирован!');
      console.log('✅ Функции: яркость, контрастность, ИСПРАВЛЕННОЕ кадрирование, улучшенный СТИЛЬ POLAROID');
      console.log('✅ ИСПРАВЛЕНА ошибка \'выбранный размер недоступен\'');
      console.log('✅ CRM интеграция с автоматическим созданием ZIP архивов');
      console.log('✅ ПРИНУДИТЕЛЬНАЯ отправка на artcopy78@bk.ru всеми доступными способами');
      console.log('✅ Все параметры редактирования сохраняются и передаются в заказ для точного исполнения');
    });
  </script>
</body>
</html>
