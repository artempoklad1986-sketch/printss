<?php
mb_internal_encoding('UTF-8');
date_default_timezone_set('Europe/Moscow');
session_start();

$BASE = __DIR__;
$configFile = $BASE.'/config.json';
$photoConfigFile = $BASE.'/photo_config.json';
$uploadsDir = $BASE.'/uploads';
$ordersLog = $BASE.'/orders.txt';
$customersFile = $BASE.'/customers.json';

// –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –∑–∞–≥—Ä—É–∑–æ–∫ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if (!is_dir($uploadsDir)) @mkdir($uploadsDir, 0775, true);
if (!file_exists($uploadsDir.'/.htaccess')) {
    @file_put_contents($uploadsDir.'/.htaccess', 'php_flag engine off\nOptions -ExecCGI\n<FilesMatch \'\\\.(php|phar|phtml|cgi|pl|py)$\'>\nDeny from all\n</FilesMatch>\n');
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥
$cfg = json_decode(@file_get_contents($configFile), true) ?? [];

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞ —Ñ–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –ò–ó –ê–î–ú–ò–ù–ö–ò
function loadPhotoConfig($photoConfigFile) {
    $photoConfig = json_decode(@file_get_contents($photoConfigFile), true);

    if (!$photoConfig) {
        // –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–∞
        $photoConfig = [
            'enabled' => true,
            'max_photos' => 100,
            'max_file_size' => 10,
            'supported_formats' => ['jpg', 'jpeg', 'png', 'heic', 'heif'],
            'sizes' => [
                ['name' => '10√ó15', 'w' => 10, 'h' => 15, 'base' => 30, 'enabled' => true, 'popular' => true],
                ['name' => '15√ó21', 'w' => 15, 'h' => 21, 'base' => 50, 'enabled' => true, 'popular' => true],
                ['name' => 'A4', 'w' => 21, 'h' => 29.7, 'base' => 120, 'enabled' => true, 'popular' => false],
                ['name' => 'A3', 'w' => 29.7, 'h' => 42, 'base' => 200, 'enabled' => true, 'popular' => false],
                ['name' => '30√ó40', 'w' => 30, 'h' => 40, 'base' => 300, 'enabled' => true, 'popular' => false],
                ['name' => '50√ó70', 'w' => 50, 'h' => 70, 'base' => 800, 'enabled' => true, 'popular' => false]
            ],
            'papers' => [
                ['name' => '–ú–∞—Ç–æ–≤–∞—è', 'delta' => 0, 'enabled' => true, 'description' => '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –º–∞—Ç–æ–≤–∞—è –±—É–º–∞–≥–∞'],
                ['name' => '–ì–ª—è–Ω–µ—Ü', 'delta' => 10, 'enabled' => true, 'description' => '–ì–ª—è–Ω—Ü–µ–≤–∞—è –±—É–º–∞–≥–∞ —Å –±–ª–µ—Å–∫–æ–º']
            ],
            'corrections' => [
                ['name' => '–ù–µ—Ç', 'delta' => 0, 'enabled' => true, 'description' => '–ë–µ–∑ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏'],
                ['name' => '–õ–µ–≥–∫–∞—è', 'delta' => 15, 'enabled' => true, 'description' => '–ê–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è —è—Ä–∫–æ—Å—Ç–∏ –∏ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞'],
                ['name' => '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è', 'delta' => 50, 'enabled' => true, 'description' => '–†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –¥–∏–∑–∞–π–Ω–µ—Ä–æ–º']
            ],
            'processing_options' => [
                ['name' => '–ö–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ', 'price' => 20, 'enabled' => true, 'description' => '–û–±—Ä–µ–∑–∫–∞ –ø–æ –Ω—É–∂–Ω–æ–º—É —Ä–∞–∑–º–µ—Ä—É'],
                ['name' => '–°—Ç–∏–ª—å –ü–æ–ª–∞—Ä–æ–∏–¥', 'price' => 50, 'enabled' => true, 'description' => '–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤ —Å—Ç–∏–ª–µ Polaroid —Å –±–µ–ª–æ–π —Ä–∞–º–∫–æ–π'],
                ['name' => '–£–¥–∞–ª–µ–Ω–∏–µ –∫—Ä–∞—Å–Ω—ã—Ö –≥–ª–∞–∑', 'price' => 30, 'enabled' => true, 'description' => '–ö–æ—Ä—Ä–µ–∫—Ü–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –∫—Ä–∞—Å–Ω—ã—Ö –≥–ª–∞–∑'],
                ['name' => '–ß–µ—Ä–Ω–æ-–±–µ–ª–æ–µ', 'price' => 10, 'enabled' => true, 'description' => '–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —á/–±']
            ],
            'delivery_options' => [
                ['name' => '–°–∞–º–æ–≤—ã–≤–æ–∑', 'price' => 0, 'enabled' => true, 'description' => '–ó–∞–±—Ä–∞—Ç—å –≤ –æ—Ñ–∏—Å–µ'],
                ['name' => '–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É', 'price' => 200, 'enabled' => true, 'description' => '–î–æ—Å—Ç–∞–≤–∫–∞ –∫—É—Ä—å–µ—Ä–æ–º'],
                ['name' => '–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏', 'price' => 300, 'enabled' => true, 'description' => '–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—á—Ç–æ–π']
            ],
            'discounts' => [
                ['name' => '–û—Ç 50 —Ñ–æ—Ç–æ', 'threshold' => 50, 'discount_percent' => 10, 'enabled' => true],
                ['name' => '–û—Ç 100 —Ñ–æ—Ç–æ', 'threshold' => 100, 'discount_percent' => 15, 'enabled' => true],
                ['name' => '–û—Ç 200 —Ñ–æ—Ç–æ', 'threshold' => 200, 'discount_percent' => 20, 'enabled' => false]
            ]
        ];
        @file_put_contents($photoConfigFile, json_encode($photoConfig, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
    }

    return $photoConfig;
}

$photoConfig = loadPhotoConfig($photoConfigFile);

// –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤–∫–ª—é—á–µ–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏
$enabledSizes = array_filter($photoConfig['sizes'] ?? [], function($item) { return !empty($item['enabled']); });
$enabledPapers = array_filter($photoConfig['papers'] ?? [], function($item) { return !empty($item['enabled']); });
$enabledCorrections = array_filter($photoConfig['corrections'] ?? [], function($item) { return !empty($item['enabled']); });
$enabledProcessingOptions = array_filter($photoConfig['processing_options'] ?? [], function($item) { return !empty($item['enabled']); });
$enabledDeliveryOptions = array_filter($photoConfig['delivery_options'] ?? [], function($item) { return !empty($item['enabled']); });
$enabledDiscounts = array_filter($photoConfig['discounts'] ?? [], function($item) { return !empty($item['enabled']); });

// Helpers
function esc($s){ return htmlspecialchars((string)$s, ENT_QUOTES|ENT_SUBSTITUTE, 'UTF-8'); }
function sanitize_text($s){ return trim(filter_var($s, FILTER_SANITIZE_FULL_SPECIAL_CHARS)); }

// CRM —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
function update_customer_info($customersFile, $name, $phone, $email = '', $orderData = null) {
    $customers = json_decode(@file_get_contents($customersFile), true) ?? [];

    $phone_clean = preg_replace('/[^0-9]/', '', $phone);
    $customer_id = $phone_clean;

    $existingCustomer = null;
    foreach ($customers as $key => $customer) {
        if ($customer['id'] === $customer_id) {
            $existingCustomer = $key;
            break;
        }
    }

    if ($existingCustomer !== null) {
        $customers[$existingCustomer]['last_contact'] = date('Y-m-d H:i:s');
        $customers[$existingCustomer]['orders_count']++;

        if ($orderData) {
            $customers[$existingCustomer]['total_spent'] += $orderData['total'] ?? 0;
            $customers[$existingCustomer]['orders'][] = [
                'id' => $orderData['id'],
                'date' => date('Y-m-d H:i:s'),
                'type' => $orderData['type'] ?? 'service',
                'total' => $orderData['total'] ?? 0,
                'status' => $orderData['status'] ?? 'new'
            ];
        }

        if ($email) $customers[$existingCustomer]['email'] = $email;
        if ($name) $customers[$existingCustomer]['name'] = $name;
    } else {
        $customers[] = [
            'id' => $customer_id,
            'name' => $name,
            'phone' => $phone,
            'email' => $email,
            'created_at' => date('Y-m-d H:i:s'),
            'last_contact' => date('Y-m-d H:i:s'),
            'orders_count' => 1,
            'total_spent' => $orderData['total'] ?? 0,
            'notes' => '',
            'tags' => ['–§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä'],
            'orders' => $orderData ? [[
                'id' => $orderData['id'],
                'date' => date('Y-m-d H:i:s'),
                'type' => $orderData['type'] ?? 'service',
                'total' => $orderData['total'] ?? 0,
                'status' => $orderData['status'] ?? 'new'
            ]] : []
        ];
    }

    @file_put_contents($customersFile, json_encode($customers, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
}

// –£–õ–£–ß–®–ï–ù–ù–ê–Ø –æ—Ç–ø—Ä–∞–≤–∫–∞ email —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–∞ artcopy78@bk.ru
function send_email_guaranteed($to, $subject, $body, $cfg, $uploadedPhotos = []) {
    $success = false;
    $attempts = [];

    // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è
    $mainEmail = 'artcopy78@bk.ru';
    $backupEmails = ['artcopy78@bk.ru', $to]; // –î—É–±–ª–∏—Ä—É–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –∏ —É–∫–∞–∑–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å

    $from = $cfg['email_from'] ?? 'noreply@' . ($_SERVER['HTTP_HOST'] ?? 'localhost');

    // –ü–æ–ø—ã—Ç–∫–∞ 1: SMTP –æ—Ç–ø—Ä–∞–≤–∫–∞ –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
    if (!empty($cfg['smtp']['enabled'])) {
        foreach ($backupEmails as $recipient) {
            if (send_smtp_email($recipient, $subject, $body, $cfg)) {
                $success = true;
                $attempts[] = "SMTP —É—Å–ø–µ—à–Ω–æ –Ω–∞ $recipient";
            } else {
                $attempts[] = "SMTP –æ—à–∏–±–∫–∞ –Ω–∞ $recipient";
            }
        }
    }

    // –ü–æ–ø—ã—Ç–∫–∞ 2: –û–±—ã—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ mail()
    $headers = "From: $from\r\n";
    $headers .= 'Reply-To: ' . ($cfg['email_reply'] ?: $from) . "\r\n";
    $headers .= "Content-Type: text/plain; charset=UTF-8\r\n";
    $headers .= "X-Mailer: PhotoConstructor/3.0\r\n";

    // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –∫–æ–ø–∏—Ä—É–µ–º –Ω–∞ artcopy78@bk.ru
    $headers .= "CC: artcopy78@bk.ru\r\n";
    $headers .= "BCC: artcopy78@bk.ru\r\n";

    if (@mail($mainEmail, '=?UTF-8?B?'.base64_encode($subject).'?=', $body, $headers)) {
        $success = true;
        $attempts[] = "PHP mail() —É—Å–ø–µ—à–Ω–æ –Ω–∞ $mainEmail";
    } else {
        $attempts[] = "PHP mail() –æ—à–∏–±–∫–∞ –Ω–∞ $mainEmail";
    }

    // –ü–æ–ø—ã—Ç–∫–∞ 3: –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ curl –Ω–∞ –≤–Ω–µ—à–Ω–∏–π API (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Å–ø–æ—Å–æ–±)
    try {
        $mailData = [
            'to' => $mainEmail,
            'subject' => $subject,
            'body' => $body,
            'from' => $from,
            'timestamp' => date('c')
        ];

        // –õ–æ–≥–∏—Ä—É–µ–º –≤ —Ñ–∞–π–ª –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Å–ø–æ—Å–æ–±
        @file_put_contents(__DIR__.'/email_backup.log', 
            "[".date('Y-m-d H:i:s')."] EMAIL_BACKUP: ".json_encode($mailData, JSON_UNESCAPED_UNICODE)."\n", 
            FILE_APPEND
        );
        $attempts[] = "Backup log –∑–∞–ø–∏—Å–∞–Ω";
    } catch (Exception $e) {
        $attempts[] = "Backup log –æ—à–∏–±–∫–∞: " . $e->getMessage();
    }

    // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏
    $logEntry = "[".date('Y-m-d H:i:s')."] EMAIL_DELIVERY_LOG: " . implode(' | ', $attempts) . "\n";
    @file_put_contents(__DIR__.'/orders.txt', $logEntry, FILE_APPEND);

    return $success;
}

function send_smtp_email($to, $subject, $body, $cfg) {
    // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è SMTP —á–µ—Ä–µ–∑ fsockopen
    $smtp = $cfg['smtp'];
    $host = $smtp['host'] ?? 'smtp.mail.ru';
    $port = $smtp['port'] ?? 465;
    $user = $smtp['user'] ?? '';
    $pass = $smtp['pass'] ?? '';
    $secure = $smtp['secure'] ?? 'ssl';

    if (!$user || !$pass) return false;

    try {
        $context = stream_context_create([
            'ssl' => [
                'verify_peer' => false,
                'verify_peer_name' => false,
                'allow_self_signed' => true
            ]
        ]);

        $conn = $secure === 'ssl'
            ? stream_socket_client("ssl://$host:$port", $errno, $errstr, 30, STREAM_CLIENT_CONNECT, $context)
            : fsockopen($host, $port, $errno, $errstr, 30);

        if (!$conn) return false;

        // SMTP –∫–æ–º–∞–Ω–¥—ã
        fgets($conn, 512);
        fputs($conn, "EHLO $host\r\n");
        fgets($conn, 512);

        if ($secure === 'tls') {
            fputs($conn, "STARTTLS\r\n");
            fgets($conn, 512);
            stream_socket_enable_crypto($conn, true, STREAM_CRYPTO_METHOD_TLS_CLIENT);
            fputs($conn, "EHLO $host\r\n");
            fgets($conn, 512);
        }

        fputs($conn, "AUTH LOGIN\r\n");
        fgets($conn, 512);
        fputs($conn, base64_encode($user) . "\r\n");
        fgets($conn, 512);
        fputs($conn, base64_encode($pass) . "\r\n");
        fgets($conn, 512);

        fputs($conn, "MAIL FROM: <$user>\r\n");
        fgets($conn, 512);
        fputs($conn, "RCPT TO: <$to>\r\n");
        fgets($conn, 512);
        fputs($conn, "DATA\r\n");
        fgets($conn, 512);

        $email_data = "From: $user\r\n";
        $email_data .= "To: $to\r\n";
        $email_data .= 'Subject: =?UTF-8?B?' . base64_encode($subject) . "?=\r\n";
        $email_data .= "Content-Type: text/plain; charset=UTF-8\r\n";
        $email_data .= "Content-Transfer-Encoding: 8bit\r\n\r\n";
        $email_data .= "$body\r\n.\r\n";

        fputs($conn, $email_data);
        fgets($conn, 512);
        fputs($conn, "QUIT\r\n");
        fclose($conn);

        return true;
    } catch (Exception $e) {
        return false;
    }
}

// Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function send_telegram($cfg, $message) {
    if (empty($cfg['telegram']['enabled']) || empty($cfg['telegram']['token']) || empty($cfg['telegram']['chat'])) {
        return false;
    }

    $url = 'https://api.telegram.org/bot' . $cfg['telegram']['token'] . '/sendMessage';
    $data = [
        'chat_id' => $cfg['telegram']['chat'],
        'text' => $message,
        'parse_mode' => 'HTML',
        'disable_web_page_preview' => true
    ];

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data));
    curl_setopt($ch, CURLOPT_TIMEOUT, 15);
    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 10);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    $result = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    return $result !== false && $httpCode === 200;
}

// –ù–û–í–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è ZIP –∞—Ä—Ö–∏–≤–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –¥–ª—è CRM
function create_photos_archive($uploadedPhotos, $orderId, $uploadsDir) {
    if (empty($uploadedPhotos) || !extension_loaded('zip')) {
        return null;
    }

    $archiveName = "photos_order_{$orderId}_" . date('Ymd_His') . '.zip';
    $archivePath = $uploadsDir . '/' . $archiveName;

    $zip = new ZipArchive();
    if ($zip->open($archivePath, ZipArchive::CREATE) === TRUE) {
        $addedFiles = 0;

        foreach ($uploadedPhotos as $i => $photo) {
            $filePath = $uploadsDir . '/' . $photo['filename'];

            if (file_exists($filePath)) {
                // –°–æ–∑–¥–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ –≤ –∞—Ä—Ö–∏–≤–µ
                $archiveFileName = sprintf('%03d_%s', 
                    $i + 1, 
                    $photo['original_name']
                );

                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±—Ä–∞–±–æ—Ç–∫–µ –µ—Å–ª–∏ –µ—Å—Ç—å
                if (!empty($photo['edit_params'])) {
                    $editInfo = [];
                    if ($photo['edit_params']['brightness'] != 0) {
                        $editInfo[] = "—è—Ä–∫–æ—Å—Ç—å" . $photo['edit_params']['brightness'];
                    }
                    if ($photo['edit_params']['contrast'] != 0) {
                        $editInfo[] = "–∫–æ–Ω—Ç—Ä–∞—Å—Ç" . $photo['edit_params']['contrast'];
                    }
                    if ($photo['edit_params']['crop']) {
                        $editInfo[] = "–∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ";
                    }
                    if ($photo['edit_params']['polaroid']) {
                        $editInfo[] = "polaroid";
                    }

                    if (!empty($editInfo)) {
                        $editSuffix = '_[' . implode('_', $editInfo) . ']';
                        $pathinfo = pathinfo($archiveFileName);
                        $archiveFileName = $pathinfo['filename'] . $editSuffix . '.' . $pathinfo['extension'];
                    }
                }

                if ($zip->addFile($filePath, $archiveFileName)) {
                    $addedFiles++;
                }
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–∞–∫–∞–∑–µ
        $orderInfo = "–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ó–ê–ö–ê–ó–ï\n";
        $orderInfo .= "ID: $orderId\n";
        $orderInfo .= "–î–∞—Ç–∞: " . date('d.m.Y H:i:s') . "\n";
        $orderInfo .= "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ: " . count($uploadedPhotos) . "\n";
        $orderInfo .= "–°–æ–∑–¥–∞–Ω: " . date('d.m.Y H:i:s') . "\n\n";

        $orderInfo .= "–°–ü–ò–°–û–ö –§–ê–ô–õ–û–í –° –ü–ê–†–ê–ú–ï–¢–†–ê–ú–ò –û–ë–†–ê–ë–û–¢–ö–ò:\n";
        foreach ($uploadedPhotos as $i => $photo) {
            $orderInfo .= ($i + 1) . ". " . $photo['original_name'] . "\n";
            $orderInfo .= "   –†–∞–∑–º–µ—Ä: " . round($photo['size']/1024, 1) . " –ö–ë\n";
            $orderInfo .= "   –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: " . $photo['dimensions'] . "\n";

            if (!empty($photo['edit_params'])) {
                $orderInfo .= "   –ü–ê–†–ê–ú–ï–¢–†–´ –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø:\n";
                if ($photo['edit_params']['brightness'] != 0) {
                    $orderInfo .= "   - –Ø—Ä–∫–æ—Å—Ç—å: " . $photo['edit_params']['brightness'] . "\n";
                }
                if ($photo['edit_params']['contrast'] != 0) {
                    $orderInfo .= "   - –ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å: " . $photo['edit_params']['contrast'] . "\n";
                }
                if ($photo['edit_params']['crop']) {
                    $crop = $photo['edit_params']['crop'];
                    $orderInfo .= "   - –ö–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ: x={$crop['x']}, y={$crop['y']}, w={$crop['width']}, h={$crop['height']}\n";
                }
                if ($photo['edit_params']['polaroid']) {
                    $orderInfo .= "   - –°—Ç–∏–ª—å Polaroid: –î–ê (–±–µ–ª–∞—è —Ä–∞–º–∫–∞ –≤ —Ä–µ—Ç—Ä–æ-—Å—Ç–∏–ª–µ)\n";
                }
            }
            $orderInfo .= "\n";
        }

        $zip->addFromString('–ò–ù–§–û–†–ú–ê–¶–ò–Ø_–û_–ó–ê–ö–ê–ó–ï.txt', $orderInfo);

        if ($zip->close() && $addedFiles > 0) {
            return [
                'filename' => $archiveName,
                'path' => $archivePath,
                'files_count' => $addedFiles,
                'size' => filesize($archivePath)
            ];
        }
    }

    return null;
}

// API –¥–ª—è –∫–æ–Ω—Ñ–∏–≥–∞ (–ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –∞–¥–º–∏–Ω–∫–æ–π)
if (isset($_GET['api']) && $_GET['api'] === 'config') {
    header('Content-Type: application/json; charset=utf-8');

    // –ü–µ—Ä–µ–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ –Ω–∞ —Å–ª—É—á–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏–π
    $photoConfig = loadPhotoConfig($photoConfigFile);

    $response = [
        'enabled' => !empty($photoConfig['enabled']),
        'max_photos' => $photoConfig['max_photos'] ?? 100,
        'max_file_size' => $photoConfig['max_file_size'] ?? 10,
        'supported_formats' => $photoConfig['supported_formats'] ?? ['jpg', 'jpeg', 'png'],
        'sizes' => array_values(array_filter($photoConfig['sizes'] ?? [], function($item) { return !empty($item['enabled']); })),
        'papers' => array_values(array_filter($photoConfig['papers'] ?? [], function($item) { return !empty($item['enabled']); })),
        'corrections' => array_values(array_filter($photoConfig['corrections'] ?? [], function($item) { return !empty($item['enabled']); })),
        'processing_options' => array_values(array_filter($photoConfig['processing_options'] ?? [], function($item) { return !empty($item['enabled']); })),
        'delivery_options' => array_values(array_filter($photoConfig['delivery_options'] ?? [], function($item) { return !empty($item['enabled']); })),
        'discounts' => array_values(array_filter($photoConfig['discounts'] ?? [], function($item) { return !empty($item['enabled']); }))
    ];

    echo json_encode($response, JSON_UNESCAPED_UNICODE);
    exit;
}

// –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ –∏–∑ CRM –∞–¥–º–∏–Ω–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–∞
if (isset($_GET['download_photo']) && !empty($_GET['filename'])) {
    $filename = basename($_GET['filename']);
    $filepath = $uploadsDir . '/' . $filename;

    if (file_exists($filepath) && preg_match('/^photo_/', $filename)) {
        $mimeType = mime_content_type($filepath);
        if (strpos($mimeType, 'image/') === 0) {
            header('Content-Type: ' . $mimeType);
            header('Content-Disposition: attachment; filename=\'' . $filename . '\'');
            header('Content-Length: ' . filesize($filepath));
            header('Cache-Control: private');
            header('Expires: 0');
            readfile($filepath);
            exit;
        }
    }

    http_response_code(404);
    echo '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
    exit;
}

// –ù–û–í–´–ô API –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–∞ –≤—Å–µ—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∑–∞–∫–∞–∑–∞ –∏–∑ CRM
if (isset($_GET['download_archive']) && !empty($_GET['order_id'])) {
    $orderId = sanitize_text($_GET['order_id']);

    // –ò—â–µ–º –∞—Ä—Ö–∏–≤ –≤ –ø–∞–ø–∫–µ uploads
    $pattern = $uploadsDir . "/photos_order_{$orderId}_*.zip";
    $archiveFiles = glob($pattern);

    if (!empty($archiveFiles)) {
        $archivePath = $archiveFiles[0]; // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π –∞—Ä—Ö–∏–≤
        $filename = basename($archivePath);

        if (file_exists($archivePath)) {
            header('Content-Type: application/zip');
            header('Content-Disposition: attachment; filename=\'' . $filename . '\'');
            header('Content-Length: ' . filesize($archivePath));
            header('Cache-Control: private');
            header('Expires: 0');
            readfile($archivePath);
            exit;
        }
    }

    // –ï—Å–ª–∏ –∞—Ä—Ö–∏–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å –µ–≥–æ –∏–∑ –ª–æ–≥–æ–≤ –∑–∞–∫–∞–∑–æ–≤
    $ordersContent = @file_get_contents($ordersLog);
    if ($ordersContent) {
        $lines = explode("\n", $ordersContent);
        foreach ($lines as $line) {
            if (strpos($line, $orderId) !== false && strpos($line, '"photos"') !== false) {
                // –ù–∞—à–ª–∏ –∑–∞–∫–∞–∑, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è—Ö
                preg_match('/\{.*\}/', $line, $matches);
                if (!empty($matches)) {
                    $orderData = json_decode($matches[0], true);
                    if ($orderData && !empty($orderData['details']['photos'])) {
                        $archive = create_photos_archive($orderData['details']['photos'], $orderId, $uploadsDir);
                        if ($archive) {
                            header('Content-Type: application/zip');
                            header('Content-Disposition: attachment; filename=\'' . $archive['filename'] . '\'');
                            header('Content-Length: ' . $archive['size']);
                            header('Cache-Control: private');
                            header('Expires: 0');
                            readfile($archive['path']);
                            exit;
                        }
                    }
                }
                break;
            }
        }
    }

    http_response_code(404);
    echo '–ê—Ä—Ö–∏–≤ –∑–∞–∫–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω';
    exit;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–∞ —Ñ–æ—Ç–æ
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['mode']) && $_POST['mode'] === 'photo_order') {
    header('Content-Type: application/json; charset=utf-8');

    try {
        // –ü–µ—Ä–µ–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
        $photoConfig = loadPhotoConfig($photoConfigFile);

        if (empty($photoConfig['enabled'])) {
            throw new Exception('–§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω');
        }

        $name = sanitize_text($_POST['name'] ?? '');
        $email = sanitize_text($_POST['email'] ?? '');
        $phone = sanitize_text($_POST['phone'] ?? '');
        $comment = sanitize_text($_POST['comment'] ?? '');
        $size = sanitize_text($_POST['size'] ?? '');
        $paper = sanitize_text($_POST['paper'] ?? '');
        $qty = max(1, (int)($_POST['qty'] ?? 1));
        $correction = sanitize_text($_POST['correction'] ?? '');
        $paymentMethod = sanitize_text($_POST['payment_method'] ?? 'offline');
        $delivery = sanitize_text($_POST['delivery'] ?? '');

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏
        $processingOptions = [];
        if (isset($_POST['processing_options']) && is_array($_POST['processing_options'])) {
            $processingOptions = array_map('sanitize_text', $_POST['processing_options']);
        }

        if (!$name || !$phone) {
            throw new Exception('–£–∫–∞–∂–∏—Ç–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω');
        }

        if ($email && !filter_var($email, FILTER_VALIDATE_EMAIL)) {
            throw new Exception('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å');
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        $phoneClean = preg_replace('/[^0-9+]/', '', $phone);
        if (strlen($phoneClean) < 10) {
            throw new Exception('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ —Å –£–õ–£–ß–®–ï–ù–ù–´–ú–ò —Ä–µ–¥–∞–∫—Ç–æ—Ä—Å–∫–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        $uploadedPhotos = [];
        $photoCount = 0;
        $maxPhotos = $photoConfig['max_photos'] ?? 100;
        $maxFileSize = ($photoConfig['max_file_size'] ?? 10) * 1024 * 1024;
        $allowedFormats = $photoConfig['supported_formats'] ?? ['jpg', 'jpeg', 'png'];

        if (isset($_FILES['photos']) && is_array($_FILES['photos']['name'])) {
            $totalFiles = count($_FILES['photos']['name']);

            for ($i = 0; $i < min($totalFiles, $maxPhotos); $i++) {
                if ($_FILES['photos']['error'][$i] !== UPLOAD_ERR_OK) continue;

                $tmpPath = $_FILES['photos']['tmp_name'][$i];
                $originalName = $_FILES['photos']['name'][$i];
                $fileSize = $_FILES['photos']['size'][$i];

                if ($fileSize > $maxFileSize) continue;

                $imageInfo = @getimagesize($tmpPath);
                if ($imageInfo === false) continue;

                $ext = strtolower(pathinfo($originalName, PATHINFO_EXTENSION));
                if (!in_array($ext, $allowedFormats)) continue;

                // –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                $newName = 'photo_' . date('Ymd_His') . '_' . sprintf('%04d', $i) . '_' . bin2hex(random_bytes(4)) . '.' . $ext;
                $newPath = $uploadsDir . '/' . $newName;

                if (move_uploaded_file($tmpPath, $newPath)) {
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
                    @chmod($newPath, 0644);

                    // –£–õ–£–ß–®–ï–ù–ù–ê–Ø –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                    $editParams = [
                        'brightness' => 0,
                        'contrast' => 0,
                        'crop' => null,
                        'polaroid' => false
                    ];

                    if (isset($_POST['edit_params'][$i]) && is_array($_POST['edit_params'][$i])) {
                        $editData = $_POST['edit_params'][$i];

                        // –Ø—Ä–∫–æ—Å—Ç—å (-100 –¥–æ 100)
                        if (isset($editData['brightness'])) {
                            $editParams['brightness'] = max(-100, min(100, (int)$editData['brightness']));
                        }

                        // –ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å (-100 –¥–æ 100) 
                        if (isset($editData['contrast'])) {
                            $editParams['contrast'] = max(-100, min(100, (int)$editData['contrast']));
                        }

                        // –ö–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                        if (isset($editData['crop']) && is_array($editData['crop'])) {
                            $crop = $editData['crop'];
                            if (isset($crop['x'], $crop['y'], $crop['width'], $crop['height'])) {
                                $editParams['crop'] = [
                                    'x' => max(0, (float)$crop['x']),
                                    'y' => max(0, (float)$crop['y']),
                                    'width' => max(1, (float)$crop['width']),
                                    'height' => max(1, (float)$crop['height'])
                                ];
                            }
                        }

                        // –°—Ç–∏–ª—å Polaroid
                        if (isset($editData['polaroid'])) {
                            $editParams['polaroid'] = !empty($editData['polaroid']) && $editData['polaroid'] !== '0';
                        }
                    }

                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ–º Polaroid –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è —É—Å–ª—É–≥–∞
                    if (in_array('–°—Ç–∏–ª—å –ü–æ–ª–∞—Ä–æ–∏–¥', $processingOptions)) {
                        $editParams['polaroid'] = true;
                    }

                    $uploadedPhotos[] = [
                        'filename' => $newName,
                        'original_name' => $originalName,
                        'size' => $fileSize,
                        'dimensions' => $imageInfo[0] . 'x' . $imageInfo[1],
                        'mime_type' => $imageInfo['mime'],
                        'upload_time' => date('Y-m-d H:i:s'),
                        'edit_params' => $editParams // –£–õ–£–ß–®–ï–ù–ù–´–ï –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    ];
                    $photoCount++;
                }
            }
        }

        if ($photoCount === 0) {
            throw new Exception('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ñ–æ—Ç–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∏ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤.');
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–µ—á–∞—Ç–∏ –∏–∑ –∞–¥–º–∏–Ω–∫–∏ - –ò–°–ü–†–ê–í–õ–ï–ù–ê –û–®–ò–ë–ö–ê
        $enabledSizes = array_values(array_filter($photoConfig['sizes'] ?? [], function($item) { return !empty($item['enabled']); }));
        $enabledPapers = array_values(array_filter($photoConfig['papers'] ?? [], function($item) { return !empty($item['enabled']); }));
        $enabledCorrections = array_values(array_filter($photoConfig['corrections'] ?? [], function($item) { return !empty($item['enabled']); }));

        $sizeConfig = null;
        foreach ($enabledSizes as $s) {
            if ($s['name'] === $size) {
                $sizeConfig = $s;
                break;
            }
        }
        if (!$sizeConfig) {
            // –ò–°–ü–†–ê–í–õ–ï–ù–ê –û–®–ò–ë–ö–ê: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≤–º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏
            if (!empty($enabledSizes)) {
                $sizeConfig = $enabledSizes[0];
                $size = $sizeConfig['name'];
            } else {
                throw new Exception('–†–∞–∑–º–µ—Ä—ã —Ñ–æ—Ç–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
            }
        }

        $paperConfig = null;
        foreach ($enabledPapers as $p) {
            if ($p['name'] === $paper) {
                $paperConfig = $p;
                break;
            }
        }
        if (!$paperConfig) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ç–∏–ø –±—É–º–∞–≥–∏
            if (!empty($enabledPapers)) {
                $paperConfig = $enabledPapers[0];
                $paper = $paperConfig['name'];
            } else {
                throw new Exception('–¢–∏–ø—ã –±—É–º–∞–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
            }
        }

        $correctionConfig = null;
        foreach ($enabledCorrections as $c) {
            if ($c['name'] === $correction) {
                $correctionConfig = $c;
                break;
            }
        }
        if (!$correctionConfig) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ç–∏–ø –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
            if (!empty($enabledCorrections)) {
                $correctionConfig = $enabledCorrections[0];
                $correction = $correctionConfig['name'];
            } else {
                throw new Exception('–¢–∏–ø—ã –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
            }
        }

        // –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –æ–ø—Ü–∏–π
        $basePrice = $sizeConfig['base'];
        $paperDelta = $paperConfig['delta'];
        $correctionDelta = $correctionConfig['delta'];

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏
        $processingCost = 0;
        $selectedProcessing = [];
        $enabledProcessingOptions = array_filter($photoConfig['processing_options'] ?? [], function($item) { return !empty($item['enabled']); });

        foreach ($processingOptions as $procName) {
            foreach ($enabledProcessingOptions as $proc) {
                if ($proc['name'] === $procName) {
                    $processingCost += $proc['price'];
                    $selectedProcessing[] = $proc;
                    break;
                }
            }
        }

        // –î–æ—Å—Ç–∞–≤–∫–∞
        $deliveryCost = 0;
        $deliveryConfig = null;
        if ($delivery) {
            $enabledDeliveryOptions = array_filter($photoConfig['delivery_options'] ?? [], function($item) { return !empty($item['enabled']); });
            foreach ($enabledDeliveryOptions as $deliv) {
                if ($deliv['name'] === $delivery) {
                    $deliveryCost = $deliv['price'];
                    $deliveryConfig = $deliv;
                    break;
                }
            }
        }

        $pricePerPhoto = $basePrice + $paperDelta + $correctionDelta;
        $totalPhotoCost = $pricePerPhoto * $qty * $photoCount;
        $totalProcessingCost = $processingCost * $photoCount;
        $totalPrice = $totalPhotoCost + $totalProcessingCost + $deliveryCost;

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫–∏ –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        $discount = 0;
        $discountInfo = null;
        $enabledDiscounts = array_filter($photoConfig['discounts'] ?? [], function($item) { return !empty($item['enabled']); });

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –ø–æ—Ä–æ–≥–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–∏–¥–∫–∏
        usort($enabledDiscounts, function($a, $b) {
            return $b['threshold'] - $a['threshold'];
        });

        foreach ($enabledDiscounts as $discountRule) {
            if ($photoCount >= $discountRule['threshold']) {
                $discount = $discountRule['discount_percent'];
                $discountInfo = $discountRule;
                break;
            }
        }

        $discountAmount = 0;
        if ($discount > 0) {
            $discountAmount = ($totalPhotoCost + $totalProcessingCost) * ($discount / 100);
            $totalPrice -= $discountAmount;
        }

        // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–∫–∞–∑–∞
        $orderId = 'photo_' . time() . '_' . rand(1000, 9999);

        // –ü–û–õ–ù–ê–Ø —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–∫–∞–∑–∞ –¥–ª—è CRM
        $order = [
            'id' => $orderId,
            'type' => 'photo_constructor',
            'timestamp' => date('Y-m-d H:i:s'),
            'name' => $name,
            'phone' => $phone,
            'email' => $email,
            'customer' => [
                'name' => $name,
                'phone' => $phone,
                'email' => $email,
                'phone_clean' => preg_replace('/[^0-9]/', '', $phone)
            ],
            'details' => [
                'size' => $size,
                'size_config' => $sizeConfig,
                'paper' => $paper,
                'paper_config' => $paperConfig,
                'qty_per_photo' => $qty,
                'correction' => $correction,
                'correction_config' => $correctionConfig,
                'processing_options' => $selectedProcessing,
                'delivery' => $delivery,
                'delivery_config' => $deliveryConfig,
                'photo_count' => $photoCount,
                'photos' => $uploadedPhotos, // –°–û–î–ï–†–ñ–ò–¢ –í–°–ï –§–û–¢–û –° –ü–ê–†–ê–ú–ï–¢–†–ê–ú–ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø
                'comment' => $comment
            ],
            'pricing' => [
                'base_price_per_photo' => $basePrice,
                'paper_delta' => $paperDelta,
                'correction_delta' => $correctionDelta,
                'processing_cost_per_photo' => $processingCost,
                'price_per_photo' => $pricePerPhoto,
                'total_photos' => $photoCount,
                'total_copies' => $photoCount * $qty,
                'photo_cost' => $totalPhotoCost,
                'processing_cost' => $totalProcessingCost,
                'delivery_cost' => $deliveryCost,
                'discount_percent' => $discount,
                'discount_amount' => $discountAmount,
                'discount_info' => $discountInfo,
                'estimated_price' => $totalPrice,
                'total_price' => $totalPrice
            ],
            'payment_method' => $paymentMethod,
            'status' => $paymentMethod === 'online' ? 'pending_payment' : 'new',
            'created_at' => date('Y-m-d H:i:s'),
            'ip' => $_SERVER['REMOTE_ADDR'] ?? '',
            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? '',
            'source' => 'photo_constructor_premium_v3.0'
        ];

        // –°–û–ó–î–ê–ï–ú –ê–†–•–ò–í –§–û–¢–û–ì–†–ê–§–ò–ô –î–õ–Ø CRM –ê–î–ú–ò–ù–ö–ò
        $photosArchive = create_photos_archive($uploadedPhotos, $orderId, $uploadsDir);
        if ($photosArchive) {
            $order['archive'] = $photosArchive;
        }

        // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–∫–∞–∑ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
        @file_put_contents($ordersLog, '['.date('Y-m-d H:i:s').'] '.json_encode($order, JSON_UNESCAPED_UNICODE).PHP_EOL, FILE_APPEND);

        // –û–±–Ω–æ–≤–ª—è–µ–º CRM –±–∞–∑—É –∫–ª–∏–µ–Ω—Ç–æ–≤
        $crmOrderData = [
            'id' => $orderId,
            'type' => 'photo_constructor',
            'total' => $totalPrice,
            'status' => $order['status']
        ];
        update_customer_info($customersFile, $name, $phone, $email, $crmOrderData);

        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç
        $response = [
            'ok' => true,
            'order_id' => $orderId,
            'photo_count' => $photoCount,
            'total_copies' => $photoCount * $qty,
            'estimated_price' => $totalPrice,
            'discount' => $discount > 0 ? $discount : null,
            'discount_amount' => $discountAmount > 0 ? $discountAmount : null,
            'processing_cost' => $totalProcessingCost > 0 ? $totalProcessingCost : null,
            'delivery_cost' => $deliveryCost > 0 ? $deliveryCost : null,
            'archive_created' => !empty($photosArchive)
        ];

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç—ã –Æ–ö–∞—Å—Å–∞
        if ($paymentMethod === 'online' && !empty($cfg['yukassa']['enabled']) && !empty($cfg['yukassa']['services']['photo_constructor'])) {
            $shop_id = $cfg['yukassa']['shop_id'];
            $secret_key = $cfg['yukassa']['secret_key'];
            $return_url = $cfg['yukassa']['return_url'] ?? ($cfg['site'] . '/payment_result.php');

            if ($shop_id && $secret_key && $totalPrice > 0) {
                $url = 'https://api.yookassa.ru/v3/payments';

                $paymentDescription = "–§–æ—Ç–æ–ø–µ—á–∞—Ç—å: $photoCount —Ñ–æ—Ç–æ √ó $qty —ç–∫–∑.";
                if ($deliveryConfig) $paymentDescription .= ' + ' . $deliveryConfig['name'];

                $data = [
                    'amount' => ['value' => number_format($totalPrice, 2, '.', ''), 'currency' => 'RUB'],
                    'confirmation' => ['type' => 'redirect', 'return_url' => $return_url . '?order_id=' . urlencode($orderId)],
                    'description' => $paymentDescription,
                    'metadata' => [
                        'order_id' => $orderId,
                        'type' => 'photo_constructor',
                        'customer_phone' => $phone,
                        'customer_name' => $name,
                        'photo_count' => $photoCount
                    ],
                    'capture' => true
                ];

                $ch = curl_init($url);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                curl_setopt($ch, CURLOPT_POST, true);
                curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
                curl_setopt($ch, CURLOPT_HTTPHEADER, [
                    'Content-Type: application/json',
                    'Idempotence-Key: ' . uniqid('photo_', true),
                    'Authorization: Basic ' . base64_encode($shop_id . ':' . $secret_key)
                ]);
                curl_setopt($ch, CURLOPT_TIMEOUT, 30);
                curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 10);

                $result = curl_exec($ch);
                $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                curl_close($ch);

                if ($result && $httpCode === 200) {
                    $paymentResponse = json_decode($result, true);
                    if ($paymentResponse && isset($paymentResponse['confirmation']['confirmation_url'])) {
                        $response['payment'] = true;
                        $response['payment_url'] = $paymentResponse['confirmation']['confirmation_url'];
                        $response['payment_id'] = $paymentResponse['id'];
                        $response['message'] = '–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–ø–ª–∞—Ç–µ...';

                        // –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ–∂–µ
                        $order['payment'] = [
                            'payment_id' => $paymentResponse['id'],
                            'payment_url' => $paymentResponse['confirmation']['confirmation_url'],
                            'amount' => $paymentResponse['amount']['value']
                        ];
                        @file_put_contents($ordersLog, '['.date('Y-m-d H:i:s').'] PAYMENT_CREATED: '.json_encode($order['payment'], JSON_UNESCAPED_UNICODE).PHP_EOL, FILE_APPEND);

                        echo json_encode($response);
                        exit;
                    }
                }
            }
        }

        // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–∞ artcopy78@bk.ru —Å–æ –í–°–ï–ú–ò —Å–ø–æ—Å–æ–±–∞–º–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
        $emailTo = 'artcopy78@bk.ru'; // –ñ–ï–°–¢–ö–û –∑–∞–¥–∞–µ–º –∞–¥—Ä–µ—Å

        // –ú–ï–ì–ê-–î–ï–¢–ê–õ–¨–ù–û–ï –ø–∏—Å—å–º–æ –¥–ª—è –∞–¥–º–∏–Ω–∞ —Å –ü–û–õ–ù–û–ô –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
        $emailBody = 'üéØ –ù–û–í–´–ô –ó–ê–ö–ê–ó –§–û–¢–û–ö–û–ù–°–¢–†–£–ö–¢–û–†–ê –ü–†–ï–ú–ò–£–ú v3.0 üéØ' . "\n\n";
        $emailBody .= '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê' . "\n";
        $emailBody .= 'üìã –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ó–ê–ö–ê–ó–ï' . "\n";
        $emailBody .= '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê' . "\n";
        $emailBody .= "ID –∑–∞–∫–∞–∑–∞: $orderId\n";
        $emailBody .= '–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: ' . date('d.m.Y H:i:s') . "\n";
        $emailBody .= '–ò—Å—Ç–æ—á–Ω–∏–∫: –§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ü—Ä–µ–º–∏—É–º v3.0 (–£–õ–£–ß–®–ï–ù–ù–´–ô –†–ï–î–ê–ö–¢–û–†)' . "\n";
        $emailBody .= 'IP –∞–¥—Ä–µ—Å: ' . ($order['ip'] ?: '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω') . "\n";

        if ($photosArchive) {
            $emailBody .= 'üì¶ –ê–†–•–ò–í –°–û–ó–î–ê–ù: ' . $photosArchive['filename'] . ' (' . round($photosArchive['size']/1024/1024, 2) . ' –ú–ë, ' . $photosArchive['files_count'] . ' —Ñ–∞–π–ª–æ–≤)' . "\n";
            $emailBody .= 'üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –∞—Ä—Ö–∏–≤: ' . ($cfg['site'] ?: 'http://' . $_SERVER['HTTP_HOST']) . '/' . basename(__FILE__) . '?download_archive=' . urlencode($orderId) . "\n";
        }
        $emailBody .= "\n";

        $emailBody .= '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê' . "\n";
        $emailBody .= 'üë§ –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ö–õ–ò–ï–ù–¢–ï' . "\n";
        $emailBody .= '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê' . "\n";
        $emailBody .= "–ò–º—è: $name\n";
        $emailBody .= "–¢–µ–ª–µ—Ñ–æ–Ω: $phone\n";
        if ($email) $emailBody .= "Email: $email\n";
        $emailBody .= "\n";

        $emailBody .= '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê' . "\n";
        $emailBody .= 'üì∏ –ü–ê–†–ê–ú–ï–¢–†–´ –ü–ï–ß–ê–¢–ò' . "\n";
        $emailBody .= '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê' . "\n";
        $emailBody .= "–†–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ: $size (" . $sizeConfig['w'] . '√ó' . $sizeConfig['h'] . " —Å–º)\n";
        $emailBody .= "–¢–∏–ø –±—É–º–∞–≥–∏: $paper";
        if ($paperConfig['delta'] > 0) $emailBody .= ' (+' . $paperConfig['delta'] . ' ‚ÇΩ)';
        $emailBody .= "\n";
        $emailBody .= "–¶–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è: $correction";
        if ($correctionConfig['delta'] > 0) $emailBody .= ' (+' . $correctionConfig['delta'] . ' ‚ÇΩ)';
        $emailBody .= "\n";
        $emailBody .= "–¢–∏—Ä–∞–∂: $qty —ç–∫–∑ –Ω–∞ –∫–∞–∂–¥–æ–µ —Ñ–æ—Ç–æ\n";
        $emailBody .= "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ: $photoCount —à—Ç\n";
        $emailBody .= '–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø–µ—á–∞—Ç–∫–æ–≤: ' . ($photoCount * $qty) . " —à—Ç\n";

        if (!empty($selectedProcessing)) {
            $emailBody .= "\nüìé –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏:\n";
            foreach ($selectedProcessing as $proc) {
                $emailBody .= '‚Ä¢ ' . $proc['name'] . ' (' . $proc['price'] . " ‚ÇΩ –∑–∞ —Ñ–æ—Ç–æ)\n";

                // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–º–µ—Ç–∫–∞ –¥–ª—è –ü–æ–ª–∞—Ä–æ–∏–¥
                if ($proc['name'] === '–°—Ç–∏–ª—å –ü–æ–ª–∞—Ä–æ–∏–¥') {
                    $emailBody .= "   üì∏ –í–ê–ñ–ù–û: –§–æ—Ç–æ –±—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –≤ —Å—Ç–∏–ª–µ Polaroid —Å –±–µ–ª–æ–π —Ä–∞–º–∫–æ–π\n";
                    $emailBody .= "   üé® –ö–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è –ø–æ–¥–≥–æ–Ω–∫–∏ —Ñ–æ—Ç–æ –ø–æ–¥ —Å—Ç–∏–ª—å\n";
                }
            }
        }

        if ($deliveryConfig) {
            $emailBody .= "\nüöö –î–æ—Å—Ç–∞–≤–∫–∞: " . $deliveryConfig['name'];
            if ($deliveryConfig['price'] > 0) $emailBody .= ' (+' . $deliveryConfig['price'] . ' ‚ÇΩ)';
            $emailBody .= "\n";
        }

        $emailBody .= "\n";

        $emailBody .= '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê' . "\n";
        $emailBody .= 'üí∞ –†–ê–°–ß–ï–¢ –°–¢–û–ò–ú–û–°–¢–ò' . "\n";
        $emailBody .= '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê' . "\n";
        $emailBody .= '–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –∑–∞ —Ñ–æ—Ç–æ: ' . $sizeConfig['base'] . " ‚ÇΩ\n";
        if ($paperConfig['delta'] > 0) $emailBody .= '–î–æ–ø–ª–∞—Ç–∞ –∑–∞ –±—É–º–∞–≥—É: +' . $paperConfig['delta'] . " ‚ÇΩ\n";
        if ($correctionConfig['delta'] > 0) $emailBody .= '–î–æ–ø–ª–∞—Ç–∞ –∑–∞ –∫–æ—Ä—Ä–µ–∫—Ü–∏—é: +' . $correctionConfig['delta'] . " ‚ÇΩ\n";
        $emailBody .= "–¶–µ–Ω–∞ –∑–∞ 1 –æ—Ç–ø–µ—á–∞—Ç–æ–∫: $pricePerPhoto ‚ÇΩ\n";
        $emailBody .= '–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏: ' . number_format($totalPhotoCost, 0) . " ‚ÇΩ\n";

        if ($totalProcessingCost > 0) {
            $emailBody .= '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏: +' . number_format($totalProcessingCost, 0) . " ‚ÇΩ\n";
        }

        if ($deliveryCost > 0) {
            $emailBody .= '–î–æ—Å—Ç–∞–≤–∫–∞: +' . number_format($deliveryCost, 0) . " ‚ÇΩ\n";
        }

        if ($discount > 0) {
            $emailBody .= "–°–ö–ò–î–ö–ê –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (-$discount%): -" . number_format($discountAmount, 0) . " ‚ÇΩ\n";
        }

        $emailBody .= '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ' . "\n";
        $emailBody .= '–ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï: ' . number_format($totalPrice, 0) . " ‚ÇΩ\n";
        $emailBody .= '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ' . "\n\n";

        if ($comment) {
            $emailBody .= '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê' . "\n";
            $emailBody .= 'üí¨ –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô –ö–õ–ò–ï–ù–¢–ê' . "\n";
            $emailBody .= '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê' . "\n";
            $emailBody .= "$comment\n\n";
        }

        $emailBody .= '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê' . "\n";
        $emailBody .= "üìÅ –ó–ê–ì–†–£–ñ–ï–ù–ù–´–ï –§–ê–ô–õ–´ ($photoCount —à—Ç) - –° –ü–ê–†–ê–ú–ï–¢–†–ê–ú–ò –†–ï–î–ê–ö–¢–û–†–ê\n";
        $emailBody .= '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê' . "\n";
        $totalSize = 0;
        $hasEditedPhotos = false;

        foreach ($uploadedPhotos as $i => $photo) {
            $sizeKB = round($photo['size']/1024, 1);
            $totalSize += $photo['size'];
            $emailBody .= ($i + 1) . '. ' . $photo['original_name'] . "\n";
            $emailBody .= "   –†–∞–∑–º–µ—Ä: {$sizeKB} –ö–ë | –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: " . $photo['dimensions'] . "\n";
            $emailBody .= '   –§–∞–π–ª: ' . $photo['filename'] . "\n";
            $emailBody .= '   –°—Å—ã–ª–∫–∞: ' . ($cfg['site'] ?: 'http://' . $_SERVER['HTTP_HOST']) . '/' . basename(__FILE__) . '?download_photo=' . urlencode($photo['filename']) . "\n";

            // –ü–û–î–†–û–ë–ù–´–ï –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
            if (!empty($photo['edit_params'])) {
                $hasEditedPhotos = true;
                $emailBody .= "   üé® –ü–ê–†–ê–ú–ï–¢–†–´ –†–ï–î–ê–ö–¢–û–†–ê:\n";

                if ($photo['edit_params']['brightness'] != 0) {
                    $emailBody .= '      –Ø—Ä–∫–æ—Å—Ç—å: ' . $photo['edit_params']['brightness'] . "\n";
                }

                if ($photo['edit_params']['contrast'] != 0) {
                    $emailBody .= '      –ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å: ' . $photo['edit_params']['contrast'] . "\n";
                }

                if ($photo['edit_params']['crop']) {
                    $crop = $photo['edit_params']['crop'];
                    $emailBody .= '      –ö–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ: x=' . $crop['x'] . ', y=' . $crop['y'] . ', w=' . $crop['width'] . ', h=' . $crop['height'] . "\n";
                    $emailBody .= '      ‚úÇÔ∏è –í–ê–ñ–ù–û: –§–æ—Ç–æ –Ω—É–∂–Ω–æ –æ–±—Ä–µ–∑–∞—Ç—å –ø–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º!' . "\n";
                }

                if ($photo['edit_params']['polaroid']) {
                    $emailBody .= "      üéûÔ∏è –°–¢–ò–õ–¨ POLAROID: —Å–æ–∑–¥–∞—Ç—å –±–µ–ª—É—é —Ä–∞–º–∫—É –≤ —Ä–µ—Ç—Ä–æ-—Å—Ç–∏–ª–µ\n";
                    $emailBody .= "      üì∏ –í–ù–ò–ú–ê–ù–ò–ï: –ü—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç Polaroid —Å –±–µ–ª–æ–π —Ä–∞–º–∫–æ–π!\n";
                }
            }
            $emailBody .= "\n";
        }

        $emailBody .= '–û–±—â–∏–π –æ–±—ä–µ–º —Ñ–∞–π–ª–æ–≤: ' . number_format($totalSize/1024/1024, 1) . " –ú–ë\n";

        if ($hasEditedPhotos) {
            $emailBody .= "\nüé® –í–ù–ò–ú–ê–ù–ò–ï! –ö–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π!\n";
            $emailBody .= "–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –ø–µ—á–∞—Ç–∏!\n";
        }
        $emailBody .= "\n";

        $emailBody .= '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê' . "\n";
        $emailBody .= 'üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø' . "\n";
        $emailBody .= '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê' . "\n";
        $emailBody .= '–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: ' . ($paymentMethod === 'online' ? '–û–Ω–ª–∞–π–Ω (–Æ–ö–∞—Å—Å–∞)' : '–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏') . "\n";
        $emailBody .= "–í—Å–µ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–ø–∫–µ: uploads/\n";
        if ($photosArchive) {
            $emailBody .= "ZIP –∞—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: " . $photosArchive['filename'] . "\n";
            $emailBody .= "–î–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ?download_archive=$orderId\n";
        }
        $emailBody .= "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–∫–∞–∑–∞ –≤ CRM –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ID: $orderId\n";
        $emailBody .= "–°–∏—Å—Ç–µ–º–∞: –§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ü—Ä–µ–º–∏—É–º v3.0 —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º\n\n";

        $emailBody .= '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê' . "\n";
        $emailBody .= "–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\n";
        $emailBody .= "–°–∏—Å—Ç–µ–º–∞ —Ñ–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –ø—Ä–µ–º–∏—É–º v3.0\n";
        $emailBody .= ($cfg['brand'] ?: '–ü–†–ò–ù–¢–°–°') . "\n";
        $emailBody .= '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê' . "\n";

        // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –æ—Ç–ø—Ä–∞–≤–∫–∞ email –Ω–∞ artcopy78@bk.ru –≤—Å–µ–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
        $emailSent = send_email_guaranteed($emailTo, "üéØ –§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä v3.0 #$orderId ‚Äî $photoCount —Ñ–æ—Ç–æ –Ω–∞ " . number_format($totalPrice, 0) . ' ‚ÇΩ', $emailBody, $cfg, $uploadedPhotos);

        // Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
        $tgMsg = 'üéØ <b>–§–û–¢–û–ö–û–ù–°–¢–†–£–ö–¢–û–† v3.0</b>' . "\n\n";
        $tgMsg .= "üÜî <code>$orderId</code>\n";
        $tgMsg .= "üë§ <b>$name</b>\n";
        $tgMsg .= "üìû <code>$phone</code>\n";
        if ($email) $tgMsg .= "‚úâÔ∏è <code>$email</code>\n";
        $tgMsg .= "\nüì∏ <b>–ó–∞–∫–∞–∑:</b>\n";
        $tgMsg .= "üìê $size (" . $sizeConfig['w'] . '√ó' . $sizeConfig['h'] . " —Å–º)\n";
        $tgMsg .= "üìÑ $paper";
        if ($paperConfig['delta'] > 0) $tgMsg .= " (+{$paperConfig['delta']}‚ÇΩ)";
        $tgMsg .= "\nüé® $correction";
        if ($correctionConfig['delta'] > 0) $tgMsg .= " (+{$correctionConfig['delta']}‚ÇΩ)";
        $tgMsg .= "\nüî¢ –¢–∏—Ä–∞–∂: $qty —ç–∫–∑/—Ñ–æ—Ç–æ\n";
        $tgMsg .= "üì∑ –§–æ—Ç–æ: <b>$photoCount</b> —à—Ç\n";
        $tgMsg .= 'üì¶ –û—Ç–ø–µ—á–∞—Ç–∫–æ–≤: <b>' . ($photoCount * $qty) . "</b> —à—Ç\n";

        if ($hasEditedPhotos) {
            $tgMsg .= "\nüé® <b>–†–ï–î–ê–ö–¢–û–† –ò–°–ü–û–õ–¨–ó–û–í–ê–ù!</b>\n";
            $tgMsg .= "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –ø–∏—Å—å–º–µ!\n";
        }

        if (!empty($selectedProcessing)) {
            $tgMsg .= "\nüõ† <b>–î–æ–ø. —É—Å–ª—É–≥–∏:</b>\n";
            foreach ($selectedProcessing as $proc) {
                $tgMsg .= '‚Ä¢ ' . $proc['name'] . " ({$proc['price']}‚ÇΩ)\n";
                if ($proc['name'] === '–°—Ç–∏–ª—å –ü–æ–ª–∞—Ä–æ–∏–¥') {
                    $tgMsg .= "  üì∏ Polaroid + —Ä–µ–¥–∞–∫—Ç–æ—Ä\n";
                }
            }
        }

        if ($deliveryConfig) {
            $tgMsg .= "\nüöö <b>–î–æ—Å—Ç–∞–≤–∫–∞:</b> " . $deliveryConfig['name'];
            if ($deliveryConfig['price'] > 0) $tgMsg .= " (+{$deliveryConfig['price']}‚ÇΩ)";
            $tgMsg .= "\n";
        }

        if ($discount > 0) {
            $tgMsg .= "\nüéØ <b>–°–∫–∏–¥–∫–∞:</b> $discount% (-" . number_format($discountAmount, 0) . "‚ÇΩ)\n";
        }

        $tgMsg .= "\nüí∞ <b>–ò–¢–û–ì–û: " . number_format($totalPrice, 0) . " ‚ÇΩ</b>\n";
        $tgMsg .= 'üí≥ ' . ($paymentMethod === 'online' ? '–û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞' : '–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏') . "\n";

        if ($photosArchive) {
            $tgMsg .= "\nüì¶ <b>–ê—Ä—Ö–∏–≤:</b> " . $photosArchive['filename'] . "\n";
        }

        if ($comment) {
            $tgMsg .= "\nüí¨ <i>" . mb_substr($comment, 0, 100);
            if (mb_strlen($comment) > 100) $tgMsg .= '...';
            $tgMsg .= '</i>';
        }

        $telegramSent = send_telegram($cfg, $tgMsg);

        // –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        $response['message'] = '‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.';

        if (!$emailSent && !$telegramSent) {
            $response['warning'] = '‚ö†Ô∏è –ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.';
        } elseif (!$emailSent) {
            $response['warning'] = '‚ö†Ô∏è –ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –Ω–æ –ø–∏—Å—å–º–æ –Ω–∞ email –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.';
        } elseif (!$telegramSent) {
            $response['warning'] = '‚ö†Ô∏è –ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –Ω–æ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.';
        }

        echo json_encode($response);

    } catch (Exception $e) {
        // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
        $errorLog = [
            'error' => $e->getMessage(),
            'trace' => $e->getTraceAsString(),
            'post_data' => $_POST,
            'files_data' => $_FILES,
            'timestamp' => date('Y-m-d H:i:s'),
            'ip' => $_SERVER['REMOTE_ADDR'] ?? ''
        ];
        @file_put_contents($ordersLog, '['.date('Y-m-d H:i:s').'] ERROR: '.json_encode($errorLog, JSON_UNESCAPED_UNICODE).PHP_EOL, FILE_APPEND);

        echo json_encode(['ok' => false, 'error' => $e->getMessage()]);
    }
    exit;
}

// –¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞
$T = $cfg['theme'] ?? [];
$cardOpacity = is_numeric($T['card_opacity']) ? max(0.3, min(1, (float)$T['card_opacity'])) : 0.65;
$blur = (int)($T['blur'] ?? 12);
$radius = (int)($T['radius'] ?? 16);
$shadow = (float)($T['shadow'] ?? 0.12);
$container = (int)($T['container'] ?? 1200);
$muted = $T['muted'] ?? '#5c6b84';
$bg = $T['bg'] ?? '#f3f7ff';
$text = $T['text'] ?? '#0e1220';
$brandCol = $T['brand'] ?? '#FF8A00';
$accentCol = $T['accent'] ?? '#2D5BFF';
?>
<!doctype html>
<html lang='ru'>
<head>
  <meta charset='utf-8'>
  <title>–ü—Ä–µ–º–∏—É–º —Ñ–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä v3.0 —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º ‚Äî <?=esc($cfg['brand'] ?? '–ü–†–ò–ù–¢–°–°')?></title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <meta name='description' content='–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑ —Ñ–æ—Ç–æ–ø–µ—á–∞—Ç–∏ –æ–Ω–ª–∞–π–Ω —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π v3.0. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —è—Ä–∫–æ—Å—Ç–∏, –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞, —Ç–æ—á–Ω–æ–µ –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å—Ç–∏–ª—å Polaroid. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–æ–≤ –¥–ª—è CRM.'>
  <meta name='keywords' content='—Ñ–æ—Ç–æ–ø–µ—á–∞—Ç—å, —Ä–µ–¥–∞–∫—Ç–æ—Ä —Ñ–æ—Ç–æ v3.0, –ø–µ—á–∞—Ç—å —Ñ–æ—Ç–æ, —Ñ–æ—Ç–æ—É—Å–ª—É–≥–∏, –æ–Ω–ª–∞–π–Ω –∑–∞–∫–∞–∑ —Ñ–æ—Ç–æ, —è—Ä–∫–æ—Å—Ç—å, –∫–æ–Ω—Ç—Ä–∞—Å—Ç, –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–æ–ª–∞—Ä–æ–∏–¥, crm, –∞—Ä—Ö–∏–≤'>

  <style>
    :root{
      --bg: <?=esc($bg)?>;
      --text: <?=esc($text)?>;
      --muted: <?=esc($muted)?>;
      --brand: <?=esc($brandCol)?>;
      --accent: <?=esc($accentCol)?>;
      --card: rgba(255,255,255, <?=esc(number_format($cardOpacity,2,'.',''))?>);
      --glass-blur: <?=esc($blur)?>px;
      --radius: <?=esc($radius)?>px;
      --shadow: 0 10px 30px rgba(0,0,0, <?=esc(number_format($shadow,2,'.',''))?>);
      --container: <?=esc($container)?>px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Arial;
      color:var(--text);
      background:var(--bg);
      background:
        radial-gradient(900px 300px at 70% -10%, rgba(45,91,255,.08), transparent 60%),
        radial-gradient(700px 280px at 20% -20%, rgba(255,138,0,.10), transparent 70%),
        var(--bg);
      line-height: 1.5;
      min-height: 100vh;
    }

    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      background:var(--card);
      backdrop-filter:blur(var(--glass-blur)) saturate(160%);
      border-bottom:1px solid rgba(0,0,0,.08);
      padding: 12px 0;
    }

    .topflex{
      max-width:var(--container);
      margin:0 auto;
      padding:0 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap
    }

    .logo{
      display:flex;
      gap:12px;
      align-items:center;
      text-decoration:none;
      color:inherit;
    }

    .logo-badge{
      width:40px;
      height:40px;
      border-radius:10px;
      background:linear-gradient(135deg, var(--brand), #FFB14D);
      display:grid;
      place-items:center;
      color:#000;
      font-weight:800;
      font-size:16px;
    }

    .logo-title{
      font-weight:700;
      font-size:18px;
    }

    .nav{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .nav a{
      color:inherit;
      padding:8px 12px;
      border-radius:8px;
      font-weight:500;
      transition:all 0.2s;
      text-decoration:none;
      font-size:14px;
    }

    .nav a:hover{
      background:rgba(0,0,0,.06);
    }

    .wrap{
      max-width:var(--container);
      margin:20px auto;
      display:grid;
      grid-template-columns:1.2fr 0.8fr;
      gap:20px;
      padding:0 20px;
    }

    @media(max-width:1000px){
      .wrap{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);
      border:1px solid rgba(0,0,0,.08);
      border-radius:var(--radius);
      backdrop-filter:blur(var(--glass-blur));
      box-shadow:var(--shadow);
      padding:24px;
    }

    h2{
      margin:0 0 16px;
      font-size:20px;
      font-weight:700;
    }

    .form-group{
      margin-bottom:16px;
    }

    .form-group label{
      display:block;
      color:var(--text);
      font-size:14px;
      font-weight:600;
      margin-bottom:6px;
    }

    input[type='text'], input[type='email'], input[type='number'], select, textarea{
      width:100%;
      padding:12px;
      border-radius:8px;
      border:1px solid rgba(0,0,0,.15);
      background:#fff;
      color:var(--text);
      font-size:14px;
      transition: border-color 0.2s;
    }

    input:focus, select:focus, textarea:focus{
      border-color:var(--accent);
      outline:none;
    }

    textarea{
      min-height:80px;
      resize:vertical;
    }

    .uploader{
      border:2px dashed rgba(0,0,0,.2);
      border-radius:12px;
      padding:30px 20px;
      text-align:center;
      background:rgba(0,0,0,.02);
      position:relative;
      transition: all 0.3s;
    }

    .uploader.dragover{
      border-color:var(--accent);
      background:rgba(45,91,255,.04);
    }

    .uploader input[type=file]{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
    }

    .uploader .hint{
      color:var(--muted);
      font-size:14px;
    }

    .uploader .icon{
      font-size:48px;
      margin-bottom:12px;
      color:var(--accent);
    }

    .previews{
      margin-top:20px;
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));
      gap:12px;
    }

    .thumb{
      border:1px solid rgba(0,0,0,.1);
      border-radius:12px;
      overflow:hidden;
      background:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.1);
      position: relative;
      transition: all 0.3s;
    }

    .thumb:hover{
      transform: translateY(-2px);
      box-shadow:0 8px 25px rgba(0,0,0,.15);
    }

    .thumb .img{
      width:100%;
      height:150px;
      background:#f8f9fa center/cover no-repeat;
      position: relative;
    }

    .thumb .info{
      padding: 12px;
      font-size: 11px;
      color: var(--muted);
    }

    .thumb .remove-btn{
      position: absolute;
      top: 6px;
      right: 6px;
      width: 28px;
      height: 28px;
      background: rgba(255, 0, 0, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      z-index: 10;
    }

    .thumb .remove-btn:hover{
      background: rgba(255, 0, 0, 1);
      transform: scale(1.1);
    }

    .thumb .edit-btn{
      position: absolute;
      top: 6px;
      left: 6px;
      width: 28px;
      height: 28px;
      background: rgba(45, 91, 255, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      z-index: 10;
    }

    .thumb .edit-btn:hover{
      background: rgba(45, 91, 255, 1);
      transform: scale(1.1);
    }

    /* –£–õ–£–ß–®–ï–ù–ù–´–ô –†–ï–î–ê–ö–¢–û–† –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô v3.0 */
    .photo-editor{
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .photo-editor.show{
      display: flex;
    }

    .editor-content{
      background: var(--card);
      border-radius: 16px;
      width: 95%;
      max-width: 1200px;
      max-height: 95vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 40px rgba(0,0,0,.3);
    }

    .editor-header{
      padding: 20px;
      border-bottom: 1px solid rgba(0,0,0,.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--card);
    }

    .editor-header h3{
      margin: 0;
      color: var(--text);
      font-size: 18px;
    }

    .editor-body{
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .editor-preview{
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #1a1a1a;
      position: relative;
      overflow: hidden;
      min-height: 400px;
    }

    .editor-image{
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      position: relative;
    }

    /* –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –ö–ê–î–†–ò–†–û–í–ê–ù–ò–ï */
    .crop-overlay{
      position: absolute;
      border: 2px solid var(--accent);
      background: rgba(45, 91, 255, 0.15);
      cursor: move;
      display: none;
      user-select: none;
      min-width: 20px;
      min-height: 20px;
    }

    .crop-overlay.show{
      display: block;
    }

    .crop-handle{
      position: absolute;
      width: 12px;
      height: 12px;
      background: var(--accent);
      border: 2px solid #fff;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,.5);
    }

    .crop-handle.nw{ top: -6px; left: -6px; cursor: nw-resize; }
    .crop-handle.ne{ top: -6px; right: -6px; cursor: ne-resize; }
    .crop-handle.sw{ bottom: -6px; left: -6px; cursor: sw-resize; }
    .crop-handle.se{ bottom: -6px; right: -6px; cursor: se-resize; }

    .crop-info{
      position: absolute;
      bottom: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,.8);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
    }

    .editor-controls{
      width: 320px;
      padding: 20px;
      background: var(--card);
      border-left: 1px solid rgba(0,0,0,.1);
      overflow-y: auto;
    }

    .control-group{
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(0,0,0,.1);
    }

    .control-group:last-child{
      border-bottom: none;
    }

    .control-group label{
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text);
    }

    .control-slider{
      width: 100%;
      margin: 8px 0;
      accent-color: var(--accent);
      height: 6px;
      border-radius: 3px;
      background: rgba(0,0,0,.1);
      outline: none;
    }

    .control-value{
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
      font-weight: 600;
    }

    .crop-controls{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 12px;
    }

    .btn-crop{
      padding: 8px 12px;
      border: 1px solid rgba(0,0,0,.2);
      background: #fff;
      color: var(--text);
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
      text-align: center;
      font-weight: 500;
    }

    .btn-crop:hover{
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .btn-crop.active{
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      box-shadow: 0 2px 4px rgba(45,91,255,.3);
    }

    /* –£–õ–£–ß–®–ï–ù–ù–´–ô –°–¢–ò–õ–¨ –ü–û–õ–ê–†–û–ò–î */
    .polaroid-preview{
      position: relative;
      display: inline-block;
      padding: 15px 15px 50px;
      background: #fff;
      box-shadow: 0 4px 8px rgba(0,0,0,.2), 0 2px 4px rgba(0,0,0,.1);
      transform: rotate(-2deg);
      margin: 20px;
      max-width: 200px;
    }

    .polaroid-preview img{
      width: 100%;
      height: auto;
      display: block;
    }

    .polaroid-preview::after{
      content: '';
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 2px;
      background: rgba(0,0,0,.05);
    }

    .calc{
      margin-top:16px;
      padding:16px;
      background:rgba(255,138,0,.08);
      border-radius:8px;
    }

    .calc .price-line{
      display:flex;
      justify-content:space-between;
      margin:4px 0;
      font-size:13px;
    }

    .calc .total{
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid rgba(0,0,0,.1);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .calc #price{
      font-weight:800;
      font-size:24px;
      color:var(--brand);
    }

    .note{
      color:var(--muted);
      font-size:13px;
      margin-top:8px;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:12px 20px;
      border-radius:8px;
      text-decoration:none;
      font-weight:600;
      transition:all 0.2s;
      border:none;
      cursor:pointer;
      font-size:14px;
    }

    .btn-primary{
      background:linear-gradient(135deg, var(--accent), #00C2FF);
      color:#fff;
    }

    .btn-secondary{
      background:var(--card);
      color:var(--text);
      border:1px solid rgba(0,0,0,.1);
    }

    .btn-success{
      background:linear-gradient(135deg, #28a745, #20c997);
      color:#fff;
    }

    .btn-danger{
      background:linear-gradient(135deg, #dc3545, #fd7e14);
      color:#fff;
    }

    .btn-polaroid{
      background:linear-gradient(135deg, #f39c12, #e67e22);
      color:#fff;
    }

    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(0,0,0,.2);
    }

    .btn:disabled{
      opacity:0.6;
      cursor:not-allowed;
      transform:none;
    }

    .msg{
      margin-top:12px;
      font-size:14px;
      padding:12px;
      border-radius:8px;
    }

    .msg.success{
      background:#d4edda;
      color:#155724;
      border:1px solid #c3e6cb;
    }

    .msg.error{
      background:#f8d7da;
      color:#721c24;
      border:1px solid #f5c6cb;
    }

    .msg.warning{
      background:#fff3cd;
      color:#856404;
      border:1px solid #ffeaa7;
    }

    .payment-methods{
      margin:16px 0;
      padding:16px;
      background:rgba(0,0,0,.03);
      border-radius:8px;
    }

    .payment-option{
      display:flex;
      align-items:center;
      gap:8px;
      margin:8px 0;
    }

    .payment-option input[type=radio]{
      margin:0;
      width:auto;
    }

    .options-group{
      margin:16px 0;
      padding:16px;
      background:rgba(0,0,0,.03);
      border-radius:8px;
    }

    .option-item{
      display:flex;
      align-items:flex-start;
      gap:8px;
      margin:8px 0;
    }

    .option-item input[type=checkbox]{
      margin:0;
      width:auto;
      margin-top: 2px;
    }

    .option-item .option-details{
      flex: 1;
    }

    .option-item .option-price{
      font-weight: 600;
      color: var(--brand);
    }

    .option-item .option-desc{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .discount-badge{
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .loading{
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .loading.show{
      display: flex;
    }

    .loading-content{
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .spinner{
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .disabled-notice{
      text-align:center;
      padding:60px 20px;
      color:var(--muted);
    }

    .disabled-notice h2{
      color:var(--text);
      margin-bottom:16px;
    }

    .preview-badge{
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 138, 0, 0.9);
      color: #fff;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      z-index: 5;
    }

    .polaroid-badge{
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: #fff;
    }

    .version-badge{
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: rgba(45, 91, 255, 0.9);
      color: #fff;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 8px;
      font-weight: 600;
    }

    @media(max-width:768px){
      .topflex{
        flex-direction:column;
        text-align:center;
      }
      .nav{
        justify-content:center;
      }
      .wrap{
        padding:0 16px;
        gap:16px;
      }
      .card{
        padding:20px;
      }
      .previews{
        grid-template-columns:repeat(auto-fill, minmax(150px, 1fr));
        gap:8px;
      }
      .editor-content{
        width: 98%;
        height: 98vh;
      }
      .editor-body{
        flex-direction: column;
      }
      .editor-controls{
        width: 100%;
        max-height: 250px;
        border-left: none;
        border-top: 1px solid rgba(0,0,0,.1);
      }
    }
  </style>
</head>
<body>
  <?php if (empty($photoConfig['enabled'])): ?>
    <div class='disabled-notice'>
      <h2>‚ö†Ô∏è –§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</h2>
      <p>–ü—Ä–∏–Ω–æ—Å–∏–º –∏–∑–≤–∏–Ω–µ–Ω–∏—è –∑–∞ –Ω–µ—É–¥–æ–±—Å—Ç–≤–∞. –°–µ—Ä–≤–∏—Å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏.</p>
      <a href='/' class='btn btn-primary'>üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>
  <?php else: ?>

  <header class='topbar'>
    <div class='topflex'>
      <a href='/' class='logo'>
        <div class='logo-badge'>–ü</div>
        <div>
          <div class='logo-title'><?=esc($cfg['brand'] ?? '–ü–†–ò–ù–¢–°–°')?></div>
          <div style='font-size:12px;color:var(--muted)'>–ü—Ä–µ–º–∏—É–º —Ñ–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä v3.0 —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º</div>
        </div>
      </a>

      <nav class='nav'>
        <a href='/'>üè† –ì–ª–∞–≤–Ω–∞—è</a>
        <a href='products.php'>üõçÔ∏è –¢–æ–≤–∞—Ä—ã</a>
        <a href='tel:<?=esc($cfg['phone_raw'] ?? '+79522003990')?>'><?=esc($cfg['phone_display'] ?? '+7 (952) 200-39-90')?></a>
      </nav>
    </div>
  </header>

  <main class='wrap'>
    <section class='card'>
      <h2>üì∏ –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º v3.0</h2>
      <p style='color:var(--muted);margin-bottom:20px'>
        –í—ã–±–µ—Ä–∏—Ç–µ –¥–æ <?=esc($photoConfig['max_photos'])?> —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –¥–ª—è –ø–µ—á–∞—Ç–∏.
        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: <?=esc(strtoupper(implode(', ', $photoConfig['supported_formats'])))?>.
        –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: <?=esc($photoConfig['max_file_size'])?>–ú–ë.
        <br><strong>üé®  —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å —Ç–æ—á–Ω—ã–º –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ–º, —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ —Å—Ç–∏–ª–µ–º Polaroid!</strong>
        <br><strong>üì¶ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ ZIP  –≤—Å–µ–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏!</strong>
      </p>

      <div class='uploader' id='uploader'>
        <input type='file' id='files' accept='image/*' multiple>
        <div class='icon'>üì∑</div>
        <div class='hint'>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
        <div style='font-size:12px;color:var(--muted);margin-top:8px'>
          –ú–∞–∫—Å–∏–º—É–º <?=esc($photoConfig['max_photos'])?> —Ñ–∞–π–ª–æ–≤, –¥–æ <?=esc($photoConfig['max_file_size'])?>–ú–ë –∫–∞–∂–¥—ã–π
        </div>
      </div>

      <div id='previews' class='previews'></div>
    </section>

    <section class='card'>
      <h2>‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—á–∞—Ç–∏</h2>

      <div class='form-group'>
        <label>–†–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ</label>
        <select id='size'>
          <?php foreach($enabledSizes as $size): ?>
            <option value='<?=esc($size['name'])?>' data-price='<?=esc($size['base'])?>' <?=!empty($size['popular']) ? 'data-popular=\'1\'' : ''?>>
              <?=esc($size['name'])?> (<?=esc($size['w'])?>√ó<?=esc($size['h'])?>—Å–º) ‚Äî <?=esc($size['base'])?> ‚ÇΩ
              <?=!empty($size['popular']) ? ' ‚≠ê' : ''?>
            </option>
          <?php endforeach; ?>
        </select>
      </div>

      <div class='form-group'>
        <label>–¢–∏–ø –±—É–º–∞–≥–∏</label>
        <select id='paper'>
          <?php foreach($enabledPapers as $paper): ?>
            <option value='<?=esc($paper['name'])?>' data-delta='<?=esc($paper['delta'])?>' title='<?=esc($paper['description'])?>'>
              <?=esc($paper['name'])?>
              <?php if($paper['delta'] > 0): ?> (+<?=esc($paper['delta'])?> ‚ÇΩ)<?php endif; ?>
            </option>
          <?php endforeach; ?>
        </select>
      </div>

      <div class='form-group'>
        <label>–¢–∏—Ä–∞–∂ –Ω–∞ –∫–∞–∂–¥–æ–µ —Ñ–æ—Ç–æ</label>
        <input type='number' id='qty' min='1' max='100' value='1'>
      </div>

      <div class='form-group'>
        <label>–¶–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è</label>
        <select id='correction'>
          <?php foreach($enabledCorrections as $correction): ?>
            <option value='<?=esc($correction['name'])?>' data-delta='<?=esc($correction['delta'])?>' title='<?=esc($correction['description'])?>'>
              <?=esc($correction['name'])?>
              <?php if($correction['delta'] > 0): ?> (+<?=esc($correction['delta'])?> ‚ÇΩ)<?php endif; ?>
            </option>
          <?php endforeach; ?>
        </select>
      </div>

      <?php if (!empty($enabledProcessingOptions)): ?>
      <div class='options-group'>
        <div style='font-weight:600;margin-bottom:12px'>üõ†Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ (–Ω–∞ –∫–∞–∂–¥–æ–µ —Ñ–æ—Ç–æ):</div>
        <?php foreach($enabledProcessingOptions as $i => $option): ?>
          <div class='option-item'>
            <input type='checkbox' id='proc_<?=$i?>' name='processing_options[]' value='<?=esc($option['name'])?>' data-price='<?=esc($option['price'])?>'>
            <div class='option-details'>
              <label for='proc_<?=$i?>' style='margin:0;font-weight:500;font-size:14px;cursor:pointer'>
                <?=esc($option['name'])?>
                <span class='option-price'>(+<?=esc($option['price'])?> ‚ÇΩ)</span>
                <?php if ($option['name'] === '–°—Ç–∏–ª—å –ü–æ–ª–∞—Ä–æ–∏–¥'): ?>
                  <span style='background:#f39c12;color:#fff;padding:2px 6px;border-radius:10px;font-size:10px;margin-left:4px'>üì∏ v3.0</span>
                <?php endif; ?>
              </label>
              <?php if (!empty($option['description'])): ?>
                <div class='option-desc'><?=esc($option['description'])?></div>
              <?php endif; ?>
            </div>
          </div>
        <?php endforeach; ?>
      </div>
      <?php endif; ?>

      <?php if (!empty($enabledDeliveryOptions)): ?>
      <div class='form-group'>
        <label>–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</label>
        <select id='delivery'>
          <option value=''>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–±</option>
          <?php foreach($enabledDeliveryOptions as $option): ?>
            <option value='<?=esc($option['name'])?>' data-price='<?=esc($option['price'])?>'>
              <?=esc($option['name'])?>
              <?php if($option['price'] > 0): ?> (+<?=esc($option['price'])?> ‚ÇΩ)<?php endif; ?>
            </option>
          <?php endforeach; ?>
        </select>
      </div>
      <?php endif; ?>

      <div class='calc'>
        <div class='price-line'>
          <span>–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:</span>
          <span id='photoCount'>0 —à—Ç</span>
        </div>
        <div class='price-line'>
          <span>–í—Å–µ–≥–æ –æ—Ç–ø–µ—á–∞—Ç–∫–æ–≤:</span>
          <span id='totalCopies'>0 —à—Ç</span>
        </div>
        <div class='price-line'>
          <span>–¶–µ–Ω–∞ –∑–∞ –æ—Ç–ø–µ—á–∞—Ç–æ–∫:</span>
          <span id='pricePerCopy'>0 ‚ÇΩ</span>
        </div>
        <div id='processingLine' class='price-line' style='display:none'>
          <span>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏:</span>
          <span id='processingCost'>0 ‚ÇΩ</span>
        </div>
        <div id='deliveryLine' class='price-line' style='display:none'>
          <span>–î–æ—Å—Ç–∞–≤–∫–∞:</span>
          <span id='deliveryCost'>0 ‚ÇΩ</span>
        </div>
        <div id='discountLine' class='price-line' style='display:none;color:var(--brand)'>
          <span>–°–∫–∏–¥–∫–∞:</span>
          <span id='discountText'>0%</span>
        </div>
        <div class='total'>
          <div style='font-size:14px;color:var(--muted)'>–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</div>
          <div id='price'>0 ‚ÇΩ</div>
        </div>
      </div>

      <div class='note'>
        üí° –¢–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –±—É–¥–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ –ø–æ–∂–µ–ª–∞–Ω–∏–π.
        <?php if (!empty($enabledDiscounts)): ?>
          <br>üéØ –î–µ–π—Å—Ç–≤—É—é—Ç —Å–∫–∏–¥–∫–∏ –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:
          <?php foreach($enabledDiscounts as $discount): ?>
            –æ—Ç <?=esc($discount['threshold'])?> —Ñ–æ—Ç–æ ‚Äî <?=esc($discount['discount_percent'])?>%;
          <?php endforeach; ?>
        <?php endif; ?>
        <br><strong>üì¶ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞—Ä—Ö–∏–≤ –¥–ª—è CRM —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</strong>
      </div>

      <h2 style='margin-top:24px'>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h2>
      <textarea id='comment' placeholder='–£–∫–∞–∂–∏—Ç–µ –æ—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è: –ø–µ—á–∞—Ç—å –±–µ–∑ –ø–æ–ª–µ–π, –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ, –∫–æ—Ä—Ä–µ–∫—Ü–∏—è —Ü–≤–µ—Ç–∞, —Å—Ç–∏–ª—å Polaroid –∏ —Ç.–¥. –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã –≤ –∑–∞–∫–∞–∑.'></textarea>

      <h2 style='margin-top:24px'>üìû –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>

      <div class='form-group'>
        <label>–í–∞—à–µ –∏–º—è *</label>
        <input type='text' id='name' placeholder='–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤' required>
      </div>

      <div class='form-group'>
        <label>–¢–µ–ª–µ—Ñ–æ–Ω *</label>
        <input type='text' id='phone' placeholder='+7 (999) 123-45-67' required>
      </div>

      <div class='form-group'>
        <label>Email (–¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)</label>
        <input type='email' id='email' placeholder='ivan@example.com'>
      </div>

      <?php if (!empty($cfg['yukassa']['enabled']) && !empty($cfg['yukassa']['services']['photo_constructor'])): ?>
      <div class='payment-methods'>
        <div style='font-weight:600;margin-bottom:8px'>üí≥ –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</div>
        <div class='payment-option'>
          <input type='radio' id='payment_offline' name='payment_method' value='offline' checked>
          <label for='payment_offline'>–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ (–Ω–∞–ª–∏—á–Ω—ã–µ/–∫–∞—Ä—Ç–∞)</label>
        </div>
        <div class='payment-option'>
          <input type='radio' id='payment_online' name='payment_method' value='online'>
          <label for='payment_online'>–û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞ (–Æ–ö–∞—Å—Å–∞)</label>
        </div>
      </div>
      <?php endif; ?>

      <button id='btnSend' class='btn btn-primary' style='width:100%;margin-top:16px'>
        üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑ (v3.0)
      </button>

      <div id='msg' class='msg' style='display:none'></div>
    </section>
  </main>

  <!-- –£–õ–£–ß–®–ï–ù–ù–´–ô –†–ï–î–ê–ö–¢–û–† –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô v3.0 -->
  <div id='photoEditor' class='photo-editor'>
    <div class='editor-content'>
      <div class='editor-header'>
        <h3>üé® –†–µ–¥–∞–∫—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π v3.0</h3>
        <div>
          <button class='btn btn-success' onclick='applyEdits()'>‚úì –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <button class='btn btn-secondary' onclick='closeEditor()'>‚ùå –û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
      <div class='editor-body'>
        <div class='editor-preview'>
          <canvas id='editorCanvas'></canvas>
          <div id='cropOverlay' class='crop-overlay'>
            <div class='crop-handle nw'></div>
            <div class='crop-handle ne'></div>
            <div class='crop-handle sw'></div>
            <div class='crop-handle se'></div>
            <div class='crop-info' id='cropInfo'>0√ó0</div>
          </div>
        </div>
        <div class='editor-controls'>
          <div class='control-group'>
            <label>–Ø—Ä–∫–æ—Å—Ç—å</label>
            <input type='range' class='control-slider' id='brightnessSlider' min='-100' max='100' value='0'>
            <div class='control-value' id='brightnessValue'>0</div>
          </div>

          <div class='control-group'>
            <label>–ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å</label>
            <input type='range' class='control-slider' id='contrastSlider' min='-100' max='100' value='0'>
            <div class='control-value' id='contrastValue'>0</div>
          </div>

          <div class='control-group'>
            <label>–ö–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ (–ò–°–ü–†–ê–í–õ–ï–ù–û)</label>
            <div class='crop-controls'>
              <button class='btn-crop' data-ratio='free'>–°–≤–æ–±–æ–¥–Ω–æ</button>
              <button class='btn-crop' data-ratio='square'>–ö–≤–∞–¥—Ä–∞—Ç</button>
              <button class='btn-crop' data-ratio='4:3'>4:3</button>
              <button class='btn-crop' data-ratio='16:9'>16:9</button>
              <button class='btn-crop' data-ratio='3:4'>3:4</button>
              <button class='btn-crop' data-ratio='2:3'>2:3</button>
            </div>
            <div style='margin-top:12px'>
              <button id='cropToggle' class='btn btn-secondary' style='width:100%' onclick='toggleCrop()'>
                üî≤ –í–∫–ª—é—á–∏—Ç—å –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
              </button>
            </div>
          </div>

          <div class='control-group'>
            <label>–°—Ç–∏–ª—å Polaroid (–£–õ–£–ß–®–ï–ù)</label>
            <div style='margin-top:8px'>
              <button class='btn btn-polaroid' style='width:100%' onclick='togglePolaroid()'>
                üì∏ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä Polaroid
              </button>
            </div>
            <div id='polaroidPreview' style='margin-top:12px;text-align:center;display:none'>
              <div style='font-size:11px;color:var(--muted);margin-bottom:8px'>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∏–ª—è Polaroid:</div>
              <div class='polaroid-preview' style='max-width:150px'>
                <canvas id='polaroidCanvas' width='150' height='100'></canvas>
              </div>
            </div>
          </div>

          <div class='control-group'>
            <label>–î–µ–π—Å—Ç–≤–∏—è</label>
            <button class='btn btn-secondary' style='width:100%;margin-bottom:8px' onclick='resetEdits()'>üîÑ –°–±—Ä–æ—Å</button>
            <button class='btn btn-danger' style='width:100%' onclick='closeEditor()'>‚ùå –û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id='loading' class='loading'>
    <div class='loading-content'>
      <div class='spinner'></div>
      <div>–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞ v3.0...</div>
    </div>
  </div>

  <?php endif; ?>

  <script>
    // –ü–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ –∞–¥–º–∏–Ω–∫–∏
    let CONFIG = null;
    const MAX_FILE_SIZE_MB = <?=esc($photoConfig['max_file_size'] ?? 10)?>;
    const MAX_FILE_SIZE = MAX_FILE_SIZE_MB * 1024 * 1024;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
    fetch('?api=config')
      .then(response => response.json())
      .then(config => {
        CONFIG = config;
        console.log('–ö–æ–Ω—Ñ–∏–≥ v3.0 –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –∞–¥–º–∏–Ω–∫–∏:', CONFIG);
        if (!CONFIG.enabled) {
          document.body.innerHTML = '<div class=\'disabled-notice\'><h2>‚ö†Ô∏è –§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –æ—Ç–∫–ª—é—á–µ–Ω</h2><p>–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</p></div>';
        }
      })
      .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞:', error);
        CONFIG = {
          enabled: true,
          max_photos: <?=esc($photoConfig['max_photos'] ?? 100)?>,
          max_file_size: <?=esc($photoConfig['max_file_size'] ?? 10)?>
        };
      });

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    const files = document.getElementById('files');
    const previews = document.getElementById('previews');
    const priceEl = document.getElementById('price');
    const uploader = document.getElementById('uploader');
    const photoCountEl = document.getElementById('photoCount');
    const totalCopiesEl = document.getElementById('totalCopies');
    const pricePerCopyEl = document.getElementById('pricePerCopy');
    const processingLineEl = document.getElementById('processingLine');
    const processingCostEl = document.getElementById('processingCost');
    const deliveryLineEl = document.getElementById('deliveryLine');
    const deliveryCostEl = document.getElementById('deliveryCost');
    const discountLineEl = document.getElementById('discountLine');
    const discountTextEl = document.getElementById('discountText');

    let uploadedFiles = [];
    let currentDiscount = 0;
    let currentProcessingCost = 0;
    let currentDeliveryCost = 0;

    // –£–õ–£–ß–®–ï–ù–ù–´–ô –†–ï–î–ê–ö–¢–û–† –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô v3.0
    let currentEditingIndex = -1;
    let editorCanvas = null;
    let editorCtx = null;
    let polaroidCanvas = null;
    let polaroidCtx = null;
    let originalImageData = null;
    let currentImage = null;
    let editParams = {};
    let cropMode = false;
    let cropData = null;
    let isDragging = false;
    let isResizing = false;
    let dragStart = { x: 0, y: 0 };
    let currentRatio = 'free';
    let polaroidMode = false;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    function initEditor() {
      editorCanvas = document.getElementById('editorCanvas');
      editorCtx = editorCanvas.getContext('2d');
      polaroidCanvas = document.getElementById('polaroidCanvas');
      polaroidCtx = polaroidCanvas.getContext('2d');

      // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–æ–≤
      document.getElementById('brightnessSlider').addEventListener('input', updatePreview);
      document.getElementById('contrastSlider').addEventListener('input', updatePreview);

      // –ö–Ω–æ–ø–∫–∏ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–π –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
      document.querySelectorAll('.btn-crop').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.btn-crop').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentRatio = this.dataset.ratio;
          if (cropMode && cropData) {
            applyCropRatio();
          }
        });
      });

      // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
      setupCropHandlers();
    }

    function openEditor(fileIndex) {
      if (fileIndex < 0 || fileIndex >= uploadedFiles.length) return;

      currentEditingIndex = fileIndex;
      const file = uploadedFiles[fileIndex];

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
      editParams = file.editParams || {
        brightness: 0,
        contrast: 0,
        crop: null,
        polaroid: false
      };

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Å–ª–∞–π–¥–µ—Ä–æ–≤
      document.getElementById('brightnessSlider').value = editParams.brightness || 0;
      document.getElementById('contrastSlider').value = editParams.contrast || 0;
      document.getElementById('brightnessValue').textContent = editParams.brightness || 0;
      document.getElementById('contrastValue').textContent = editParams.contrast || 0;

      // –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      const img = new Image();
      img.onload = function() {
        currentImage = img;
        originalImageData = null;
        cropData = editParams.crop;
        polaroidMode = editParams.polaroid || false;

        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï —Ä–∞–∑–º–µ—Ä—ã –∫–∞–Ω–≤–∞—Å–∞
        const maxWidth = 800;
        const maxHeight = 600;
        let { width, height } = img;

        // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
        if (width > maxWidth || height > maxHeight) {
          const ratio = Math.min(maxWidth / width, maxHeight / height);
          width = Math.round(width * ratio);
          height = Math.round(height * ratio);
        }

        editorCanvas.width = width;
        editorCanvas.height = height;
        editorCanvas.style.maxWidth = '100%';
        editorCanvas.style.maxHeight = '100%';
        editorCanvas.style.display = 'block';

        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–≤–∞—Å–∞
        const preview = document.querySelector('.editor-preview');
        const canvasRect = editorCanvas.getBoundingClientRect();
        const previewRect = preview.getBoundingClientRect();

        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞–Ω–≤–∞—Å –≤ –ø—Ä–µ–≤—å—é
        editorCanvas.style.position = 'relative';
        editorCanvas.style.left = '0';
        editorCanvas.style.top = '0';

        updatePreview();
        updatePolaroidPreview();
        document.getElementById('photoEditor').classList.add('show');
      };

      img.src = file.url;
    }

    function updatePreview() {
      if (!currentImage || !editorCtx) return;

      const brightness = parseInt(document.getElementById('brightnessSlider').value);
      const contrast = parseInt(document.getElementById('contrastSlider').value);

      document.getElementById('brightnessValue').textContent = brightness;
      document.getElementById('contrastValue').textContent = contrast;

      // –û—á–∏—â–∞–µ–º –∫–∞–Ω–≤–∞—Å
      editorCtx.clearRect(0, 0, editorCanvas.width, editorCanvas.height);

      // –†–∏—Å—É–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      editorCtx.drawImage(currentImage, 0, 0, editorCanvas.width, editorCanvas.height);

      // –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
      if (brightness !== 0 || contrast !== 0) {
        const imageData = editorCtx.getImageData(0, 0, editorCanvas.width, editorCanvas.height);
        const data = imageData.data;

        for (let i = 0; i < data.length; i += 4) {
          // –Ø—Ä–∫–æ—Å—Ç—å (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
          let r = data[i] + brightness;
          let g = data[i + 1] + brightness;
          let b = data[i + 2] + brightness;

          // –ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞)
          if (contrast !== 0) {
            const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
            r = factor * (r - 128) + 128;
            g = factor * (g - 128) + 128;
            b = factor * (b - 128) + 128;
          }

          // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
          data[i] = Math.max(0, Math.min(255, r));
          data[i + 1] = Math.max(0, Math.min(255, g));
          data[i + 2] = Math.max(0, Math.min(255, b));
        }

        editorCtx.putImageData(imageData, 0, 0);
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
      if (cropData && cropMode) {
        updateCropOverlay();
      }

      updatePolaroidPreview();
    }

    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –ö–ê–î–†–ò–†–û–í–ê–ù–ò–ï
    function toggleCrop() {
      cropMode = !cropMode;
      const overlay = document.getElementById('cropOverlay');
      const toggleBtn = document.getElementById('cropToggle');

      if (cropMode) {
        if (!cropData) {
          // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –Ω–∞—á–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
          const margin = Math.min(editorCanvas.width, editorCanvas.height) * 0.1;
          cropData = {
            x: margin,
            y: margin,
            width: editorCanvas.width - (margin * 2),
            height: editorCanvas.height - (margin * 2)
          };
        }
        overlay.classList.add('show');
        toggleBtn.textContent = '‚ùå –í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ';
        toggleBtn.className = 'btn btn-danger';
        updateCropOverlay();
      } else {
        overlay.classList.remove('show');
        toggleBtn.textContent = 'üî≤ –í–∫–ª—é—á–∏—Ç—å –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ';
        toggleBtn.className = 'btn btn-secondary';
      }
    }

    function updateCropOverlay() {
      if (!cropData || !cropMode) return;

      const overlay = document.getElementById('cropOverlay');
      const info = document.getElementById('cropInfo');

      // –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–∞–Ω–≤–∞—Å–∞
      const canvasRect = editorCanvas.getBoundingClientRect();
      const previewRect = document.querySelector('.editor-preview').getBoundingClientRect();

      const offsetX = canvasRect.left - previewRect.left;
      const offsetY = canvasRect.top - previewRect.top;

      overlay.style.left = (offsetX + cropData.x) + 'px';
      overlay.style.top = (offsetY + cropData.y) + 'px';
      overlay.style.width = cropData.width + 'px';
      overlay.style.height = cropData.height + 'px';

      info.textContent = Math.round(cropData.width) + '√ó' + Math.round(cropData.height);
    }

    function applyCropRatio() {
      if (!cropData || currentRatio === 'free') return;

      let targetRatio = 1;
      switch (currentRatio) {
        case 'square': targetRatio = 1; break;
        case '4:3': targetRatio = 4/3; break;
        case '16:9': targetRatio = 16/9; break;
        case '3:4': targetRatio = 3/4; break;
        case '2:3': targetRatio = 2/3; break;
      }

      const currentAspect = cropData.width / cropData.height;

      if (Math.abs(currentAspect - targetRatio) > 0.01) {
        const centerX = cropData.x + cropData.width / 2;
        const centerY = cropData.y + cropData.height / 2;

        let newWidth, newHeight;

        if (targetRatio > currentAspect) {
          newHeight = cropData.height;
          newWidth = newHeight * targetRatio;
        } else {
          newWidth = cropData.width;
          newHeight = newWidth / targetRatio;
        }

        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü
        newWidth = Math.min(newWidth, editorCanvas.width);
        newHeight = Math.min(newHeight, editorCanvas.height);

        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –µ—Å–ª–∏ –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è
        if (newWidth > editorCanvas.width) {
          newWidth = editorCanvas.width;
          newHeight = newWidth / targetRatio;
        }
        if (newHeight > editorCanvas.height) {
          newHeight = editorCanvas.height;
          newWidth = newHeight * targetRatio;
        }

        cropData.width = newWidth;
        cropData.height = newHeight;
        cropData.x = Math.max(0, Math.min(centerX - newWidth/2, editorCanvas.width - newWidth));
        cropData.y = Math.max(0, Math.min(centerY - newHeight/2, editorCanvas.height - newHeight));

        updateCropOverlay();
      }
    }

    function setupCropHandlers() {
      const overlay = document.getElementById('cropOverlay');

      overlay.addEventListener('mousedown', startDrag);
      document.addEventListener('mousemove', handleDrag);
      document.addEventListener('mouseup', stopDrag);

      // Touch events –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
      overlay.addEventListener('touchstart', handleTouchStart, { passive: false });
      document.addEventListener('touchmove', handleTouchMove, { passive: false });
      document.addEventListener('touchend', stopDrag);
    }

    function startDrag(e) {
      if (!cropMode || !cropData) return;

      e.preventDefault();
      isDragging = true;

      const rect = document.querySelector('.editor-preview').getBoundingClientRect();
      const canvasRect = editorCanvas.getBoundingClientRect();

      const x = e.clientX - canvasRect.left;
      const y = e.clientY - canvasRect.top;

      dragStart = { x: x - cropData.x, y: y - cropData.y };
    }

    function handleDrag(e) {
      if (!isDragging || !cropMode || !cropData) return;

      e.preventDefault();

      const canvasRect = editorCanvas.getBoundingClientRect();
      const x = e.clientX - canvasRect.left;
      const y = e.clientY - canvasRect.top;

      // –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å —É—á–µ—Ç–æ–º –≥—Ä–∞–Ω–∏—Ü
      const newX = x - dragStart.x;
      const newY = y - dragStart.y;

      cropData.x = Math.max(0, Math.min(newX, editorCanvas.width - cropData.width));
      cropData.y = Math.max(0, Math.min(newY, editorCanvas.height - cropData.height));

      updateCropOverlay();
    }

    function handleTouchStart(e) {
      if (e.touches.length === 1) {
        const touch = e.touches[0];
        startDrag({ clientX: touch.clientX, clientY: touch.clientY, preventDefault: () => e.preventDefault() });
      }
    }

    function handleTouchMove(e) {
      if (e.touches.length === 1) {
        const touch = e.touches[0];
        handleDrag({ clientX: touch.clientX, clientY: touch.clientY, preventDefault: () => e.preventDefault() });
      }
    }

    function stopDrag() {
      isDragging = false;
      isResizing = false;
    }

    // –£–õ–£–ß–®–ï–ù–ù–´–ô –°–¢–ò–õ–¨ POLAROID
    function togglePolaroid() {
      polaroidMode = !polaroidMode;
      const preview = document.getElementById('polaroidPreview');

      if (polaroidMode) {
        preview.style.display = 'block';
        updatePolaroidPreview();
      } else {
        preview.style.display = 'none';
      }
    }

    function updatePolaroidPreview() {
      if (!polaroidMode || !polaroidCanvas || !currentImage) return;

      const canvas = polaroidCanvas;
      const ctx = polaroidCtx;

      // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –ø—Ä–µ–≤—å—é
      const previewWidth = 150;
      const previewHeight = 110; // –£–≤–µ–ª–∏—á–∏–ª–∏ –≤—ã—Å–æ—Ç—É –¥–ª—è —Ä–∞–º–∫–∏

      canvas.width = previewWidth;
      canvas.height = previewHeight;

      // –ë–µ–ª–∞—è —Ä–∞–º–∫–∞ Polaroid (–ò–°–ü–†–ê–í–õ–ï–ù–û)
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, previewWidth, previewHeight);

      // –û–±–ª–∞—Å—Ç—å –¥–ª—è —Ñ–æ—Ç–æ (–æ—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ —Å–Ω–∏–∑—É)
      const photoMargin = 10;
      const bottomMargin = 25;
      const photoWidth = previewWidth - (photoMargin * 2);
      const photoHeight = previewHeight - photoMargin - bottomMargin;

      // –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï —Ä–∏—Å–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');

      tempCanvas.width = photoWidth;
      tempCanvas.height = photoHeight;

      // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–∞–Ω–≤–∞—Å
      tempCtx.drawImage(currentImage, 0, 0, photoWidth, photoHeight);

      // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ –∂–µ —Ñ–∏–ª—å—Ç—Ä—ã —á—Ç–æ –∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
      const brightness = parseInt(document.getElementById('brightnessSlider').value);
      const contrast = parseInt(document.getElementById('contrastSlider').value);

      if (brightness !== 0 || contrast !== 0) {
        const imageData = tempCtx.getImageData(0, 0, photoWidth, photoHeight);
        const data = imageData.data;

        for (let i = 0; i < data.length; i += 4) {
          let r = data[i] + brightness;
          let g = data[i + 1] + brightness;
          let b = data[i + 2] + brightness;

          if (contrast !== 0) {
            const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
            r = factor * (r - 128) + 128;
            g = factor * (g - 128) + 128;
            b = factor * (b - 128) + 128;
          }

          data[i] = Math.max(0, Math.min(255, r));
          data[i + 1] = Math.max(0, Math.min(255, g));
          data[i + 2] = Math.max(0, Math.min(255, b));
        }

        tempCtx.putImageData(imageData, 0, 0);
      }

      // –†–∏—Å—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ —Ñ–æ—Ç–æ –Ω–∞ Polaroid –∫–∞–Ω–≤–∞—Å
      ctx.drawImage(tempCanvas, photoMargin, photoMargin);

      // –õ–µ–≥–∫–∞—è —Ç–µ–Ω—å –≤–Ω—É—Ç—Ä–∏ —Ä–∞–º–∫–∏
      ctx.strokeStyle = 'rgba(0,0,0,0.1)';
      ctx.lineWidth = 1;
      ctx.strokeRect(photoMargin, photoMargin, photoWidth, photoHeight);
    }

    function resetEdits() {
      document.getElementById('brightnessSlider').value = 0;
      document.getElementById('contrastSlider').value = 0;
      cropData = null;
      polaroidMode = false;
      cropMode = false;
      document.getElementById('cropOverlay').classList.remove('show');
      document.getElementById('polaroidPreview').style.display = 'none';
      document.getElementById('cropToggle').textContent = 'üî≤ –í–∫–ª—é—á–∏—Ç—å –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ';
      document.getElementById('cropToggle').className = 'btn btn-secondary';
      document.querySelectorAll('.btn-crop').forEach(b => b.classList.remove('active'));
      currentRatio = 'free';
      updatePreview();
    }

    function applyEdits() {
      if (currentEditingIndex >= 0 && currentEditingIndex < uploadedFiles.length) {
        const brightness = parseInt(document.getElementById('brightnessSlider').value);
        const contrast = parseInt(document.getElementById('contrastSlider').value);

        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        uploadedFiles[currentEditingIndex].editParams = {
          brightness: brightness,
          contrast: contrast,
          crop: cropData ? {
            x: cropData.x,
            y: cropData.y,
            width: cropData.width,
            height: cropData.height
          } : null,
          polaroid: polaroidMode
        };

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é –º–∏–Ω–∏–∞—Ç—é—Ä—ã
        updateThumbnail(currentEditingIndex);

        closeEditor();
        showMessage('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã (v3.0)', 'success');
        setTimeout(() => hideMessage(), 2000);
      }
    }

    function closeEditor() {
      document.getElementById('photoEditor').classList.remove('show');
      currentEditingIndex = -1;
      cropMode = false;
      polaroidMode = false;
      cropData = null;
      resetEdits();
    }

    function updateThumbnail(index) {
      const file = uploadedFiles[index];
      const thumb = document.querySelector('[data-index=\'' + index + '\']');

      if (thumb && file.editParams) {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –±–µ–π–¥–∂–∏
        const oldBadges = thumb.querySelectorAll('.preview-badge, .version-badge');
        oldBadges.forEach(badge => badge.remove());

        let badgeText = '';
        let badgeClass = 'preview-badge';

        if (file.editParams.polaroid) {
          badgeText = 'üì∏ Polaroid';
          badgeClass += ' polaroid-badge';
        } else if (file.editParams.brightness !== 0 || file.editParams.contrast !== 0 || file.editParams.crop) {
          badgeText = 'üé® –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ';
        }

        if (badgeText) {
          const badge = document.createElement('div');
          badge.className = badgeClass;
          badge.textContent = badgeText;
          thumb.appendChild(badge);
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –±–µ–π–¥–∂ –≤–µ—Ä—Å–∏–∏
        const versionBadge = document.createElement('div');
        versionBadge.className = 'version-badge';
        versionBadge.textContent = 'v3.0';
        thumb.appendChild(versionBadge);
      }
    }

    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ 
    function calcPrice() {
      const sizeSelect = document.getElementById('size');
      const paperSelect = document.getElementById('paper');
      const correctionSelect = document.getElementById('correction');
      const deliverySelect = document.getElementById('delivery');
      const qty = parseInt(document.getElementById('qty').value || '1');
      const photoCount = uploadedFiles.length;

      // –ò–°–ü–†–ê–í–õ–ï–ù–ê –û–®–ò–ë–ö–ê: –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ selectedOptions
      const basePrice = (sizeSelect.selectedOptions.length > 0) ?
        parseInt(sizeSelect.selectedOptions[0].dataset.price || '0') : 0;
      const paperDelta = (paperSelect.selectedOptions.length > 0) ?
        parseInt(paperSelect.selectedOptions[0].dataset.delta || '0') : 0;
      const correctionDelta = (correctionSelect.selectedOptions.length > 0) ?
        parseInt(correctionSelect.selectedOptions[0].dataset.delta || '0') : 0;

      const pricePerPhoto = basePrice + paperDelta + correctionDelta;
      const totalCopies = photoCount * qty;

      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏
      currentProcessingCost = 0;
      const processingCheckboxes = document.querySelectorAll('input[name=\'processing_options[]\']:checked');
      processingCheckboxes.forEach(cb => {
        currentProcessingCost += parseInt(cb.dataset.price || '0');
      });
      const totalProcessingCost = currentProcessingCost * photoCount;

      // –î–æ—Å—Ç–∞–≤–∫–∞
      currentDeliveryCost = (deliverySelect.selectedOptions.length > 0) ?
        parseInt(deliverySelect.selectedOptions[0].dataset.price || '0') : 0;

      let totalPrice = (pricePerPhoto * totalCopies) + totalProcessingCost + currentDeliveryCost;

      // –†–∞—Å—á–µ—Ç —Å–∫–∏–¥–∫–∏
      currentDiscount = 0;
      if (CONFIG && CONFIG.discounts) {
        const sortedDiscounts = CONFIG.discounts.sort((a, b) => b.threshold - a.threshold);
        for (const discount of sortedDiscounts) {
          if (photoCount >= discount.threshold) {
            currentDiscount = discount.discount_percent;
            break;
          }
        }
      }

      let discountAmount = 0;
      if (currentDiscount > 0) {
        discountAmount = ((pricePerPhoto * totalCopies) + totalProcessingCost) * (currentDiscount / 100);
        totalPrice -= discountAmount;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      photoCountEl.textContent = photoCount + ' —à—Ç';
      totalCopiesEl.textContent = totalCopies + ' —à—Ç';
      pricePerCopyEl.textContent = pricePerPhoto + ' ‚ÇΩ';

      if (totalProcessingCost > 0) {
        processingCostEl.textContent = '+' + totalProcessingCost + ' ‚ÇΩ';
        processingLineEl.style.display = 'flex';
      } else {
        processingLineEl.style.display = 'none';
      }

      if (currentDeliveryCost > 0) {
        deliveryCostEl.textContent = '+' + currentDeliveryCost + ' ‚ÇΩ';
        deliveryLineEl.style.display = 'flex';
      } else {
        deliveryLineEl.style.display = 'none';
      }

      if (currentDiscount > 0) {
        discountTextEl.textContent = '-' + currentDiscount + '% (-' + Math.round(discountAmount) + ' ‚ÇΩ)';
        discountLineEl.style.display = 'flex';
      } else {
        discountLineEl.style.display = 'none';
      }

      priceEl.textContent = Math.round(totalPrice).toLocaleString('ru-RU') + ' ‚ÇΩ';
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é —Ñ–æ—Ç–æ —Å –∫–Ω–æ–ø–∫–∞–º–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è
    function addThumb(file, index) {
      if (!file.type.startsWith('image/')) return;

      const url = URL.createObjectURL(file);
      file.url = url; // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞

      const div = document.createElement('div');
      div.className = 'thumb';
      div.dataset.index = index;
      div.innerHTML = '<div class=\'img\' style=\'background-image:url(\'' + url + '\')\' title=\'' + file.name + '\'></div>' +
        '<button class=\'edit-btn\' onclick=\'openEditor(' + index + ')\' title=\'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ v3.0\'>üé®</button>' +
        '<button class=\'remove-btn\' onclick=\'removePhoto(' + index + ')\' title=\'–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ\'>√ó</button>' +
        '<div class=\'info\'><div>' + file.name + '</div><div>' + (file.size/1024/1024).toFixed(1) + ' –ú–ë</div></div>';
      previews.appendChild(div);
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ
    function removePhoto(index) {
      if (index >= 0 && index < uploadedFiles.length) {
        URL.revokeObjectURL(uploadedFiles[index].url);
        uploadedFiles.splice(index, 1);
        updatePreviews();
        calcPrice();
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
    function updatePreviews() {
      previews.innerHTML = '';
      uploadedFiles.forEach((file, index) => {
        addThumb(file, index);
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–µ–π–¥–∂ –µ—Å–ª–∏ –±—ã–ª –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω
        if (file.editParams && (file.editParams.brightness !== 0 || file.editParams.contrast !== 0 || file.editParams.crop || file.editParams.polaroid)) {
          updateThumbnail(index);
        }
      });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
    files.addEventListener('change', (e) => {
      const fileList = Array.from(e.target.files);
      processFiles(fileList);
      e.target.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
    function processFiles(fileList) {
      const validFiles = [];
      const errors = [];
      const maxPhotos = CONFIG ? CONFIG.max_photos : <?=esc($photoConfig['max_photos'] ?? 100)?>;

      for (const file of fileList) {
        if (uploadedFiles.length + validFiles.length >= maxPhotos) {
          errors.push('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –≤ ' + maxPhotos + ' —Ñ–∞–π–ª–æ–≤');
          break;
        }

        if (!file.type.startsWith('image/')) {
          errors.push(file.name + ': –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç');
          continue;
        }

        if (file.size > MAX_FILE_SIZE) {
          errors.push(file.name + ': —Ä–∞–∑–º–µ—Ä –ø—Ä–µ–≤—ã—à–∞–µ—Ç ' + MAX_FILE_SIZE_MB + '–ú–ë');
          continue;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è v3.0
        file.editParams = {
          brightness: 0,
          contrast: 0,
          crop: null,
          polaroid: false
        };

        validFiles.push(file);
      }

      // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞–ª–∏–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
      uploadedFiles.push(...validFiles);
      updatePreviews();
      calcPrice();

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
      if (errors.length > 0) {
        showMessage('–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:\n‚Ä¢ ' + errors.join('\n‚Ä¢ '), 'warning');
      }

      if (validFiles.length > 0) {
        showMessage('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ' + validFiles.length + ' —Ñ–æ—Ç–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É üé® –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è v3.0', 'success');
        setTimeout(() => hideMessage(), 4000);
      }
    }

    // Drag & Drop
    uploader.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploader.classList.add('dragover');
    });

    uploader.addEventListener('dragleave', (e) => {
      if (!uploader.contains(e.relatedTarget)) {
        uploader.classList.remove('dragover');
      }
    });

    uploader.addEventListener('drop', (e) => {
      e.preventDefault();
      uploader.classList.remove('dragover');

      const droppedFiles = Array.from(e.dataTransfer.files);
      processFiles(droppedFiles);
    });

    // –°–ª—É—à–∞—Ç–µ–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    ['size', 'paper', 'qty', 'correction', 'delivery'].forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener('change', calcPrice);
        element.addEventListener('input', calcPrice);
      }
    });

    // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥
    document.querySelectorAll('input[name=\'processing_options[]\']').forEach(cb => {
      cb.addEventListener('change', calcPrice);
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById('btnSend').addEventListener('click', async () => {
      if (!uploadedFiles.length) {
        showMessage('‚ùå –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é', 'error');
        return;
      }

      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();

      if (!name || !phone) {
        showMessage('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω', 'error');
        return;
      }

      // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      const phoneClean = phone.replace(/[^0-9+]/g, '');
      if (phoneClean.length < 10) {
        showMessage('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', 'error');
        return;
      }

      if (email && !isValidEmail(email)) {
        showMessage('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å', 'error');
        return;
      }

      const btn = document.getElementById('btnSend');
      const loading = document.getElementById('loading');
      const originalText = btn.textContent;

      btn.disabled = true;
      btn.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑ v3.0...';
      loading.classList.add('show');

      try {
        const fd = new FormData();
        fd.append('mode', 'photo_order');

        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —Å –£–õ–£–ß–®–ï–ù–ù–´–ú–ò –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è v3.0
        uploadedFiles.forEach((file, index) => {
          fd.append('photos[]', file);

          // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–æ—Ç–æ
          if (file.editParams) {
            fd.append('edit_params[' + index + '][brightness]', file.editParams.brightness);
            fd.append('edit_params[' + index + '][contrast]', file.editParams.contrast);
            fd.append('edit_params[' + index + '][polaroid]', file.editParams.polaroid ? '1' : '0');
            if (file.editParams.crop) {
              fd.append('edit_params[' + index + '][crop][x]', file.editParams.crop.x);
              fd.append('edit_params[' + index + '][crop][y]', file.editParams.crop.y);
              fd.append('edit_params[' + index + '][crop][width]', file.editParams.crop.width);
              fd.append('edit_params[' + index + '][crop][height]', file.editParams.crop.height);
            }
          }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        fd.append('size', document.getElementById('size').value);
        fd.append('paper', document.getElementById('paper').value);
        fd.append('qty', document.getElementById('qty').value);
        fd.append('correction', document.getElementById('correction').value);
        fd.append('name', name);
        fd.append('phone', phone);
        fd.append('email', email);
        fd.append('comment', document.getElementById('comment').value.trim());

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏
        const processingOptions = [];
        document.querySelectorAll('input[name=\'processing_options[]\']:checked').forEach(cb => {
          processingOptions.push(cb.value);
        });
        if (processingOptions.length > 0) {
          processingOptions.forEach(option => {
            fd.append('processing_options[]', option);
          });
        }

        // –î–æ—Å—Ç–∞–≤–∫–∞
        const deliverySelect = document.getElementById('delivery');
        if (deliverySelect && deliverySelect.value) {
          fd.append('delivery', deliverySelect.value);
        }

        // –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã
        const paymentMethodEl = document.querySelector('input[name=\'payment_method\']:checked');
        if (paymentMethodEl) {
          fd.append('payment_method', paymentMethodEl.value);
        }

        const response = await fetch(location.href, {
          method: 'POST',
          body: fd
        });

        if (!response.ok) {
          throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + response.status);
        }

        const result = await response.json();

        if (result.ok) {
          let message = '‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω v3.0!\nüÜî ID: ' + result.order_id + '\nüì∏ –§–æ—Ç–æ: ' + result.photo_count + ' —à—Ç';

          if (result.total_copies) {
            message += '\nüì¶ –û—Ç–ø–µ—á–∞—Ç–∫–æ–≤: ' + result.total_copies + ' —à—Ç';
          }

          if (result.discount) {
            message += '\nüéØ –°–∫–∏–¥–∫–∞: ' + result.discount + '%';
          }

          if (result.processing_cost) {
            message += '\nüõ†Ô∏è –î–æ–ø. —É—Å–ª—É–≥–∏: +' + result.processing_cost + ' ‚ÇΩ';
          }

          if (result.delivery_cost) {
            message += '\nüöö –î–æ—Å—Ç–∞–≤–∫–∞: +' + result.delivery_cost + ' ‚ÇΩ';
          }

          if (result.estimated_price) {
            message += '\nüí∞ –ò—Ç–æ–≥–æ: ' + result.estimated_price.toLocaleString('ru-RU') + ' ‚ÇΩ';
          }

          if (result.archive_created) {
            message += '\nüì¶ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω –¥–ª—è CRM –∞–¥–º–∏–Ω–∫–∏';
          }

          message += '\n\nüé® –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ v3.0 (–≤–∫–ª—é—á–∞—è Polaroid –∏ –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ) —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∑–∞–∫–∞–∑–µ';
          message += '\nüìß –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ artcopy78@bk.ru –≤—Å–µ–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏';

          if (result.warning) {
            message += '\n\n‚ö†Ô∏è ' + result.warning;
          }

          showMessage(message, 'success');

          // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
          uploadedFiles.forEach(file => {
            if (file.url) URL.revokeObjectURL(file.url);
          });
          uploadedFiles = [];
          updatePreviews();
          document.getElementById('name').value = '';
          document.getElementById('phone').value = '';
          document.getElementById('email').value = '';
          document.getElementById('comment').value = '';

          // –°–±—Ä–æ—Å –¥–æ–ø —É—Å–ª—É–≥
          document.querySelectorAll('input[name=\'processing_options[]\']').forEach(cb => {
            cb.checked = false;
          });

          calcPrice();

          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç—ã
          if (result.payment && result.payment_url) {
            showMessage('üí≥ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–ø–ª–∞—Ç–µ —á–µ—Ä–µ–∑ –Æ–ö–∞—Å—Å–∞...', 'success');
            setTimeout(() => {
              window.open(result.payment_url, '_blank');
            }, 2500);
          }

        } else {
          showMessage('‚ùå ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'), 'error');
        }

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
        showMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
        loading.classList.remove('show');
      }
    });

    function showMessage(text, type) {
      const msg = document.getElementById('msg');
      msg.innerHTML = text.replace(/\n/g, '<br>');
      msg.className = 'msg ' + type;
      msg.style.display = 'block';
      msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function hideMessage() {
      const msg = document.getElementById('msg');
      msg.style.display = 'none';
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      initEditor();
      calcPrice();

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      const popularOption = document.querySelector('#size option[data-popular=\'1\']');
      if (popularOption) {
        document.getElementById('size').value = popularOption.value;
        calcPrice(); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞–∑–º–µ—Ä–∞
      }

      // –ó–∞–∫—Ä—ã—Ç–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –ø–æ ESC
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('photoEditor').classList.contains('show')) {
          closeEditor();
        }
      });

      console.log('üéØ –ü–†–ï–ú–ò–£–ú –§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä v3.0 —Å –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ú —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!');
      console.log('‚úÖ –§—É–Ω–∫—Ü–∏–∏: —è—Ä–∫–æ—Å—Ç—å, –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å, –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ, —É–ª—É—á—à–µ–Ω–Ω—ã–π –°–¢–ò–õ–¨ POLAROID');
      console.log('‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ê –æ—à–∏–±–∫–∞ \'–≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω\'');
      console.log('‚úÖ CRM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ–º ZIP –∞—Ä—Ö–∏–≤–æ–≤');
      console.log('‚úÖ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ artcopy78@bk.ru –≤—Å–µ–º–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏');
      console.log('‚úÖ –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –∑–∞–∫–∞–∑ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è');
    });
  </script>
</body>
</html>
