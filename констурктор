<?php
mb_internal_encoding('UTF-8');
date_default_timezone_set('Europe/Moscow');
session_start();

$BASE = __DIR__;
$configFile = $BASE.'/config.json';
$photoConfigFile = $BASE.'/photo_config.json';
$uploadsDir = $BASE.'/uploads';
$ordersLog = $BASE.'/orders.txt';
$customersFile = $BASE.'/customers.json';

// –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –∑–∞–≥—Ä—É–∑–æ–∫ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if (!is_dir($uploadsDir)) @mkdir($uploadsDir, 0775, true);
if (!file_exists($uploadsDir.'/.htaccess')) {
    @file_put_contents($uploadsDir.'/.htaccess', 'php_flag engine off\nOptions -ExecCGI\n<FilesMatch \'\.(php|phar|phtml|cgi|pl|py)$\'>\nDeny from all\n</FilesMatch>\n');
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥
$cfg = json_decode(@file_get_contents($configFile), true) ?? [];

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞ —Ñ–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –ò–ó –ê–î–ú–ò–ù–ö–ò
function loadPhotoConfig($photoConfigFile) {
    $photoConfig = json_decode(@file_get_contents($photoConfigFile), true);

    if (!$photoConfig) {
        // –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–∞
        $photoConfig = [
            'enabled' => true,
            'max_photos' => 100,
            'max_file_size' => 10,
            'supported_formats' => ['jpg', 'jpeg', 'png', 'heic', 'heif'],
            'sizes' => [
                ['name' => '10√ó15', 'w' => 10, 'h' => 15, 'base' => 30, 'enabled' => true, 'popular' => true],
                ['name' => '15√ó21', 'w' => 15, 'h' => 21, 'base' => 50, 'enabled' => true, 'popular' => true],
                ['name' => 'A4', 'w' => 21, 'h' => 29.7, 'base' => 120, 'enabled' => true, 'popular' => false],
                ['name' => 'A3', 'w' => 29.7, 'h' => 42, 'base' => 200, 'enabled' => true, 'popular' => false],
                ['name' => '30√ó40', 'w' => 30, 'h' => 40, 'base' => 300, 'enabled' => true, 'popular' => false],
                ['name' => '50√ó70', 'w' => 50, 'h' => 70, 'base' => 800, 'enabled' => true, 'popular' => false]
            ],
            'papers' => [
                ['name' => '–ú–∞—Ç–æ–≤–∞—è', 'delta' => 0, 'enabled' => true, 'description' => '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –º–∞—Ç–æ–≤–∞—è –±—É–º–∞–≥–∞'],
                ['name' => '–ì–ª—è–Ω–µ—Ü', 'delta' => 10, 'enabled' => true, 'description' => '–ì–ª—è–Ω—Ü–µ–≤–∞—è –±—É–º–∞–≥–∞ —Å –±–ª–µ—Å–∫–æ–º']
            ],
            'corrections' => [
                ['name' => '–ù–µ—Ç', 'delta' => 0, 'enabled' => true, 'description' => '–ë–µ–∑ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏'],
                ['name' => '–õ–µ–≥–∫–∞—è', 'delta' => 15, 'enabled' => true, 'description' => '–ê–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è —è—Ä–∫–æ—Å—Ç–∏ –∏ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞'],
                ['name' => '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è', 'delta' => 50, 'enabled' => true, 'description' => '–†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –¥–∏–∑–∞–π–Ω–µ—Ä–æ–º']
            ],
            'processing_options' => [
                ['name' => '–ö–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ', 'price' => 20, 'enabled' => true, 'description' => '–û–±—Ä–µ–∑–∫–∞ –ø–æ –Ω—É–∂–Ω–æ–º—É —Ä–∞–∑–º–µ—Ä—É'],
                ['name' => '–£–¥–∞–ª–µ–Ω–∏–µ –∫—Ä–∞—Å–Ω—ã—Ö –≥–ª–∞–∑', 'price' => 30, 'enabled' => true, 'description' => '–ö–æ—Ä—Ä–µ–∫—Ü–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –∫—Ä–∞—Å–Ω—ã—Ö –≥–ª–∞–∑'],
                ['name' => '–ß–µ—Ä–Ω–æ-–±–µ–ª–æ–µ', 'price' => 10, 'enabled' => true, 'description' => '–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —á/–±']
            ],
            'delivery_options' => [
                ['name' => '–°–∞–º–æ–≤—ã–≤–æ–∑', 'price' => 0, 'enabled' => true, 'description' => '–ó–∞–±—Ä–∞—Ç—å –≤ –æ—Ñ–∏—Å–µ'],
                ['name' => '–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É', 'price' => 200, 'enabled' => true, 'description' => '–î–æ—Å—Ç–∞–≤–∫–∞ –∫—É—Ä—å–µ—Ä–æ–º'],
                ['name' => '–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏', 'price' => 300, 'enabled' => true, 'description' => '–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—á—Ç–æ–π']
            ],
            'discounts' => [
                ['name' => '–û—Ç 50 —Ñ–æ—Ç–æ', 'threshold' => 50, 'discount_percent' => 10, 'enabled' => true],
                ['name' => '–û—Ç 100 —Ñ–æ—Ç–æ', 'threshold' => 100, 'discount_percent' => 15, 'enabled' => true],
                ['name' => '–û—Ç 200 —Ñ–æ—Ç–æ', 'threshold' => 200, 'discount_percent' => 20, 'enabled' => false]
            ]
        ];
        @file_put_contents($photoConfigFile, json_encode($photoConfig, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
    }

    return $photoConfig;
}

$photoConfig = loadPhotoConfig($photoConfigFile);

// –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤–∫–ª—é—á–µ–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏
$enabledSizes = array_filter($photoConfig['sizes'] ?? [], function($item) { return !empty($item['enabled']); });
$enabledPapers = array_filter($photoConfig['papers'] ?? [], function($item) { return !empty($item['enabled']); });
$enabledCorrections = array_filter($photoConfig['corrections'] ?? [], function($item) { return !empty($item['enabled']); });
$enabledProcessingOptions = array_filter($photoConfig['processing_options'] ?? [], function($item) { return !empty($item['enabled']); });
$enabledDeliveryOptions = array_filter($photoConfig['delivery_options'] ?? [], function($item) { return !empty($item['enabled']); });
$enabledDiscounts = array_filter($photoConfig['discounts'] ?? [], function($item) { return !empty($item['enabled']); });

// Helpers
function esc($s){ return htmlspecialchars((string)$s, ENT_QUOTES|ENT_SUBSTITUTE, 'UTF-8'); }
function sanitize_text($s){ return trim(filter_var($s, FILTER_SANITIZE_FULL_SPECIAL_CHARS)); }

// CRM —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
function update_customer_info($customersFile, $name, $phone, $email = '', $orderData = null) {
    $customers = json_decode(@file_get_contents($customersFile), true) ?? [];

    $phone_clean = preg_replace('/[^0-9]/', '', $phone);
    $customer_id = $phone_clean;

    $existingCustomer = null;
    foreach ($customers as $key => $customer) {
        if ($customer['id'] === $customer_id) {
            $existingCustomer = $key;
            break;
        }
    }

    if ($existingCustomer !== null) {
        $customers[$existingCustomer]['last_contact'] = date('Y-m-d H:i:s');
        $customers[$existingCustomer]['orders_count']++;

        if ($orderData) {
            $customers[$existingCustomer]['total_spent'] += $orderData['total'] ?? 0;
            $customers[$existingCustomer]['orders'][] = [
                'id' => $orderData['id'],
                'date' => date('Y-m-d H:i:s'),
                'type' => $orderData['type'] ?? 'service',
                'total' => $orderData['total'] ?? 0,
                'status' => $orderData['status'] ?? 'new'
            ];
        }

        if ($email) $customers[$existingCustomer]['email'] = $email;
        if ($name) $customers[$existingCustomer]['name'] = $name;
    } else {
        $customers[] = [
            'id' => $customer_id,
            'name' => $name,
            'phone' => $phone,
            'email' => $email,
            'created_at' => date('Y-m-d H:i:s'),
            'last_contact' => date('Y-m-d H:i:s'),
            'orders_count' => 1,
            'total_spent' => $orderData['total'] ?? 0,
            'notes' => '',
            'tags' => ['–§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä'],
            'orders' => $orderData ? [[
                'id' => $orderData['id'],
                'date' => date('Y-m-d H:i:s'),
                'type' => $orderData['type'] ?? 'service',
                'total' => $orderData['total'] ?? 0,
                'status' => $orderData['status'] ?? 'new'
            ]] : []
        ];
    }

    @file_put_contents($customersFile, json_encode($customers, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
}

// –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ email —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π SMTP
function send_email($to, $subject, $body, $cfg) {
    $from = $cfg['email_from'] ?? 'noreply@' . ($_SERVER['HTTP_HOST'] ?? 'localhost');

    // SMTP –æ—Ç–ø—Ä–∞–≤–∫–∞ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞
    if (!empty($cfg['smtp']['enabled'])) {
        return send_smtp_email($to, $subject, $body, $cfg);
    }

    // –û–±—ã—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ mail()
    $headers = "From: $from\r\n";
    $headers .= 'Reply-To: ' . ($cfg['email_reply'] ?: $from) . "\r\n";
    $headers .= "Content-Type: text/plain; charset=UTF-8\r\n";
    $headers .= "X-Mailer: PhotoConstructor/1.0\r\n";

    if (!empty($cfg['email_cc'])) {
        $headers .= 'CC: ' . $cfg['email_cc'] . "\r\n";
    }
    if (!empty($cfg['email_bcc'])) {
        $headers .= 'BCC: ' . $cfg['email_bcc'] . "\r\n";
    }

    return @mail($to, '=?UTF-8?B?'.base64_encode($subject).'?=', $body, $headers);
}

function send_smtp_email($to, $subject, $body, $cfg) {
    // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è SMTP —á–µ—Ä–µ–∑ fsockopen
    $smtp = $cfg['smtp'];
    $host = $smtp['host'] ?? 'smtp.mail.ru';
    $port = $smtp['port'] ?? 465;
    $user = $smtp['user'] ?? '';
    $pass = $smtp['pass'] ?? '';
    $secure = $smtp['secure'] ?? 'ssl';

    if (!$user || !$pass) return false;

    try {
        $context = stream_context_create([
            'ssl' => [
                'verify_peer' => false,
                'verify_peer_name' => false,
                'allow_self_signed' => true
            ]
        ]);

        $conn = $secure === 'ssl'
            ? stream_socket_client("ssl://$host:$port", $errno, $errstr, 30, STREAM_CLIENT_CONNECT, $context)
            : fsockopen($host, $port, $errno, $errstr, 30);

        if (!$conn) return false;

        // SMTP –∫–æ–º–∞–Ω–¥—ã
        fgets($conn, 512);
        fputs($conn, "EHLO $host\r\n");
        fgets($conn, 512);

        if ($secure === 'tls') {
            fputs($conn, "STARTTLS\r\n");
            fgets($conn, 512);
            stream_socket_enable_crypto($conn, true, STREAM_CRYPTO_METHOD_TLS_CLIENT);
            fputs($conn, "EHLO $host\r\n");
            fgets($conn, 512);
        }

        fputs($conn, "AUTH LOGIN\r\n");
        fgets($conn, 512);
        fputs($conn, base64_encode($user) . "\r\n");
        fgets($conn, 512);
        fputs($conn, base64_encode($pass) . "\r\n");
        fgets($conn, 512);

        fputs($conn, "MAIL FROM: <$user>\r\n");
        fgets($conn, 512);
        fputs($conn, "RCPT TO: <$to>\r\n");
        fgets($conn, 512);
        fputs($conn, "DATA\r\n");
        fgets($conn, 512);

        $email_data = "From: $user\r\n";
        $email_data .= "To: $to\r\n";
        $email_data .= 'Subject: =?UTF-8?B?' . base64_encode($subject) . "?=\r\n";
        $email_data .= "Content-Type: text/plain; charset=UTF-8\r\n";
        $email_data .= "Content-Transfer-Encoding: 8bit\r\n\r\n";
        $email_data .= "$body\r\n.\r\n";

        fputs($conn, $email_data);
        fgets($conn, 512);
        fputs($conn, "QUIT\r\n");
        fclose($conn);

        return true;
    } catch (Exception $e) {
        return false;
    }
}

// Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function send_telegram($cfg, $message) {
    if (empty($cfg['telegram']['enabled']) || empty($cfg['telegram']['token']) || empty($cfg['telegram']['chat'])) {
        return false;
    }

    $url = 'https://api.telegram.org/bot' . $cfg['telegram']['token'] . '/sendMessage';
    $data = [
        'chat_id' => $cfg['telegram']['chat'],
        'text' => $message,
        'parse_mode' => 'HTML',
        'disable_web_page_preview' => true
    ];

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data));
    curl_setopt($ch, CURLOPT_TIMEOUT, 15);
    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 10);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    $result = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    return $result !== false && $httpCode === 200;
}

// API –¥–ª—è –∫–æ–Ω—Ñ–∏–≥–∞ (–ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –∞–¥–º–∏–Ω–∫–æ–π)
if (isset($_GET['api']) && $_GET['api'] === 'config') {
    header('Content-Type: application/json; charset=utf-8');

    // –ü–µ—Ä–µ–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ –Ω–∞ —Å–ª—É—á–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏–π
    $photoConfig = loadPhotoConfig($photoConfigFile);

    $response = [
        'enabled' => !empty($photoConfig['enabled']),
        'max_photos' => $photoConfig['max_photos'] ?? 100,
        'max_file_size' => $photoConfig['max_file_size'] ?? 10,
        'supported_formats' => $photoConfig['supported_formats'] ?? ['jpg', 'jpeg', 'png'],
        'sizes' => array_values(array_filter($photoConfig['sizes'] ?? [], function($item) { return !empty($item['enabled']); })),
        'papers' => array_values(array_filter($photoConfig['papers'] ?? [], function($item) { return !empty($item['enabled']); })),
        'corrections' => array_values(array_filter($photoConfig['corrections'] ?? [], function($item) { return !empty($item['enabled']); })),
        'processing_options' => array_values(array_filter($photoConfig['processing_options'] ?? [], function($item) { return !empty($item['enabled']); })),
        'delivery_options' => array_values(array_filter($photoConfig['delivery_options'] ?? [], function($item) { return !empty($item['enabled']); })),
        'discounts' => array_values(array_filter($photoConfig['discounts'] ?? [], function($item) { return !empty($item['enabled']); }))
    ];

    echo json_encode($response, JSON_UNESCAPED_UNICODE);
    exit;
}

// –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ –∏–∑ CRM –∞–¥–º–∏–Ω–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–∞
if (isset($_GET['download_photo']) && !empty($_GET['filename'])) {
    $filename = basename($_GET['filename']);
    $filepath = $uploadsDir . '/' . $filename;

    if (file_exists($filepath) && preg_match('/^photo_/', $filename)) {
        $mimeType = mime_content_type($filepath);
        if (strpos($mimeType, 'image/') === 0) {
            header('Content-Type: ' . $mimeType);
            header('Content-Disposition: attachment; filename="' . $filename . '"');
            header('Content-Length: ' . filesize($filepath));
            header('Cache-Control: private');
            header('Expires: 0');
            readfile($filepath);
            exit;
        }
    }

    http_response_code(404);
    echo '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
    exit;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–∞ —Ñ–æ—Ç–æ
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['mode']) && $_POST['mode'] === 'photo_order') {
    header('Content-Type: application/json; charset=utf-8');

    try {
        // –ü–µ—Ä–µ–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
        $photoConfig = loadPhotoConfig($photoConfigFile);

        if (empty($photoConfig['enabled'])) {
            throw new Exception('–§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω');
        }

        $name = sanitize_text($_POST['name'] ?? '');
        $email = sanitize_text($_POST['email'] ?? '');
        $phone = sanitize_text($_POST['phone'] ?? '');
        $comment = sanitize_text($_POST['comment'] ?? '');
        $size = sanitize_text($_POST['size'] ?? '');
        $paper = sanitize_text($_POST['paper'] ?? '');
        $qty = max(1, (int)($_POST['qty'] ?? 1));
        $correction = sanitize_text($_POST['correction'] ?? '');
        $paymentMethod = sanitize_text($_POST['payment_method'] ?? 'offline');
        $delivery = sanitize_text($_POST['delivery'] ?? '');

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏
        $processingOptions = [];
        if (isset($_POST['processing_options']) && is_array($_POST['processing_options'])) {
            $processingOptions = array_map('sanitize_text', $_POST['processing_options']);
        }

        if (!$name || !$phone) {
            throw new Exception('–£–∫–∞–∂–∏—Ç–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω');
        }

        if ($email && !filter_var($email, FILTER_VALIDATE_EMAIL)) {
            throw new Exception('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å');
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        $phoneClean = preg_replace('/[^0-9+]/', '', $phone);
        if (strlen($phoneClean) < 10) {
            throw new Exception('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä—Å–∫–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        $uploadedPhotos = [];
        $photoCount = 0;
        $maxPhotos = $photoConfig['max_photos'] ?? 100;
        $maxFileSize = ($photoConfig['max_file_size'] ?? 10) * 1024 * 1024;
        $allowedFormats = $photoConfig['supported_formats'] ?? ['jpg', 'jpeg', 'png'];

        if (isset($_FILES['photos']) && is_array($_FILES['photos']['name'])) {
            $totalFiles = count($_FILES['photos']['name']);

            for ($i = 0; $i < min($totalFiles, $maxPhotos); $i++) {
                if ($_FILES['photos']['error'][$i] !== UPLOAD_ERR_OK) continue;

                $tmpPath = $_FILES['photos']['tmp_name'][$i];
                $originalName = $_FILES['photos']['name'][$i];
                $fileSize = $_FILES['photos']['size'][$i];

                if ($fileSize > $maxFileSize) continue;

                $imageInfo = @getimagesize($tmpPath);
                if ($imageInfo === false) continue;

                $ext = strtolower(pathinfo($originalName, PATHINFO_EXTENSION));
                if (!in_array($ext, $allowedFormats)) continue;

                // –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                $newName = 'photo_' . date('Ymd_His') . '_' . sprintf('%04d', $i) . '_' . bin2hex(random_bytes(4)) . '.' . $ext;
                $newPath = $uploadsDir . '/' . $newName;

                if (move_uploaded_file($tmpPath, $newPath)) {
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
                    @chmod($newPath, 0644);

                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã
                    $editParams = [];
                    if (isset($_POST['edit_params'][$i]) && is_array($_POST['edit_params'][$i])) {
                        $editParams = $_POST['edit_params'][$i];
                    }

                    $uploadedPhotos[] = [
                        'filename' => $newName,
                        'original_name' => $originalName,
                        'size' => $fileSize,
                        'dimensions' => $imageInfo[0] . 'x' . $imageInfo[1],
                        'mime_type' => $imageInfo['mime'],
                        'upload_time' => date('Y-m-d H:i:s'),
                        'edit_params' => $editParams // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    ];
                    $photoCount++;
                }
            }
        }

        if ($photoCount === 0) {
            throw new Exception('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ñ–æ—Ç–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∏ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤.');
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–µ—á–∞—Ç–∏ –∏–∑ –∞–¥–º–∏–Ω–∫–∏
        $enabledSizes = array_filter($photoConfig['sizes'] ?? [], function($item) { return !empty($item['enabled']); });
        $enabledPapers = array_filter($photoConfig['papers'] ?? [], function($item) { return !empty($item['enabled']); });
        $enabledCorrections = array_filter($photoConfig['corrections'] ?? [], function($item) { return !empty($item['enabled']); });

        $sizeConfig = null;
        foreach ($enabledSizes as $s) {
            if ($s['name'] === $size) {
                $sizeConfig = $s;
                break;
            }
        }
        if (!$sizeConfig) {
            throw new Exception('–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        }

        $paperConfig = null;
        foreach ($enabledPapers as $p) {
            if ($p['name'] === $paper) {
                $paperConfig = $p;
                break;
            }
        }
        if (!$paperConfig) {
            throw new Exception('–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø –±—É–º–∞–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        }

        $correctionConfig = null;
        foreach ($enabledCorrections as $c) {
            if ($c['name'] === $correction) {
                $correctionConfig = $c;
                break;
            }
        }
        if (!$correctionConfig) {
            throw new Exception('–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        }

        // –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –æ–ø—Ü–∏–π
        $basePrice = $sizeConfig['base'];
        $paperDelta = $paperConfig['delta'];
        $correctionDelta = $correctionConfig['delta'];

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏
        $processingCost = 0;
        $selectedProcessing = [];
        $enabledProcessingOptions = array_filter($photoConfig['processing_options'] ?? [], function($item) { return !empty($item['enabled']); });

        foreach ($processingOptions as $procName) {
            foreach ($enabledProcessingOptions as $proc) {
                if ($proc['name'] === $procName) {
                    $processingCost += $proc['price'];
                    $selectedProcessing[] = $proc;
                    break;
                }
            }
        }

        // –î–æ—Å—Ç–∞–≤–∫–∞
        $deliveryCost = 0;
        $deliveryConfig = null;
        if ($delivery) {
            $enabledDeliveryOptions = array_filter($photoConfig['delivery_options'] ?? [], function($item) { return !empty($item['enabled']); });
            foreach ($enabledDeliveryOptions as $deliv) {
                if ($deliv['name'] === $delivery) {
                    $deliveryCost = $deliv['price'];
                    $deliveryConfig = $deliv;
                    break;
                }
            }
        }

        $pricePerPhoto = $basePrice + $paperDelta + $correctionDelta;
        $totalPhotoCost = $pricePerPhoto * $qty * $photoCount;
        $totalProcessingCost = $processingCost * $photoCount;
        $totalPrice = $totalPhotoCost + $totalProcessingCost + $deliveryCost;

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫–∏ –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        $discount = 0;
        $discountInfo = null;
        $enabledDiscounts = array_filter($photoConfig['discounts'] ?? [], function($item) { return !empty($item['enabled']); });

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –ø–æ—Ä–æ–≥–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–∏–¥–∫–∏
        usort($enabledDiscounts, function($a, $b) {
            return $b['threshold'] - $a['threshold'];
        });

        foreach ($enabledDiscounts as $discountRule) {
            if ($photoCount >= $discountRule['threshold']) {
                $discount = $discountRule['discount_percent'];
                $discountInfo = $discountRule;
                break;
            }
        }

        $discountAmount = 0;
        if ($discount > 0) {
            $discountAmount = ($totalPhotoCost + $totalProcessingCost) * ($discount / 100);
            $totalPrice -= $discountAmount;
        }

        // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–∫–∞–∑–∞
        $orderId = 'photo_' . time() . '_' . rand(1000, 9999);

        // –ü–û–õ–ù–ê–Ø —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–∫–∞–∑–∞ –¥–ª—è CRM
        $order = [
            'id' => $orderId,
            'type' => 'photo_constructor',
            'timestamp' => date('Y-m-d H:i:s'),
            'name' => $name,
            'phone' => $phone,
            'email' => $email,
            'customer' => [
                'name' => $name,
                'phone' => $phone,
                'email' => $email,
                'phone_clean' => preg_replace('/[^0-9]/', '', $phone)
            ],
            'details' => [
                'size' => $size,
                'size_config' => $sizeConfig,
                'paper' => $paper,
                'paper_config' => $paperConfig,
                'qty_per_photo' => $qty,
                'correction' => $correction,
                'correction_config' => $correctionConfig,
                'processing_options' => $selectedProcessing,
                'delivery' => $delivery,
                'delivery_config' => $deliveryConfig,
                'photo_count' => $photoCount,
                'photos' => $uploadedPhotos,
                'comment' => $comment
            ],
            'pricing' => [
                'base_price_per_photo' => $basePrice,
                'paper_delta' => $paperDelta,
                'correction_delta' => $correctionDelta,
                'processing_cost_per_photo' => $processingCost,
                'price_per_photo' => $pricePerPhoto,
                'total_photos' => $photoCount,
                'total_copies' => $photoCount * $qty,
                'photo_cost' => $totalPhotoCost,
                'processing_cost' => $totalProcessingCost,
                'delivery_cost' => $deliveryCost,
                'discount_percent' => $discount,
                'discount_amount' => $discountAmount,
                'discount_info' => $discountInfo,
                'estimated_price' => $totalPrice,
                'total_price' => $totalPrice
            ],
            'payment_method' => $paymentMethod,
            'status' => $paymentMethod === 'online' ? 'pending_payment' : 'new',
            'created_at' => date('Y-m-d H:i:s'),
            'ip' => $_SERVER['REMOTE_ADDR'] ?? '',
            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? '',
            'source' => 'photo_constructor_premium_v2.0'
        ];

        // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–∫–∞–∑ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
        @file_put_contents($ordersLog, '['.date('Y-m-d H:i:s').'] '.json_encode($order, JSON_UNESCAPED_UNICODE).PHP_EOL, FILE_APPEND);

        // –û–±–Ω–æ–≤–ª—è–µ–º CRM –±–∞–∑—É –∫–ª–∏–µ–Ω—Ç–æ–≤
        $crmOrderData = [
            'id' => $orderId,
            'type' => 'photo_constructor',
            'total' => $totalPrice,
            'status' => $order['status']
        ];
        update_customer_info($customersFile, $name, $phone, $email, $crmOrderData);

        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç
        $response = [
            'ok' => true,
            'order_id' => $orderId,
            'photo_count' => $photoCount,
            'total_copies' => $photoCount * $qty,
            'estimated_price' => $totalPrice,
            'discount' => $discount > 0 ? $discount : null,
            'discount_amount' => $discountAmount > 0 ? $discountAmount : null,
            'processing_cost' => $totalProcessingCost > 0 ? $totalProcessingCost : null,
            'delivery_cost' => $deliveryCost > 0 ? $deliveryCost : null
        ];

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç—ã –Æ–ö–∞—Å—Å–∞
        if ($paymentMethod === 'online' && !empty($cfg['yukassa']['enabled']) && !empty($cfg['yukassa']['services']['photo_constructor'])) {
            $shop_id = $cfg['yukassa']['shop_id'];
            $secret_key = $cfg['yukassa']['secret_key'];
            $return_url = $cfg['yukassa']['return_url'] ?? ($cfg['site'] . '/payment_result.php');

            if ($shop_id && $secret_key && $totalPrice > 0) {
                $url = 'https://api.yookassa.ru/v3/payments';

                $paymentDescription = "–§–æ—Ç–æ–ø–µ—á–∞—Ç—å: $photoCount —Ñ–æ—Ç–æ √ó $qty —ç–∫–∑.";
                if ($deliveryConfig) $paymentDescription .= " + " . $deliveryConfig['name'];

                $data = [
                    'amount' => ['value' => number_format($totalPrice, 2, '.', ''), 'currency' => 'RUB'],
                    'confirmation' => ['type' => 'redirect', 'return_url' => $return_url . '?order_id=' . urlencode($orderId)],
                    'description' => $paymentDescription,
                    'metadata' => [
                        'order_id' => $orderId,
                        'type' => 'photo_constructor',
                        'customer_phone' => $phone,
                        'customer_name' => $name,
                        'photo_count' => $photoCount
                    ],
                    'capture' => true
                ];

                $ch = curl_init($url);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                curl_setopt($ch, CURLOPT_POST, true);
                curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
                curl_setopt($ch, CURLOPT_HTTPHEADER, [
                    'Content-Type: application/json',
                    'Idempotence-Key: ' . uniqid('photo_', true),
                    'Authorization: Basic ' . base64_encode($shop_id . ':' . $secret_key)
                ]);
                curl_setopt($ch, CURLOPT_TIMEOUT, 30);
                curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 10);

                $result = curl_exec($ch);
                $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                curl_close($ch);

                if ($result && $httpCode === 200) {
                    $paymentResponse = json_decode($result, true);
                    if ($paymentResponse && isset($paymentResponse['confirmation']['confirmation_url'])) {
                        $response['payment'] = true;
                        $response['payment_url'] = $paymentResponse['confirmation']['confirmation_url'];
                        $response['payment_id'] = $paymentResponse['id'];
                        $response['message'] = '–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–ø–ª–∞—Ç–µ...';

                        // –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ–∂–µ
                        $order['payment'] = [
                            'payment_id' => $paymentResponse['id'],
                            'payment_url' => $paymentResponse['confirmation']['confirmation_url'],
                            'amount' => $paymentResponse['amount']['value']
                        ];
                        @file_put_contents($ordersLog, '['.date('Y-m-d H:i:s').'] PAYMENT_CREATED: '.json_encode($order['payment'], JSON_UNESCAPED_UNICODE).PHP_EOL, FILE_APPEND);

                        echo json_encode($response);
                        exit;
                    }
                }
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω–∞ artcopy78@bk.ru
        $emailTo = 'artcopy78@bk.ru'; // –ñ–ï–°–¢–ö–û –∑–∞–¥–∞–µ–º –∞–¥—Ä–µ—Å

        // –ú–ï–ì–ê-–î–ï–¢–ê–õ–¨–ù–û–ï –ø–∏—Å—å–º–æ –¥–ª—è –∞–¥–º–∏–Ω–∞
        $emailBody = "üéØ –ù–û–í–´–ô –ó–ê–ö–ê–ó –§–û–¢–û–ö–û–ù–°–¢–†–£–ö–¢–û–†–ê –ü–†–ï–ú–ò–£–ú üéØ\n\n";
        $emailBody .= "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        $emailBody .= "üìã –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ó–ê–ö–ê–ó–ï\n";
        $emailBody .= "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        $emailBody .= "ID –∑–∞–∫–∞–∑–∞: $orderId\n";
        $emailBody .= '–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: ' . date('d.m.Y H:i:s') . "\n";
        $emailBody .= "–ò—Å—Ç–æ—á–Ω–∏–∫: –§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ü—Ä–µ–º–∏—É–º v2.0\n";
        $emailBody .= 'IP –∞–¥—Ä–µ—Å: ' . ($order['ip'] ?: '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω') . "\n\n";

        $emailBody .= "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        $emailBody .= "üë§ –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ö–õ–ò–ï–ù–¢–ï\n";
        $emailBody .= "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        $emailBody .= "–ò–º—è: $name\n";
        $emailBody .= "–¢–µ–ª–µ—Ñ–æ–Ω: $phone\n";
        if ($email) $emailBody .= "Email: $email\n";
        $emailBody .= "\n";

        $emailBody .= "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        $emailBody .= "üì∏ –ü–ê–†–ê–ú–ï–¢–†–´ –ü–ï–ß–ê–¢–ò\n";
        $emailBody .= "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        $emailBody .= "–†–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ: $size (" . $sizeConfig['w'] . '√ó' . $sizeConfig['h'] . " —Å–º)\n";
        $emailBody .= "–¢–∏–ø –±—É–º–∞–≥–∏: $paper";
        if ($paperConfig['delta'] > 0) $emailBody .= ' (+' . $paperConfig['delta'] . ' ‚ÇΩ)';
        $emailBody .= "\n";
        $emailBody .= "–¶–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è: $correction";
        if ($correctionConfig['delta'] > 0) $emailBody .= ' (+' . $correctionConfig['delta'] . ' ‚ÇΩ)';
        $emailBody .= "\n";
        $emailBody .= "–¢–∏—Ä–∞–∂: $qty —ç–∫–∑ –Ω–∞ –∫–∞–∂–¥–æ–µ —Ñ–æ—Ç–æ\n";
        $emailBody .= "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ: $photoCount —à—Ç\n";
        $emailBody .= '–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø–µ—á–∞—Ç–∫–æ–≤: ' . ($photoCount * $qty) . " —à—Ç\n";

        if (!empty($selectedProcessing)) {
            $emailBody .= "\nüìé –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏:\n";
            foreach ($selectedProcessing as $proc) {
                $emailBody .= '‚Ä¢ ' . $proc['name'] . ' (' . $proc['price'] . " ‚ÇΩ –∑–∞ —Ñ–æ—Ç–æ)\n";
            }
        }

        if ($deliveryConfig) {
            $emailBody .= "\nüöö –î–æ—Å—Ç–∞–≤–∫–∞: " . $deliveryConfig['name'];
            if ($deliveryConfig['price'] > 0) $emailBody .= ' (+' . $deliveryConfig['price'] . ' ‚ÇΩ)';
            $emailBody .= "\n";
        }

        $emailBody .= "\n";

        $emailBody .= "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        $emailBody .= "üí∞ –†–ê–°–ß–ï–¢ –°–¢–û–ò–ú–û–°–¢–ò\n";
        $emailBody .= "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        $emailBody .= '–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –∑–∞ —Ñ–æ—Ç–æ: ' . $sizeConfig['base'] . " ‚ÇΩ\n";
        if ($paperConfig['delta'] > 0) $emailBody .= '–î–æ–ø–ª–∞—Ç–∞ –∑–∞ –±—É–º–∞–≥—É: +' . $paperConfig['delta'] . " ‚ÇΩ\n";
        if ($correctionConfig['delta'] > 0) $emailBody .= '–î–æ–ø–ª–∞—Ç–∞ –∑–∞ –∫–æ—Ä—Ä–µ–∫—Ü–∏—é: +' . $correctionConfig['delta'] . " ‚ÇΩ\n";
        $emailBody .= "–¶–µ–Ω–∞ –∑–∞ 1 –æ—Ç–ø–µ—á–∞—Ç–æ–∫: $pricePerPhoto ‚ÇΩ\n";
        $emailBody .= '–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏: ' . number_format($totalPhotoCost, 0) . " ‚ÇΩ\n";

        if ($totalProcessingCost > 0) {
            $emailBody .= '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏: +' . number_format($totalProcessingCost, 0) . " ‚ÇΩ\n";
        }

        if ($deliveryCost > 0) {
            $emailBody .= '–î–æ—Å—Ç–∞–≤–∫–∞: +' . number_format($deliveryCost, 0) . " ‚ÇΩ\n";
        }

        if ($discount > 0) {
            $emailBody .= "–°–ö–ò–î–ö–ê –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (-$discount%): -" . number_format($discountAmount, 0) . " ‚ÇΩ\n";
        }

        $emailBody .= "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n";
        $emailBody .= '–ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï: ' . number_format($totalPrice, 0) . " ‚ÇΩ\n";
        $emailBody .= "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n";

        if ($comment) {
            $emailBody .= "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
            $emailBody .= "üí¨ –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô –ö–õ–ò–ï–ù–¢–ê\n";
            $emailBody .= "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
            $emailBody .= "$comment\n\n";
        }

        $emailBody .= "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        $emailBody .= "üìÅ –ó–ê–ì–†–£–ñ–ï–ù–ù–´–ï –§–ê–ô–õ–´ ($photoCount —à—Ç) - –ê–†–•–ò–í –î–õ–Ø –°–ö–ê–ß–ò–í–ê–ù–ò–Ø\n";
        $emailBody .= "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        $totalSize = 0;
        foreach ($uploadedPhotos as $i => $photo) {
            $sizeKB = round($photo['size']/1024, 1);
            $totalSize += $photo['size'];
            $emailBody .= ($i + 1) . '. ' . $photo['original_name'] . "\n";
            $emailBody .= "   –†–∞–∑–º–µ—Ä: {$sizeKB} –ö–ë | –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: " . $photo['dimensions'] . "\n";
            $emailBody .= '   –§–∞–π–ª: ' . $photo['filename'] . "\n";
            $emailBody .= '   –°—Å—ã–ª–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: ' . ($cfg['site'] ?: 'http://' . $_SERVER['HTTP_HOST']) . '/' . basename(__FILE__) . '?download_photo=' . urlencode($photo['filename']) . "\n";

            // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (!empty($photo['edit_params'])) {
                $emailBody .= "   üìù –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:\n";
                if (isset($photo['edit_params']['brightness'])) $emailBody .= '      –Ø—Ä–∫–æ—Å—Ç—å: ' . $photo['edit_params']['brightness'] . "\n";
                if (isset($photo['edit_params']['contrast'])) $emailBody .= '      –ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å: ' . $photo['edit_params']['contrast'] . "\n";
                if (isset($photo['edit_params']['crop'])) {
                    $crop = $photo['edit_params']['crop'];
                    $emailBody .= '      –ö–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ: x=' . $crop['x'] . ', y=' . $crop['y'] . ', w=' . $crop['width'] . ', h=' . $crop['height'] . "\n";
                }
            }
            $emailBody .= "\n";
        }
        $emailBody .= '–û–±—â–∏–π –æ–±—ä–µ–º —Ñ–∞–π–ª–æ–≤: ' . number_format($totalSize/1024/1024, 1) . " –ú–ë\n\n";

        $emailBody .= "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        $emailBody .= "üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø\n";
        $emailBody .= "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        $emailBody .= '–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: ' . ($paymentMethod === 'online' ? '–û–Ω–ª–∞–π–Ω (–Æ–ö–∞—Å—Å–∞)' : '–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏') . "\n";
        $emailBody .= "–í—Å–µ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–ø–∫–µ: uploads/\n";
        $emailBody .= "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–∫–∞–∑–∞ –≤ CRM –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ID: $orderId\n";
        $emailBody .= "–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–∞ –≤—Å–µ—Ö —Ñ–æ—Ç–æ –∑–∞–∫–∞–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é \"–°–∫–∞—á–∞—Ç—å –∞—Ä—Ö–∏–≤ —Ñ–æ—Ç–æ\" –≤ –∞–¥–º–∏–Ω–∫–µ\n\n";

        $emailBody .= "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        $emailBody .= "–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\n";
        $emailBody .= "–°–∏—Å—Ç–µ–º–∞ —Ñ–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –ø—Ä–µ–º–∏—É–º\n";
        $emailBody .= ($cfg['brand'] ?: '–ü–†–ò–ù–¢–°–°') . "\n";
        $emailBody .= "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ú–ï–ì–ê-email –ù–ê artcopy78@bk.ru
        $emailSent = send_email($emailTo, "üéØ –§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ü—Ä–µ–º–∏—É–º #$orderId ‚Äî $photoCount —Ñ–æ—Ç–æ –Ω–∞ $totalPrice ‚ÇΩ", $emailBody, $cfg);

        // Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –ú–ï–ì–ê-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
        $tgMsg = "üéØ <b>–§–û–¢–û–ö–û–ù–°–¢–†–£–ö–¢–û–† –ü–†–ï–ú–ò–£–ú</b>\n\n";
        $tgMsg .= "üÜî <code>$orderId</code>\n";
        $tgMsg .= "üë§ <b>$name</b>\n";
        $tgMsg .= "üìû <code>$phone</code>\n";
        if ($email) $tgMsg .= "‚úâÔ∏è <code>$email</code>\n";
        $tgMsg .= "\nüì∏ <b>–ó–∞–∫–∞–∑:</b>\n";
        $tgMsg .= "üìê $size (" . $sizeConfig['w'] . '√ó' . $sizeConfig['h'] . " —Å–º)\n";
        $tgMsg .= "üìÑ $paper";
        if ($paperConfig['delta'] > 0) $tgMsg .= " (+" . $paperConfig['delta'] . "‚ÇΩ)";
        $tgMsg .= "\nüé® $correction";
        if ($correctionConfig['delta'] > 0) $tgMsg .= " (+" . $correctionConfig['delta'] . "‚ÇΩ)";
        $tgMsg .= "\nüî¢ –¢–∏—Ä–∞–∂: $qty —ç–∫–∑/—Ñ–æ—Ç–æ\n";
        $tgMsg .= "üì∑ –§–æ—Ç–æ: <b>$photoCount</b> —à—Ç\n";
        $tgMsg .= 'üì¶ –û—Ç–ø–µ—á–∞—Ç–∫–æ–≤: <b>' . ($photoCount * $qty) . "</b> —à—Ç\n";

        if (!empty($selectedProcessing)) {
            $tgMsg .= "\nüõ† <b>–î–æ–ø. —É—Å–ª—É–≥–∏:</b>\n";
            foreach ($selectedProcessing as $proc) {
                $tgMsg .= "‚Ä¢ " . $proc['name'] . " (" . $proc['price'] . "‚ÇΩ)\n";
            }
        }

        if ($deliveryConfig) {
            $tgMsg .= "\nüöö <b>–î–æ—Å—Ç–∞–≤–∫–∞:</b> " . $deliveryConfig['name'];
            if ($deliveryConfig['price'] > 0) $tgMsg .= " (+" . $deliveryConfig['price'] . "‚ÇΩ)";
            $tgMsg .= "\n";
        }

        if ($discount > 0) {
            $tgMsg .= "\nüéØ <b>–°–∫–∏–¥–∫–∞:</b> $discount% (-" . number_format($discountAmount, 0) . "‚ÇΩ)\n";
        }

        $tgMsg .= "\nüí∞ <b>–ò–¢–û–ì–û: " . number_format($totalPrice, 0) . " ‚ÇΩ</b>\n";
        $tgMsg .= "üí≥ " . ($paymentMethod === 'online' ? '–û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞' : '–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏') . "\n";

        if ($comment) {
            $tgMsg .= "\nüí¨ <i>" . mb_substr($comment, 0, 100);
            if (mb_strlen($comment) > 100) $tgMsg .= '...';
            $tgMsg .= '</i>';
        }

        $telegramSent = send_telegram($cfg, $tgMsg);

        // –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        $response['message'] = '‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.';

        if (!$emailSent && !$telegramSent) {
            $response['warning'] = '‚ö†Ô∏è –ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.';
        } elseif (!$emailSent) {
            $response['warning'] = '‚ö†Ô∏è –ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –Ω–æ –ø–∏—Å—å–º–æ –Ω–∞ email –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.';
        } elseif (!$telegramSent) {
            $response['warning'] = '‚ö†Ô∏è –ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –Ω–æ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.';
        }

        echo json_encode($response);

    } catch (Exception $e) {
        // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
        $errorLog = [
            'error' => $e->getMessage(),
            'trace' => $e->getTraceAsString(),
            'post_data' => $_POST,
            'files_data' => $_FILES,
            'timestamp' => date('Y-m-d H:i:s'),
            'ip' => $_SERVER['REMOTE_ADDR'] ?? ''
        ];
        @file_put_contents($ordersLog, '['.date('Y-m-d H:i:s').'] ERROR: '.json_encode($errorLog, JSON_UNESCAPED_UNICODE).PHP_EOL, FILE_APPEND);

        echo json_encode(['ok' => false, 'error' => $e->getMessage()]);
    }
    exit;
}

// –¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞
$T = $cfg['theme'] ?? [];
$cardOpacity = is_numeric($T['card_opacity']) ? max(0.3, min(1, (float)$T['card_opacity'])) : 0.65;
$blur = (int)($T['blur'] ?? 12);
$radius = (int)($T['radius'] ?? 16);
$shadow = (float)($T['shadow'] ?? 0.12);
$container = (int)($T['container'] ?? 1200);
$muted = $T['muted'] ?? '#5c6b84';
$bg = $T['bg'] ?? '#f3f7ff';
$text = $T['text'] ?? '#0e1220';
$brandCol = $T['brand'] ?? '#FF8A00';
$accentCol = $T['accent'] ?? '#2D5BFF';
?>
<!doctype html>
<html lang='ru'>
<head>
  <meta charset='utf-8'>
  <title>–ü—Ä–µ–º–∏—É–º —Ñ–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º ‚Äî <?=esc($cfg['brand'] ?? '–ü–†–ò–ù–¢–°–°')?></title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <meta name='description' content='–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑ —Ñ–æ—Ç–æ–ø–µ—á–∞—Ç–∏ –æ–Ω–ª–∞–π–Ω —Å —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —è—Ä–∫–æ—Å—Ç—å –∏ –∫–æ–Ω—Ç—Ä–∞—Å—Ç, –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä. –ë—ã—Å—Ç—Ä–æ, –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ, —É–¥–æ–±–Ω–æ.'>
  <meta name='keywords' content='—Ñ–æ—Ç–æ–ø–µ—á–∞—Ç—å, —Ä–µ–¥–∞–∫—Ç–æ—Ä —Ñ–æ—Ç–æ, –ø–µ—á–∞—Ç—å —Ñ–æ—Ç–æ, —Ñ–æ—Ç–æ—É—Å–ª—É–≥–∏, –æ–Ω–ª–∞–π–Ω –∑–∞–∫–∞–∑ —Ñ–æ—Ç–æ, —è—Ä–∫–æ—Å—Ç—å, –∫–æ–Ω—Ç—Ä–∞—Å—Ç, –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ'>

  <style>
    :root{
      --bg: <?=esc($bg)?>;
      --text: <?=esc($text)?>;
      --muted: <?=esc($muted)?>;
      --brand: <?=esc($brandCol)?>;
      --accent: <?=esc($accentCol)?>;
      --card: rgba(255,255,255, <?=esc(number_format($cardOpacity,2,'.',''))?>);
      --glass-blur: <?=esc($blur)?>px;
      --radius: <?=esc($radius)?>px;
      --shadow: 0 10px 30px rgba(0,0,0, <?=esc(number_format($shadow,2,'.',''))?>);
      --container: <?=esc($container)?>px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Arial;
      color:var(--text);
      background:var(--bg);
      background:
        radial-gradient(900px 300px at 70% -10%, rgba(45,91,255,.08), transparent 60%),
        radial-gradient(700px 280px at 20% -20%, rgba(255,138,0,.10), transparent 70%),
        var(--bg);
      line-height: 1.5;
      min-height: 100vh;
    }

    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      background:var(--card);
      backdrop-filter:blur(var(--glass-blur)) saturate(160%);
      border-bottom:1px solid rgba(0,0,0,.08);
      padding: 12px 0;
    }

    .topflex{
      max-width:var(--container);
      margin:0 auto;
      padding:0 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap
    }

    .logo{
      display:flex;
      gap:12px;
      align-items:center;
      text-decoration:none;
      color:inherit;
    }

    .logo-badge{
      width:40px;
      height:40px;
      border-radius:10px;
      background:linear-gradient(135deg, var(--brand), #FFB14D);
      display:grid;
      place-items:center;
      color:#000;
      font-weight:800;
      font-size:16px;
    }

    .logo-title{
      font-weight:700;
      font-size:18px;
    }

    .nav{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .nav a{
      color:inherit;
      padding:8px 12px;
      border-radius:8px;
      font-weight:500;
      transition:all 0.2s;
      text-decoration:none;
      font-size:14px;
    }

    .nav a:hover{
      background:rgba(0,0,0,.06);
    }

    .wrap{
      max-width:var(--container);
      margin:20px auto;
      display:grid;
      grid-template-columns:1.2fr 0.8fr;
      gap:20px;
      padding:0 20px;
    }

    @media(max-width:1000px){
      .wrap{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);
      border:1px solid rgba(0,0,0,.08);
      border-radius:var(--radius);
      backdrop-filter:blur(var(--glass-blur));
      box-shadow:var(--shadow);
      padding:24px;
    }

    h2{
      margin:0 0 16px;
      font-size:20px;
      font-weight:700;
    }

    .form-group{
      margin-bottom:16px;
    }

    .form-group label{
      display:block;
      color:var(--text);
      font-size:14px;
      font-weight:600;
      margin-bottom:6px;
    }

    input[type='text'], input[type='email'], input[type='number'], select, textarea{
      width:100%;
      padding:12px;
      border-radius:8px;
      border:1px solid rgba(0,0,0,.15);
      background:#fff;
      color:var(--text);
      font-size:14px;
      transition: border-color 0.2s;
    }

    input:focus, select:focus, textarea:focus{
      border-color:var(--accent);
      outline:none;
    }

    textarea{
      min-height:80px;
      resize:vertical;
    }

    .uploader{
      border:2px dashed rgba(0,0,0,.2);
      border-radius:12px;
      padding:30px 20px;
      text-align:center;
      background:rgba(0,0,0,.02);
      position:relative;
      transition: all 0.3s;
    }

    .uploader.dragover{
      border-color:var(--accent);
      background:rgba(45,91,255,.04);
    }

    .uploader input[type=file]{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
    }

    .uploader .hint{
      color:var(--muted);
      font-size:14px;
    }

    .uploader .icon{
      font-size:48px;
      margin-bottom:12px;
      color:var(--accent);
    }

    .previews{
      margin-top:20px;
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));
      gap:12px;
    }

    .thumb{
      border:1px solid rgba(0,0,0,.1);
      border-radius:12px;
      overflow:hidden;
      background:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.1);
      position: relative;
      transition: all 0.3s;
    }

    .thumb:hover{
      transform: translateY(-2px);
      box-shadow:0 8px 25px rgba(0,0,0,.15);
    }

    .thumb .img{
      width:100%;
      height:150px;
      background:#f8f9fa center/cover no-repeat;
      position: relative;
    }

    .thumb .info{
      padding: 12px;
      font-size: 11px;
      color: var(--muted);
    }

    .thumb .remove-btn{
      position: absolute;
      top: 6px;
      right: 6px;
      width: 28px;
      height: 28px;
      background: rgba(255, 0, 0, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      z-index: 10;
    }

    .thumb .remove-btn:hover{
      background: rgba(255, 0, 0, 1);
      transform: scale(1.1);
    }

    .thumb .edit-btn{
      position: absolute;
      top: 6px;
      left: 6px;
      width: 28px;
      height: 28px;
      background: rgba(45, 91, 255, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      z-index: 10;
    }

    .thumb .edit-btn:hover{
      background: rgba(45, 91, 255, 1);
      transform: scale(1.1);
    }

    /* –†–ï–î–ê–ö–¢–û–† –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô */
    .photo-editor{
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .photo-editor.show{
      display: flex;
    }

    .editor-content{
      background: var(--card);
      border-radius: 16px;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .editor-header{
      padding: 20px;
      border-bottom: 1px solid rgba(0,0,0,.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .editor-body{
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .editor-preview{
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      position: relative;
      overflow: hidden;
    }

    .editor-image{
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .crop-overlay{
      position: absolute;
      border: 2px solid var(--accent);
      cursor: move;
      display: none;
    }

    .crop-overlay.show{
      display: block;
    }

    .crop-handle{
      position: absolute;
      width: 8px;
      height: 8px;
      background: var(--accent);
      border: 1px solid #fff;
      cursor: nw-resize;
    }

    .editor-controls{
      width: 280px;
      padding: 20px;
      background: var(--card);
      border-left: 1px solid rgba(0,0,0,.1);
      overflow-y: auto;
    }

    .control-group{
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(0,0,0,.1);
    }

    .control-group:last-child{
      border-bottom: none;
    }

    .control-group label{
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text);
    }

    .control-slider{
      width: 100%;
      margin: 8px 0;
      accent-color: var(--accent);
    }

    .control-value{
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .crop-controls{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 12px;
    }

    .btn-crop{
      padding: 6px 12px;
      border: 1px solid rgba(0,0,0,.2);
      background: #fff;
      color: var(--text);
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .btn-crop:hover{
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .btn-crop.active{
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .calc{
      margin-top:16px;
      padding:16px;
      background:rgba(255,138,0,.08);
      border-radius:8px;
    }

    .calc .price-line{
      display:flex;
      justify-content:space-between;
      margin:4px 0;
      font-size:13px;
    }

    .calc .total{
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid rgba(0,0,0,.1);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .calc #price{
      font-weight:800;
      font-size:24px;
      color:var(--brand);
    }

    .note{
      color:var(--muted);
      font-size:13px;
      margin-top:8px;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:12px 20px;
      border-radius:8px;
      text-decoration:none;
      font-weight:600;
      transition:all 0.2s;
      border:none;
      cursor:pointer;
      font-size:14px;
    }

    .btn-primary{
      background:linear-gradient(135deg, var(--accent), #00C2FF);
      color:#fff;
    }

    .btn-secondary{
      background:var(--card);
      color:var(--text);
      border:1px solid rgba(0,0,0,.1);
    }

    .btn-success{
      background:linear-gradient(135deg, #28a745, #20c997);
      color:#fff;
    }

    .btn-danger{
      background:linear-gradient(135deg, #dc3545, #fd7e14);
      color:#fff;
    }

    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(0,0,0,.2);
    }

    .btn:disabled{
      opacity:0.6;
      cursor:not-allowed;
      transform:none;
    }

    .msg{
      margin-top:12px;
      font-size:14px;
      padding:12px;
      border-radius:8px;
    }

    .msg.success{
      background:#d4edda;
      color:#155724;
      border:1px solid #c3e6cb;
    }

    .msg.error{
      background:#f8d7da;
      color:#721c24;
      border:1px solid #f5c6cb;
    }

    .msg.warning{
      background:#fff3cd;
      color:#856404;
      border:1px solid #ffeaa7;
    }

    .payment-methods{
      margin:16px 0;
      padding:16px;
      background:rgba(0,0,0,.03);
      border-radius:8px;
    }

    .payment-option{
      display:flex;
      align-items:center;
      gap:8px;
      margin:8px 0;
    }

    .payment-option input[type=radio]{
      margin:0;
      width:auto;
    }

    .options-group{
      margin:16px 0;
      padding:16px;
      background:rgba(0,0,0,.03);
      border-radius:8px;
    }

    .option-item{
      display:flex;
      align-items:center;
      gap:8px;
      margin:8px 0;
    }

    .option-item input[type=checkbox]{
      margin:0;
      width:auto;
    }

    .discount-badge{
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .loading{
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .loading.show{
      display: flex;
    }

    .loading-content{
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .spinner{
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .disabled-notice{
      text-align:center;
      padding:60px 20px;
      color:var(--muted);
    }

    .disabled-notice h2{
      color:var(--text);
      margin-bottom:16px;
    }

    .preview-badge{
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 138, 0, 0.9);
      color: #fff;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      z-index: 5;
    }

    @media(max-width:768px){
      .topflex{
        flex-direction:column;
        text-align:center;
      }
      .nav{
        justify-content:center;
      }
      .wrap{
        padding:0 16px;
        gap:16px;
      }
      .card{
        padding:20px;
      }
      .previews{
        grid-template-columns:repeat(auto-fill, minmax(150px, 1fr));
        gap:8px;
      }
      .editor-content{
        width: 95%;
        height: 95vh;
      }
      .editor-body{
        flex-direction: column;
      }
      .editor-controls{
        width: 100%;
        max-height: 200px;
        border-left: none;
        border-top: 1px solid rgba(0,0,0,.1);
      }
    }
  </style>
</head>
<body>
  <?php if (empty($photoConfig['enabled'])): ?>
    <div class='disabled-notice'>
      <h2>‚ö†Ô∏è –§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</h2>
      <p>–ü—Ä–∏–Ω–æ—Å–∏–º –∏–∑–≤–∏–Ω–µ–Ω–∏—è –∑–∞ –Ω–µ—É–¥–æ–±—Å—Ç–≤–∞. –°–µ—Ä–≤–∏—Å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏.</p>
      <a href='/' class='btn btn-primary'>üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>
  <?php else: ?>

  <header class='topbar'>
    <div class='topflex'>
      <a href='/' class='logo'>
        <div class='logo-badge'>–ü</div>
        <div>
          <div class='logo-title'><?=esc($cfg['brand'] ?? '–ü–†–ò–ù–¢–°–°')?></div>
          <div style='font-size:12px;color:var(--muted)'>–ü—Ä–µ–º–∏—É–º —Ñ–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º</div>
        </div>
      </a>

      <nav class='nav'>
        <a href='/'>üè† –ì–ª–∞–≤–Ω–∞—è</a>
        <a href='products.php'>üõçÔ∏è –¢–æ–≤–∞—Ä—ã</a>
        <a href='tel:<?=esc($cfg['phone_raw'] ?? '+79522003990')?>'><?=esc($cfg['phone_display'] ?? '+7 (952) 200-39-90')?></a>
      </nav>
    </div>
  </header>

  <main class='wrap'>
    <section class='card'>
      <h2>üì∏ –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h2>
      <p style='color:var(--muted);margin-bottom:20px'>
        –í—ã–±–µ—Ä–∏—Ç–µ –¥–æ <?=esc($photoConfig['max_photos'])?> —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –¥–ª—è –ø–µ—á–∞—Ç–∏.
        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: <?=esc(strtoupper(implode(', ', $photoConfig['supported_formats'])))?>. 
        –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: <?=esc($photoConfig['max_file_size'])?>–ú–ë.
        <br><strong>üé® –ù–æ–≤–æ–µ: –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —è—Ä–∫–æ—Å—Ç–∏, –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ –∏ –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è!</strong>
      </p>

      <div class='uploader' id='uploader'>
        <input type='file' id='files' accept='image/*' multiple>
        <div class='icon'>üì∑</div>
        <div class='hint'>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
        <div style='font-size:12px;color:var(--muted);margin-top:8px'>
          –ú–∞–∫—Å–∏–º—É–º <?=esc($photoConfig['max_photos'])?> —Ñ–∞–π–ª–æ–≤, –¥–æ <?=esc($photoConfig['max_file_size'])?>–ú–ë –∫–∞–∂–¥—ã–π
        </div>
      </div>

      <div id='previews' class='previews'></div>
    </section>

    <section class='card'>
      <h2>‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—á–∞—Ç–∏</h2>

      <div class='form-group'>
        <label>–†–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ</label>
        <select id='size'>
          <?php foreach($enabledSizes as $size): ?>
            <option value='<?=esc($size['name'])?>' data-price='<?=esc($size['base'])?>' <?=!empty($size['popular']) ? 'data-popular=\'1\'' : ''?>>
              <?=esc($size['name'])?> (<?=esc($size['w'])?>√ó<?=esc($size['h'])?>—Å–º) ‚Äî <?=esc($size['base'])?> ‚ÇΩ
              <?=!empty($size['popular']) ? ' ‚≠ê' : ''?>
            </option>
          <?php endforeach; ?>
        </select>
      </div>

      <div class='form-group'>
        <label>–¢–∏–ø –±—É–º–∞–≥–∏</label>
        <select id='paper'>
          <?php foreach($enabledPapers as $paper): ?>
            <option value='<?=esc($paper['name'])?>' data-delta='<?=esc($paper['delta'])?>' title='<?=esc($paper['description'])?>'>
              <?=esc($paper['name'])?>
              <?php if($paper['delta'] > 0): ?> (+<?=esc($paper['delta'])?> ‚ÇΩ)<?php endif; ?>
            </option>
          <?php endforeach; ?>
        </select>
      </div>

      <div class='form-group'>
        <label>–¢–∏—Ä–∞–∂ –Ω–∞ –∫–∞–∂–¥–æ–µ —Ñ–æ—Ç–æ</label>
        <input type='number' id='qty' min='1' max='100' value='1'>
      </div>

      <div class='form-group'>
        <label>–¶–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è</label>
        <select id='correction'>
          <?php foreach($enabledCorrections as $correction): ?>
            <option value='<?=esc($correction['name'])?>' data-delta='<?=esc($correction['delta'])?>' title='<?=esc($correction['description'])?>'>
              <?=esc($correction['name'])?>
              <?php if($correction['delta'] > 0): ?> (+<?=esc($correction['delta'])?> ‚ÇΩ)<?php endif; ?>
            </option>
          <?php endforeach; ?>
        </select>
      </div>

      <?php if (!empty($enabledProcessingOptions)): ?>
      <div class='options-group'>
        <div style='font-weight:600;margin-bottom:8px'>üõ†Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ (–Ω–∞ –∫–∞–∂–¥–æ–µ —Ñ–æ—Ç–æ):</div>
        <?php foreach($enabledProcessingOptions as $i => $option): ?>
          <div class='option-item'>
            <input type='checkbox' id='proc_<?=$i?>' name='processing_options[]' value='<?=esc($option['name'])?>' data-price='<?=esc($option['price'])?>'>
            <label for='proc_<?=$i?>' style='margin:0;font-weight:normal;font-size:13px'>
              <?=esc($option['name'])?> (+<?=esc($option['price'])?> ‚ÇΩ)
              <?php if (!empty($option['description'])): ?>
                <small style='color:var(--muted);display:block'><?=esc($option['description'])?></small>
              <?php endif; ?>
            </label>
          </div>
        <?php endforeach; ?>
      </div>
      <?php endif; ?>

      <?php if (!empty($enabledDeliveryOptions)): ?>
      <div class='form-group'>
        <label>–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</label>
        <select id='delivery'>
          <option value=''>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–±</option>
          <?php foreach($enabledDeliveryOptions as $option): ?>
            <option value='<?=esc($option['name'])?>' data-price='<?=esc($option['price'])?>'>
              <?=esc($option['name'])?>
              <?php if($option['price'] > 0): ?> (+<?=esc($option['price'])?> ‚ÇΩ)<?php endif; ?>
            </option>
          <?php endforeach; ?>
        </select>
      </div>
      <?php endif; ?>

      <div class='calc'>
        <div class='price-line'>
          <span>–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:</span>
          <span id='photoCount'>0 —à—Ç</span>
        </div>
        <div class='price-line'>
          <span>–í—Å–µ–≥–æ –æ—Ç–ø–µ—á–∞—Ç–∫–æ–≤:</span>
          <span id='totalCopies'>0 —à—Ç</span>
        </div>
        <div class='price-line'>
          <span>–¶–µ–Ω–∞ –∑–∞ –æ—Ç–ø–µ—á–∞—Ç–æ–∫:</span>
          <span id='pricePerCopy'>0 ‚ÇΩ</span>
        </div>
        <div id='processingLine' class='price-line' style='display:none'>
          <span>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏:</span>
          <span id='processingCost'>0 ‚ÇΩ</span>
        </div>
        <div id='deliveryLine' class='price-line' style='display:none'>
          <span>–î–æ—Å—Ç–∞–≤–∫–∞:</span>
          <span id='deliveryCost'>0 ‚ÇΩ</span>
        </div>
        <div id='discountLine' class='price-line' style='display:none;color:var(--brand)'>
          <span>–°–∫–∏–¥–∫–∞:</span>
          <span id='discountText'>0%</span>
        </div>
        <div class='total'>
          <div style='font-size:14px;color:var(--muted)'>–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</div>
          <div id='price'>0 ‚ÇΩ</div>
        </div>
      </div>

      <div class='note'>
        üí° –¢–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –±—É–¥–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ –ø–æ–∂–µ–ª–∞–Ω–∏–π.
        <?php if (!empty($enabledDiscounts)): ?>
          <br>üéØ –î–µ–π—Å—Ç–≤—É—é—Ç —Å–∫–∏–¥–∫–∏ –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:
          <?php foreach($enabledDiscounts as $discount): ?>
            –æ—Ç <?=esc($discount['threshold'])?> —Ñ–æ—Ç–æ ‚Äî <?=esc($discount['discount_percent'])?>%;
          <?php endforeach; ?>
        <?php endif; ?>
      </div>

      <h2 style='margin-top:24px'>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h2>
      <textarea id='comment' placeholder='–£–∫–∞–∂–∏—Ç–µ –æ—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è: –ø–µ—á–∞—Ç—å –±–µ–∑ –ø–æ–ª–µ–π, –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ, –∫–æ—Ä—Ä–µ–∫—Ü–∏—è —Ü–≤–µ—Ç–∞ –∏ —Ç.–¥.'></textarea>

      <h2 style='margin-top:24px'>üìû –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>

      <div class='form-group'>
        <label>–í–∞—à–µ –∏–º—è *</label>
        <input type='text' id='name' placeholder='–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤' required>
      </div>

      <div class='form-group'>
        <label>–¢–µ–ª–µ—Ñ–æ–Ω *</label>
        <input type='text' id='phone' placeholder='+7 (999) 123-45-67' required>
      </div>

      <div class='form-group'>
        <label>Email (–¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)</label>
        <input type='email' id='email' placeholder='ivan@example.com'>
      </div>

      <?php if (!empty($cfg['yukassa']['enabled']) && !empty($cfg['yukassa']['services']['photo_constructor'])): ?>
      <div class='payment-methods'>
        <div style='font-weight:600;margin-bottom:8px'>üí≥ –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</div>
        <div class='payment-option'>
          <input type='radio' id='payment_offline' name='payment_method' value='offline' checked>
          <label for='payment_offline'>–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ (–Ω–∞–ª–∏—á–Ω—ã–µ/–∫–∞—Ä—Ç–∞)</label>
        </div>
        <div class='payment-option'>
          <input type='radio' id='payment_online' name='payment_method' value='online'>
          <label for='payment_online'>–û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞ (–Æ–ö–∞—Å—Å–∞)</label>
        </div>
      </div>
      <?php endif; ?>

      <button id='btnSend' class='btn btn-primary' style='width:100%;margin-top:16px'>
        üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑
      </button>

      <div id='msg' class='msg' style='display:none'></div>
    </section>
  </main>

  <!-- –†–ï–î–ê–ö–¢–û–† –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô -->
  <div id='photoEditor' class='photo-editor'>
    <div class='editor-content'>
      <div class='editor-header'>
        <h3>üé® –†–µ–¥–∞–∫—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h3>
        <div>
          <button class='btn btn-success' onclick='applyEdits()'>‚úì –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <button class='btn btn-secondary' onclick='closeEditor()'>–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
      <div class='editor-body'>
        <div class='editor-preview'>
          <canvas id='editorCanvas'></canvas>
          <div id='cropOverlay' class='crop-overlay'>
            <div class='crop-handle' style='top:-4px;left:-4px'></div>
            <div class='crop-handle' style='top:-4px;right:-4px'></div>
            <div class='crop-handle' style='bottom:-4px;left:-4px'></div>
            <div class='crop-handle' style='bottom:-4px;right:-4px'></div>
          </div>
        </div>
        <div class='editor-controls'>
          <div class='control-group'>
            <label>–Ø—Ä–∫–æ—Å—Ç—å</label>
            <input type='range' class='control-slider' id='brightnessSlider' min='-100' max='100' value='0'>
            <div class='control-value' id='brightnessValue'>0</div>
          </div>

          <div class='control-group'>
            <label>–ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å</label>
            <input type='range' class='control-slider' id='contrastSlider' min='-100' max='100' value='0'>
            <div class='control-value' id='contrastValue'>0</div>
          </div>

          <div class='control-group'>
            <label>–ö–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</label>
            <div class='crop-controls'>
              <button class='btn-crop' data-ratio='free'>–°–≤–æ–±–æ–¥–Ω–æ</button>
              <button class='btn-crop' data-ratio='square'>–ö–≤–∞–¥—Ä–∞—Ç</button>
              <button class='btn-crop' data-ratio='4:3'>4:3</button>
              <button class='btn-crop' data-ratio='16:9'>16:9</button>
              <button class='btn-crop' data-ratio='3:4'>3:4</button>
              <button class='btn-crop' data-ratio='2:3'>2:3</button>
            </div>
            <div style='margin-top:12px'>
              <button class='btn btn-secondary' style='width:100%' onclick='enableCrop()'>üî≤ –í–∫–ª—é—á–∏—Ç—å –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            </div>
          </div>

          <div class='control-group'>
            <label>–î–µ–π—Å—Ç–≤–∏—è</label>
            <button class='btn btn-secondary' style='width:100%;margin-bottom:8px' onclick='resetEdits()'>üîÑ –°–±—Ä–æ—Å</button>
            <button class='btn btn-danger' style='width:100%' onclick='closeEditor()'>‚ùå –û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id='loading' class='loading'>
    <div class='loading-content'>
      <div class='spinner'></div>
      <div>–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞...</div>
    </div>
  </div>

  <?php endif; ?>

  <script>
    // –ü–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ –∞–¥–º–∏–Ω–∫–∏
    let CONFIG = null;
    const MAX_FILE_SIZE_MB = <?=esc($photoConfig['max_file_size'] ?? 10)?>;
    const MAX_FILE_SIZE = MAX_FILE_SIZE_MB * 1024 * 1024;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
    fetch('?api=config')
      .then(response => response.json())
      .then(config => {
        CONFIG = config;
        console.log('–ö–æ–Ω—Ñ–∏–≥ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –∞–¥–º–∏–Ω–∫–∏:', CONFIG);
        if (!CONFIG.enabled) {
          document.body.innerHTML = '<div class="disabled-notice"><h2>‚ö†Ô∏è –§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –æ—Ç–∫–ª—é—á–µ–Ω</h2><p>–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</p></div>';
        }
      })
      .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞:', error);
        CONFIG = {
          enabled: true,
          max_photos: <?=esc($photoConfig['max_photos'] ?? 100)?>,
          max_file_size: <?=esc($photoConfig['max_file_size'] ?? 10)?>
        };
      });

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    const files = document.getElementById('files');
    const previews = document.getElementById('previews');
    const priceEl = document.getElementById('price');
    const uploader = document.getElementById('uploader');
    const photoCountEl = document.getElementById('photoCount');
    const totalCopiesEl = document.getElementById('totalCopies');
    const pricePerCopyEl = document.getElementById('pricePerCopy');
    const processingLineEl = document.getElementById('processingLine');
    const processingCostEl = document.getElementById('processingCost');
    const deliveryLineEl = document.getElementById('deliveryLine');
    const deliveryCostEl = document.getElementById('deliveryCost');
    const discountLineEl = document.getElementById('discountLine');
    const discountTextEl = document.getElementById('discountText');

    let uploadedFiles = [];
    let currentDiscount = 0;
    let currentProcessingCost = 0;
    let currentDeliveryCost = 0;

    // –†–ï–î–ê–ö–¢–û–† –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô
    let currentEditingIndex = -1;
    let editorCanvas = null;
    let editorCtx = null;
    let originalImageData = null;
    let currentImage = null;
    let editParams = {};
    let cropMode = false;
    let cropData = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    function initEditor() {
      editorCanvas = document.getElementById('editorCanvas');
      editorCtx = editorCanvas.getContext('2d');

      // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–æ–≤
      document.getElementById('brightnessSlider').addEventListener('input', updatePreview);
      document.getElementById('contrastSlider').addEventListener('input', updatePreview);

      // –ö–Ω–æ–ø–∫–∏ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–π –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
      document.querySelectorAll('.btn-crop').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.btn-crop').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
        });
      });
    }

    function openEditor(fileIndex) {
      if (fileIndex < 0 || fileIndex >= uploadedFiles.length) return;

      currentEditingIndex = fileIndex;
      const file = uploadedFiles[fileIndex];

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
      editParams = file.editParams || {
        brightness: 0,
        contrast: 0,
        crop: null
      };

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Å–ª–∞–π–¥–µ—Ä–æ–≤
      document.getElementById('brightnessSlider').value = editParams.brightness || 0;
      document.getElementById('contrastSlider').value = editParams.contrast || 0;
      document.getElementById('brightnessValue').textContent = editParams.brightness || 0;
      document.getElementById('contrastValue').textContent = editParams.contrast || 0;

      // –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      const img = new Image();
      img.onload = function() {
        currentImage = img;
        originalImageData = null;
        cropData = editParams.crop;

        // –†–∞–∑–º–µ—Ä—ã –∫–∞–Ω–≤–∞—Å–∞
        const maxWidth = 600;
        const maxHeight = 400;
        let { width, height } = img;

        if (width > maxWidth || height > maxHeight) {
          const ratio = Math.min(maxWidth / width, maxHeight / height);
          width *= ratio;
          height *= ratio;
        }

        editorCanvas.width = width;
        editorCanvas.height = height;
        editorCanvas.style.maxWidth = '100%';
        editorCanvas.style.maxHeight = '100%';

        updatePreview();
        document.getElementById('photoEditor').classList.add('show');
      };

      img.src = file.url;
    }

    function updatePreview() {
      if (!currentImage || !editorCtx) return;

      const brightness = parseInt(document.getElementById('brightnessSlider').value);
      const contrast = parseInt(document.getElementById('contrastSlider').value);

      document.getElementById('brightnessValue').textContent = brightness;
      document.getElementById('contrastValue').textContent = contrast;

      // –û—á–∏—â–∞–µ–º –∫–∞–Ω–≤–∞—Å
      editorCtx.clearRect(0, 0, editorCanvas.width, editorCanvas.height);

      // –†–∏—Å—É–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      editorCtx.drawImage(currentImage, 0, 0, editorCanvas.width, editorCanvas.height);

      // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
      if (brightness !== 0 || contrast !== 0) {
        const imageData = editorCtx.getImageData(0, 0, editorCanvas.width, editorCanvas.height);
        const data = imageData.data;

        for (let i = 0; i < data.length; i += 4) {
          // –Ø—Ä–∫–æ—Å—Ç—å
          data[i] = Math.max(0, Math.min(255, data[i] + brightness));     // R
          data[i + 1] = Math.max(0, Math.min(255, data[i + 1] + brightness)); // G
          data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + brightness)); // B

          // –ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å
          if (contrast !== 0) {
            const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
            data[i] = Math.max(0, Math.min(255, factor * (data[i] - 128) + 128));     // R
            data[i + 1] = Math.max(0, Math.min(255, factor * (data[i + 1] - 128) + 128)); // G
            data[i + 2] = Math.max(0, Math.min(255, factor * (data[i + 2] - 128) + 128)); // B
          }
        }

        editorCtx.putImageData(imageData, 0, 0);
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
      if (cropData) {
        drawCropOverlay();
      }
    }

    function enableCrop() {
      cropMode = !cropMode;
      const overlay = document.getElementById('cropOverlay');

      if (cropMode) {
        if (!cropData) {
          cropData = {
            x: editorCanvas.width * 0.1,
            y: editorCanvas.height * 0.1,
            width: editorCanvas.width * 0.8,
            height: editorCanvas.height * 0.8
          };
        }
        overlay.classList.add('show');
        setupCropHandlers();
      } else {
        overlay.classList.remove('show');
        cropData = null;
      }
    }

    function setupCropHandlers() {
      // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è drag & drop –¥–ª—è –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
      // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
      console.log('–ö–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.');
    }

    function drawCropOverlay() {
      if (!cropData) return;

      editorCtx.save();
      editorCtx.strokeStyle = '#2D5BFF';
      editorCtx.lineWidth = 2;
      editorCtx.strokeRect(cropData.x, cropData.y, cropData.width, cropData.height);
      editorCtx.restore();
    }

    function resetEdits() {
      document.getElementById('brightnessSlider').value = 0;
      document.getElementById('contrastSlider').value = 0;
      cropData = null;
      document.getElementById('cropOverlay').classList.remove('show');
      updatePreview();
    }

    function applyEdits() {
      if (currentEditingIndex >= 0 && currentEditingIndex < uploadedFiles.length) {
        const brightness = parseInt(document.getElementById('brightnessSlider').value);
        const contrast = parseInt(document.getElementById('contrastSlider').value);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        uploadedFiles[currentEditingIndex].editParams = {
          brightness: brightness,
          contrast: contrast,
          crop: cropData
        };

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é –º–∏–Ω–∏–∞—Ç—é—Ä—ã
        updateThumbnail(currentEditingIndex);

        closeEditor();
        showMessage('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã', 'success');
        setTimeout(() => hideMessage(), 2000);
      }
    }

    function closeEditor() {
      document.getElementById('photoEditor').classList.remove('show');
      currentEditingIndex = -1;
      cropMode = false;
      cropData = null;
    }

    function updateThumbnail(index) {
      const file = uploadedFiles[index];
      const thumb = document.querySelector('[data-index="' + index + '"] .img');

      if (thumb && file.editParams && (file.editParams.brightness !== 0 || file.editParams.contrast !== 0)) {
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–æ–∫ —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ
        let badge = document.querySelector('[data-index="' + index + '"] .preview-badge');
        if (!badge) {
          badge = document.createElement('div');
          badge.className = 'preview-badge';
          badge.textContent = 'üé® –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ';
          document.querySelector('[data-index="' + index + '"]').appendChild(badge);
        }
      }
    }

    // –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    function calcPrice() {
      const sizeSelect = document.getElementById('size');
      const paperSelect = document.getElementById('paper');
      const correctionSelect = document.getElementById('correction');
      const deliverySelect = document.getElementById('delivery');
      const qty = parseInt(document.getElementById('qty').value || '1');
      const photoCount = uploadedFiles.length;

      const basePrice = parseInt(sizeSelect.selectedOptions[0] && sizeSelect.selectedOptions[0].dataset.price || '0');
      const paperDelta = parseInt(paperSelect.selectedOptions[0] && paperSelect.selectedOptions[0].dataset.delta || '0');
      const correctionDelta = parseInt(correctionSelect.selectedOptions[0] && correctionSelect.selectedOptions[0].dataset.delta || '0');

      const pricePerPhoto = basePrice + paperDelta + correctionDelta;
      const totalCopies = photoCount * qty;

      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏
      currentProcessingCost = 0;
      const processingCheckboxes = document.querySelectorAll('input[name="processing_options[]"]:checked');
      processingCheckboxes.forEach(cb => {
        currentProcessingCost += parseInt(cb.dataset.price || '0');
      });
      const totalProcessingCost = currentProcessingCost * photoCount;

      // –î–æ—Å—Ç–∞–≤–∫–∞
      currentDeliveryCost = parseInt(deliverySelect.selectedOptions[0] && deliverySelect.selectedOptions[0].dataset.price || '0');

      let totalPrice = (pricePerPhoto * totalCopies) + totalProcessingCost + currentDeliveryCost;

      // –†–∞—Å—á–µ—Ç —Å–∫–∏–¥–∫–∏
      currentDiscount = 0;
      if (CONFIG && CONFIG.discounts) {
        const sortedDiscounts = CONFIG.discounts.sort((a, b) => b.threshold - a.threshold);
        for (const discount of sortedDiscounts) {
          if (photoCount >= discount.threshold) {
            currentDiscount = discount.discount_percent;
            break;
          }
        }
      }

      let discountAmount = 0;
      if (currentDiscount > 0) {
        discountAmount = ((pricePerPhoto * totalCopies) + totalProcessingCost) * (currentDiscount / 100);
        totalPrice -= discountAmount;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      photoCountEl.textContent = photoCount + ' —à—Ç';
      totalCopiesEl.textContent = totalCopies + ' —à—Ç';
      pricePerCopyEl.textContent = pricePerPhoto + ' ‚ÇΩ';

      if (totalProcessingCost > 0) {
        processingCostEl.textContent = '+' + totalProcessingCost + ' ‚ÇΩ';
        processingLineEl.style.display = 'flex';
      } else {
        processingLineEl.style.display = 'none';
      }

      if (currentDeliveryCost > 0) {
        deliveryCostEl.textContent = '+' + currentDeliveryCost + ' ‚ÇΩ';
        deliveryLineEl.style.display = 'flex';
      } else {
        deliveryLineEl.style.display = 'none';
      }

      if (currentDiscount > 0) {
        discountTextEl.textContent = '-' + currentDiscount + '% (-' + Math.round(discountAmount) + ' ‚ÇΩ)';
        discountLineEl.style.display = 'flex';
      } else {
        discountLineEl.style.display = 'none';
      }

      priceEl.textContent = Math.round(totalPrice).toLocaleString('ru-RU') + ' ‚ÇΩ';
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é —Ñ–æ—Ç–æ —Å –∫–Ω–æ–ø–∫–∞–º–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è
    function addThumb(file, index) {
      if (!file.type.startsWith('image/')) return;

      const url = URL.createObjectURL(file);
      file.url = url; // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞

      const div = document.createElement('div');
      div.className = 'thumb';
      div.dataset.index = index;
      div.innerHTML = '<div class="img" style="background-image:url(\'' + url + '\')"></div>' +
        '<button class="edit-btn" onclick="openEditor(' + index + ')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ">üé®</button>' +
        '<button class="remove-btn" onclick="removePhoto(' + index + ')" title="–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ">√ó</button>' +
        '<div class="info"><div>' + file.name + '</div><div>' + (file.size/1024/1024).toFixed(1) + ' –ú–ë</div></div>';
      previews.appendChild(div);
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ
    function removePhoto(index) {
      if (index >= 0 && index < uploadedFiles.length) {
        URL.revokeObjectURL(uploadedFiles[index].url);
        uploadedFiles.splice(index, 1);
        updatePreviews();
        calcPrice();
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
    function updatePreviews() {
      previews.innerHTML = '';
      uploadedFiles.forEach((file, index) => {
        addThumb(file, index);
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–µ–π–¥–∂ –µ—Å–ª–∏ –±—ã–ª –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω
        if (file.editParams && (file.editParams.brightness !== 0 || file.editParams.contrast !== 0)) {
          updateThumbnail(index);
        }
      });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
    files.addEventListener('change', (e) => {
      const fileList = Array.from(e.target.files);
      processFiles(fileList);
      e.target.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
    function processFiles(fileList) {
      const validFiles = [];
      const errors = [];
      const maxPhotos = CONFIG ? CONFIG.max_photos : <?=esc($photoConfig['max_photos'] ?? 100)?>;

      for (const file of fileList) {
        if (uploadedFiles.length + validFiles.length >= maxPhotos) {
          errors.push('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –≤ ' + maxPhotos + ' —Ñ–∞–π–ª–æ–≤');
          break;
        }

        if (!file.type.startsWith('image/')) {
          errors.push(file.name + ': –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç');
          continue;
        }

        if (file.size > MAX_FILE_SIZE) {
          errors.push(file.name + ': —Ä–∞–∑–º–µ—Ä –ø—Ä–µ–≤—ã—à–∞–µ—Ç ' + MAX_FILE_SIZE_MB + '–ú–ë');
          continue;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        file.editParams = {
          brightness: 0,
          contrast: 0,
          crop: null
        };

        validFiles.push(file);
      }

      // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞–ª–∏–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
      uploadedFiles.push(...validFiles);
      updatePreviews();
      calcPrice();

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
      if (errors.length > 0) {
        showMessage('–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:\n‚Ä¢ ' + errors.join('\n‚Ä¢ '), 'warning');
      }

      if (validFiles.length > 0) {
        showMessage('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ' + validFiles.length + ' —Ñ–æ—Ç–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É üé® –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'success');
        setTimeout(() => hideMessage(), 4000);
      }
    }

    // Drag & Drop
    uploader.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploader.classList.add('dragover');
    });

    uploader.addEventListener('dragleave', (e) => {
      if (!uploader.contains(e.relatedTarget)) {
        uploader.classList.remove('dragover');
      }
    });

    uploader.addEventListener('drop', (e) => {
      e.preventDefault();
      uploader.classList.remove('dragover');

      const droppedFiles = Array.from(e.dataTransfer.files);
      processFiles(droppedFiles);
    });

    // –°–ª—É—à–∞—Ç–µ–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    ['size', 'paper', 'qty', 'correction', 'delivery'].forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener('change', calcPrice);
        element.addEventListener('input', calcPrice);
      }
    });

    // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥
    document.querySelectorAll('input[name="processing_options[]"]').forEach(cb => {
      cb.addEventListener('change', calcPrice);
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById('btnSend').addEventListener('click', async () => {
      if (!uploadedFiles.length) {
        showMessage('‚ùå –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é', 'error');
        return;
      }

      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();

      if (!name || !phone) {
        showMessage('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω', 'error');
        return;
      }

      // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      const phoneClean = phone.replace(/[^0-9+]/g, '');
      if (phoneClean.length < 10) {
        showMessage('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', 'error');
        return;
      }

      if (email && !isValidEmail(email)) {
        showMessage('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å', 'error');
        return;
      }

      const btn = document.getElementById('btnSend');
      const loading = document.getElementById('loading');
      const originalText = btn.textContent;

      btn.disabled = true;
      btn.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑...';
      loading.classList.add('show');

      try {
        const fd = new FormData();
        fd.append('mode', 'photo_order');

        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        uploadedFiles.forEach((file, index) => {
          fd.append('photos[]', file);

          // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–æ—Ç–æ
          if (file.editParams) {
            fd.append('edit_params[' + index + '][brightness]', file.editParams.brightness);
            fd.append('edit_params[' + index + '][contrast]', file.editParams.contrast);
            if (file.editParams.crop) {
              fd.append('edit_params[' + index + '][crop][x]', file.editParams.crop.x);
              fd.append('edit_params[' + index + '][crop][y]', file.editParams.crop.y);
              fd.append('edit_params[' + index + '][crop][width]', file.editParams.crop.width);
              fd.append('edit_params[' + index + '][crop][height]', file.editParams.crop.height);
            }
          }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        fd.append('size', document.getElementById('size').value);
        fd.append('paper', document.getElementById('paper').value);
        fd.append('qty', document.getElementById('qty').value);
        fd.append('correction', document.getElementById('correction').value);
        fd.append('name', name);
        fd.append('phone', phone);
        fd.append('email', email);
        fd.append('comment', document.getElementById('comment').value.trim());

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏
        const processingOptions = [];
        document.querySelectorAll('input[name="processing_options[]"]:checked').forEach(cb => {
          processingOptions.push(cb.value);
        });
        if (processingOptions.length > 0) {
          processingOptions.forEach(option => {
            fd.append('processing_options[]', option);
          });
        }

        // –î–æ—Å—Ç–∞–≤–∫–∞
        const deliverySelect = document.getElementById('delivery');
        if (deliverySelect && deliverySelect.value) {
          fd.append('delivery', deliverySelect.value);
        }

        // –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã
        const paymentMethodEl = document.querySelector('input[name="payment_method"]:checked');
        if (paymentMethodEl) {
          fd.append('payment_method', paymentMethodEl.value);
        }

        const response = await fetch(location.href, {
          method: 'POST',
          body: fd
        });

        if (!response.ok) {
          throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + response.status);
        }

        const result = await response.json();

        if (result.ok) {
          let message = '‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!\nüÜî ID: ' + result.order_id + '\nüì∏ –§–æ—Ç–æ: ' + result.photo_count + ' —à—Ç';

          if (result.total_copies) {
            message += '\nüì¶ –û—Ç–ø–µ—á–∞—Ç–∫–æ–≤: ' + result.total_copies + ' —à—Ç';
          }

          if (result.discount) {
            message += '\nüéØ –°–∫–∏–¥–∫–∞: ' + result.discount + '%';
          }

          if (result.processing_cost) {
            message += '\nüõ†Ô∏è –î–æ–ø. —É—Å–ª—É–≥–∏: +' + result.processing_cost + ' ‚ÇΩ';
          }

          if (result.delivery_cost) {
            message += '\nüöö –î–æ—Å—Ç–∞–≤–∫–∞: +' + result.delivery_cost + ' ‚ÇΩ';
          }

          if (result.estimated_price) {
            message += '\nüí∞ –ò—Ç–æ–≥–æ: ' + result.estimated_price.toLocaleString('ru-RU') + ' ‚ÇΩ';
          }

          message += '\n\nüé® –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ –ø–µ—Ä–µ–¥–∞–Ω—ã –≤ –∑–∞–∫–∞–∑';

          if (result.warning) {
            message += '\n\n‚ö†Ô∏è ' + result.warning;
          } else {
            message += '\n\nüìß –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ artcopy78@bk.ru';
          }

          showMessage(message, 'success');

          // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
          uploadedFiles.forEach(file => {
            if (file.url) URL.revokeObjectURL(file.url);
          });
          uploadedFiles = [];
          updatePreviews();
          document.getElementById('name').value = '';
          document.getElementById('phone').value = '';
          document.getElementById('email').value = '';
          document.getElementById('comment').value = '';

          // –°–±—Ä–æ—Å –¥–æ–ø —É—Å–ª—É–≥
          document.querySelectorAll('input[name="processing_options[]"]').forEach(cb => {
            cb.checked = false;
          });

          calcPrice();

          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç—ã
          if (result.payment && result.payment_url) {
            showMessage('üí≥ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–ø–ª–∞—Ç–µ —á–µ—Ä–µ–∑ –Æ–ö–∞—Å—Å–∞...', 'success');
            setTimeout(() => {
              window.open(result.payment_url, '_blank');
            }, 2500);
          }

        } else {
          showMessage('‚ùå ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'), 'error');
        }

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
        showMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
        loading.classList.remove('show');
      }
    });

    function showMessage(text, type) {
      const msg = document.getElementById('msg');
      msg.innerHTML = text.replace(/\n/g, '<br>');
      msg.className = 'msg ' + type;
      msg.style.display = 'block';
      msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function hideMessage() {
      const msg = document.getElementById('msg');
      msg.style.display = 'none';
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      initEditor();
      calcPrice();

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      const popularOption = document.querySelector('#size option[data-popular="1"]');
      if (popularOption) {
        document.getElementById('size').value = popularOption.value;
      }

      // –ó–∞–∫—Ä—ã—Ç–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –ø–æ ESC
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('photoEditor').classList.contains('show')) {
          closeEditor();
        }
      });

      console.log('üéØ –ü–†–ï–ú–ò–£–ú –§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π v2.0 –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!');
      console.log('‚úÖ –§—É–Ω–∫—Ü–∏–∏: —è—Ä–∫–æ—Å—Ç—å, –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å, –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ');
      console.log('‚úÖ CRM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞—Ä—Ö–∏–≤–æ–º —Ñ–æ—Ç–æ');
      console.log('‚úÖ –í—Å–µ –∑–∞–∫–∞–∑—ã –Ω–∞ artcopy78@bk.ru');
    });
  </script>
</body>
</html>
