<?php
mb_internal_encoding('UTF-8');
date_default_timezone_set('Europe/Moscow');
session_start();

/* Paths */
$BASE = __DIR__;
$uploadsDir = $BASE.'/uploads';
$ordersLog  = $BASE.'/orders.txt';
$configFile = $BASE.'/config.json';
$productsFile = $BASE.'/products.json';
$servicesFile = $BASE.'/services.json';
$photoConfigFile = $BASE.'/photo_config.json';
$chatLog = $BASE.'/chat_log.txt';
$aiKnowledgeFile = $BASE.'/ai_knowledge.json';
$customersFile = $BASE.'/customers.json';
$reviewsFile = $BASE.'/reviews.json';

/* FS init */
if (!is_dir($uploadsDir)) @mkdir($uploadsDir, 0775, true);
if (!file_exists($uploadsDir.'/.htaccess')) {
  @file_put_contents($uploadsDir.'/.htaccess', 'php_flag engine off\nOptions -ExecCGI\n<FilesMatch \'\\.(php|phar|phtml|cgi|pl|py)$\'>\nDeny from all\n</FilesMatch>\n');
}
if (!file_exists($ordersLog)) @file_put_contents($ordersLog, '');
if (!file_exists($chatLog)) @file_put_contents($chatLog, '');
if (!file_exists($customersFile)) @file_put_contents($customersFile, json_encode([], JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
if (!file_exists($reviewsFile)) @file_put_contents($reviewsFile, json_encode([], JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));

/* Config */
$host = $_SERVER['HTTP_HOST'] ?? 'localhost';
$scheme = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') ? 'https://' : 'http://';
$siteURL = $scheme.$host;

$defaultConfig = [
  'brand'         => '–ö–æ–ø–∏—Ä–æ–≤–∞–ª—å–Ω—ã–π —Ñ–æ—Ç–æ—Ü–µ–Ω—Ç—Ä –ü–†–ò–ù–¢–°–°',
  'slogan'        => '–ü–µ—á–∞—Ç—å –≤ –°–æ—Å–Ω–æ–≤–æ–º –ë–æ—Ä—É ‚Äî —É–ª. –ö—Ä–∞—Å–Ω—ã—Ö –§–æ—Ä—Ç–æ–≤, 49 (—Ä—è–¥–æ–º —Å OZON –∏ –°–∞—à–∞ –°—É—à–∏)',
  'hero'          => '–§–æ—Ç–æ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã ‚Äî 5 –º–∏–Ω—É—Ç (—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –≤–∏–¥ –±–µ—Å–ø–ª–∞—Ç–Ω–æ)',
  'phone_display' => '+7 (952) 200-39-90',
  'phone_raw'     => '+79522003990',
  'email_to'      => 'artcopy78@bk.ru',
  'email_from'    => 'noreply@'.preg_replace('~^www\.~','',$host),
  'email_cc'      => '',
  'email_bcc'     => '',
  'email_reply'   => '',
  'address'       => '–†–æ—Å—Å–∏—è, –õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª., –°–æ—Å–Ω–æ–≤—ã–π –ë–æ—Ä, —É–ª. –ö—Ä–∞—Å–Ω—ã—Ö –§–æ—Ä—Ç–æ–≤, 49',
  'workhours'     => ['–ü–Ω‚Äì–ü—Ç 10:00‚Äì20:00', '–°–±‚Äì–í—Å 11:00‚Äì18:00'],
  'site'          => $siteURL,
  'logo'          => '',
  'hero_mode'     => 'svg',
  'hero_image'    => '',
  'catalog_desc'  => '–ö–∞—Ç–∞–ª–æ–≥ —É—Å–ª—É–≥ –Ω–∞—à–µ–π —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∏ –∏ —Ñ–æ—Ç–æ—Ü–µ–Ω—Ç—Ä–∞. –ë—ã—Å—Ç—Ä–æ, —Ä—è–¥–æ–º, –ø–æ-—á–µ—Å—Ç–Ω—ã–º —Ü–µ–Ω–∞–º.',
  'homepage_features' => [
    'fast_photo' => true,
    'online_payment' => true,
    'delivery' => true,
    'photo_constructor' => true
  ],
  'seo' => [
    'title'       => '–ö–æ–ø–∏—Ä–æ–≤–∞–ª—å–Ω—ã–π —Ñ–æ—Ç–æ—Ü–µ–Ω—Ç—Ä –ü–†–ò–ù–¢–°–° ‚Äî —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏—è | –§–æ—Ç–æ 5 –º–∏–Ω—É—Ç',
    'description' => '–¢–∏–ø–æ–≥—Ä–∞—Ñ–∏—è –∏ —Ñ–æ—Ç–æ—Ü–µ–Ω—Ç—Ä: –≤–∏–∑–∏—Ç–∫–∏, –±–∞–Ω–Ω–µ—Ä—ã, –ª–∏—Å—Ç–æ–≤–∫–∏, —Ñ–æ—Ç–æ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã 5 –º–∏–Ω—É—Ç. –ö—Ä–∞—Å–Ω—ã—Ö –§–æ—Ä—Ç–æ–≤, 49. –¢–µ–ª. +7 (952) 200-39-90',
    'keywords'    => '–ø–µ—á–∞—Ç—å, —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏—è, —Ñ–æ—Ç–æ—Ü–µ–Ω—Ç—Ä, –≤–∏–∑–∏—Ç–∫–∏, –±–∞–Ω–Ω–µ—Ä—ã, —Ñ–æ—Ç–æ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã, –°–æ—Å–Ω–æ–≤—ã–π –ë–æ—Ä',
    'og_image'    => '',
    'sitemap_enable' => true,
  ],
  'business' => [
    'show_requisites' => true,
    'show_payment_icons' => true,
    'legal_name' => '–ò–ü –ì—É—Ä–±–∞–Ω–æ–≤–∞ –ì–∞–ª–∏–Ω–∞ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–∞',
    'inn' => '',
    'ogrn' => '',
    'bank' => '',
    'bik' => '',
    'account' => '',
  ],
  'yukassa' => [
    'enabled'  => false,
    'shop_id'  => '',
    'secret_key' => '',
    'test_mode' => true,
    'return_url' => $siteURL . '/oplata.php',
    'services' => [
      'products' => true,
      'photo_constructor' => true,
      'regular_orders' => false
    ]
  ],
  'theme' => [
    'mode'         => 'light',
    'bg'           => '#f3f7ff',
    'text'         => '#0e1220',
    'muted'        => '#5c6b84',
    'brand'        => '#FF8A00',
    'accent'       => '#2D5BFF',
    'card_opacity' => 0.65,
    'blur'         => 12,
    'radius'       => 16,
    'shadow'       => 0.12,
    'container'    => 1200
  ],
  'telegram'      => [
    'enabled' => true,
    'token'   => '8385005974:AAHhQkvdKP5LJSbSI-pge_TGefgcYDLTBZw',
    'chat'    => ''
  ],
  'smtp' => [
    'enabled' => true,
    'host'    => 'smtp.mail.ru',
    'port'    => 465,
    'secure'  => 'ssl',
    'user'    => 'artcopy78@bk.ru',
    'pass'    => ''
  ],
  'admin_pass' => 'printss49',
  'features' => [
    'reviews_enabled' => true,
    'callback_widget' => true,
    'price_alerts' => true,
    'loyalty_program' => false,
  ],
  'social' => [
    'vk' => '',
    'instagram' => '',
    'youtube' => '',
    'whatsapp' => '+79522003990',
    'telegram_channel' => '',
  ]
];

if (!file_exists($configFile)) @file_put_contents($configFile, json_encode($defaultConfig, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
$cfg = json_decode(@file_get_contents($configFile), true);
if (!is_array($cfg)) $cfg = $defaultConfig;
$cfg = array_replace_recursive($defaultConfig, $cfg);

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã
$products = json_decode(@file_get_contents($productsFile), true) ?? [];

// –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Å–ª—É–≥–∏
$defaultServices = [
  ['name' => '–§–æ—Ç–æ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã', 'price' => '–æ—Ç 400 ‚ÇΩ', 'description' => '5‚Äì10 –º–∏–Ω—É—Ç. –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ.', 'enabled' => true, 'yukassa_enabled' => false],
  ['name' => '–ü–µ—á–∞—Ç—å –≤–∏–∑–∏—Ç–æ–∫', 'price' => '–æ—Ç 900 ‚ÇΩ', 'description' => '–ú–µ–ª–æ–≤–∞–Ω–Ω–∞—è –±—É–º–∞–≥–∞, –±—ã—Å—Ç—Ä—ã–µ —Å—Ä–æ–∫–∏.', 'enabled' => true, 'yukassa_enabled' => false],
  ['name' => '–ü–µ—á–∞—Ç—å –±–∞–Ω–Ω–µ—Ä–æ–≤', 'price' => '–æ—Ç 1100 ‚ÇΩ', 'description' => '–ü–í–• 440 –≥/–º¬≤, –ª—é–≤–µ—Ä—Å—ã, –ø—Ä–æ–≤–∞—Ä–∫–∞.', 'enabled' => true, 'yukassa_enabled' => false],
  ['name' => '–§–æ—Ç–æ–ø–µ—á–∞—Ç—å', 'price' => '–æ—Ç 30 ‚ÇΩ', 'description' => '–ë—ã—Å—Ç—Ä–∞—è —Ñ–æ—Ç–æ–ø–µ—á–∞—Ç—å —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤.', 'enabled' => true, 'yukassa_enabled' => true],
];
if (!file_exists($servicesFile)) @file_put_contents($servicesFile, json_encode($defaultServices, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
$services = json_decode(@file_get_contents($servicesFile), true) ?? $defaultServices;

// –ö–æ–Ω—Ñ–∏–≥ —Ñ–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
$defaultPhotoConfig = [
  'enabled' => true,
  'max_photos' => 100,
  'max_file_size' => 10,
  'supported_formats' => ['jpg', 'jpeg', 'png', 'heic', 'heif'],
  'sizes' => [
    ['name' => '10√ó15', 'w' => 10, 'h' => 15, 'base' => 30, 'enabled' => true, 'popular' => true],
    ['name' => '15√ó21', 'w' => 15, 'h' => 21, 'base' => 50, 'enabled' => true, 'popular' => true],
    ['name' => '20√ó30', 'w' => 20, 'h' => 30, 'base' => 80, 'enabled' => true, 'popular' => false],
    ['name' => 'A4', 'w' => 21, 'h' => 29.7, 'base' => 120, 'enabled' => true, 'popular' => false],
    ['name' => 'A3', 'w' => 29.7, 'h' => 42, 'base' => 200, 'enabled' => true, 'popular' => false],
    ['name' => '30√ó40', 'w' => 30, 'h' => 40, 'base' => 300, 'enabled' => true, 'popular' => false],
    ['name' => '40√ó50', 'w' => 40, 'h' => 50, 'base' => 400, 'enabled' => false, 'popular' => false],
    ['name' => '50√ó70', 'w' => 50, 'h' => 70, 'base' => 800, 'enabled' => true, 'popular' => false],
    ['name' => '60√ó90', 'w' => 60, 'h' => 90, 'base' => 1200, 'enabled' => false, 'popular' => false]
  ],
  'papers' => [
    ['name' => '–ú–∞—Ç–æ–≤–∞—è', 'delta' => 0, 'enabled' => true, 'description' => '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –º–∞—Ç–æ–≤–∞—è –±—É–º–∞–≥–∞'],
    ['name' => '–ì–ª—è–Ω–µ—Ü', 'delta' => 10, 'enabled' => true, 'description' => '–ì–ª—è–Ω—Ü–µ–≤–∞—è –±—É–º–∞–≥–∞ —Å –±–ª–µ—Å–∫–æ–º'],
    ['name' => '–ü–æ–ª—É–º–∞—Ç–æ–≤–∞—è', 'delta' => 5, 'enabled' => true, 'description' => '–ü–æ–ª—É–º–∞—Ç–æ–≤–∞—è –ø—Ä–µ–º–∏—É–º –±—É–º–∞–≥–∞'],
    ['name' => '–•–æ–ª—Å—Ç', 'delta' => 100, 'enabled' => false, 'description' => '–ü–µ—á–∞—Ç—å –Ω–∞ —Ö–æ–ª—Å—Ç–µ'],
    ['name' => '–ú–µ—Ç–∞–ª–ª–∏–∫', 'delta' => 50, 'enabled' => false, 'description' => '–ú–µ—Ç–∞–ª–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –±—É–º–∞–≥–∞']
  ],
  'corrections' => [
    ['name' => '–ù–µ—Ç', 'delta' => 0, 'enabled' => true, 'description' => '–ë–µ–∑ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏'],
    ['name' => '–õ–µ–≥–∫–∞—è', 'delta' => 15, 'enabled' => true, 'description' => '–ê–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è —è—Ä–∫–æ—Å—Ç–∏ –∏ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞'],
    ['name' => '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è', 'delta' => 50, 'enabled' => true, 'description' => '–†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –¥–∏–∑–∞–π–Ω–µ—Ä–æ–º'],
    ['name' => '–†–µ—Å—Ç–∞–≤—Ä–∞—Ü–∏—è', 'delta' => 200, 'enabled' => false, 'description' => '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ñ–æ—Ç–æ']
  ],
  'processing_options' => [
    ['name' => '–ö–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ', 'price' => 20, 'enabled' => true, 'description' => '–û–±—Ä–µ–∑–∫–∞ –ø–æ –Ω—É–∂–Ω–æ–º—É —Ä–∞–∑–º–µ—Ä—É'],
    ['name' => '–£–¥–∞–ª–µ–Ω–∏–µ –∫—Ä–∞—Å–Ω—ã—Ö –≥–ª–∞–∑', 'price' => 30, 'enabled' => true, 'description' => '–ö–æ—Ä—Ä–µ–∫—Ü–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –∫—Ä–∞—Å–Ω—ã—Ö –≥–ª–∞–∑'],
    ['name' => '–ß–µ—Ä–Ω–æ-–±–µ–ª–æ–µ', 'price' => 10, 'enabled' => true, 'description' => '–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —á/–±'],
    ['name' => '–†–µ—Ç—É—à—å –ª–∏—Ü–∞', 'price' => 150, 'enabled' => false, 'description' => '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ä–µ—Ç—É—à—å'],
    ['name' => '–ó–∞–º–µ–Ω–∞ —Ñ–æ–Ω–∞', 'price' => 300, 'enabled' => false, 'description' => '–ó–∞–º–µ–Ω–∞ —Ñ–æ–Ω–∞ –Ω–∞ —Ñ–æ—Ç–æ']
  ],
  'delivery_options' => [
    ['name' => '–°–∞–º–æ–≤—ã–≤–æ–∑', 'price' => 0, 'enabled' => true, 'description' => '–ó–∞–±—Ä–∞—Ç—å –≤ –æ—Ñ–∏—Å–µ'],
    ['name' => '–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É', 'price' => 200, 'enabled' => true, 'description' => '–î–æ—Å—Ç–∞–≤–∫–∞ –∫—É—Ä—å–µ—Ä–æ–º'],
    ['name' => '–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏', 'price' => 300, 'enabled' => true, 'description' => '–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—á—Ç–æ–π']
  ],
  'discounts' => [
    ['name' => '–û—Ç 50 —Ñ–æ—Ç–æ', 'threshold' => 50, 'discount_percent' => 10, 'enabled' => true],
    ['name' => '–û—Ç 100 —Ñ–æ—Ç–æ', 'threshold' => 100, 'discount_percent' => 15, 'enabled' => true],
    ['name' => '–û—Ç 200 —Ñ–æ—Ç–æ', 'threshold' => 200, 'discount_percent' => 20, 'enabled' => false]
  ]
];

if (!file_exists($photoConfigFile)) @file_put_contents($photoConfigFile, json_encode($defaultPhotoConfig, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
$photoConfig = json_decode(@file_get_contents($photoConfigFile), true);
if (!is_array($photoConfig)) $photoConfig = $defaultPhotoConfig;
$photoConfig = array_replace_recursive($defaultPhotoConfig, $photoConfig);

// –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è CRM
$customers = json_decode(@file_get_contents($customersFile), true) ?? [];

// –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–∑—ã–≤—ã
$reviews = json_decode(@file_get_contents($reviewsFile), true) ?? [];

/* Helpers */
function esc($s){ return htmlspecialchars((string)$s, ENT_QUOTES|ENT_SUBSTITUTE, 'UTF-8'); }
function sanitize_text($s){ return trim(filter_var($s, FILTER_SANITIZE_FULL_SPECIAL_CHARS)); }
function sanitize_hex($s){ $s=trim((string)$s); if($s==='') return ''; if($s[0]!=='#') $s='#'.$s; if(!preg_match('~^#[0-9a-fA-F]{3,8}$~',$s)) return '#000000'; return $s; }
function clamp_float($v,$min,$max,$def){ $v=(float)$v; if(!is_finite($v)) return $def; return max($min, min($max, $v)); }
function clamp_int($v,$min,$max,$def){ $v=(int)$v; if(!is_finite($v)) return $def; return max($min, min($max, $v)); }

function save_upload_general($field, $uploadsDir, $allowExt){
  if (!isset($_FILES[$field]) || !is_uploaded_file($_FILES[$field]['tmp_name'])) return null;
  $name = preg_replace('~[^a-zA-Z0-9_\.-]+~u','-', $_FILES[$field]['name']);
  $ext = strtolower(pathinfo($name, PATHINFO_EXTENSION));
  if (!in_array($ext, $allowExt)) throw new Exception('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç: '.esc($ext));
  if ($_FILES[$field]['size'] > 100*1024*1024) throw new Exception('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 100 –ú–ë).');
  $newName = date('Ymd-His').'-'.bin2hex(random_bytes(3)).'-'.$name;
  $dest = $uploadsDir.'/'.$newName;
  if (!move_uploaded_file($_FILES[$field]['tmp_name'], $dest)) throw new Exception('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª.');
  return $newName;
}

function save_upload_image($field, $uploadsDir){
  $allowed = ['jpg','jpeg','png','webp','svg'];
  return save_upload_general($field, $uploadsDir, $allowed);
}

function log_order($path, $data){
  @file_put_contents($path, '['.date('Y-m-d H:i:s').'] '.json_encode($data, JSON_UNESCAPED_UNICODE).PHP_EOL, FILE_APPEND);
}

/* Email helpers */
function parse_emails($s){
  $s = str_replace([';','\n','\r'],',',$s);
  $parts = array_filter(array_map('trim', explode(',', (string)$s)));
  $out = [];
  foreach($parts as $p){
    if (filter_var($p, FILTER_VALIDATE_EMAIL)) $out[] = $p;
  }
  return array_values(array_unique($out));
}

function email_headers($fromName, $from, $reply=null, $cc=null, $bcc=null){
  $h  = 'MIME-Version: 1.0\r\n';
  $h .= 'Content-Type: text/plain; charset=UTF-8\r\n';
  $h .= 'From: '.$fromName.' <'.$from.'>\r\n';
  if ($reply) $h .= 'Reply-To: '.$reply.'\r\n';
  if ($cc){
    $ccs = is_array($cc) ? implode(', ',$cc) : $cc;
    if($ccs) $h .= 'Cc: '.$ccs.'\r\n';
  }
  if ($bcc){
    $bccs = is_array($bcc) ? implode(', ',$bcc) : $bcc;
    if($bccs) $h .= 'Bcc: '.$bccs.'\r\n';
  }
  $h .= 'X-Priority: 1\r\nX-Mailer: SmartPrint\r\n';
  return $h;
}

function email_send_mail($to,$subj,$body,$fromName,$from,$reply=null,$cc=null,$bcc=null){
  $h = email_headers($fromName,$from,$reply,$cc,$bcc);
  $toStr = is_array($to) ? implode(', ',$to) : $to;
  return @mail($toStr, '=?UTF-8?B?'.base64_encode($subj).'?=', $body, $h);
}

function smtp_cmd($fp,$cmd,$expect=null){
  if ($cmd !== null) fwrite($fp, $cmd.'\r\n');
  $resp=''; while($line=fgets($fp, 515)){ $resp.=$line; if(isset($line[3])&&$line[3]===' ') break; }
  if ($expect && strpos($resp,(string)$expect)!==0) throw new Exception('SMTP error: expected '.$expect.', got: '.$resp);
  return $resp;
}

function email_send_smtp($to,$subj,$body,$fromName,$from,$smtp,$reply=null,$cc=null,$bcc=null){
  $host=$smtp['host']; $port=(int)$smtp['port']; $secure=strtolower($smtp['secure']??'ssl');
  $ctx=stream_context_create(['ssl'=>['verify_peer'=>false,'verify_peer_name'=>false]]);
  $endpoint=(($secure==='ssl')?'ssl://':'tcp://').$host.':'.$port;
  $fp=@stream_socket_client($endpoint,$errno,$errstr,15,STREAM_CLIENT_CONNECT,$ctx);
  if(!$fp) throw new Exception('SMTP connect failed: '.$errstr);
  stream_set_timeout($fp,15);
  smtp_cmd($fp,null,220);
  smtp_cmd($fp,'EHLO localhost',250);
  if($secure==='tls'){ smtp_cmd($fp,'STARTTLS',220); if(!stream_socket_enable_crypto($fp,true,STREAM_CRYPTO_METHOD_TLS_CLIENT)) throw new Exception('STARTTLS failed'); smtp_cmd($fp,'EHLO localhost',250); }
  if (!empty($smtp['user'])){ smtp_cmd($fp,'AUTH LOGIN',334); smtp_cmd($fp,base64_encode($smtp['user']),334); smtp_cmd($fp,base64_encode($smtp['pass']),235); }
  smtp_cmd($fp,'MAIL FROM:<'.$from.'>',250);
  $rcpts = [];
  foreach ((array)$to as $rcpt) $rcpts[]=$rcpt;
  foreach ((array)$cc as $rcpt) $rcpts[]=$rcpt;
  foreach ((array)$bcc as $rcpt) $rcpts[]=$rcpt;
  $rcpts = array_values(array_unique(array_filter($rcpts)));
  foreach ($rcpts as $rcpt) smtp_cmd($fp,'RCPT TO:<'.$rcpt.'>',250);
  smtp_cmd($fp,'DATA',354);
  $data  = email_headers($fromName,$from,$reply,$cc,$bcc);
  $allToHeader = array_values(array_unique(array_merge((array)$to,(array)$cc)));
  $data .= 'To: <'.(implode(', ',$allToHeader)).'>\r\n';
  $data .= 'Subject: =?UTF-8?B?'.base64_encode($subj).'?=\r\n\r\n'.$body.'\r\n.\r\n';
  fwrite($fp,$data);
  $r=fgets($fp,515); if (strpos($r,'250')!==0) throw new Exception('SMTP DATA not accepted: '.$r);
  smtp_cmd($fp,'QUIT',221); fclose($fp); return true;
}

function send_email_all($cfg,$subject,$body){
  $to = parse_emails($cfg['email_to']);
  if (empty($to)) {
    $to = [$cfg['email_to']];
  }
  $cc = parse_emails($cfg['email_cc'] ?? '');
  $bcc= parse_emails($cfg['email_bcc'] ?? '');
  $reply = trim($cfg['email_reply'] ?? '') ?: null;
  $from = $cfg['email_from'];
  $ok=false; $errs=[];

  // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è —á–µ—Ä–µ–∑ SMTP –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω
  if (!empty($cfg['smtp']['enabled'])){
    try{
      email_send_smtp($to,$subject,$body,'SmartPrint',$from,$cfg['smtp'],$reply,$cc,$bcc);
      $ok=true;
    } catch(Throwable $e){
      $errs[]='SMTP: '.$e->getMessage();
    }
  }

  // –ï—Å–ª–∏ SMTP –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—ã—Ç–∞–µ–º—Å—è —á–µ—Ä–µ–∑ mail()
  if(!$ok){
    $mailResult = email_send_mail($to,$subject,$body,'SmartPrint',$from,$reply,$cc,$bcc);
    if($mailResult) {
      $ok = true;
    } else {
      $errs[]='mail(): failed to send';
    }
  }

  return [$ok,$errs];
}

/* Telegram API */
function tg_api($token,$method,$params=[],$multipart=false){
  $url='https://api.telegram.org/bot'.$token.'/'.$method;
  $ch=curl_init($url);
  curl_setopt($ch,CURLOPT_RETURNTRANSFER,true);
  curl_setopt($ch,CURLOPT_CONNECTTIMEOUT,10);
  curl_setopt($ch,CURLOPT_TIMEOUT,20);
  if($multipart){ curl_setopt($ch,CURLOPT_POSTFIELDS,$params); }
  else{ curl_setopt($ch,CURLOPT_POSTFIELDS,http_build_query($params)); }
  $resp=curl_exec($ch); $err=curl_error($ch); curl_close($ch);
  if($err) throw new Exception('Telegram CURL: '.$err);
  $j=json_decode($resp,true);
  if(!$j || empty($j['ok'])) throw new Exception('Telegram API: '.$resp);
  return $j['result'] ?? true;
}

function require_admin($cfg){
  if(empty($_SESSION['is_admin'])){ header('Location: ?login=1'); exit; }
}

// =================== CRM –§–£–ù–ö–¶–ò–ò ===================
function update_customer_info($customersFile, $name, $phone, $email = '', $orderData = null) {
  $customers = json_decode(@file_get_contents($customersFile), true) ?? [];

  $phone_clean = preg_replace('/[^0-9]/', '', $phone);
  $customer_id = $phone_clean;

  $existingCustomer = null;
  foreach ($customers as $key => $customer) {
    if ($customer['id'] === $customer_id) {
      $existingCustomer = $key;
      break;
    }
  }

  if ($existingCustomer !== null) {
    $customers[$existingCustomer]['last_contact'] = date('Y-m-d H:i:s');
    $customers[$existingCustomer]['orders_count']++;

    if ($orderData) {
      $customers[$existingCustomer]['total_spent'] += $orderData['total'] ?? 0;
      $customers[$existingCustomer]['orders'][] = [
        'id' => $orderData['id'],
        'date' => date('Y-m-d H:i:s'),
        'type' => $orderData['type'] ?? 'service',
        'total' => $orderData['total'] ?? 0,
        'status' => $orderData['status'] ?? 'new'
      ];
    }

    if ($email) $customers[$existingCustomer]['email'] = $email;
  } else {
    $customers[] = [
      'id' => $customer_id,
      'name' => $name,
      'phone' => $phone,
      'email' => $email,
      'created_at' => date('Y-m-d H:i:s'),
      'last_contact' => date('Y-m-d H:i:s'),
      'orders_count' => 1,
      'total_spent' => $orderData['total'] ?? 0,
      'notes' => '',
      'tags' => [],
      'orders' => $orderData ? [[
        'id' => $orderData['id'],
        'date' => date('Y-m-d H:i:s'),
        'type' => $orderData['type'] ?? 'service',
        'total' => $orderData['total'] ?? 0,
        'status' => $orderData['status'] ?? 'new'
      ]] : []
    ];
  }

  @file_put_contents($customersFile, json_encode($customers, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
}

function get_order_statistics($ordersLog) {
  $lines = @file($ordersLog, FILE_IGNORE_NEW_LINES|FILE_SKIP_EMPTY_LINES) ?: [];
  $stats = [
    'total' => 0,
    'today' => 0,
    'this_week' => 0,
    'this_month' => 0,
    'photo_orders' => 0,
    'cart_orders' => 0,
    'service_orders' => 0,
    'callback_requests' => 0,
    'total_revenue' => 0,
    'avg_order_value' => 0
  ];

  $today = date('Y-m-d');
  $week_start = date('Y-m-d', strtotime('monday this week'));
  $month_start = date('Y-m-01');
  $revenue_orders = [];

  foreach($lines as $line) {
    if(!preg_match('~^$$(.+?)$$ (.+)$~u', $line, $m)) continue;
    $ts = $m[1];
    $j = json_decode($m[2], true);
    if(!$j) continue;

    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –∑–∞–ø–∏—Å–∏
    if (isset($j['action']) && $j['action'] === 'status_update') continue;
    if (isset($j['updated_order'])) continue;

    $stats['total']++;
    $order_date = date('Y-m-d', strtotime($ts));

    if($order_date === $today) $stats['today']++;
    if($order_date >= $week_start) $stats['this_week']++;
    if($order_date >= $month_start) $stats['this_month']++;

    $type = $j['type'] ?? 'service';
    if($type === 'photo_constructor') $stats['photo_orders']++;
    elseif($type === 'cart') $stats['cart_orders']++;
    elseif($type === 'callback') $stats['callback_requests']++;
    else $stats['service_orders']++;

    // –ü–æ–¥—Å—á–µ—Ç –≤—ã—Ä—É—á–∫–∏
    if(isset($j['total_price']) && $j['total_price'] > 0) {
      $stats['total_revenue'] += $j['total_price'];
      $revenue_orders[] = $j['total_price'];
    }
    elseif(isset($j['estimated_price']) && $j['estimated_price'] > 0) {
      $stats['total_revenue'] += $j['estimated_price'];
      $revenue_orders[] = $j['estimated_price'];
    }
  }

  if(count($revenue_orders) > 0) {
    $stats['avg_order_value'] = $stats['total_revenue'] / count($revenue_orders);
  }

  return $stats;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ –∏–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
function download_constructor_photos($order_id) {
  // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ –∏–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
  // –ü–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞
  return ['success' => true, 'files' => []];
}

/* –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ */
if ($_SERVER['REQUEST_METHOD'] === 'POST') {

  if (isset($_POST['admin_login'])){
    $pass=$_POST['password']??'';
    if(hash_equals($cfg['admin_pass'],$pass)){
      $_SESSION['is_admin']=true;
      header('Location: admin.php');
    }
    else {
      header('Location: admin.php?login=1&err=1');
    }
    exit;
  }

  require_admin($cfg);

  // =================== –°–ö–ê–ß–ò–í–ê–ù–ò–ï –§–û–¢–û –ò–ó –ö–û–ù–°–¢–†–£–ö–¢–û–†–ê ===================
  if (isset($_POST['download_constructor_photos'])) {
    $order_id = $_POST['order_id'] ?? '';
    if ($order_id) {
      $result = download_constructor_photos($order_id);
      header('Content-Type: application/json');
      echo json_encode($result);
      exit;
    }
  }

  // =================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –û–¢–ó–´–í–ê–ú–ò ===================
  if (isset($_POST['review_action'])) {
    $action = $_POST['review_action'] ?? '';
    $review_id = (int)($_POST['review_id'] ?? 0);

    if ($action === 'approve' && $review_id) {
      foreach ($reviews as $key => $review) {
        if ($review['id'] == $review_id) {
          $reviews[$key]['status'] = 'approved';
          break;
        }
      }
    } elseif ($action === 'reject' && $review_id) {
      foreach ($reviews as $key => $review) {
        if ($review['id'] == $review_id) {
          $reviews[$key]['status'] = 'rejected';
          break;
        }
      }
    } elseif ($action === 'delete' && $review_id) {
      foreach ($reviews as $key => $review) {
        if ($review['id'] == $review_id) {
          unset($reviews[$key]);
          break;
        }
      }
      $reviews = array_values($reviews);
    }

    @file_put_contents($reviewsFile, json_encode($reviews, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
    header('Location: admin.php?tab=reviews&review_updated=1');
    exit;
  }

  // =================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê –ó–ê–ö–ê–ó–ê ===================
  if (isset($_POST['update_order_status'])) {
    $order_id = $_POST['order_id'] ?? '';
    $new_status = $_POST['new_status'] ?? '';
    $admin_notes = $_POST['admin_notes'] ?? '';

    if ($order_id && $new_status) {
      $update_data = [
        'order_id' => $order_id,
        'old_status' => $_POST['old_status'] ?? '',
        'new_status' => $new_status,
        'admin_notes' => $admin_notes,
        'updated_by' => 'admin',
        'updated_at' => date('Y-m-d H:i:s'),
        'action' => 'status_update'
      ];

      log_order($ordersLog, $update_data);

      header('Location: admin.php?tab=orders&order_updated=1');
      exit;
    }
  }

  // =================== –î–û–ë–ê–í–õ–ï–ù–ò–ï –ó–ê–ú–ï–¢–û–ö –ö –ö–õ–ò–ï–ù–¢–£ ===================
  if (isset($_POST['update_customer_notes'])) {
    $customer_id = $_POST['customer_id'] ?? '';
    $notes = $_POST['notes'] ?? '';
    $tags = array_filter(array_map('trim', explode(',', $_POST['tags'] ?? '')));

    if ($customer_id) {
      $customers = json_decode(@file_get_contents($customersFile), true) ?? [];

      foreach ($customers as $key => $customer) {
        if ($customer['id'] === $customer_id) {
          $customers[$key]['notes'] = $notes;
          $customers[$key]['tags'] = $tags;
          $customers[$key]['updated_at'] = date('Y-m-d H:i:s');
          break;
        }
      }

      @file_put_contents($customersFile, json_encode($customers, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));

      header('Location: admin.php?tab=orders&customer_updated=1');
      exit;
    }
  }

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ñ–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤)
  if (isset($_POST['save_photo_config'])){
    $newConfig = $photoConfig;

    // –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    $newConfig['enabled'] = !empty($_POST['photo_enabled']);
    $newConfig['max_photos'] = max(1, min(500, (int)($_POST['max_photos'] ?? 100)));
    $newConfig['max_file_size'] = max(1, min(100, (int)($_POST['max_file_size'] ?? 10)));

    // –†–∞–∑–º–µ—Ä—ã (—É–±–∏—Ä–∞–µ–º &times –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏–π)
    if (isset($_POST['sizes']) && is_array($_POST['sizes'])) {
      $newConfig['sizes'] = [];
      foreach ($_POST['sizes'] as $i => $size) {
        $name = sanitize_text($size['name'] ?? '');
        $name = str_replace(['&times;', '√ótimes;', '&times', 'times'], '√ó', $name); // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫—É
        $newConfig['sizes'][] = [
          'name' => $name,
          'w' => max(1, (float)($size['w'] ?? 10)),
          'h' => max(1, (float)($size['h'] ?? 15)),
          'base' => max(0, (int)($size['base'] ?? 30)),
          'enabled' => !empty($size['enabled']),
          'popular' => !empty($size['popular'])
        ];
      }
    }

    // –¢–∏–ø—ã –±—É–º–∞–≥–∏
    if (isset($_POST['papers']) && is_array($_POST['papers'])) {
      $newConfig['papers'] = [];
      foreach ($_POST['papers'] as $i => $paper) {
        $newConfig['papers'][] = [
          'name' => sanitize_text($paper['name'] ?? ''),
          'delta' => max(0, (int)($paper['delta'] ?? 0)),
          'enabled' => !empty($paper['enabled']),
          'description' => sanitize_text($paper['description'] ?? '')
        ];
      }
    }

    // –í–∏–¥—ã –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
    if (isset($_POST['corrections']) && is_array($_POST['corrections'])) {
      $newConfig['corrections'] = [];
      foreach ($_POST['corrections'] as $i => $correction) {
        $newConfig['corrections'][] = [
          'name' => sanitize_text($correction['name'] ?? ''),
          'delta' => max(0, (int)($correction['delta'] ?? 0)),
          'enabled' => !empty($correction['enabled']),
          'description' => sanitize_text($correction['description'] ?? '')
        ];
      }
    }

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏
    if (isset($_POST['processing_options']) && is_array($_POST['processing_options'])) {
      $newConfig['processing_options'] = [];
      foreach ($_POST['processing_options'] as $i => $option) {
        $newConfig['processing_options'][] = [
          'name' => sanitize_text($option['name'] ?? ''),
          'price' => max(0, (int)($option['price'] ?? 0)),
          'enabled' => !empty($option['enabled']),
          'description' => sanitize_text($option['description'] ?? '')
        ];
      }
    }

    // –°–ø–æ—Å–æ–±—ã –¥–æ—Å—Ç–∞–≤–∫–∏
    if (isset($_POST['delivery_options']) && is_array($_POST['delivery_options'])) {
      $newConfig['delivery_options'] = [];
      foreach ($_POST['delivery_options'] as $i => $option) {
        $newConfig['delivery_options'][] = [
          'name' => sanitize_text($option['name'] ?? ''),
          'price' => max(0, (int)($option['price'] ?? 0)),
          'enabled' => !empty($option['enabled']),
          'description' => sanitize_text($option['description'] ?? '')
        ];
      }
    }

    // –°–∫–∏–¥–∫–∏
    if (isset($_POST['discounts']) && is_array($_POST['discounts'])) {
      $newConfig['discounts'] = [];
      foreach ($_POST['discounts'] as $i => $discount) {
        $newConfig['discounts'][] = [
          'name' => sanitize_text($discount['name'] ?? ''),
          'threshold' => max(1, (int)($discount['threshold'] ?? 50)),
          'discount_percent' => max(0, min(99, (int)($discount['discount_percent'] ?? 10))),
          'enabled' => !empty($discount['enabled'])
        ];
      }
    }

    @file_put_contents($photoConfigFile, json_encode($newConfig, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
    header('Location: admin.php?photo_config_saved=1'); exit;
  }

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  if (isset($_POST['save_homepage'])){
    $new=$cfg;

    foreach(['brand','slogan','hero','catalog_desc'] as $f){
      if(isset($_POST[$f])) $new[$f]=trim($_POST[$f]);
    }

    if(isset($_POST['homepage_features']) && is_array($_POST['homepage_features'])){
      $new['homepage_features']['fast_photo'] = !empty($_POST['homepage_features']['fast_photo']);
      $new['homepage_features']['online_payment'] = !empty($_POST['homepage_features']['online_payment']);
      $new['homepage_features']['delivery'] = !empty($_POST['homepage_features']['delivery']);
      $new['homepage_features']['photo_constructor'] = !empty($_POST['homepage_features']['photo_constructor']);
    } else {
      $new['homepage_features'] = array_fill_keys(array_keys($new['homepage_features']), false);
    }

    @file_put_contents($configFile, json_encode($new, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
    header('Location: admin.php?homepage_saved=1'); exit;
  }

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É—Å–ª—É–≥
  if (isset($_POST['save_services'])){
    $newServices = [];
    if(isset($_POST['services']) && is_array($_POST['services'])){
      foreach($_POST['services'] as $i => $service){
        $newServices[] = [
          'name' => sanitize_text($service['name'] ?? ''),
          'price' => sanitize_text($service['price'] ?? ''),
          'description' => sanitize_text($service['description'] ?? ''),
          'enabled' => !empty($service['enabled']),
          'yukassa_enabled' => !empty($service['yukassa_enabled'])
        ];
      }
    }
    @file_put_contents($servicesFile, json_encode($newServices, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
    header('Location: admin.php?services_saved=1'); exit;
  }

  // –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π
  if (isset($_POST['admin_save'])){
    $new=$cfg;
    foreach(['brand','slogan','hero','phone_display','phone_raw','email_to','email_from','email_cc','email_bcc','email_reply','address','hero_mode','hero_image','catalog_desc'] as $f){
      if(isset($_POST[$f])) $new[$f]=trim($_POST[$f]);
    }
    if(isset($_POST['workhours'])){
      $wh=array_filter(array_map('trim', explode('\n', str_replace('\r','',$_POST['workhours']))));
      if($wh) $new['workhours']=array_values($wh);
    }
    if(!empty($_POST['admin_pass'])) $new['admin_pass']=$_POST['admin_pass'];

    if(isset($_POST['seo']) && is_array($_POST['seo'])){
      $new['seo']['title'] = trim($_POST['seo']['title'] ?? $new['seo']['title']);
      $new['seo']['description'] = trim($_POST['seo']['description'] ?? $new['seo']['description']);
      $new['seo']['keywords'] = trim($_POST['seo']['keywords'] ?? $new['seo']['keywords']);
      $new['seo']['og_image'] = trim($_POST['seo']['og_image'] ?? $new['seo']['og_image']);
      $new['seo']['sitemap_enable'] = !empty($_POST['seo']['sitemap_enable']);
    }

    if(isset($_POST['business']) && is_array($_POST['business'])){
      $new['business']['show_requisites'] = !empty($_POST['business']['show_requisites']);
      $new['business']['show_payment_icons'] = !empty($_POST['business']['show_payment_icons']);
      $new['business']['legal_name'] = trim($_POST['business']['legal_name'] ?? $new['business']['legal_name']);
      $new['business']['inn'] = trim($_POST['business']['inn'] ?? $new['business']['inn']);
      $new['business']['ogrn'] = trim($_POST['business']['ogrn'] ?? $new['business']['ogrn']);
      $new['business']['bank'] = trim($_POST['business']['bank'] ?? $new['business']['bank']);
      $new['business']['bik'] = trim($_POST['business']['bik'] ?? $new['business']['bik']);
      $new['business']['account'] = trim($_POST['business']['account'] ?? $new['business']['account']);
    }

    if(isset($_POST['social']) && is_array($_POST['social'])){
      foreach(['vk','instagram','youtube','whatsapp','telegram_channel'] as $s) {
        $new['social'][$s] = trim($_POST['social'][$s] ?? $new['social'][$s]);
      }
    }

    if(isset($_POST['yukassa']) && is_array($_POST['yukassa'])){
      $new['yukassa']['enabled'] = !empty($_POST['yukassa']['enabled']);
      $new['yukassa']['shop_id'] = trim($_POST['yukassa']['shop_id'] ?? $new['yukassa']['shop_id']);
      $new['yukassa']['test_mode'] = !empty($_POST['yukassa']['test_mode']);
      $new['yukassa']['return_url'] = trim($_POST['yukassa']['return_url'] ?? $new['yukassa']['return_url']);
      if(isset($_POST['yukassa']['secret_key']) && $_POST['yukassa']['secret_key'] !== '__KEEP__') {
        $new['yukassa']['secret_key'] = $_POST['yukassa']['secret_key'];
      }

      if(isset($_POST['yukassa']['services']) && is_array($_POST['yukassa']['services'])){
        $new['yukassa']['services']['products'] = !empty($_POST['yukassa']['services']['products']);
        $new['yukassa']['services']['photo_constructor'] = !empty($_POST['yukassa']['services']['photo_constructor']);
        $new['yukassa']['services']['regular_orders'] = !empty($_POST['yukassa']['services']['regular_orders']);
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SMTP
    $new['smtp']['enabled']=!empty($_POST['smtp_enabled']);
    $new['smtp']['host']=trim($_POST['smtp_host']??$new['smtp']['host']);
    $new['smtp']['port']=(int)($_POST['smtp_port']??$new['smtp']['port']);
    $new['smtp']['secure']=in_array($_POST['smtp_secure']??'ssl',['ssl','tls','none'])?$_POST['smtp_secure']:'ssl';
    $new['smtp']['user']=trim($_POST['smtp_user']??$new['smtp']['user']);
    if(isset($_POST['smtp_pass']) && $_POST['smtp_pass']!=='__KEEP__') $new['smtp']['pass']=$_POST['smtp_pass'];

    $new['telegram']['enabled']=!empty($_POST['tg_enabled']);
    $new['telegram']['token']=trim($_POST['tg_token']??$new['telegram']['token']);
    $new['telegram']['chat']=trim($_POST['tg_chat']??$new['telegram']['chat']);

    // –û–±–Ω–æ–≤–ª—è–µ–º features - —É–±–∏—Ä–∞–µ–º –ª–æ—è–ª—å–Ω–æ—Å—Ç—å
    $new['features']['loyalty_program'] = false; // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º
    $new['features']['reviews_enabled'] = !empty($_POST['features_reviews_enabled']);
    $new['features']['callback_widget'] = !empty($_POST['features_callback_widget']);
    $new['features']['price_alerts'] = !empty($_POST['features_price_alerts']);

    if(isset($_POST['theme']) && is_array($_POST['theme'])){
      $t=$new['theme'];
      $t['mode']  = in_array(($_POST['theme']['mode']??'light'),['light','dark'])?$_POST['theme']['mode']:'light';
      $t['bg']    = sanitize_hex($_POST['theme']['bg']   ?? $t['bg']);
      $t['text']  = sanitize_hex($_POST['theme']['text'] ?? $t['text']);
      $t['muted'] = sanitize_hex($_POST['theme']['muted']?? $t['muted']);
      $t['brand'] = sanitize_hex($_POST['theme']['brand']?? $t['brand']);
      $t['accent']= sanitize_hex($_POST['theme']['accent']??$t['accent']);
      $t['card_opacity']= clamp_float($_POST['theme']['card_opacity']??$t['card_opacity'], 0.3, 1.0, 0.65);
      $t['blur']  = clamp_int($_POST['theme']['blur']??$t['blur'], 0, 30, 12);
      $t['radius']= clamp_int($_POST['theme']['radius']??$t['radius'], 0, 28, 16);
      $t['shadow']= clamp_float($_POST['theme']['shadow']??$t['shadow'], 0, 0.5, 0.12);
      $t['container']= clamp_int($_POST['theme']['container']??$t['container'], 900, 1400, 1200);
      $new['theme']=$t;
    }

    @file_put_contents($configFile, json_encode($new, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
    header('Location: admin.php?saved=1'); exit;
  }

  if (isset($_POST['admin_upload'])){
    try{
      $what=$_POST['what']??'';
      if($what==='logo'){
        $fn=save_upload_image('file',$uploadsDir);
        $cfg['logo']='/uploads/'.$fn;
      } elseif($what==='hero'){
        $fn=save_upload_image('file',$uploadsDir);
        $cfg['hero_mode']='image';
        $cfg['hero_image']='/uploads/'.$fn;
      } else { throw new Exception('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∑–∞–≥—Ä—É–∑–∫–∏'); }
      @file_put_contents($configFile, json_encode($cfg, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
      header('Location: admin.php?saved=1'); exit;
    }catch(Exception $e){
      header('Location: admin.php?err='.urlencode($e->getMessage())); exit;
    }
  }

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
  if (isset($_POST['save_product'])) {
    try {
      $id = (int)($_POST['id'] ?? 0);
      $name = sanitize_text($_POST['name'] ?? '');
      $price = max(0, (int)($_POST['price'] ?? 0));
      $old_price = max(0, (int)($_POST['old_price'] ?? 0));
      $category = sanitize_text($_POST['category'] ?? 'frames');
      $description = sanitize_text($_POST['description'] ?? '');
      $enabled = !empty($_POST['enabled']);
      $featured = !empty($_POST['featured']);
      $stock = max(0, (int)($_POST['stock'] ?? 0));

      if (!$name || !$price) throw new Exception('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É.');

      $image = '';
      if (!empty($_FILES['image']['name'])) {
        $image = save_upload_image('image', $uploadsDir);
      } else {
        foreach ($products as $p) {
          if ($p['id'] == $id) {
            $image = $p['image'] ?? '';
            break;
          }
        }
      }

      $newProduct = [
        'id' => $id ?: (count($products) > 0 ? max(array_column($products, 'id')) + 1 : 1),
        'name' => $name,
        'price' => $price,
        'old_price' => $old_price,
        'category' => $category,
        'image' => $image,
        'description' => $description,
        'enabled' => $enabled,
        'featured' => $featured,
        'stock' => $stock
      ];

      if ($id) {
        foreach ($products as $key => $p) {
          if ($p['id'] == $id) {
            $products[$key] = $newProduct;
            break;
          }
        }
      } else {
        $products[] = $newProduct;
      }

      @file_put_contents($productsFile, json_encode($products, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
      header('Location: admin.php?product_saved=1');
      exit;

    } catch (Exception $e) {
      header('Location: admin.php?error=' . urlencode($e->getMessage()));
      exit;
    }
  }

  // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
  if (isset($_POST['delete_product'])) {
    $id = (int)($_POST['id'] ?? 0);
    foreach ($products as $key => $p) {
      if ($p['id'] == $id) {
        if ($p['image'] && file_exists($uploadsDir . '/' . $p['image'])) {
          @unlink($uploadsDir . '/' . $p['image']);
        }
        unset($products[$key]);
        break;
      }
    }
    $products = array_values($products);
    @file_put_contents($productsFile, json_encode($products, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
    header('Location: admin.php?product_deleted=1');
    exit;
  }

  // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
  if (isset($_POST['admin_test_email'])){
    [$ok,$errs] = send_email_all($cfg,'–¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—á—Ç—ã', '–¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –æ—Ç '.date('Y-m-d H:i:s').'\n–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.');
    header('Location: admin.php?test_email='.($ok?'ok':'fail').'&test_errors='.urlencode(implode('; ', $errs)));
    exit;
  }

  if (isset($_POST['admin_test_tg'])){
    try{
      tg_api($cfg['telegram']['token'],'sendMessage',['chat_id'=>$cfg['telegram']['chat'],'text'=>'üß™ –¢–µ—Å—Ç Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏\n\n‚úÖ –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ\nüìÖ '.date('Y-m-d H:i:s')]);
      header('Location: admin.php?test_tg=ok');
    }
    catch(Throwable $e){
      header('Location: admin.php?test_tg=fail&tg_error='.urlencode($e->getMessage()));
    }
    exit;
  }

  if (isset($_POST['tg_delete_webhook'])){
    try{ tg_api($cfg['telegram']['token'],'deleteWebhook'); header('Location: admin.php?tg_webhook=deleted'); }
    catch(Throwable $e){ header('Location: admin.php?tg_webhook=err'); }
    exit;
  }

  if (isset($_POST['tg_get_updates'])){
    $_SESSION['tg_updates'] = null;
    try{ $res = tg_api($cfg['telegram']['token'],'getUpdates', ['timeout'=>0]); $_SESSION['tg_updates']=$res; header('Location: admin.php?tg_updates=ok'); }
    catch(Throwable $e){ header('Location: admin.php?tg_updates=err'); }
    exit;
  }

  if (isset($_POST['tg_use_chat'])){
    $chat = trim($_POST['chat']??'');
    if ($chat!=='') { $cfg['telegram']['chat']=$chat; @file_put_contents($configFile, json_encode($cfg, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT)); header('Location: admin.php?tg_chat=saved'); }
    else { header('Location: admin.php?tg_chat=err'); }
    exit;
  }
}

$isLogin = !isset($_SESSION['is_admin']);
$stats = get_order_statistics($ordersLog);
?><!doctype html>
<html lang='ru'>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî <?=esc($cfg['brand'])?></title>
  <style>
    :root{--bg:#0f1115;--panel:#151a22;--muted:#a7b0c0;--brand:#FFD400;--accent:#2D5BFF;--ok:#66e38a;--bad:#ff7a7a;--text:#e9eef7}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,'Segoe UI',Arial,Roboto;line-height:1.4}
    .wrap{max-width:1400px;margin:0 auto;padding:16px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:18px;margin-bottom:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:980px){.row{grid-template-columns:1fr}}
    input,textarea,select{width:100%;background:#121825;border:1px solid rgba(255,255,255,.15);color:#fff;border-radius:8px;padding:10px;box-sizing:border-box;font-size:14px}
    input:focus,textarea:focus,select:focus{border-color:var(--accent);outline:none}
    .btn{background:linear-gradient(90deg,var(--accent),#00c2ff);border:none;color:#fff;padding:10px 16px;border-radius:8px;cursor:pointer;margin-right:8px;margin-bottom:8px;font-size:14px;font-weight:500}
    .btn:hover{opacity:0.9;transform:translateY(-1px)}
    .btn-danger{background:linear-gradient(90deg,#ff4757,#ff6b7a)}
    .btn-success{background:linear-gradient(90deg,#2ed573,#55eaa3)}
    .btn2{background:#1b2232;border:1px solid rgba(255,255,255,.15);color:#fff;padding:10px 16px;border-radius:8px;cursor:pointer;font-size:14px}
    .btn2:hover{background:#252b3a}
    .muted{color:var(--muted);font-size:13px}
    .ok{color:var(--ok);font-weight:600}
    .bad{color:var(--bad);font-weight:600}
    .tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
    .tab{background:#1b2232;border:1px solid rgba(255,255,255,.15);color:#fff;padding:12px 18px;border-radius:8px;cursor:pointer;text-decoration:none;font-size:14px;font-weight:500}
    .tab:hover{background:#252b3a}
    .tab.active{background:var(--accent);border-color:var(--accent)}
    .products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:16px}
    .product-card{background:#1e2530;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:16px;position:relative}
    .product-image{width:100%;height:160px;background:#0f1624;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:12px}
    .product-image img{width:100%;height:100%;object-fit:cover}
    .badge{display:inline-block;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600;margin-right:6px;text-transform:uppercase}
    .badge-success{background:#2ed573;color:#000}
    .badge-danger{background:#ff4757;color:#fff}
    .badge-warning{background:#ffa502;color:#000}
    .badge-info{background:#3742fa;color:#fff}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:13px}
    th{background:rgba(255,255,255,.05);font-weight:600}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;margin-bottom:6px;font-weight:600;font-size:13px;text-transform:uppercase;letter-spacing:0.5px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    @media(max-width:768px){.form-row,.form-row-3{grid-template-columns:1fr}}
    .mini{font-size:12px}
    .flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    .drop{position:relative;display:grid;place-items:center;min-height:120px;border:2px dashed rgba(255,255,255,.25);border-radius:10px;background:#0f1624;cursor:pointer;transition:all 0.3s}
    .drop.hover{background:#0c1220;border-color:var(--brand)}
    .drop input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer}
    .drop-content{text-align:center;pointer-events:none}
    .drop-icon{font-size:28px;margin-bottom:8px;opacity:0.7}
    .drop-text{font-size:13px;font-weight:600;margin-bottom:4px}
    .drop-hint{font-size:11px;opacity:0.6}
    .drop.has-image{border-style:solid;border-color:var(--brand)}
    .drop-preview{max-width:100%;max-height:90px;border-radius:6px;margin-bottom:8px}
    .drop-remove{position:absolute;top:8px;right:8px;background:rgba(255,0,0,.8);color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:12px;display:none}
    .drop.has-image .drop-remove{display:block}

    .alert{padding:12px 16px;border-radius:8px;margin-bottom:16px;font-size:14px}
    .alert-success{background:#1a4d3a;border:1px solid #2ed573;color:#66e38a}
    .alert-danger{background:#4d1a1a;border:1px solid #ff4757;color:#ff7a7a}
    .alert-info{background:#1a2d4d;border:1px solid #2d5bff;color:#7aa7ff}

    .stats-bar{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:20px}
    .stat-card{background:#1e2530;padding:16px;border-radius:10px;text-align:center;border:1px solid rgba(255,255,255,.1)}
    .stat-number{font-size:24px;font-weight:700;color:var(--brand)}
    .stat-label{font-size:12px;color:var(--muted);text-transform:uppercase;margin-top:4px}
    .stat-change{font-size:11px;margin-top:4px}
    .stat-up{color:var(--ok)}
    .stat-down{color:var(--bad)}
    @media(max-width:768px){.stats-bar{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:480px){.stats-bar{grid-template-columns:1fr}}

    .service-item{background:#1e2530;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:16px;margin-bottom:12px}
    .service-controls{display:flex;gap:12px;align-items:center;margin-top:10px}
    .toggle{position:relative;display:inline-block;width:50px;height:24px}
    .toggle input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#666;transition:.4s;border-radius:24px}
    .slider:before{position:absolute;content:'';height:18px;width:18px;left:3px;bottom:3px;background:white;transition:.4s;border-radius:50%}
    input:checked + .slider{background:var(--accent)}
    input:checked + .slider:before{transform:translateX(26px)}

    .orders-filter{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
    .filter-btn{background:#1b2232;border:1px solid rgba(255,255,255,.15);color:#fff;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:12px}
    .filter-btn.active{background:var(--accent)}

    .config-section{background:#252b3a;border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:16px;margin-bottom:16px}
    .config-section h4{margin:0 0 12px;color:var(--brand)}
    .config-item{background:#1e2530;border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:12px;margin-bottom:8px;position:relative}
    .config-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .remove-config-item{position:absolute;top:8px;right:8px;background:#ff4757;color:#fff;border:none;border-radius:4px;width:20px;height:20px;cursor:pointer;font-size:12px}

    .crm-sidebar{position:fixed;right:-400px;top:0;width:400px;height:100vh;background:var(--panel);border-left:1px solid rgba(255,255,255,.15);transition:all 0.3s;z-index:1000;overflow-y:auto}
    .crm-sidebar.open{right:0}
    .crm-header{padding:16px;border-bottom:1px solid rgba(255,255,255,.15);display:flex;justify-content:space-between;align-items:center}
    .crm-body{padding:16px}
    .crm-close{background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer}
    .customer-info{background:#1e2530;padding:16px;border-radius:8px;margin-bottom:16px}
    .customer-tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .customer-tag{background:var(--accent);color:#fff;padding:2px 8px;border-radius:12px;font-size:11px}
    .order-history{margin-top:16px}
    .order-item{background:#1e2530;padding:12px;border-radius:6px;margin-bottom:8px;border-left:3px solid var(--brand)}

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:2000;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-content{background:var(--panel);border-radius:12px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto}
    .modal-header{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.15);display:flex;justify-content:space-between;align-items:center}
    .modal-body{padding:20px}
    .close-modal{background:none;border:none;color:var(--muted);font-size:24px;cursor:pointer}

    @media(max-width:768px){
      .crm-sidebar{width:100vw;right:-100vw}
      .wrap{padding:12px}
      .stats-bar{gap:12px}
      .form-row,.form-row-3{grid-template-columns:1fr}
    }

    .status-select{background:#1e2530;border:1px solid rgba(255,255,255,.15);color:#fff;padding:6px 8px;border-radius:4px;font-size:12px}
    .order-actions{display:flex;gap:6px;margin-top:8px}
    .order-notes{margin-top:12px;padding:12px;background:#1a1f28;border-radius:6px;font-size:12px}
    .quick-actions{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}

    .integration-status{padding:8px 12px;border-radius:6px;font-size:12px;font-weight:600;margin:4px 0}
    .integration-ok{background:#1a4d3a;color:#66e38a}
    .integration-fail{background:#4d1a1a;color:#ff7a7a}

    .reviews-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin:16px 0}
    .review-card{background:#1e2530;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:16px}
    .review-rating{color:#FFD700;font-size:18px;margin-bottom:8px}
    .review-actions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
  </style>
  <meta name='robots' content='noindex,nofollow'>
</head>
<body>
  <div class='wrap'>
    <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:16px'>
      <h1>üè™ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî <?=esc($cfg['brand'])?></h1>
      <div class='flex'>
        <a href='/' class='btn2' target='_blank'>üè† –°–∞–π—Ç</a>
        <a href='produkt.php' class='btn2' target='_blank'>üõçÔ∏è –¢–æ–≤–∞—Ä—ã</a>
        <a href='–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä.php' class='btn2' target='_blank'>üì∏ –§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</a>
        <?php if(!empty($_SESSION['is_admin'])): ?>
          <a href='?logout=1' class='btn-danger'>üö™ –í—ã—Ö–æ–¥</a>
        <?php endif; ?>
      </div>
    </div>

    <?php if (isset($_GET['logout'])){ session_destroy(); header('Location: admin.php'); exit; } ?>

    <?php if ($isLogin): ?>
      <div class='card'>
        <h3>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
        <?php if(isset($_GET['err'])): ?><div class='alert alert-danger'>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div><?php endif; ?>
        <form method='post'>
          <div class='form-group'>
            <label>–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
            <input type='password' name='password' placeholder='–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å' required autofocus>
          </div>
          <button class='btn-success' name='admin_login' value='1'>üîì –í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
        </form>
        <div class='muted mini' style='margin-top:12px'>–ü–∞—Ä–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: <code><?=esc($cfg['admin_pass'])?></code></div>
      </div>
    <?php else: ?>

      <?php if (isset($_GET['saved'])): ?><div class='alert alert-success'>‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</div><?php endif; ?>
      <?php if (isset($_GET['homepage_saved'])): ?><div class='alert alert-success'>‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</div><?php endif; ?>
      <?php if (isset($_GET['services_saved'])): ?><div class='alert alert-success'>‚úÖ –£—Å–ª—É–≥–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</div><?php endif; ?>
      <?php if (isset($_GET['photo_config_saved'])): ?><div class='alert alert-success'>‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</div><?php endif; ?>
      <?php if (isset($_GET['product_saved'])): ?><div class='alert alert-success'>‚úÖ –¢–æ–≤–∞—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω!</div><?php endif; ?>
      <?php if (isset($_GET['product_deleted'])): ?><div class='alert alert-success'>üóëÔ∏è –¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω!</div><?php endif; ?>
      <?php if (isset($_GET['order_updated'])): ?><div class='alert alert-success'>üì¶ –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω!</div><?php endif; ?>
      <?php if (isset($_GET['customer_updated'])): ?><div class='alert alert-success'>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!</div><?php endif; ?>
      <?php if (isset($_GET['review_updated'])): ?><div class='alert alert-success'>‚≠ê –û—Ç–∑—ã–≤ –æ–±–Ω–æ–≤–ª–µ–Ω!</div><?php endif; ?>
      <?php if (isset($_GET['error'])): ?><div class='alert alert-danger'>‚ùå <?=esc($_GET['error'])?></div><?php endif; ?>

      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div class='stats-bar'>
        <div class='stat-card'>
          <div class='stat-number'><?=$stats['total']?></div>
          <div class='stat-label'>–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
          <div class='stat-change stat-up'>+<?=$stats['today']?> —Å–µ–≥–æ–¥–Ω—è</div>
        </div>
        <div class='stat-card'>
          <div class='stat-number'><?=$stats['this_week']?></div>
          <div class='stat-label'>–ó–∞ –Ω–µ–¥–µ–ª—é</div>
          <div class='stat-change muted'><?=$stats['this_month']?> –∑–∞ –º–µ—Å—è—Ü</div>
        </div>
        <div class='stat-card'>
          <div class='stat-number'><?=number_format($stats['total_revenue'], 0, ' ', ' ')?> ‚ÇΩ</div>
          <div class='stat-label'>–í—ã—Ä—É—á–∫–∞</div>
          <div class='stat-change muted'>~<?=number_format($stats['avg_order_value'], 0, ' ', ' ')?> ‚ÇΩ —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
        </div>
        <div class='stat-card'>
          <div class='stat-number'><?=count($customers)?></div>
          <div class='stat-label'>–ö–ª–∏–µ–Ω—Ç–æ–≤ –≤ –±–∞–∑–µ</div>
          <div class='stat-change muted'><?=$stats['callback_requests']?> –∑–≤–æ–Ω–∫–æ–≤</div>
        </div>
        <div class='stat-card'>
          <div class='stat-number'><?=count($products)?></div>
          <div class='stat-label'>–¢–æ–≤–∞—Ä–æ–≤</div>
          <div class='stat-change muted'><?=$stats['photo_orders']?> —Ñ–æ—Ç–æ –∑–∞–∫–∞–∑–æ–≤</div>
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∏ -->
      <div class='tabs'>
        <a href='#orders' class='tab <?=($_GET['tab']??'orders')==='orders'?'active':''?>' onclick='showTab("orders",this)'>üì¶ CRM –∏ –ó–∞–∫–∞–∑—ã</a>
        <a href='#photoconstructor' class='tab <?=($_GET['tab']??'')==='photoconstructor'?'active':''?>' onclick='showTab("photoconstructor",this)'>üì∏ –§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</a>
        <a href='#homepage' class='tab <?=($_GET['tab']??'')==='homepage'?'active':''?>' onclick='showTab("homepage",this)'>üè† –ì–ª–∞–≤–Ω–∞—è</a>
        <a href='#products' class='tab <?=($_GET['tab']??'')==='products'?'active':''?>' onclick='showTab("products",this)'>üõçÔ∏è –¢–æ–≤–∞—Ä—ã</a>
        <a href='#reviews' class='tab <?=($_GET['tab']??'')==='reviews'?'active':''?>' onclick='showTab("reviews",this)'>‚≠ê –û—Ç–∑—ã–≤—ã</a>
        <a href='#settings' class='tab <?=($_GET['tab']??'')==='settings'?'active':''?>' onclick='showTab("settings",this)'>‚öôÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</a>
        <a href='#integrations' class='tab <?=($_GET['tab']??'')==='integrations'?'active':''?>' onclick='showTab("integrations",this)'>üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</a>
        <a href='#design' class='tab <?=($_GET['tab']??'')==='design'?'active':''?>' onclick='showTab("design",this)'>üé® –î–∏–∑–∞–π–Ω</a>
      </div>

      <!-- –†–ê–ó–î–ï–õ: CRM –∏ –ó–∞–∫–∞–∑—ã -->
      <div id='tab-orders' class='tab-content' style='<?=($_GET['tab']??'orders')==='orders'?'':'display:none'?>'>
        <div class='card'>
          <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px'>
            <h3>üì¶ CRM-—Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏</h3>
            <div class='quick-actions'>
              <button class='btn2' onclick='exportOrders()'>üìä –≠–∫—Å–ø–æ—Ä—Ç</button>
              <button class='btn2' onclick='filterOrders("new")'>üÜï –ù–æ–≤—ã–µ</button>
              <button class='btn2' onclick='filterOrders("in_progress")'>‚è≥ –í —Ä–∞–±–æ—Ç–µ</button>
              <button class='btn2' onclick='filterOrders("completed")'>‚úÖ –ì–æ—Ç–æ–≤–æ</button>
            </div>
          </div>

          <div class='orders-filter'>
            <button class='filter-btn active' onclick='filterOrders("all")'>–í—Å–µ (<?=$stats['total']?>)</button>
            <button class='filter-btn' onclick='filterOrders("cart")'>üõí –¢–æ–≤–∞—Ä—ã (<?=$stats['cart_orders']?>)</button>
            <button class='filter-btn' onclick='filterOrders("photo_constructor")'>üì∏ –§–æ—Ç–æ (<?=$stats['photo_orders']?>)</button>
            <button class='filter-btn' onclick='filterOrders("service")'>üìã –£—Å–ª—É–≥–∏ (<?=$stats['service_orders']?>)</button>
            <button class='filter-btn' onclick='filterOrders("callback")'>üìû –ó–≤–æ–Ω–∫–∏ (<?=$stats['callback_requests']?>)</button>
          </div>

          <div style='overflow-x:auto'>
            <table id='ordersTable'>
              <thead>
                <tr>
                  <th>–í—Ä–µ–º—è</th>
                  <th>–¢–∏–ø</th>
                  <th>–ö–ª–∏–µ–Ω—Ç</th>
                  <th>–ó–∞–∫–∞–∑</th>
                  <th>–°—É–º–º–∞</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                  <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody>
                <?php
                $lines = @file($ordersLog, FILE_IGNORE_NEW_LINES|FILE_SKIP_EMPTY_LINES) ?: [];
                $lines = array_slice(array_reverse($lines), 0, 200);

                foreach($lines as $line){
                  if(!preg_match('~^$$(.+?)$$ (.+)$~u', $line, $m)) continue;
                  $ts = $m[1];
                  $j = json_decode($m[2], true);
                  if (!$j) continue;

                  // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –∑–∞–ø–∏—Å–∏
                  if (isset($j['action']) && $j['action'] === 'status_update') continue;
                  if (isset($j['updated_order'])) continue;

                  $type = $j['type'] ?? 'service';
                  $typeIcon = $type === 'cart' ? 'üõí' : ($type === 'callback' ? 'üìû' : ($type === 'photo_constructor' ? 'üì∏' : 'üìã'));
                  $orderId = $j['id'] ?? 'unknown';
                  $status = $j['status'] ?? 'new';

                  echo '<tr data-type="'.esc($type).'" data-order-id="'.esc($orderId).'" data-status="'.esc($status).'">';
                  echo '<td><small>'.esc(date('d.m H:i', strtotime($ts))).'</small></td>';
                  echo '<td>'.$typeIcon.'</td>';
                  echo '<td>';
                  echo '<strong>'.esc($j['name'] ?? '‚Äî').'</strong><br>';
                  echo '<small>'.esc($j['phone'] ?? '‚Äî').'</small>';
                  if (!empty($j['email'])) echo '<br><small>'.esc($j['email']).'</small>';
                  echo '</td>';

                  // –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
                  echo '<td>';
                  if ($type === 'cart') {
                    $itemCount = count($j['items'] ?? []);
                    echo '–¢–æ–≤–∞—Ä—ã: '.$itemCount.' —à—Ç<br>';
                    if (!empty($j['items'])) {
                      foreach (array_slice($j['items'], 0, 2) as $item) {
                        echo '<small>‚Ä¢ '.esc($item['name'] ?? '').' √ó '.($item['quantity'] ?? 1).'</small><br>';
                      }
                      if (count($j['items']) > 2) echo '<small>... –∏ –µ—â–µ '.(count($j['items']) - 2).'</small>';
                    }
                  } elseif ($type === 'photo_constructor') {
                    $photoCount = $j['photo_count'] ?? 0;
                    echo '–§–æ—Ç–æ–ø–µ—á–∞—Ç—å: '.$photoCount.' —Ñ–æ—Ç–æ<br>';
                    echo '<small>–†–∞–∑–º–µ—Ä: '.esc($j['size'] ?? '‚Äî').'</small><br>';
                    echo '<small>–ë—É–º–∞–≥–∞: '.esc($j['paper'] ?? '‚Äî').'</small><br>';
                    echo '<small>–¢–∏—Ä–∞–∂: '.esc($j['qty_per_photo'] ?? 1).' –Ω–∞ —Ñ–æ—Ç–æ</small>';
                  } elseif ($type === 'callback') {
                    echo '–û–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫<br>';
                    if (!empty($j['preferred_time'])) echo '<small>–í—Ä–µ–º—è: '.esc($j['preferred_time']).'</small>';
                  } else {
                    echo esc($j['service'] ?? '‚Äî').'<br>';
                    if (!empty($j['comment'])) echo '<small>'.esc(mb_substr($j['comment'], 0, 50)).'...</small>';
                  }
                  echo '</td>';

                  // –°—É–º–º–∞
                  echo '<td>';
                  if (isset($j['total_price'])) {
                    echo '<strong>'.number_format($j['total_price'], 0, ',', ' ').' ‚ÇΩ</strong>';
                  } elseif (isset($j['estimated_price'])) {
                    echo '<strong>'.number_format($j['estimated_price'], 0, ',', ' ').' ‚ÇΩ</strong>';
                  } elseif (!empty($j['price']) && $j['price'] !== '‚Äî') {
                    echo '<strong>'.esc($j['price']).'</strong>';
                  } else {
                    echo '<span class="muted">‚Äî</span>';
                  }
                  echo '</td>';

                  // –°—Ç–∞—Ç—É—Å —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∏–∑–º–µ–Ω–µ–Ω–∏—è
                  echo '<td>';
                  $statusLabels = [
                    'new' => ['–ù–æ–≤—ã–π', 'badge-info'],
                    'in_progress' => ['–í —Ä–∞–±–æ—Ç–µ', 'badge-warning'],
                    'completed' => ['–ì–æ—Ç–æ–≤–æ', 'badge-success'],
                    'cancelled' => ['–û—Ç–º–µ–Ω–µ–Ω', 'badge-danger'],
                    'paid' => ['–û–ø–ª–∞—á–µ–Ω', 'badge-success'],
                    'pending_payment' => ['–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã', 'badge-warning']
                  ];

                  $statusInfo = $statusLabels[$status] ?? ['–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', 'badge'];
                  echo '<span class="badge '.$statusInfo[1].'">'.$statusInfo[0].'</span>';

                  $paymentMethod = $j['payment_method'] ?? '';
                  if ($paymentMethod === 'online') {
                    echo '<br><small class="muted">üí≥ –û–Ω–ª–∞–π–Ω</small>';
                  }
                  echo '</td>';

                  // –î–µ–π—Å—Ç–≤–∏—è
                  echo '<td>';
                  echo '<button class="btn2" style="padding:4px 8px;font-size:11px;margin:2px" onclick="viewOrderDetails(\''.esc($orderId).'\')"">üëÅÔ∏è –î–µ—Ç–∞–ª–∏</button>';
                  echo '<button class="btn2" style="padding:4px 8px;font-size:11px;margin:2px" onclick="editOrderStatus(\''.esc($orderId).'\', \''.esc($status).'\')">‚úèÔ∏è –°—Ç–∞—Ç—É—Å</button>';

                  // –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ –¥–ª—è –∑–∞–∫–∞–∑–æ–≤ —Ñ–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
                  if ($type === 'photo_constructor') {
                    echo '<button class="btn2" style="padding:4px 8px;font-size:11px;margin:2px" onclick="downloadConstructorPhotos(\''.esc($orderId).'\')">üì• –§–æ—Ç–æ</button>';
                  }

                  if (!empty($j['name']) && !empty($j['phone'])) {
                    echo '<button class="btn2" style="padding:4px 8px;font-size:11px;margin:2px" onclick="viewCustomer(\''.esc(preg_replace('/[^0-9]/', '', $j['phone'])).'\')">üë§ CRM</button>';
                  }
                  echo '</td>';
                  echo '</tr>';
                }
                ?>
              </tbody>
            </table>
          </div>
        </div>

        <!-- –ë–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
        <div class='card'>
          <h3>üë• –ë–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ (CRM)</h3>
          <div style='overflow-x:auto'>
            <table>
              <thead>
                <tr>
                  <th>–ö–ª–∏–µ–Ω—Ç</th>
                  <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
                  <th>–ó–∞–∫–∞–∑–æ–≤</th>
                  <th>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</th>
                  <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç</th>
                  <th>–¢–µ–≥–∏</th>
                  <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody>
                <?php
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –∫–æ–Ω—Ç–∞–∫—Ç—É
                usort($customers, function($a, $b) {
                  return strtotime($b['last_contact'] ?? '1970-01-01') - strtotime($a['last_contact'] ?? '1970-01-01');
                });

                foreach (array_slice($customers, 0, 50) as $customer):
                ?>
                  <tr>
                    <td>
                      <strong><?=esc($customer['name'])?></strong><br>
                      <small class='muted'>ID: <?=esc($customer['id'])?></small>
                    </td>
                    <td>
                      <small><?=esc($customer['phone'])?></small><br>
                      <?php if (!empty($customer['email'])): ?>
                        <small><?=esc($customer['email'])?></small>
                      <?php endif; ?>
                    </td>
                    <td><strong><?=($customer['orders_count'] ?? 0)?></strong></td>
                    <td><strong><?=number_format($customer['total_spent'] ?? 0, 0, ' ', ' ')?> ‚ÇΩ</strong></td>
                    <td><small><?=esc(date('d.m.Y H:i', strtotime($customer['last_contact'] ?? '1970-01-01')))?></small></td>
                    <td>
                      <?php if (!empty($customer['tags'])): ?>
                        <?php foreach (array_slice($customer['tags'], 0, 3) as $tag): ?>
                          <span class='customer-tag'><?=esc($tag)?></span>
                        <?php endforeach; ?>
                      <?php endif; ?>
                    </td>
                    <td>
                      <button class='btn2' style='padding:4px 8px;font-size:11px' onclick='viewCustomer("<?=esc($customer['id'])?>")'> üëÅÔ∏è –ü—Ä–æ—Ñ–∏–ª—å</button>
                    </td>
                  </tr>
                <?php endforeach; ?>
              </tbody>
            </table>
          </div>

          <?php if (count($customers) > 50): ?>
            <div style='text-align:center;margin-top:16px' class='muted'>
              –ü–æ–∫–∞–∑–∞–Ω–æ 50 –∏–∑ <?=count($customers)?> –∫–ª–∏–µ–Ω—Ç–æ–≤
            </div>
          <?php endif; ?>
        </div>
      </div>

      <!-- –†–ê–ó–î–ï–õ: –§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä -->
      <div id='tab-photoconstructor' class='tab-content' style='<?=($_GET['tab']??'')==='photoconstructor'?'':'display:none'?>'>
        <div class='card'>
          <h3>üì∏ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞</h3>
          <form method='post' id='photoConfigForm'>

            <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div class='config-section'>
              <h4>‚öôÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h4>

              <div class='form-row-3'>
                <div class='form-group'>
                  <label class='toggle'>
                    <input type='checkbox' name='photo_enabled' <?=!empty($photoConfig['enabled']) ? 'checked' : ''?>>
                    <span class='slider'></span>
                  </label>
                  <span style='margin-left: 10px;'>–í–∫–ª—é—á–∏—Ç—å —Ñ–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</span>
                </div>

                <div class='form-group'>
                  <label>–ú–∞–∫—Å–∏–º—É–º —Ñ–æ—Ç–æ –≤ –∑–∞–∫–∞–∑–µ</label>
                  <input type='number' name='max_photos' value='<?=esc($photoConfig['max_photos'])?>' min='1' max='500'>
                </div>

                <div class='form-group'>
                  <label>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–ú–ë)</label>
                  <input type='number' name='max_file_size' value='<?=esc($photoConfig['max_file_size'])?>' min='1' max='100'>
                </div>
              </div>
            </div>

            <!-- –†–∞–∑–º–µ—Ä—ã —Ñ–æ—Ç–æ -->
            <div class='config-section'>
              <h4>üìê –†–∞–∑–º–µ—Ä—ã —Ñ–æ—Ç–æ</h4>
              <div id='sizesList'>
                <?php foreach($photoConfig['sizes'] as $i => $size): ?>
                  <div class='config-item'>
                    <button type='button' class='remove-config-item' onclick='removeConfigItem(this)'>√ó</button>

                    <div class='form-row'>
                      <div class='form-group'>
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input name='sizes[<?=$i?>][name]' value='<?=esc($size['name'])?>' placeholder='10√ó15'>
                      </div>
                      <div class='form-group'>
                        <label>–®–∏—Ä–∏–Ω–∞ (—Å–º)</label>
                        <input type='number' step='0.1' name='sizes[<?=$i?>][w]' value='<?=esc($size['w'])?>' placeholder='10'>
                      </div>
                      <div class='form-group'>
                        <label>–í—ã—Å–æ—Ç–∞ (—Å–º)</label>
                        <input type='number' step='0.1' name='sizes[<?=$i?>][h]' value='<?=esc($size['h'])?>' placeholder='15'>
                      </div>
                      <div class='form-group'>
                        <label>–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ (‚ÇΩ)</label>
                        <input type='number' name='sizes[<?=$i?>][base]' value='<?=esc($size['base'])?>' placeholder='30'>
                      </div>
                    </div>

                    <div class='service-controls'>
                      <label class='toggle'>
                        <input type='checkbox' name='sizes[<?=$i?>][enabled]' <?=!empty($size['enabled']) ? 'checked' : ''?>>
                        <span class='slider'></span>
                      </label>
                      <span>–î–æ—Å—Ç—É–ø–µ–Ω</span>

                      <label class='toggle' style='margin-left: 20px;'>
                        <input type='checkbox' name='sizes[<?=$i?>][popular]' <?=!empty($size['popular']) ? 'checked' : ''?>>
                        <span class='slider'></span>
                      </label>
                      <span>–ü–æ–ø—É–ª—è—Ä–Ω—ã–π</span>
                    </div>
                  </div>
                <?php endforeach; ?>
              </div>
              <button type='button' class='btn2' onclick='addSize()'>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–º–µ—Ä</button>
            </div>

            <!-- –¢–∏–ø—ã –±—É–º–∞–≥–∏ -->
            <div class='config-section'>
              <h4>üìÑ –¢–∏–ø—ã –±—É–º–∞–≥–∏</h4>
              <div id='papersList'>
                <?php foreach($photoConfig['papers'] as $i => $paper): ?>
                  <div class='config-item'>
                    <button type='button' class='remove-config-item' onclick='removeConfigItem(this)'>√ó</button>

                    <div class='form-row'>
                      <div class='form-group'>
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input name='papers[<?=$i?>][name]' value='<?=esc($paper['name'])?>' placeholder='–ú–∞—Ç–æ–≤–∞—è'>
                      </div>
                      <div class='form-group'>
                        <label>–î–æ–ø–ª–∞—Ç–∞ (‚ÇΩ)</label>
                        <input type='number' name='papers[<?=$i?>][delta]' value='<?=esc($paper['delta'])?>' placeholder='0'>
                      </div>
                    </div>

                    <div class='form-group'>
                      <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                      <input name='papers[<?=$i?>][description]' value='<?=esc($paper['description'])?>' placeholder='–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –º–∞—Ç–æ–≤–∞—è –±—É–º–∞–≥–∞'>
                    </div>

                    <div class='service-controls'>
                      <label class='toggle'>
                        <input type='checkbox' name='papers[<?=$i?>][enabled]' <?=!empty($paper['enabled']) ? 'checked' : ''?>>
                        <span class='slider'></span>
                      </label>
                      <span>–î–æ—Å—Ç—É–ø–µ–Ω</span>
                    </div>
                  </div>
                <?php endforeach; ?>
              </div>
              <button type='button' class='btn2' onclick='addPaper()'>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø –±—É–º–∞–≥–∏</button>
            </div>

            <!-- –í–∏–¥—ã –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ -->
            <div class='config-section'>
              <h4>üé® –í–∏–¥—ã –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏</h4>
              <div id='correctionsList'>
                <?php foreach($photoConfig['corrections'] as $i => $correction): ?>
                  <div class='config-item'>
                    <button type='button' class='remove-config-item' onclick='removeConfigItem(this)'>√ó</button>

                    <div class='form-row'>
                      <div class='form-group'>
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input name='corrections[<?=$i?>][name]' value='<?=esc($correction['name'])?>' placeholder='–ù–µ—Ç'>
                      </div>
                      <div class='form-group'>
                        <label>–î–æ–ø–ª–∞—Ç–∞ (‚ÇΩ)</label>
                        <input type='number' name='corrections[<?=$i?>][delta]' value='<?=esc($correction['delta'])?>' placeholder='0'>
                      </div>
                    </div>

                    <div class='form-group'>
                      <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                      <input name='corrections[<?=$i?>][description]' value='<?=esc($correction['description'])?>' placeholder='–ë–µ–∑ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏'>
                    </div>

                    <div class='service-controls'>
                      <label class='toggle'>
                        <input type='checkbox' name='corrections[<?=$i?>][enabled]' <?=!empty($correction['enabled']) ? 'checked' : ''?>>
                        <span class='slider'></span>
                      </label>
                      <span>–î–æ—Å—Ç—É–ø–µ–Ω</span>
                    </div>
                  </div>
                <?php endforeach; ?>
              </div>
              <button type='button' class='btn2' onclick='addCorrection()'>‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏</button>
            </div>

            <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ -->
            <div class='config-section'>
              <h4>üõ†Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</h4>
              <div id='processingList'>
                <?php foreach($photoConfig['processing_options'] as $i => $option): ?>
                  <div class='config-item'>
                    <button type='button' class='remove-config-item' onclick='removeConfigItem(this)'>√ó</button>

                    <div class='form-row'>
                      <div class='form-group'>
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input name='processing_options[<?=$i?>][name]' value='<?=esc($option['name'])?>' placeholder='–ö–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ'>
                      </div>
                      <div class='form-group'>
                        <label>–¶–µ–Ω–∞ (‚ÇΩ)</label>
                        <input type='number' name='processing_options[<?=$i?>][price]' value='<?=esc($option['price'])?>' placeholder='20'>
                      </div>
                    </div>

                    <div class='form-group'>
                      <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                      <input name='processing_options[<?=$i?>][description]' value='<?=esc($option['description'])?>' placeholder='–û–±—Ä–µ–∑–∫–∞ –ø–æ –Ω—É–∂–Ω–æ–º—É —Ä–∞–∑–º–µ—Ä—É'>
                    </div>

                    <div class='service-controls'>
                      <label class='toggle'>
                        <input type='checkbox' name='processing_options[<?=$i?>][enabled]' <?=!empty($option['enabled']) ? 'checked' : ''?>>
                        <span class='slider'></span>
                      </label>
                      <span>–î–æ—Å—Ç—É–ø–µ–Ω</span>
                    </div>
                  </div>
                <?php endforeach; ?>
              </div>
              <button type='button' class='btn2' onclick='addProcessingOption()'>‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É</button>
            </div>

            <!-- –°–ø–æ—Å–æ–±—ã –¥–æ—Å—Ç–∞–≤–∫–∏ -->
            <div class='config-section'>
              <h4>üöö –°–ø–æ—Å–æ–±—ã –¥–æ—Å—Ç–∞–≤–∫–∏</h4>
              <div id='deliveryList'>
                <?php foreach($photoConfig['delivery_options'] as $i => $option): ?>
                  <div class='config-item'>
                    <button type='button' class='remove-config-item' onclick='removeConfigItem(this)'>√ó</button>

                    <div class='form-row'>
                      <div class='form-group'>
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input name='delivery_options[<?=$i?>][name]' value='<?=esc($option['name'])?>' placeholder='–°–∞–º–æ–≤—ã–≤–æ–∑'>
                      </div>
                      <div class='form-group'>
                        <label>–¶–µ–Ω–∞ (‚ÇΩ)</label>
                        <input type='number' name='delivery_options[<?=$i?>][price]' value='<?=esc($option['price'])?>' placeholder='0'>
                      </div>
                    </div>

                    <div class='form-group'>
                      <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                      <input name='delivery_options[<?=$i?>][description]' value='<?=esc($option['description'])?>' placeholder='–ó–∞–±—Ä–∞—Ç—å –≤ –æ—Ñ–∏—Å–µ'>
                    </div>

                    <div class='service-controls'>
                      <label class='toggle'>
                        <input type='checkbox' name='delivery_options[<?=$i?>][enabled]' <?=!empty($option['enabled']) ? 'checked' : ''?>>
                        <span class='slider'></span>
                      </label>
                      <span>–î–æ—Å—Ç—É–ø–µ–Ω</span>
                    </div>
                  </div>
                <?php endforeach; ?>
              </div>
              <button type='button' class='btn2' onclick='addDeliveryOption()'>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏</button>
            </div>

            <!-- –°–∫–∏–¥–∫–∏ -->
            <div class='config-section'>
              <h4>üí∞ –°–∫–∏–¥–∫–∏ –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</h4>
              <div id='discountsList'>
                <?php foreach($photoConfig['discounts'] as $i => $discount): ?>
                  <div class='config-item'>
                    <button type='button' class='remove-config-item' onclick='removeConfigItem(this)'>√ó</button>

                    <div class='form-row-3'>
                      <div class='form-group'>
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input name='discounts[<?=$i?>][name]' value='<?=esc($discount['name'])?>' placeholder='–û—Ç 50 —Ñ–æ—Ç–æ'>
                      </div>
                      <div class='form-group'>
                        <label>–û—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–æ—Ç–æ</label>
                        <input type='number' name='discounts[<?=$i?>][threshold]' value='<?=esc($discount['threshold'])?>' placeholder='50'>
                      </div>
                      <div class='form-group'>
                        <label>–°–∫–∏–¥–∫–∞ (%)</label>
                        <input type='number' name='discounts[<?=$i?>][discount_percent]' value='<?=esc($discount['discount_percent'])?>' min='0' max='99' placeholder='10'>
                      </div>
                    </div>

                    <div class='service-controls'>
                      <label class='toggle'>
                        <input type='checkbox' name='discounts[<?=$i?>][enabled]' <?=!empty($discount['enabled']) ? 'checked' : ''?>>
                        <span class='slider'></span>
                      </label>
                      <span>–ê–∫—Ç–∏–≤–Ω–∞</span>
                    </div>
                  </div>
                <?php endforeach; ?>
              </div>
              <button type='button' class='btn2' onclick='addDiscount()'>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–¥–∫—É</button>
            </div>

            <div style='margin-top: 30px; text-align: center;'>
              <button class='btn-success' name='save_photo_config' value='1' style='font-size: 16px; padding: 15px 30px;'>
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- –†–ê–ó–î–ï–õ: –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
      <div id='tab-homepage' class='tab-content' style='<?=($_GET['tab']??'')==='homepage'?'':'display:none'?>'>
        <div class='card'>
          <h3>üè† –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h3>
          <form method='post'>
            <div class='form-row'>
              <div class='form-group'>
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞</label>
                <input name='brand' value='<?=esc($cfg['brand'])?>' placeholder='–ö–æ–ø–∏—Ä–æ–≤–∞–ª—å–Ω—ã–π —Ñ–æ—Ç–æ—Ü–µ–Ω—Ç—Ä –ü–†–ò–ù–¢–°–°'>
              </div>
              <div class='form-group'>
                <label>–°–ª–æ–≥–∞–Ω</label>
                <input name='slogan' value='<?=esc($cfg['slogan'])?>' placeholder='–ü–µ—á–∞—Ç—å –≤ –°–æ—Å–Ω–æ–≤–æ–º –ë–æ—Ä—É'>
              </div>
            </div>

            <div class='form-group'>
              <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥–µ—Ä–æ—è (–≥–ª–∞–≤–Ω—ã–π –ø—Ä–∏–∑—ã–≤)</label>
              <input name='hero' value='<?=esc($cfg['hero'])?>' placeholder='–§–æ—Ç–æ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã ‚Äî 5 –º–∏–Ω—É—Ç'>
            </div>

            <div class='form-group'>
              <label>–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ —É—Å–ª—É–≥</label>
              <textarea name='catalog_desc' rows='2'><?=esc($cfg['catalog_desc'])?></textarea>
            </div>

            <h4>üìã –§—É–Ω–∫—Ü–∏–∏ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h4>
            <div class='row'>
              <div>
                <label class='toggle'>
                  <input type='checkbox' name='homepage_features[fast_photo]' <?=!empty($cfg['homepage_features']['fast_photo']) ? 'checked' : ''?>>
                  <span class='slider'></span>
                </label>
                <span style='margin-left: 10px;'>‚ö° –ë—ã—Å—Ç—Ä–æ–µ —Ñ–æ—Ç–æ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã</span>
              </div>

              <div>
                <label class='toggle'>
                  <input type='checkbox' name='homepage_features[online_payment]' <?=!empty($cfg['homepage_features']['online_payment']) ? 'checked' : ''?>>
                  <span class='slider'></span>
                </label>
                <span style='margin-left: 10px;'>üí≥ –û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞</span>
              </div>

              <div>
                <label class='toggle'>
                  <input type='checkbox' name='homepage_features[delivery]' <?=!empty($cfg['homepage_features']['delivery']) ? 'checked' : ''?>>
                  <span class='slider'></span>
                </label>
                <span style='margin-left: 10px;'>üöö –î–æ—Å—Ç–∞–≤–∫–∞</span>
              </div>

              <div>
                <label class='toggle'>
                  <input type='checkbox' name='homepage_features[photo_constructor]' <?=!empty($cfg['homepage_features']['photo_constructor']) ? 'checked' : ''?>>
                  <span class='slider'></span>
                </label>
                <span style='margin-left: 10px;'>üì∏ –§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</span>
              </div>
            </div>

            <div style='margin-top: 20px;'>
              <button class='btn-success' name='save_homepage' value='1'>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–ª–∞–≤–Ω–æ–π</button>
            </div>
          </form>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏ -->
        <div class='card'>
          <h3>üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏ –∏ —Ü–µ–Ω–∞–º–∏</h3>
          <form method='post' id='servicesForm'>
            <div id='servicesList'>
              <?php foreach($services as $i => $service): ?>
                <div class='service-item'>
                  <div class='form-row'>
                    <div class='form-group'>
                      <label>–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏</label>
                      <input name='services[<?=$i?>][name]' value='<?=esc($service['name'])?>' placeholder='–§–æ—Ç–æ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã'>
                    </div>
                    <div class='form-group'>
                      <label>–¶–µ–Ω–∞</label>
                      <input name='services[<?=$i?>][price]' value='<?=esc($service['price'])?>' placeholder='–æ—Ç 400 ‚ÇΩ'>
                    </div>
                  </div>

                  <div class='form-group'>
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea name='services[<?=$i?>][description]' rows='2'><?=esc($service['description'])?></textarea>
                  </div>

                  <div class='service-controls'>
                    <label class='toggle'>
                      <input type='checkbox' name='services[<?=$i?>][enabled]' <?=!empty($service['enabled']) ? 'checked' : ''?>>
                      <span class='slider'></span>
                    </label>
                    <span>–£—Å–ª—É–≥–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>

                    <label class='toggle' style='margin-left: 20px;'>
                      <input type='checkbox' name='services[<?=$i?>][yukassa_enabled]' <?=!empty($service['yukassa_enabled']) ? 'checked' : ''?>>
                      <span class='slider'></span>
                    </label>
                    <span>–Æ–ö–∞—Å—Å–∞ –≤–∫–ª—é—á–µ–Ω–∞</span>

                    <button type='button' class='btn-danger' onclick='removeService(this)' style='margin-left: auto;'>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                  </div>
                </div>
              <?php endforeach; ?>
            </div>

            <div class='flex' style='margin-top: 16px;'>
              <button type='button' class='btn2' onclick='addService()'>‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É</button>
              <button class='btn-success' name='save_services' value='1'>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—Å–ª—É–≥–∏</button>
            </div>
          </form>
        </div>
      </div>

      <!-- –†–ê–ó–î–ï–õ: –¢–æ–≤–∞—Ä—ã -->
      <div id='tab-products' class='tab-content' style='<?=($_GET['tab']??'')==='products'?'':'display:none'?>'>
        <div class='card'>
          <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px'>
            <h3>üõçÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏</h3>
            <button class='btn-success' onclick='openProductModal()'>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
          </div>

          <div class='products-grid'>
            <?php foreach($products as $product): ?>
              <div class='product-card'>
                <?php if($product['featured']): ?>
                  <div class='badge badge-warning' style='position:absolute;top:8px;right:8px;z-index:10'>–•–ò–¢</div>
                <?php endif; ?>

                <div class='product-image'>
                  <?php if($product['image'] && file_exists($uploadsDir.'/'.$product['image'])): ?>
                    <img src='uploads/<?=esc($product['image'])?>' alt='<?=esc($product['name'])?>'>
                  <?php else: ?>
                    <div style='color:#666;font-size:32px'>üì¶</div>
                  <?php endif; ?>
                </div>

                <h4 style='margin:12px 0 8px'><?=esc($product['name'])?></h4>
                <p class='muted' style='font-size:12px;margin-bottom:8px'><?=esc($product['description'])?></p>

                <div style='display:flex;align-items:baseline;gap:8px;margin-bottom:8px'>
                  <strong style='font-size:16px'><?=number_format($product['price'])?> ‚ÇΩ</strong>
                  <?php if($product['old_price'] > 0): ?>
                    <s class='muted'><?=number_format($product['old_price'])?> ‚ÇΩ</s>
                  <?php endif; ?>
                </div>

                <div style='margin-bottom:12px'>
                  <span class='badge <?=$product['enabled'] ? 'badge-success' : 'badge-danger'?>'>
                    <?=$product['enabled'] ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–û—Ç–∫–ª—é—á–µ–Ω'?>
                  </span>
                  <span class='badge'>–°–∫–ª–∞–¥: <?=$product['stock']?></span>
                  <span class='badge'><?=ucfirst($product['category'])?></span>
                </div>

                <div style='display:flex;gap:6px'>
                  <button class='btn2' style='flex:1;padding:6px' onclick='editProduct(<?=json_encode($product, JSON_UNESCAPED_UNICODE)?>)'>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                  <form method='post' style='display:inline' onsubmit='return confirm("–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?")'>
                    <input type='hidden' name='delete_product' value='1'>
                    <input type='hidden' name='id' value='<?=$product['id']?>'>
                    <button class='btn-danger' style='padding:6px 8px'>üóëÔ∏è</button>
                  </form>
                </div>
              </div>
            <?php endforeach; ?>
          </div>

          <?php if(empty($products)): ?>
            <div style='text-align:center;padding:40px;color:var(--muted)'>
              <div style='font-size:48px;margin-bottom:16px'>üì¶</div>
              <h4>–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</h4>
              <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏</p>
            </div>
          <?php endif; ?>
        </div>
      </div>

      <!-- –†–ê–ó–î–ï–õ: –û—Ç–∑—ã–≤—ã -->
      <div id='tab-reviews' class='tab-content' style='<?=($_GET['tab']??'')==='reviews'?'':'display:none'?>'>
        <div class='card'>
          <h3>‚≠ê –ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤</h3>
          <div class='reviews-grid'>
            <?php if (empty($reviews)): ?>
              <div style='text-align:center;padding:40px;color:var(--muted);grid-column:1/-1'>
                <div style='font-size:48px;margin-bottom:16px'>‚≠ê</div>
                <h4>–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</h4>
                <p>–û—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å</p>
              </div>
            <?php else: ?>
              <?php foreach($reviews as $review): ?>
                <div class='review-card'>
                  <div class='review-rating'>
                    <?php for($i = 1; $i <= 5; $i++): ?>
                      <?= $i <= $review['rating'] ? '‚≠ê' : '‚òÜ' ?>
                    <?php endfor; ?>
                    (<?=$review['rating']?>/5)
                  </div>
                  <h4><?=esc($review['name'])?></h4>
                  <p><?=esc($review['text'])?></p>
                  <div class='muted mini'>
                    <?=esc(date('d.m.Y H:i', strtotime($review['created_at'])))?> ‚Ä¢ 
                    <span class='badge <?=$review['status']==='approved' ? 'badge-success' : ($review['status']==='rejected' ? 'badge-danger' : 'badge-warning')?>'>
                      <?=$review['status']==='approved' ? '–û–¥–æ–±—Ä–µ–Ω' : ($review['status']==='rejected' ? '–û—Ç–∫–ª–æ–Ω–µ–Ω' : '–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏')?>
                    </span>
                  </div>

                  <div class='review-actions'>
                    <?php if($review['status'] !== 'approved'): ?>
                      <form method='post' style='display:inline'>
                        <input type='hidden' name='review_action' value='approve'>
                        <input type='hidden' name='review_id' value='<?=$review['id']?>'>
                        <button class='btn-success' style='padding:6px 12px'>‚úì –û–¥–æ–±—Ä–∏—Ç—å</button>
                      </form>
                    <?php endif; ?>

                    <?php if($review['status'] !== 'rejected'): ?>
                      <form method='post' style='display:inline'>
                        <input type='hidden' name='review_action' value='reject'>
                        <input type='hidden' name='review_id' value='<?=$review['id']?>'>
                        <button class='btn-danger' style='padding:6px 12px'>‚úó –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                      </form>
                    <?php endif; ?>

                    <form method='post' style='display:inline' onsubmit='return confirm("–£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤?")'>
                      <input type='hidden' name='review_action' value='delete'>
                      <input type='hidden' name='review_id' value='<?=$review['id']?>'>
                      <button class='btn2' style='padding:6px 12px'>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                  </div>
                </div>
              <?php endforeach; ?>
            <?php endif; ?>
          </div>
        </div>
      </div>

      <!-- –†–ê–ó–î–ï–õ: –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
      <div id='tab-settings' class='tab-content' style='<?=($_GET['tab']??'')==='settings'?'':'display:none'?>'>
        <div class='card'>
          <h3>‚öôÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
          <form method='post'>
            <div class='form-row'>
              <div class='form-group'>
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞</label>
                <input name='brand' value='<?=esc($cfg['brand'])?>' placeholder='–§–æ—Ç–æ—Ü–µ–Ω—Ç—Ä –ü–†–ò–ù–¢–°–°'>
              </div>
              <div class='form-group'>
                <label>–°–ª–æ–≥–∞–Ω</label>
                <input name='slogan' value='<?=esc($cfg['slogan'])?>' placeholder='–ü–µ—á–∞—Ç—å –≤ –°–æ—Å–Ω–æ–≤–æ–º –ë–æ—Ä—É'>
              </div>
            </div>

            <div class='form-row'>
              <div class='form-group'>
                <label>–¢–µ–ª–µ—Ñ–æ–Ω (–æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π)</label>
                <input name='phone_display' value='<?=esc($cfg['phone_display'])?>' placeholder='+7 (952) 200-39-90'>
              </div>
              <div class='form-group'>
                <label>–¢–µ–ª–µ—Ñ–æ–Ω (–¥–ª—è —Å—Å—ã–ª–æ–∫)</label>
                <input name='phone_raw' value='<?=esc($cfg['phone_raw'])?>' placeholder='+79522003990'>
              </div>
            </div>

            <div class='form-group'>
              <label>Email –¥–ª—è –∑–∞–∫–∞–∑–æ–≤</label>
              <input name='email_to' value='<?=esc($cfg['email_to'])?>' placeholder='artcopy78@bk.ru'>
            </div>

            <div class='form-group'>
              <label>–ê–¥—Ä–µ—Å</label>
              <input name='address' value='<?=esc($cfg['address'])?>' placeholder='–≥. –ì–æ—Ä–æ–¥, —É–ª. –£–ª–∏—Ü–∞, 1'>
            </div>

            <div class='form-group'>
              <label>–†–∞–±–æ—á–∏–µ —á–∞—Å—ã (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)</label>
              <textarea name='workhours' rows='3'><?=esc(implode('\n', $cfg['workhours']))?></textarea>
            </div>

            <div class='form-group'>
              <label>–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
              <input type='password' name='admin_pass' placeholder='–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å'>
              <div class='muted mini'>–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å: <?=esc($cfg['admin_pass'])?></div>
            </div>

            <!-- –§—É–Ω–∫—Ü–∏–∏ —Å–∞–π—Ç–∞ -->
            <h4>üîß –§—É–Ω–∫—Ü–∏–∏ —Å–∞–π—Ç–∞</h4>
            <div class='form-row'>
              <div>
                <label class='toggle'>
                  <input type='checkbox' name='features_reviews_enabled' <?=!empty($cfg['features']['reviews_enabled']) ? 'checked' : ''?>>
                  <span class='slider'></span>
                </label>
                <span style='margin-left: 10px;'>–û—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</span>
              </div>

              <div>
                <label class='toggle'>
                  <input type='checkbox' name='features_callback_widget' <?=!empty($cfg['features']['callback_widget']) ? 'checked' : ''?>>
                  <span class='slider'></span>
                </label>
                <span style='margin-left: 10px;'>–í–∏–¥–∂–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞</span>
              </div>
            </div>

            <div style='margin-top: 20px;'>
              <button class='btn-success' name='admin_save' value='1'>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </div>
          </form>
        </div>

        <!-- SEO –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class='card'>
          <h3>üîç SEO –∏ –º–µ—Ç–∞-—Ç–µ–≥–∏</h3>
          <form method='post'>
            <div class='form-group'>
              <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (Title)</label>
              <input name='seo[title]' value='<?=esc($cfg['seo']['title'])?>' placeholder='–§–æ—Ç–æ—Ü–µ–Ω—Ç—Ä ‚Äî –±—ã—Å—Ç—Ä–∞—è –ø–µ—á–∞—Ç—å'>
            </div>

            <div class='form-group'>
              <label>–û–ø–∏—Å–∞–Ω–∏–µ (Description)</label>
              <textarea name='seo[description]' rows='3'><?=esc($cfg['seo']['description'])?></textarea>
            </div>

            <div class='form-group'>
              <label>–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (Keywords)</label>
              <input name='seo[keywords]' value='<?=esc($cfg['seo']['keywords'])?>' placeholder='–ø–µ—á–∞—Ç—å, —Ñ–æ—Ç–æ, –≤–∏–∑–∏—Ç–∫–∏'>
            </div>

            <div class='form-group'>
              <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π (OG Image)</label>
              <input name='seo[og_image]' value='<?=esc($cfg['seo']['og_image'])?>' placeholder='https://example.com/og-image.jpg'>
            </div>

            <div style='margin-bottom:16px'>
              <label class='toggle'>
                <input type='checkbox' name='seo[sitemap_enable]' <?=!empty($cfg['seo']['sitemap_enable']) ? 'checked' : ''?>>
                <span class='slider'></span>
              </label>
              <span style='margin-left: 10px;'>–í–∫–ª—é—á–∏—Ç—å –∫–∞—Ä—Ç—É —Å–∞–π—Ç–∞</span>
            </div>

            <button class='btn-success' name='admin_save' value='1'>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å SEO –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
          </form>
        </div>

        <!-- –†–µ–∫–≤–∏–∑–∏—Ç—ã -->
        <div class='card'>
          <h3>üìã –†–µ–∫–≤–∏–∑–∏—Ç—ã –∏ –ø—Ä–∞–≤–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
          <form method='post'>
            <div style='margin-bottom:16px'>
              <label class='toggle'>
                <input type='checkbox' name='business[show_requisites]' <?=!empty($cfg['business']['show_requisites']) ? 'checked' : ''?>>
                <span class='slider'></span>
              </label>
              <span style='margin-left: 10px;'>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –Ω–∞ —Å–∞–π—Ç–µ</span>
            </div>

            <div style='margin-bottom:16px'>
              <label class='toggle'>
                <input type='checkbox' name='business[show_payment_icons]' <?=!empty($cfg['business']['show_payment_icons']) ? 'checked' : ''?>>
                <span class='slider'></span>
              </label>
              <span style='margin-left: 10px;'>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–∫–æ–Ω–∫–∏ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã</span>
            </div>

            <div class='form-group'>
              <label>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</label>
              <input name='business[legal_name]' value='<?=esc($cfg['business']['legal_name'])?>' placeholder='–ò–ü –ò–≤–∞–Ω–æ–≤ –ò.–ò.'>
            </div>

            <div class='form-row'>
              <div class='form-group'>
                <label>–ò–ù–ù</label>
                <input name='business[inn]' value='<?=esc($cfg['business']['inn'])?>' placeholder='123456789012'>
              </div>
              <div class='form-group'>
                <label>–û–ì–†–ù–ò–ü</label>
                <input name='business[ogrn]' value='<?=esc($cfg['business']['ogrn'])?>' placeholder='123456789012345'>
              </div>
            </div>

            <div class='form-group'>
              <label>–ë–∞–Ω–∫</label>
              <input name='business[bank]' value='<?=esc($cfg['business']['bank'])?>' placeholder='–ü–ê–û –°–±–µ—Ä–±–∞–Ω–∫'>
            </div>

            <div class='form-row'>
              <div class='form-group'>
                <label>–ë–ò–ö</label>
                <input name='business[bik]' value='<?=esc($cfg['business']['bik'])?>' placeholder='044525225'>
              </div>
              <div class='form-group'>
                <label>–†–∞—Å—á–µ—Ç–Ω—ã–π —Å—á–µ—Ç</label>
                <input name='business[account]' value='<?=esc($cfg['business']['account'])?>' placeholder='40817810099910004312'>
              </div>
            </div>

            <button class='btn-success' name='admin_save' value='1'>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</button>
          </form>
        </div>
      </div>

      <!-- –†–ê–ó–î–ï–õ: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π) -->
      <div id='tab-integrations' class='tab-content' style='<?=($_GET['tab']??'')==='integrations'?'':'display:none'?>'>
        <!-- –Æ–ö–∞—Å—Å–∞ -->
        <div class='card'>
          <h3>üí≥ –Æ–ö–∞—Å—Å–∞ (–æ–Ω–ª–∞–π–Ω-–ø–ª–∞—Ç–µ–∂–∏)</h3>
          <form method='post'>
            <div style='margin-bottom:16px'>
              <label class='toggle'>
                <input type='checkbox' name='yukassa[enabled]' <?=!empty($cfg['yukassa']['enabled']) ? 'checked' : ''?>>
                <span class='slider'></span>
              </label>
              <span style='margin-left: 10px;'>–í–∫–ª—é—á–∏—Ç—å –æ–Ω–ª–∞–π–Ω-–ø–ª–∞—Ç–µ–∂–∏ –Æ–ö–∞—Å—Å–∞</span>
            </div>

            <div class='form-row'>
              <div class='form-group'>
                <label>Shop ID</label>
                <input name='yukassa[shop_id]' value='<?=esc($cfg['yukassa']['shop_id'])?>' placeholder='123456'>
              </div>
              <div class='form-group'>
                <label>Secret Key</label>
                <input type='password' name='yukassa[secret_key]' value='<?=!empty($cfg['yukassa']['secret_key']) ? '__KEEP__' : ''?>' placeholder='live_...'>
              </div>
            </div>

            <div class='form-group'>
              <label>URL –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã</label>
              <input name='yukassa[return_url]' value='<?=esc($cfg['yukassa']['return_url'])?>' placeholder='https://example.com/payment_result.php'>
            </div>

            <div style='margin-bottom:16px'>
              <label class='toggle'>
                <input type='checkbox' name='yukassa[test_mode]' <?=!empty($cfg['yukassa']['test_mode']) ? 'checked' : ''?>>
                <span class='slider'></span>
              </label>
              <span style='margin-left: 10px;'>–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º</span>
            </div>

            <h4>–ì–¥–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –æ–Ω–ª–∞–π–Ω-–ø–ª–∞—Ç–µ–∂–∏:</h4>
            <div style='margin-bottom:16px'>
              <label class='toggle'>
                <input type='checkbox' name='yukassa[services][products]' <?=!empty($cfg['yukassa']['services']['products']) ? 'checked' : ''?>>
                <span class='slider'></span>
              </label>
              <span style='margin-left: 10px;'>–¢–æ–≤–∞—Ä—ã (–º–∞–≥–∞–∑–∏–Ω)</span>
            </div>

            <div style='margin-bottom:16px'>
              <label class='toggle'>
                <input type='checkbox' name='yukassa[services][photo_constructor]' <?=!empty($cfg['yukassa']['services']['photo_constructor']) ? 'checked' : ''?>>
                <span class='slider'></span>
              </label>
              <span style='margin-left: 10px;'>–§–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</span>
            </div>

            <div style='margin-bottom:16px'>
              <label class='toggle'>
                <input type='checkbox' name='yukassa[services][regular_orders]' <?=!empty($cfg['yukassa']['services']['regular_orders']) ? 'checked' : ''?>>
                <span class='slider'></span>
              </label>
              <span style='margin-left: 10px;'>–û–±—ã—á–Ω—ã–µ –∑–∞—è–≤–∫–∏</span>
            </div>

            <button class='btn-success' name='admin_save' value='1'>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Æ–ö–∞—Å—Å–∞</button>
          </form>
        </div>

        <!-- Email (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞) -->
        <div class='card'>
          <h3>üìß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Email (100% –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ artcopy78@bk.ru)</h3>
          <form method='post'>
            <div class='alert alert-info'>
              ‚úÖ –í—Å–µ –∑–∞–∫–∞–∑—ã –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –Ω–∞ <strong>artcopy78@bk.ru</strong> —á–µ—Ä–µ–∑ –Ω–∞–¥–µ–∂–Ω—É—é SMTP —Å–∏—Å—Ç–µ–º—É
            </div>

            <div style='margin-bottom:16px'>
              <label class='toggle'>
                <input type='checkbox' name='smtp_enabled' <?=!empty($cfg['smtp']['enabled']) ? 'checked' : ''?>>
                <span class='slider'></span>
              </label>
              <span style='margin-left: 10px;'>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SMTP (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è 100% –¥–æ—Å—Ç–∞–≤–∫–∏)</span>
            </div>

            <div class='form-row'>
              <div class='form-group'>
                <label>SMTP —Å–µ—Ä–≤–µ—Ä</label>
                <input name='smtp_host' value='<?=esc($cfg['smtp']['host'])?>' placeholder='smtp.mail.ru'>
              </div>
              <div class='form-group'>
                <label>–ü–æ—Ä—Ç</label>
                <input type='number' name='smtp_port' value='<?=esc($cfg['smtp']['port'])?>' placeholder='465'>
              </div>
            </div>

            <div class='form-row'>
              <div class='form-group'>
                <label>–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ</label>
                <select name='smtp_secure'>
                  <option value='ssl' <?=$cfg['smtp']['secure']==='ssl'?'selected':''?>>SSL</option>
                  <option value='tls' <?=$cfg['smtp']['secure']==='tls'?'selected':''?>>TLS</option>
                  <option value='none' <?=$cfg['smtp']['secure']==='none'?'selected':''?>>–ë–µ–∑ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è</option>
                </select>
              </div>
              <div class='form-group'>
                <label>–õ–æ–≥–∏–Ω</label>
                <input name='smtp_user' value='<?=esc($cfg['smtp']['user'])?>' placeholder='artcopy78@bk.ru'>
              </div>
            </div>

            <div class='form-group'>
              <label>–ü–∞—Ä–æ–ª—å SMTP</label>
              <input type='password' name='smtp_pass' value='<?=!empty($cfg['smtp']['pass']) ? '__KEEP__' : ''?>' placeholder='–ü–∞—Ä–æ–ª—å –¥–ª—è SMTP'>
              <div class='muted mini'>–ü–æ–ª—É—á–∏—Ç–µ –ø–∞—Ä–æ–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø–æ—á—Ç—ã Mail.ru</div>
            </div>

            <div style='margin-top:16px;display:flex;gap:8px;align-items:center'>
              <button class='btn-success' name='admin_save' value='1'>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å Email</button>
              <button class='btn2' name='admin_test_email' value='1'>üìß –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ artcopy78@bk.ru</button>

              <?php if(isset($_GET['test_email'])): ?>
                <div class='integration-status <?=($_GET['test_email']==='ok' ? 'integration-ok' : 'integration-fail')?>'>
                  <?=($_GET['test_email']==='ok' ? '‚úÖ Email —Ä–∞–±–æ—Ç–∞–µ—Ç!' : '‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏')?>
                  <?php if(isset($_GET['test_errors'])): ?>
                    <br><small><?=esc($_GET['test_errors'])?></small>
                  <?php endif; ?>
                </div>
              <?php endif; ?>
            </div>
          </form>
        </div>

        <!-- Telegram -->
        <div class='card'>
          <h3>ü§ñ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
          <form method='post'>
            <div style='margin-bottom:16px'>
              <label class='toggle'>
                <input type='checkbox' name='tg_enabled' <?=!empty($cfg['telegram']['enabled']) ? 'checked' : ''?>>
                <span class='slider'></span>
              </label>
              <span style='margin-left: 10px;'>–í–∫–ª—é—á–∏—Ç—å Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
            </div>

            <div class='form-group'>
              <label>Token –±–æ—Ç–∞</label>
              <input name='tg_token' value='<?=esc($cfg['telegram']['token'])?>' placeholder='123456789:ABC-DEF1234ghIkl-zyx57W2v1u123ew11'>
              <div class='muted mini'>–ü–æ–ª—É—á–∏—Ç–µ —É @BotFather</div>
            </div>

            <div class='form-group'>
              <label>Chat ID</label>
              <input name='tg_chat' value='<?=esc($cfg['telegram']['chat'])?>' placeholder='-100123456789'>
              <div class='muted mini'>ID —á–∞—Ç–∞ –∏–ª–∏ –≥—Ä—É–ø–ø—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
            </div>

            <div style='display:flex;gap:8px;flex-wrap:wrap;margin-top:16px'>
              <button class='btn-success' name='admin_save' value='1'>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å Telegram</button>
              <button class='btn2' name='admin_test_tg' value='1'>ü§ñ –¢–µ—Å—Ç Telegram</button>
              <button class='btn2' name='tg_delete_webhook' value='1'>üîÑ –£–¥–∞–ª–∏—Ç—å Webhook</button>
              <button class='btn2' name='tg_get_updates' value='1'>üì® –ü–æ–ª—É—á–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</button>
            </div>

            <div style='margin-top:8px;display:flex;gap:8px;align-items:center'>
              <?php if(isset($_GET['test_tg'])): ?>
                <div class='integration-status <?=($_GET['test_tg']==='ok' ? 'integration-ok' : 'integration-fail')?>'>
                  <?=($_GET['test_tg']==='ok' ? '‚úÖ Telegram —Ä–∞–±–æ—Ç–∞–µ—Ç!' : '‚ùå –û—à–∏–±–∫–∞ Telegram')?>
                  <?php if(isset($_GET['tg_error'])): ?>
                    <br><small><?=esc($_GET['tg_error'])?></small>
                  <?php endif; ?>
                </div>
              <?php endif; ?>

              <?php if(isset($_GET['tg_webhook'])): ?>
                <div class='integration-status <?=($_GET['tg_webhook']==='deleted' ? 'integration-ok' : 'integration-fail')?>'>
                  <?=($_GET['tg_webhook']==='deleted' ? 'üîÑ Webhook —É–¥–∞–ª–µ–Ω' : '‚ùå –û—à–∏–±–∫–∞ webhook')?>
                </div>
              <?php endif; ?>

              <?php if(isset($_GET['tg_updates'])): ?>
                <div class='integration-status <?=($_GET['tg_updates']==='ok' ? 'integration-ok' : 'integration-fail')?>'>
                  <?=($_GET['tg_updates']==='ok' ? 'üì® –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω—ã' : '‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π')?>
                </div>
              <?php endif; ?>
            </div>

            <?php if(isset($_SESSION['tg_updates']) && is_array($_SESSION['tg_updates'])): ?>
              <div style='margin-top:16px;padding:12px;background:#1a1f28;border-radius:8px'>
                <div class='muted mini' style='margin-bottom:8px'>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –±–æ—Ç–µ:</div>
                <?php foreach(array_slice($_SESSION['tg_updates'], -5) as $u): ?>
                  <?php if(isset($u['message'])): $msg=$u['message']; ?>
                    <div style='background:#252b3a;padding:8px;margin:6px 0;border-radius:6px;font-size:12px'>
                      <strong>Chat: <?=esc($msg['chat']['id'])?></strong> |
                      <?=esc($msg['from']['first_name']??'')?> <?=esc($msg['from']['last_name']??'')?>
                      <br><?=esc(mb_substr($msg['text']??'',0,100))?>
                      <form method='post' style='display:inline;margin-left:8px'>
                        <input type='hidden' name='chat' value='<?=esc($msg['chat']['id'])?>'>
                        <button class='btn2' name='tg_use_chat' value='1' style='padding:2px 6px;font-size:10px'>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —á–∞—Ç</button>
                      </form>
                    </div>
                  <?php endif; ?>
                <?php endforeach; ?>
              </div>
            <?php endif; ?>
          </form>
        </div>
      </div>

      <!-- –†–ê–ó–î–ï–õ: –î–∏–∑–∞–π–Ω -->
      <div id='tab-design' class='tab-content' style='<?=($_GET['tab']??'')==='design'?'':'display:none'?>'>
        <div class='row'>
          <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
          <div class='card'>
            <h3>üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∞–π—Ç–∞</h3>

            <h4>–õ–æ–≥–æ—Ç–∏–ø</h4>
            <form method='post' enctype='multipart/form-data' id='logoForm'>
              <input type='hidden' name='admin_upload' value='1'>
              <input type='hidden' name='what' value='logo'>
              <div class='drop <?=!empty($cfg['logo']) ? 'has-image' : ''?>' id='logoDrop'>
                <input type='file' name='file' accept='image/*' onchange='handleFileUpload(this, "logoDrop", "logoForm")'>
                <button type='button' class='drop-remove' onclick='removeImage("logoDrop", "logo")'>‚úï</button>
                <div class='drop-content'>
                  <?php if(!empty($cfg['logo'])): ?>
                    <img src='<?=esc($cfg['logo'])?>' class='drop-preview' alt='–õ–æ–≥–æ—Ç–∏–ø'>
                    <div class='drop-text'>–õ–æ–≥–æ—Ç–∏–ø –∑–∞–≥—Ä—É–∂–µ–Ω</div>
                    <div class='drop-hint'>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–º–µ–Ω—ã</div>
                  <?php else: ?>
                    <div class='drop-icon'>üñºÔ∏è</div>
                    <div class='drop-text'>–ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø</div>
                    <div class='drop-hint'>PNG, JPG, SVG –¥–æ 10 –ú–ë</div>
                  <?php endif; ?>
                </div>
              </div>
            </form>

            <h4 style='margin-top:20px'>Hero –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h4>
            <form method='post' enctype='multipart/form-data' id='heroForm'>
              <input type='hidden' name='admin_upload' value='1'>
              <input type='hidden' name='what' value='hero'>
              <div class='drop <?=($cfg['hero_mode']==='image'&&!empty($cfg['hero_image'])) ? 'has-image' : ''?>' id='heroDrop'>
                <input type='file' name='file' accept='image/*' onchange='handleFileUpload(this, "heroDrop", "heroForm")'>
                <button type='button' class='drop-remove' onclick='removeImage("heroDrop", "hero")'>‚úï</button>
                <div class='drop-content'>
                  <?php if($cfg['hero_mode']==='image'&&!empty($cfg['hero_image'])): ?>
                    <img src='<?=esc($cfg['hero_image'])?>' class='drop-preview' alt='Hero –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'>
                    <div class='drop-text'>Hero –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</div>
                    <div class='drop-hint'>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–º–µ–Ω—ã</div>
                  <?php else: ?>
                    <div class='drop-icon'>üé®</div>
                    <div class='drop-text'>–ó–∞–≥—Ä—É–∑–∏—Ç—å hero –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
                    <div class='drop-hint'>PNG, JPG –¥–æ 10 –ú–ë</div>
                  <?php endif; ?>
                </div>
              </div>
            </form>
          </div>

          <!-- –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ -->
          <div class='card'>
            <h3>üé® –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ –∏ —Å—Ç–∏–ª–∏</h3>
            <form method='post'>
              <div class='form-row'>
                <div class='form-group'>
                  <label>–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç –±—Ä–µ–Ω–¥–∞</label>
                  <input type='color' name='theme[brand]' value='<?=esc($cfg['theme']['brand'])?>'>
                </div>
                <div class='form-group'>
                  <label>–ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç</label>
                  <input type='color' name='theme[accent]' value='<?=esc($cfg['theme']['accent'])?>'>
                </div>
              </div>

              <div class='form-row'>
                <div class='form-group'>
                  <label>–¶–≤–µ—Ç —Ñ–æ–Ω–∞</label>
                  <input type='color' name='theme[bg]' value='<?=esc($cfg['theme']['bg'])?>'>
                </div>
                <div class='form-group'>
                  <label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label>
                  <input type='color' name='theme[text]' value='<?=esc($cfg['theme']['text'])?>'>
                </div>
              </div>

              <div class='form-group'>
                <label>–¶–≤–µ—Ç –ø—Ä–∏–≥–ª—É—à–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞</label>
                <input type='color' name='theme[muted]' value='<?=esc($cfg['theme']['muted'])?>'>
              </div>

              <h4>–≠—Ñ—Ñ–µ–∫—Ç—ã –∏ —Ä–∞–∑–º–µ—Ä—ã</h4>
              <div class='form-row'>
                <div class='form-group'>
                  <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∫–∞—Ä—Ç–æ—á–µ–∫ (<?=esc($cfg['theme']['card_opacity'])?>)</label>
                  <input type='range' name='theme[card_opacity]' min='0.3' max='1' step='0.05' value='<?=esc($cfg['theme']['card_opacity'])?>'>
                </div>
                <div class='form-group'>
                  <label>–†–∞–∑–º—ã—Ç–∏–µ —Å—Ç–µ–∫–ª–∞ (<?=esc($cfg['theme']['blur'])?>px)</label>
                  <input type='range' name='theme[blur]' min='0' max='30' value='<?=esc($cfg['theme']['blur'])?>'>
                </div>
              </div>

              <div class='form-row'>
                <div class='form-group'>
                  <label>–†–∞–¥–∏—É—Å —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è (<?=esc($cfg['theme']['radius'])?>px)</label>
                  <input type='range' name='theme[radius]' min='0' max='28' value='<?=esc($cfg['theme']['radius'])?>'>
                </div>
                <div class='form-group'>
                  <label>–°–∏–ª–∞ —Ç–µ–Ω–µ–π (<?=esc($cfg['theme']['shadow'])?>)</label>
                  <input type='range' name='theme[shadow]' min='0' max='0.5' step='0.01' value='<?=esc($cfg['theme']['shadow'])?>'>
                </div>
              </div>

              <div class='form-group'>
                <label>–®–∏—Ä–∏–Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (<?=esc($cfg['theme']['container'])?>px)</label>
                <input type='range' name='theme[container]' min='900' max='1400' step='50' value='<?=esc($cfg['theme']['container'])?>'>
              </div>

              <button class='btn-success' name='admin_save' value='1'>üé® –ü—Ä–∏–º–µ–Ω–∏—Ç—å –¥–∏–∑–∞–π–Ω</button>
            </form>
          </div>
        </div>
      </div>

    <?php endif; ?>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
  <div id='productModal' class='modal'>
    <div class='modal-content'>
      <div class='modal-header'>
        <h3 id='productModalTitle'>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h3>
        <button class='close-modal' onclick='closeProductModal()'>&times;</button>
      </div>
      <div class='modal-body'>
        <form id='productForm' method='post' enctype='multipart/form-data'>
          <input type='hidden' name='save_product' value='1'>
          <input type='hidden' name='id' id='productId'>

          <div class='form-row'>
            <div class='form-group'>
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
              <input name='name' id='productName' required placeholder='–§–æ—Ç–æ—Ä–∞–º–∫–∞ 10√ó15'>
            </div>
            <div class='form-group'>
              <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
              <select name='category' id='productCategory'>
                <option value='frames'>üñºÔ∏è –§–æ—Ç–æ—Ä–∞–º–∫–∏</option>
                <option value='albums'>üìö –§–æ—Ç–æ–∞–ª—å–±–æ–º—ã</option>
                <option value='souvenirs'>üéÅ –°—É–≤–µ–Ω–∏—Ä—ã</option>
              </select>
            </div>
          </div>

          <div class='form-row'>
            <div class='form-group'>
              <label>–¶–µ–Ω–∞ (‚ÇΩ)</label>
              <input type='number' name='price' id='productPrice' required placeholder='500'>
            </div>
            <div class='form-group'>
              <label>–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ (‚ÇΩ)</label>
              <input type='number' name='old_price' id='productOldPrice' placeholder='700'>
            </div>
          </div>

          <div class='form-group'>
            <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea name='description' id='productDescription' rows='3' placeholder='–ö—Ä–∞—Å–∏–≤–∞—è –¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è —Ä–∞–º–∫–∞ –¥–ª—è —Ñ–æ—Ç–æ'></textarea>
          </div>

          <div class='form-row'>
            <div class='form-group'>
              <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ</label>
              <input type='number' name='stock' id='productStock' min='0' value='0' placeholder='10'>
            </div>
            <div class='form-group' style='display:flex;gap:16px;align-items:end;padding-top:20px'>
              <label class='toggle'>
                <input type='checkbox' name='enabled' id='productEnabled'>
                <span class='slider'></span>
              </label>
              <span>–ê–∫—Ç–∏–≤–µ–Ω</span>

              <label class='toggle' style='margin-left:12px'>
                <input type='checkbox' name='featured' id='productFeatured'>
                <span class='slider'></span>
              </label>
              <span>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π</span>
            </div>
          </div>

          <div class='form-group'>
            <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
            <input type='file' name='image' accept='image/*'>
            <div id='currentImage' style='margin-top:8px'></div>
          </div>

          <div style='text-align:center;margin-top:20px'>
            <button class='btn-success' type='submit'>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
            <button class='btn2' type='button' onclick='closeProductModal()'>–û—Ç–º–µ–Ω–∞</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏
    let sizeIndex = <?=count($photoConfig['sizes']??[])?>;
    let paperIndex = <?=count($photoConfig['papers']??[])?>;
    let correctionIndex = <?=count($photoConfig['corrections']??[])?>;
    let processingIndex = <?=count($photoConfig['processing_options']??[])?>;
    let deliveryIndex = <?=count($photoConfig['delivery_options']??[])?>;
    let discountIndex = <?=count($photoConfig['discounts']??[])?>;
    let serviceIndex = <?=count($services??[])?>;

    function showTab(tabName, element) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
      });
      document.querySelectorAll('.tab').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById('tab-' + tabName).style.display = 'block';
      element.classList.add('active');
      history.replaceState(null, null, '?tab=' + tabName);
    }

    function viewCustomer(customerId) {
      alert('–ü—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞: ' + customerId);
    }

    function filterOrders(type) {
      const rows = document.querySelectorAll('#ordersTable tbody tr');
      const buttons = document.querySelectorAll('.orders-filter .filter-btn');

      buttons.forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      rows.forEach(row => {
        const rowType = row.dataset.type;
        const rowStatus = row.dataset.status;
        let show = false;

        if (type === 'all') show = true;
        else if (type === 'new' && (rowStatus === 'new' || rowStatus === 'pending_payment')) show = true;
        else if (type === 'in_progress' && rowStatus === 'in_progress') show = true;
        else if (type === 'completed' && (rowStatus === 'completed' || rowStatus === 'paid')) show = true;
        else if (rowType === type) show = true;

        row.style.display = show ? '' : 'none';
      });
    }

    function viewOrderDetails(orderId) {
      alert('–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞: ' + orderId);
    }

    function editOrderStatus(orderId, currentStatus) {
      const newStatus = prompt('–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –¥–ª—è –∑–∞–∫–∞–∑–∞ ' + orderId + ':\n\nnew - –ù–æ–≤—ã–π\nin_progress - –í —Ä–∞–±–æ—Ç–µ\ncompleted - –ì–æ—Ç–æ–≤–æ\ncancelled - –û—Ç–º–µ–Ω–µ–Ω', currentStatus);
      if (newStatus && newStatus !== currentStatus) {
        alert('–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ' + newStatus);
      }
    }

    function downloadConstructorPhotos(orderId) {
      const formData = new FormData();
      formData.append('download_constructor_photos', '1');
      formData.append('order_id', orderId);

      fetch('admin.php', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('–§–æ—Ç–æ —Å–∫–∞—á–∞–Ω—ã: ' + data.files.length + ' —Ñ–∞–π–ª–æ–≤');
        } else {
          alert('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ');
        }
      })
      .catch(error => {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
      });
    }

    function exportOrders() {
      alert('–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–∫–∞–∑–æ–≤ –≤ CSV');
    }

    function removeConfigItem(button) {
      if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç?')) {
        button.closest('.config-item').remove();
      }
    }

    function addService() {
      const servicesList = document.getElementById('servicesList');
      const serviceItem = document.createElement('div');
      serviceItem.className = 'service-item';
      serviceItem.innerHTML = `
        <div class='form-row'>
          <div class='form-group'>
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏</label>
            <input name='services[${serviceIndex}][name]' placeholder='–ù–æ–≤–∞—è —É—Å–ª—É–≥–∞'>
          </div>
          <div class='form-group'>
            <label>–¶–µ–Ω–∞</label>
            <input name='services[${serviceIndex}][price]' placeholder='–æ—Ç 500 ‚ÇΩ'>
          </div>
        </div>

        <div class='form-group'>
          <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea name='services[${serviceIndex}][description]' rows='2'></textarea>
        </div>

        <div class='service-controls'>
          <label class='toggle'>
            <input type='checkbox' name='services[${serviceIndex}][enabled]' checked>
            <span class='slider'></span>
          </label>
          <span>–£—Å–ª—É–≥–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>

          <label class='toggle' style='margin-left: 20px;'>
            <input type='checkbox' name='services[${serviceIndex}][yukassa_enabled]'>
            <span class='slider'></span>
          </label>
          <span>–Æ–ö–∞—Å—Å–∞ –≤–∫–ª—é—á–µ–Ω–∞</span>

          <button type='button' class='btn-danger' onclick='removeService(this)' style='margin-left: auto;'>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `;
      servicesList.appendChild(serviceItem);
      serviceIndex++;
    }

    function removeService(button) {
      if (confirm('–£–¥–∞–ª–∏—Ç—å —É—Å–ª—É–≥—É?')) {
        button.closest('.service-item').remove();
      }
    }

    function openProductModal() {
      document.getElementById('productModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
      document.getElementById('productForm').reset();
      document.getElementById('productId').value = '';
      document.getElementById('currentImage').innerHTML = '';
      document.getElementById('productModal').classList.add('show');
    }

    function editProduct(product) {
      document.getElementById('productModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä';
      document.getElementById('productId').value = product.id;
      document.getElementById('productName').value = product.name;
      document.getElementById('productCategory').value = product.category;
      document.getElementById('productPrice').value = product.price;
      document.getElementById('productOldPrice').value = product.old_price || '';
      document.getElementById('productDescription').value = product.description;
      document.getElementById('productStock').value = product.stock;
      document.getElementById('productEnabled').checked = product.enabled;
      document.getElementById('productFeatured').checked = product.featured;

      if (product.image) {
        document.getElementById('currentImage').innerHTML =
          '<div style="margin-top:8px"><img src="uploads/' + product.image + '" style="max-width:100px;border-radius:4px"><br><small>–¢–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</small></div>';
      }

      document.getElementById('productModal').classList.add('show');
    }

    function closeProductModal() {
      document.getElementById('productModal').classList.remove('show');
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ñ–æ—Ç–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
    function addSize() {
      const container = document.getElementById('sizesList');
      const item = document.createElement('div');
      item.className = 'config-item';
      item.innerHTML = `
        <button type='button' class='remove-config-item' onclick='removeConfigItem(this)'>√ó</button>
        <div class='form-row'>
          <div class='form-group'>
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input name='sizes[${sizeIndex}][name]' placeholder='13√ó18'>
          </div>
          <div class='form-group'>
            <label>–®–∏—Ä–∏–Ω–∞ (—Å–º)</label>
            <input type='number' step='0.1' name='sizes[${sizeIndex}][w]' placeholder='13'>
          </div>
          <div class='form-group'>
            <label>–í—ã—Å–æ—Ç–∞ (—Å–º)</label>
            <input type='number' step='0.1' name='sizes[${sizeIndex}][h]' placeholder='18'>
          </div>
          <div class='form-group'>
            <label>–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ (‚ÇΩ)</label>
            <input type='number' name='sizes[${sizeIndex}][base]' placeholder='40'>
          </div>
        </div>
        <div class='service-controls'>
          <label class='toggle'>
            <input type='checkbox' name='sizes[${sizeIndex}][enabled]' checked>
            <span class='slider'></span>
          </label>
          <span>–î–æ—Å—Ç—É–ø–µ–Ω</span>
          <label class='toggle' style='margin-left: 20px;'>
            <input type='checkbox' name='sizes[${sizeIndex}][popular]'>
            <span class='slider'></span>
          </label>
          <span>–ü–æ–ø—É–ª—è—Ä–Ω—ã–π</span>
        </div>
      `;
      container.appendChild(item);
      sizeIndex++;
    }

    function addPaper() {
      const container = document.getElementById('papersList');
      const item = document.createElement('div');
      item.className = 'config-item';
      item.innerHTML = `
        <button type='button' class='remove-config-item' onclick='removeConfigItem(this)'>√ó</button>
        <div class='form-row'>
          <div class='form-group'>
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input name='papers[${paperIndex}][name]' placeholder='–ü—Ä–µ–º–∏—É–º'>
          </div>
          <div class='form-group'>
            <label>–î–æ–ø–ª–∞—Ç–∞ (‚ÇΩ)</label>
            <input type='number' name='papers[${paperIndex}][delta]' placeholder='20'>
          </div>
        </div>
        <div class='form-group'>
          <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <input name='papers[${paperIndex}][description]' placeholder='–ü—Ä–µ–º–∏—É–º –±—É–º–∞–≥–∞ –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏'>
        </div>
        <div class='service-controls'>
          <label class='toggle'>
            <input type='checkbox' name='papers[${paperIndex}][enabled]' checked>
            <span class='slider'></span>
          </label>
          <span>–î–æ—Å—Ç—É–ø–µ–Ω</span>
        </div>
      `;
      container.appendChild(item);
      paperIndex++;
    }

    function addCorrection() {
      const container = document.getElementById('correctionsList');
      const item = document.createElement('div');
      item.className = 'config-item';
      item.innerHTML = `
        <button type='button' class='remove-config-item' onclick='removeConfigItem(this)'>√ó</button>
        <div class='form-row'>
          <div class='form-group'>
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input name='corrections[${correctionIndex}][name]' placeholder='–ü—Ä–µ–º–∏—É–º –∫–æ—Ä—Ä–µ–∫—Ü–∏—è'>
          </div>
          <div class='form-group'>
            <label>–î–æ–ø–ª–∞—Ç–∞ (‚ÇΩ)</label>
            <input type='number' name='corrections[${correctionIndex}][delta]' placeholder='100'>
          </div>
        </div>
        <div class='form-group'>
          <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <input name='corrections[${correctionIndex}][description]' placeholder='–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∏–∑–∞–π–Ω–µ—Ä–æ–º'>
        </div>
        <div class='service-controls'>
          <label class='toggle'>
            <input type='checkbox' name='corrections[${correctionIndex}][enabled]' checked>
            <span class='slider'></span>
          </label>
          <span>–î–æ—Å—Ç—É–ø–µ–Ω</span>
        </div>
      `;
      container.appendChild(item);
      correctionIndex++;
    }

    function addProcessingOption() {
      const container = document.getElementById('processingList');
      const item = document.createElement('div');
      item.className = 'config-item';
      item.innerHTML = `
        <button type='button' class='remove-config-item' onclick='removeConfigItem(this)'>√ó</button>
        <div class='form-row'>
          <div class='form-group'>
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input name='processing_options[${processingIndex}][name]' placeholder='–ù–æ–≤–∞—è —É—Å–ª—É–≥–∞'>
          </div>
          <div class='form-group'>
            <label>–¶–µ–Ω–∞ (‚ÇΩ)</label>
            <input type='number' name='processing_options[${processingIndex}][price]' placeholder='100'>
          </div>
        </div>
        <div class='form-group'>
          <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <input name='processing_options[${processingIndex}][description]' placeholder='–û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏'>
        </div>
        <div class='service-controls'>
          <label class='toggle'>
            <input type='checkbox' name='processing_options[${processingIndex}][enabled]' checked>
            <span class='slider'></span>
          </label>
          <span>–î–æ—Å—Ç—É–ø–µ–Ω</span>
        </div>
      `;
      container.appendChild(item);
      processingIndex++;
    }

    function addDeliveryOption() {
      const container = document.getElementById('deliveryList');
      const item = document.createElement('div');
      item.className = 'config-item';
      item.innerHTML = `
        <button type='button' class='remove-config-item' onclick='removeConfigItem(this)'>√ó</button>
        <div class='form-row'>
          <div class='form-group'>
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input name='delivery_options[${deliveryIndex}][name]' placeholder='–≠–∫—Å–ø—Ä–µ—Å—Å –¥–æ—Å—Ç–∞–≤–∫–∞'>
          </div>
          <div class='form-group'>
            <label>–¶–µ–Ω–∞ (‚ÇΩ)</label>
            <input type='number' name='delivery_options[${deliveryIndex}][price]' placeholder='500'>
          </div>
        </div>
        <div class='form-group'>
          <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <input name='delivery_options[${deliveryIndex}][description]' placeholder='–î–æ—Å—Ç–∞–≤–∫–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤'>
        </div>
        <div class='service-controls'>
          <label class='toggle'>
            <input type='checkbox' name='delivery_options[${deliveryIndex}][enabled]' checked>
            <span class='slider'></span>
          </label>
          <span>–î–æ—Å—Ç—É–ø–µ–Ω</span>
        </div>
      `;
      container.appendChild(item);
      deliveryIndex++;
    }

    function addDiscount() {
      const container = document.getElementById('discountsList');
      const item = document.createElement('div');
      item.className = 'config-item';
      item.innerHTML = `
        <button type='button' class='remove-config-item' onclick='removeConfigItem(this)'>√ó</button>
        <div class='form-row-3'>
          <div class='form-group'>
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input name='discounts[${discountIndex}][name]' placeholder='–û—Ç 300 —Ñ–æ—Ç–æ'>
          </div>
          <div class='form-group'>
            <label>–û—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–æ—Ç–æ</label>
            <input type='number' name='discounts[${discountIndex}][threshold]' placeholder='300'>
          </div>
          <div class='form-group'>
            <label>–°–∫–∏–¥–∫–∞ (%)</label>
            <input type='number' name='discounts[${discountIndex}][discount_percent]' min='0' max='99' placeholder='25'>
          </div>
        </div>
        <div class='service-controls'>
          <label class='toggle'>
            <input type='checkbox' name='discounts[${discountIndex}][enabled]' checked>
            <span class='slider'></span>
          </label>
          <span>–ê–∫—Ç–∏–≤–Ω–∞</span>
        </div>
      `;
      container.appendChild(item);
      discountIndex++;
    }

    function handleFileUpload(input, dropId, formId) {
      if (input.files && input.files[0]) {
        const file = input.files[0];
        const drop = document.getElementById(dropId);
        const form = document.getElementById(formId);

        if (file.size > 10 * 1024 * 1024) {
          alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 10 –ú–ë.');
          input.value = '';
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          const content = drop.querySelector('.drop-content');
          content.innerHTML = `
            <img src='${e.target.result}' class='drop-preview' alt='–ü—Ä–µ–≤—å—é'>
            <div class='drop-text'>–§–∞–π–ª –≥–æ—Ç–æ–≤ –∫ –∑–∞–≥—Ä—É–∑–∫–µ</div>
            <div class='drop-hint'>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–º–µ–Ω—ã</div>
          `;
          drop.classList.add('has-image');
        };
        reader.readAsDataURL(file);

        setTimeout(() => {
          form.submit();
        }, 500);
      }
    }

    function removeImage(dropId, type) {
      if (confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ?')) {
        const drop = document.getElementById(dropId);

        if (type === 'logo') {
          drop.querySelector('.drop-content').innerHTML = `
            <div class='drop-icon'>üñºÔ∏è</div>
            <div class='drop-text'>–ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø</div>
            <div class='drop-hint'>PNG, JPG, SVG –¥–æ 10 –ú–ë</div>
          `;
        } else {
          drop.querySelector('.drop-content').innerHTML = `
            <div class='drop-icon'>üé®</div>
            <div class='drop-text'>–ó–∞–≥—Ä—É–∑–∏—Ç—å hero –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
            <div class='drop-hint'>PNG, JPG –¥–æ 10 –ú–ë</div>
          `;
        }

        drop.classList.remove('has-image');

        const form = new FormData();
        form.append('admin_save', '1');
        form.append(type === 'logo' ? 'logo' : 'hero_image', '');
        form.append(type === 'logo' ? 'logo' : 'hero_mode', type === 'logo' ? '' : 'svg');

        fetch(location.href, {
          method: 'POST',
          body: form
        }).then(() => {
          location.reload();
        });
      }
    }

    document.querySelectorAll('.drop').forEach(drop => {
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        drop.addEventListener(eventName, preventDefaults, false);
      });

      ['dragenter', 'dragover'].forEach(eventName => {
        drop.addEventListener(eventName, () => drop.classList.add('hover'), false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        drop.addEventListener(eventName, () => drop.classList.remove('hover'), false);
      });

      drop.addEventListener('drop', handleDrop, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      const input = e.target.querySelector('input[type="file"]');

      if (files.length > 0) {
        input.files = files;
        const changeEvent = new Event('change', { bubbles: true });
        input.dispatchEvent(changeEvent);
      }
    }

    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal.show').forEach(modal => {
          modal.classList.remove('show');
        });
      }
    });

    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const tab = urlParams.get('tab') || 'orders';
      const tabElement = document.querySelector(`[onclick*='${tab}']`);
      if (tabElement) {
        showTab(tab, tabElement);
      }
      console.log('–ü–û–õ–ù–ê–Ø –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å–æ –≤—Å–µ–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏');
    });
  </script>
</body>
</html>
