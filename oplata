<?php
mb_internal_encoding('UTF-8');
date_default_timezone_set('Europe/Moscow');
session_start();

$BASE = __DIR__;
$configFile = $BASE.'/config.json';
$ordersLog = $BASE.'/orders.txt';

// –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥
$cfg = json_decode(@file_get_contents($configFile), true) ?? [];

// Helpers
function esc($s){ return htmlspecialchars((string)$s, ENT_QUOTES|ENT_SUBSTITUTE, 'UTF-8'); }

function yukassa_check_payment($cfg, $payment_id){
  if(empty($cfg['yukassa']['enabled'])) return [false, 'Payments disabled'];

  $shop_id = $cfg['yukassa']['shop_id'];
  $secret_key = $cfg['yukassa']['secret_key'];

  if(!$shop_id || !$secret_key) return [false, 'Missing credentials'];

  $url = "https://api.yookassa.ru/v3/payments/$payment_id";

  $ch = curl_init($url);
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
  curl_setopt($ch, CURLOPT_HTTPHEADER, [
    'Authorization: Basic ' . base64_encode($shop_id . ':' . $secret_key)
  ]);

  $result = curl_exec($ch);
  $error = curl_error($ch);
  curl_close($ch);

  if($error) return [false, 'CURL error: ' . $error];

  $response = json_decode($result, true);
  if(!$response) return [false, 'Invalid response: ' . $result];

  return [true, $response];
}

function log_payment_status($path, $data){
  @file_put_contents($path, '['.date('Y-m-d H:i:s').'] PAYMENT_STATUS: '.json_encode($data, JSON_UNESCAPED_UNICODE).PHP_EOL, FILE_APPEND);
}

function tg_send_message_cfg($cfg, $text){
  if(empty($cfg['telegram']['enabled'])) return [false,'disabled'];
  $token=$cfg['telegram']['token']??''; $chat=$cfg['telegram']['chat']??'';
  if(!$token || !$chat) return [false,'no token/chat'];

  $url='https://api.telegram.org/bot$token/sendMessage';
  $ch=curl_init($url);
  curl_setopt($ch,CURLOPT_RETURNTRANSFER,true);
  curl_setopt($ch,CURLOPT_CONNECTTIMEOUT,10);
  curl_setopt($ch,CURLOPT_TIMEOUT,20);
  curl_setopt($ch,CURLOPT_POSTFIELDS,http_build_query([
    'chat_id'=>$chat,
    'text'=>$text,
    'parse_mode'=>'HTML',
    'disable_web_page_preview'=>true
  ]));
  $resp=curl_exec($ch); curl_close($ch);
  return [true, null];
}

// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–ª–∞—Ç–µ–∂–µ
$order_id = $_GET['order_id'] ?? '';
$payment_id = $_GET['payment_id'] ?? '';
$status = 'unknown';
$amount = 0;
$payment_info = null;

if ($payment_id) {
  list($payOk, $payResult) = yukassa_check_payment($cfg, $payment_id);
  if ($payOk) {
    $payment_info = $payResult;
    $status = $payResult['status'] ?? 'unknown';
    $amount = $payResult['amount']['value'] ?? 0;
    $order_id = $payResult['metadata']['order_id'] ?? $order_id;

    // –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
    log_payment_status($ordersLog, [
      'payment_id' => $payment_id,
      'order_id' => $order_id,
      'status' => $status,
      'amount' => $amount,
      'timestamp' => date('Y-m-d H:i:s')
    ]);

    // –ï—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    if ($status === 'succeeded') {
      $tgMsg = "üí∞ <b>–ü–ª–∞—Ç–µ–∂ –ø–æ–ª—É—á–µ–Ω!</b>\n\n";
      $tgMsg .= "üí≥ –°—É–º–º–∞: " . number_format($amount, 0, ',', ' ') . " ‚ÇΩ\n";
      $tgMsg .= "üÜî –ó–∞–∫–∞–∑: " . esc($order_id) . "\n";
      $tgMsg .= "üÜî –ü–ª–∞—Ç–µ–∂: " . esc($payment_id) . "\n";
      $tgMsg .= "‚è∞ " . date('d.m.Y H:i:s') . "\n\n";
      $tgMsg .= "‚úÖ –°—Ç–∞—Ç—É—Å: –£—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω";

      tg_send_message_cfg($cfg, $tgMsg);
    }
  }
}

// –¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
$T = $cfg['theme'] ?? [];
$cardOpacity = is_numeric($T['card_opacity']) ? max(0.3, min(1, (float)$T['card_opacity'])) : 0.65;
$blur = (int)($T['blur'] ?? 12);
$radius = (int)($T['radius'] ?? 16);
$shadow = (float)($T['shadow'] ?? 0.12);
$container = (int)($T['container'] ?? 1200);
$muted = $T['muted'] ?? '#5c6b84';
$bg = $T['bg'] ?? '#f3f7ff';
$text = $T['text'] ?? '#0e1220';
$brandCol = $T['brand'] ?? '#FF8A00';
$accentCol = $T['accent'] ?? '#2D5BFF';
?>
<!doctype html>
<html lang='ru'>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <title>–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–ª–∞—Ç—ã ‚Äî <?=esc($cfg['brand'] ?? '–ü–†–ò–ù–¢–°–°')?></title>
  <style>
    :root{
      --bg: <?=esc($bg)?>;
      --text: <?=esc($text)?>;
      --muted: <?=esc($muted)?>;
      --brand: <?=esc($brandCol)?>;
      --accent: <?=esc($accentCol)?>;
      --card: rgba(255,255,255, <?=esc(number_format($cardOpacity,2,'.',''))?>) ;
      --glass-blur: <?=esc($blur)?>px;
      --radius: <?=esc($radius)?>px;
      --shadow: 0 10px 30px rgba(0,0,0, <?=esc(number_format($shadow,2,'.',''))?>);
      --container: <?=esc($container)?>px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;line-height:1.5}
    body{
      background:
        radial-gradient(900px 300px at 70% -10%, rgba(45,91,255,.10), transparent 60%),
        radial-gradient(700px 280px at 20% -20%, rgba(255,138,0,.12), transparent 70%),
        var(--bg);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container{max-width:600px;width:100%}
    .card{
      background:var(--card);
      border:1px solid rgba(0,0,0,.08);
      border-radius:var(--radius);
      backdrop-filter:blur(var(--glass-blur));
      box-shadow:var(--shadow);
      padding:40px;
      text-align:center;
    }
    .status-icon{
      font-size:64px;
      margin-bottom:20px;
      display:block;
    }
    .status-success{color:#28a745}
    .status-pending{color:#ffc107}
    .status-failed{color:#dc3545}
    h1{font-size:28px;margin:0 0 10px;font-weight:700}
    .amount{font-size:36px;font-weight:800;color:var(--brand);margin:20px 0}
    .details{
      background:rgba(0,0,0,.03);
      border-radius:12px;
      padding:20px;
      margin:25px 0;
      text-align:left;
    }
    .detail-row{
      display:flex;
      justify-content:space-between;
      margin:8px 0;
      padding:4px 0;
    }
    .detail-label{color:var(--muted);font-size:14px}
    .detail-value{font-weight:600}
    .buttons{
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:30px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:12px 20px;
      border-radius:12px;
      text-decoration:none;
      font-weight:600;
      transition:all 0.2s;
      border:none;
      cursor:pointer;
    }
    .btn-primary{
      background:linear-gradient(135deg, var(--accent), #00C2FF);
      color:#fff;
    }
    .btn-secondary{
      background:var(--card);
      color:var(--text);
      border:1px solid rgba(0,0,0,.1);
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 20px rgba(0,0,0,.15);
    }
    .message{
      background:rgba(40,167,69,.1);
      border:1px solid #28a745;
      border-radius:8px;
      padding:15px;
      margin:20px 0;
      color:#155724;
    }
    .message.warning{
      background:rgba(255,193,7,.1);
      border-color:#ffc107;
      color:#856404;
    }
    .message.error{
      background:rgba(220,53,69,.1);
      border-color:#dc3545;
      color:#721c24;
    }
    @media(max-width:480px){
      .card{padding:30px 20px}
      .amount{font-size:28px}
      .buttons{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class='container'>
    <div class='card'>
      <?php if ($status === 'succeeded'): ?>
        <div class='status-icon status-success'>‚úÖ</div>
        <h1>–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!</h1>
        <p>–í–∞—à –ø–ª–∞—Ç–µ–∂ –±—ã–ª —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω</p>

        <?php if ($amount > 0): ?>
          <div class='amount'><?=number_format($amount, 0, ',', ' ')?> ‚ÇΩ</div>
        <?php endif; ?>

        <div class='message'>
          <strong>–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑!</strong><br>
          –ú—ã –ø–æ–ª—É—á–∏–ª–∏ –≤–∞—à –ø–ª–∞—Ç–µ–∂ –∏ –ø—Ä–∏—Å—Ç—É–ø–∞–µ–º –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∑–∞–∫–∞–∑–∞. 
          –í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π.
        </div>

      <?php elseif ($status === 'pending'): ?>
        <div class='status-icon status-pending'>‚è≥</div>
        <h1>–ü–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è</h1>
        <p>–í–∞—à –ø–ª–∞—Ç–µ–∂ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ</p>

        <div class='message warning'>
          <strong>–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞</strong><br>
          –ü–ª–∞—Ç–µ–∂ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ. –û–±—ã—á–Ω–æ —ç—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç. 
          –ú—ã —É–≤–µ–¥–æ–º–∏–º –≤–∞—Å –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ.
        </div>

      <?php elseif ($status === 'canceled' || $status === 'failed'): ?>
        <div class='status-icon status-failed'>‚ùå</div>
        <h1>–ü–ª–∞—Ç–µ–∂ –Ω–µ –ø—Ä–æ—à–µ–ª</h1>
        <p>–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∞—à –ø–ª–∞—Ç–µ–∂</p>

        <div class='message error'>
          <strong>–ü–ª–∞—Ç–µ–∂ –æ—Ç–∫–ª–æ–Ω–µ–Ω</strong><br>
          –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã. 
          –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏.
        </div>

      <?php else: ?>
        <div class='status-icon status-pending'>‚ùì</div>
        <h1>–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞</h1>
        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</p>

        <div class='message warning'>
          <strong>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞</strong><br>
          –ú—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –≤–∞—à–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞. –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, 
          –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –Ω–∞—à–µ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É.
        </div>
      <?php endif; ?>

      <?php if ($order_id || $payment_id): ?>
        <div class='details'>
          <?php if ($order_id): ?>
            <div class='detail-row'>
              <span class='detail-label'>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</span>
              <span class='detail-value'><?=esc($order_id)?></span>
            </div>
          <?php endif; ?>

          <?php if ($payment_id): ?>
            <div class='detail-row'>
              <span class='detail-label'>ID –ø–ª–∞—Ç–µ–∂–∞:</span>
              <span class='detail-value'><?=esc($payment_id)?></span>
            </div>
          <?php endif; ?>

          <div class='detail-row'>
            <span class='detail-label'>–í—Ä–µ–º—è:</span>
            <span class='detail-value'><?=date('d.m.Y H:i:s')?></span>
          </div>

          <?php if ($payment_info && isset($payment_info['payment_method']['type'])): ?>
            <div class='detail-row'>
              <span class='detail-label'>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</span>
              <span class='detail-value'><?=esc($payment_info['payment_method']['type'])?></span>
            </div>
          <?php endif; ?>
        </div>
      <?php endif; ?>

      <div class='buttons'>
        <a href='/' class='btn btn-primary'>üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <a href='products.php' class='btn btn-secondary'>üõçÔ∏è –¢–æ–≤–∞—Ä—ã</a>
        <a href='photoconstructor.php' class='btn btn-secondary'>üì∏ –§–æ—Ç–æ –æ–Ω–ª–∞–π–Ω</a>
        <a href='tel:<?=esc($cfg['phone_raw'] ?? '+79522003990')?>' class='btn btn-secondary'>
          üìû <?=esc($cfg['phone_display'] ?? '+7 (952) 200-39-90')?>
        </a>
      </div>

      <div style='margin-top:30px;padding-top:20px;border-top:1px solid rgba(0,0,0,.1);color:var(--muted);font-size:14px'>
        <p><strong><?=esc($cfg['brand'] ?? '–§–æ—Ç–æ—Ü–µ–Ω—Ç—Ä –ü–†–ò–ù–¢–°–°')?></strong></p>
        <p><?=esc($cfg['address'] ?? '–≥. –°–æ—Å–Ω–æ–≤—ã–π –ë–æ—Ä, —É–ª. –ö—Ä–∞—Å–Ω—ã—Ö –§–æ—Ä—Ç–æ–≤, 49')?></p>
        <p>–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –∑–≤–æ–Ω–∏—Ç–µ: <strong><?=esc($cfg['phone_display'] ?? '+7 (952) 200-39-90')?></strong></p>
      </div>
    </div>
  </div>

  <?php if ($status === 'pending'): ?>
  <script>
    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è pending –ø–ª–∞—Ç–µ–∂–µ–π
    setTimeout(() => {
      location.reload();
    }, 30000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è pending —Å—Ç–∞—Ç—É—Å–∞
  </script>
  <?php endif; ?>
</body>
</html>
